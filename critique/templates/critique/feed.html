{% extends "critique/base.html" %}
{% load static %}

{% block title %}Critique Feed - BrushUp{% endblock %}

{% block extra_head %}
<style>
  /* --- Desktop look & feel --- */
  @media (min-width: 992px){
    body{ background: linear-gradient(135deg,#2c3e50 0%,#34495e 100%); color:#fff; }
    #quickbar{ display:none !important; } /* hide bottom bar on desktop */
  }
  #pair-container{ max-width:1200px; margin:0 auto; padding:20px; }
  .desktop-layout{ display:grid; grid-template-columns:2fr 1.2fr; gap:40px; align-items:start; }
  .spotlight-artwork,.counter-artwork{ border-radius:16px; overflow:hidden; box-shadow:0 12px 48px rgba(0,0,0,.35); background:#111; }
  .spotlight-artwork .ratio-lg{ aspect-ratio:4/3; position:relative; }
  .counter-artwork .ratio-sm{ aspect-ratio:16/10; position:relative; }
  .spotlight-artwork img,.counter-artwork img{ width:100%; height:100%; object-fit:cover; display:block; }

  .critique-interface{ background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:24px; backdrop-filter:blur(10px); }
  .critique-columns{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:24px; }
  .critique-column h6{ color:#bdc3c7; font-size:.9rem; text-transform:uppercase; margin-bottom:12px; }

  /* Chips (collapse with Show more) */
  .chips-wrap{ display:flex; flex-wrap:wrap; gap:8px; max-height:200px; overflow:hidden; position:relative; }
  .chips-wrap.is-expanded{ max-height:none; }
  .chips-fade{ position:absolute; left:0; right:0; bottom:0; height:48px; background:linear-gradient(to bottom,rgba(0,0,0,0),rgba(255,255,255,.05)); pointer-events:none; }
  .more-chips{ margin-top:8px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.2); color:#bdc3c7; padding:6px 12px; border-radius:12px; font-size:.8rem; }

  .tag-chip{ background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.25); color:#ecf0f1; padding:6px 12px; border-radius:16px; font-size:.82rem; cursor:pointer; }
  .tag-chip.selected{ background:#3498db; border-color:#2980b9; color:#fff; }
  .pro-chip.selected{ background:#27ae60; border-color:#219a52; }
  .con-chip.selected{ background:#e67e22; border-color:#c86b17; }

  /* Mobile container */
  @media (max-width: 991px){
    #pair-container{ padding:0 15px 120px; }
  }

  /* Quickbar (mobile) */
  #quickbar{
    position:fixed; left:0; right:0; bottom:0; z-index:1000;
    backdrop-filter:blur(10px); background:rgba(33,37,41,.95);
    border-top:1px solid rgba(255,255,255,.1); max-height:40vh; overflow-y:auto;
    padding:15px;
  }
  .chip-row{ max-height:120px; overflow-x:auto; overflow-y:hidden; }
</style>
{% endblock %}

{% block content %}

<!-- Desktop Layout -->
<div id="pair-container" class="desktop-layout">
  <!-- LEFT: Spotlight -->
  <section id="spotlight-desktop" class="spotlight-section">
    <div class="spotlight-artwork" data-artwork-id="">
      <div class="ratio-lg">
        <img id="spotlight-img-desktop" alt="Spotlight artwork" style="display:none;">
        <div class="loading-placeholder" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#bdc3c7;">
          <div class="spinner-border spinner-border-sm me-2" role="status"></div> Loading artwork...
        </div>
      </div>
    </div>
    <div class="card-body">
      <h5 id="spotlight-title-desktop" class="card-title mb-2"></h5>
      <p id="spotlight-caption-desktop" class="card-text text-muted small"></p>
      <div id="spotlight-meta-desktop" class="d-flex justify-content-between align-items-center text-muted small">
        <span id="spotlight-medium-desktop"></span>
        <span id="spotlight-date-desktop"></span>
      </div>
    </div>
  </section>

  <!-- RIGHT: Counter + Critique UI -->
  <section class="right-section">
    <div id="counter-desktop" class="counter-artwork" data-artwork-id="">
      <div class="ratio-sm">
        <img id="counter-img-desktop" alt="Counterpoint artwork" style="display:none;">
        <div class="loading-placeholder" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#bdc3c7;">
          <div class="spinner-border spinner-border-sm me-2" role="status"></div> Loading artwork...
        </div>
      </div>
      <div class="card-body">
        <h6 id="counter-title-desktop" class="card-title mb-2"></h6>
        <p id="counter-caption-desktop" class="card-text text-muted small"></p>
        <div id="counter-meta-desktop" class="d-flex justify-content-between align-items-center text-muted small">
          <span id="counter-medium-desktop"></span>
          <span id="counter-date-desktop"></span>
        </div>
      </div>
    </div>

    <div class="critique-interface">
      <div class="critique-columns">
        <div class="critique-column">
          <h6>Strengths</h6>
          <div id="pro-tags" class="chips-wrap"></div>
          <div class="chips-fade"></div>
          <button id="pro-more" class="more-chips" style="display:none;">Show more</button>
        </div>
        <div class="critique-column">
          <h6>Your Feedback</h6>
          <textarea id="general-feedback" class="form-control mb-2" rows="4" placeholder="Share a specific suggestion..."></textarea>
          <div class="d-flex gap-2">
            <button id="desktop-submit-btn" class="btn btn-primary">Submit</button>
            <button id="desktop-swap-btn" class="btn btn-outline-secondary">Swap</button>
            <button id="desktop-next-btn" class="btn btn-outline-secondary ms-auto" disabled>Next →</button>
          </div>
        </div>
        <div class="critique-column">
          <h6>Opportunities</h6>
          <div id="con-tags" class="chips-wrap"></div>
          <div class="chips-fade"></div>
          <button id="con-more" class="more-chips" style="display:none;">Show more</button>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Mobile Quickbar -->
<div id="quickbar" class="d-lg-none">
  <div class="row chip-row mb-3">
    <div class="col-6">
      <h6 class="small text-muted mb-2">Strengths</h6>
      <div id="pro-tags-mobile" class="d-flex flex-wrap gap-2"></div>
    </div>
    <div class="col-6">
      <h6 class="small text-muted mb-2">Opportunities</h6>
      <div id="con-tags-mobile" class="d-flex flex-wrap gap-2"></div>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <textarea id="general-feedback-mobile" class="form-control mb-2" rows="3" placeholder="Share feedback..."></textarea>
      <div class="d-flex gap-2">
        <button id="mobile-submit-btn" class="btn btn-primary btn-sm">Submit</button>
        <button id="mobile-swap-btn" class="btn btn-outline-secondary btn-sm">Swap</button>
        <button id="mobile-next-btn" class="btn btn-outline-secondary btn-sm ms-auto" disabled>Next →</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Load feed data and initialize interface
  loadFeedData();
  initializeFeedInterface();
});

function loadFeedData() {
  // Fetch two artworks for comparison
  fetch('/api/feed/pair/')
    .then(response => response.json())
    .then(data => {
      if (data.artworks && data.artworks.length >= 2) {
        displayArtworks(data.artworks[0], data.artworks[1]);
      } else {
        console.error('Not enough artworks for feed');
      }
    })
    .catch(error => {
      console.error('Error loading feed data:', error);
    });
}

function displayArtworks(spotlight, counter) {
  // Display spotlight artwork
  document.getElementById('spotlight-img-desktop').src = spotlight.image_url;
  document.getElementById('spotlight-img-desktop').style.display = 'block';
  document.getElementById('spotlight-title-desktop').textContent = spotlight.title;
  document.getElementById('spotlight-caption-desktop').textContent = spotlight.description || '';
  document.getElementById('spotlight-medium-desktop').textContent = spotlight.medium || '';
  document.getElementById('spotlight-date-desktop').textContent = new Date(spotlight.created_at).toLocaleDateString();

  // Display counter artwork
  document.getElementById('counter-img-desktop').src = counter.image_url;
  document.getElementById('counter-img-desktop').style.display = 'block';
  document.getElementById('counter-title-desktop').textContent = counter.title;
  document.getElementById('counter-caption-desktop').textContent = counter.description || '';
  document.getElementById('counter-medium-desktop').textContent = counter.medium || '';
  document.getElementById('counter-date-desktop').textContent = new Date(counter.created_at).toLocaleDateString();

  // Hide loading placeholders
  document.querySelectorAll('.loading-placeholder').forEach(el => el.style.display = 'none');
}

function initializeFeedInterface() {
  // Initialize critique tag selections
  loadCritiqueTags();
  
  // Bind event handlers
  document.getElementById('desktop-submit-btn').addEventListener('click', submitCritique);
  document.getElementById('desktop-swap-btn').addEventListener('click', swapArtworks);
  document.getElementById('desktop-next-btn').addEventListener('click', loadNextPair);
  
  // Mobile handlers
  document.getElementById('mobile-submit-btn').addEventListener('click', submitCritique);
  document.getElementById('mobile-swap-btn').addEventListener('click', swapArtworks);
  document.getElementById('mobile-next-btn').addEventListener('click', loadNextPair);
}

function loadCritiqueTags() {
  // Sample critique tags
  const proTags = ['Strong composition', 'Great use of color', 'Excellent technique', 'Creative concept', 'Good lighting', 'Nice details'];
  const conTags = ['Could improve composition', 'Color balance needs work', 'Technique could be refined', 'Needs more contrast', 'Background distracting'];
  
  populateTags('pro-tags', proTags, 'pro-chip');
  populateTags('con-tags', conTags, 'con-chip');
  populateTags('pro-tags-mobile', proTags, 'pro-chip');
  populateTags('con-tags-mobile', conTags, 'con-chip');
}

function populateTags(containerId, tags, chipClass) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  
  tags.forEach(tag => {
    const chip = document.createElement('span');
    chip.className = `tag-chip ${chipClass}`;
    chip.textContent = tag;
    chip.addEventListener('click', () => chip.classList.toggle('selected'));
    container.appendChild(chip);
  });
}

function submitCritique() {
  const feedback = document.getElementById('general-feedback').value || document.getElementById('general-feedback-mobile').value;
  const selectedProTags = getSelectedTags('pro-chip');
  const selectedConTags = getSelectedTags('con-chip');
  
  if (!feedback.trim() && selectedProTags.length === 0 && selectedConTags.length === 0) {
    alert('Please provide some feedback or select tags before submitting.');
    return;
  }
  
  // Submit critique data
  console.log('Submitting critique:', { feedback, selectedProTags, selectedConTags });
  
  // Enable next button
  document.getElementById('desktop-next-btn').disabled = false;
  document.getElementById('mobile-next-btn').disabled = false;
}

function getSelectedTags(chipClass) {
  return Array.from(document.querySelectorAll(`.${chipClass}.selected`))
    .map(chip => chip.textContent);
}

function swapArtworks() {
  // Swap the spotlight and counter artworks
  const spotlightData = {
    img: document.getElementById('spotlight-img-desktop').src,
    title: document.getElementById('spotlight-title-desktop').textContent,
    caption: document.getElementById('spotlight-caption-desktop').textContent,
    medium: document.getElementById('spotlight-medium-desktop').textContent,
    date: document.getElementById('spotlight-date-desktop').textContent
  };
  
  const counterData = {
    img: document.getElementById('counter-img-desktop').src,
    title: document.getElementById('counter-title-desktop').textContent,
    caption: document.getElementById('counter-caption-desktop').textContent,
    medium: document.getElementById('counter-medium-desktop').textContent,
    date: document.getElementById('counter-date-desktop').textContent
  };
  
  // Swap the data
  document.getElementById('spotlight-img-desktop').src = counterData.img;
  document.getElementById('spotlight-title-desktop').textContent = counterData.title;
  document.getElementById('spotlight-caption-desktop').textContent = counterData.caption;
  document.getElementById('spotlight-medium-desktop').textContent = counterData.medium;
  document.getElementById('spotlight-date-desktop').textContent = counterData.date;
  
  document.getElementById('counter-img-desktop').src = spotlightData.img;
  document.getElementById('counter-title-desktop').textContent = spotlightData.title;
  document.getElementById('counter-caption-desktop').textContent = spotlightData.caption;
  document.getElementById('counter-medium-desktop').textContent = spotlightData.medium;
  document.getElementById('counter-date-desktop').textContent = spotlightData.date;
}

function loadNextPair() {
  // Reset form
  document.getElementById('general-feedback').value = '';
  document.getElementById('general-feedback-mobile').value = '';
  document.querySelectorAll('.tag-chip.selected').forEach(chip => chip.classList.remove('selected'));
  
  // Disable next button
  document.getElementById('desktop-next-btn').disabled = true;
  document.getElementById('mobile-next-btn').disabled = true;
  
  // Load new pair
  loadFeedData();
}
</script>

{% endblock %}
