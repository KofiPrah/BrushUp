{% extends "critique/base.html" %}
{% load static %}

{% block title %}Critique Feed - BrushUp{% endblock %}

{% block extra_head %}
<style>
  /* --- Desktop look & feel --- */
  @media (min-width: 992px){
    body{ background: linear-gradient(135deg,#2c3e50 0%,#34495e 100%); color:#fff; }
    #quickbar{ display:none !important; } /* hide bottom bar on desktop */
  }
  #feed-container{ max-width:800px; margin:0 auto; padding:20px; }
  .single-layout{ display:flex; flex-direction:column; gap:20px; }
  
  .artwork-display{ 
    border-radius:16px; overflow:hidden; box-shadow:0 12px 48px rgba(0,0,0,.35); 
    background:#111; display:flex; justify-content:center; align-items:center;
  }
  .artwork-display .ratio-artwork{ 
    position:relative; display:flex; justify-content:center; align-items:center; 
    min-height:500px; transition:min-height 0.3s ease-out; width:100%;
  }
  .artwork-display .ratio-artwork.has-image{ 
    min-height:auto;
  }
  
  .artwork-info {
    background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.12); 
    border-radius:16px; margin-top:20px; backdrop-filter:blur(10px);
  }
  .artwork-display img{ 
    max-width:100%; max-height:80vh; width:auto; height:auto; 
    object-fit:contain; display:block; border-radius:8px;
    opacity:0; transition:opacity 0.6s ease-in-out, transform 0.6s ease-in-out;
    transform:scale(0.98);
  }
  .artwork-display img.loaded{ 
    opacity:1; transform:scale(1);
  }

  .critique-interface{ 
    background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.12); 
    border-radius:16px; padding:24px; backdrop-filter:blur(10px); 
  }
  .critique-columns{ display:grid; grid-template-columns:1fr 1fr; gap:20px; }
  .critique-column h6{ color:#bdc3c7; font-size:.9rem; text-transform:uppercase; margin-bottom:8px; }
  
  .tag-section-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  .tag-search-container{ position:relative; }
  .tag-suggestions{ 
    position:absolute; top:100%; left:0; right:0; z-index:10; 
    background:#fff; border:1px solid #ddd; border-radius:4px; 
    max-height:150px; overflow-y:auto; display:none;
  }
  .tag-suggestions.show{ display:block; }
  .suggestion-item{ 
    padding:8px 12px; cursor:pointer; border-bottom:1px solid #eee; 
    font-size:0.85rem; color:#333;
  }
  .suggestion-item:hover{ background:#f8f9fa; }
  .suggestion-item:last-child{ border-bottom:none; }

  /* Chips */
  .chips-wrap{ display:flex; flex-wrap:wrap; gap:8px; max-height:180px; overflow-y:auto; margin-bottom:8px; }
  .tag-chip{ 
    background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.25); 
    color:#ecf0f1; padding:6px 12px; border-radius:16px; font-size:.82rem; 
    cursor:pointer; transition:all 0.2s ease; user-select:none; position:relative;
  }
  .tag-chip:hover{ background:rgba(255,255,255,.2); }
  .tag-chip.selected{ background:#3498db; border-color:#2980b9; color:#fff; }
  .pro-chip.selected{ background:#27ae60; border-color:#219a52; }
  .con-chip.selected{ background:#e67e22; border-color:#c86b17; }
  .tag-chip.disabled{ opacity:0.5; cursor:not-allowed; }
  .tag-chip.custom-tag{ 
    background:rgba(52, 152, 219, 0.2); border-color:#3498db;
    position:relative;
  }
  .tag-chip.custom-tag:before{
    content:'✨'; position:absolute; left:-2px; top:-2px;
    font-size:0.7rem; opacity:0.7;
  }
  
  .selected-count{ text-align:center; margin-top:5px; }
  
  /* Category System */
  .category-toggle{ text-align:center; }
  .tag-categories{ max-height:300px; overflow-y:auto; }
  .category-group{ margin-bottom:12px; }
  .category-header{ 
    display:flex; align-items:center; gap:6px; padding:8px 12px; 
    background:rgba(255,255,255,.08); border-radius:8px; cursor:pointer;
    transition:all 0.2s ease; user-select:none; font-size:0.85rem;
  }
  .category-header:hover{ background:rgba(255,255,255,.12); }
  .category-header.expanded{ background:rgba(255,255,255,.15); }
  .category-header.expanded .category-icon{ transform:rotate(90deg); }
  .category-icon{ transition:transform 0.2s ease; font-size:0.75rem; }
  .category-count{ margin-left:auto; opacity:0.7; }
  .category-content{ 
    display:none; padding:8px 16px; 
    border-left:2px solid rgba(255,255,255,.1); margin-left:8px; margin-top:6px;
  }
  .category-content.expanded{ display:block; }
  .category-content .chips-wrap{ max-height:120px; margin-bottom:0; }
  
  /* Tab System */
  .tag-tabs{ display:flex; gap:8px; justify-content:center; }
  .tab-button{ 
    padding:10px 16px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.2); 
    border-radius:8px; color:#bdc3c7; cursor:pointer; transition:all 0.2s ease;
    display:flex; align-items:center; gap:6px; font-size:0.9rem;
  }
  .tab-button:hover{ background:rgba(255,255,255,.12); }
  .tab-button.active{ background:#3498db; border-color:#2980b9; color:#fff; }
  .tab-button .badge{ font-size:0.75rem; margin-left:4px; }
  
  .tab-content{ display:none; }
  .tab-content.active{ display:block; }
  
  /* Selected Tags Summary */
  .selected-tags-column{ 
    background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.1); 
    border-radius:12px; padding:16px; min-height:300px;
  }
  .selected-tags-column h6{ 
    color:#bdc3c7; font-size:0.9rem; text-transform:uppercase; 
    margin-bottom:16px; display:flex; align-items:center; gap:6px;
  }
  
  .selected-group{ margin-bottom:20px; }
  .selected-group-header{ 
    display:flex; align-items:center; gap:8px; margin-bottom:8px; 
    font-size:0.85rem; font-weight:600; color:#ecf0f1;
  }
  .group-icon{ 
    width:20px; height:20px; border-radius:50%; display:flex; 
    align-items:center; justify-content:center; font-size:0.7rem; color:#fff;
  }
  
  .selected-tags-list{ min-height:40px; }
  .selected-tag-item{ 
    display:inline-block; padding:4px 8px; margin:2px; 
    background:rgba(255,255,255,.1); border-radius:12px; 
    font-size:0.75rem; color:#ecf0f1; position:relative;
  }
  .selected-tag-item.strength{ background:rgba(39, 174, 96, 0.2); border:1px solid #27ae60; }
  .selected-tag-item.opportunity{ background:rgba(230, 126, 34, 0.2); border:1px solid #e67e22; }
  .selected-tag-item .remove-tag{ 
    margin-left:4px; cursor:pointer; opacity:0.7; 
    font-size:0.7rem; font-weight:bold;
  }
  .selected-tag-item .remove-tag:hover{ opacity:1; }
  
  .selection-stats{ text-align:center; padding-top:12px; border-top:1px solid rgba(255,255,255,.1); }
  
  /* Entry Point Selection */
  .entry-point-container{ 
    background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.12); 
    border-radius:16px; padding:24px; backdrop-filter:blur(10px); margin-bottom:24px;
  }
  .entry-point-header{ text-align:center; margin-bottom:24px; }
  .entry-point-header h5{ color:#ecf0f1; margin-bottom:8px; display:flex; align-items:center; justify-content:center; gap:8px; }
  .entry-point-header p{ margin:0; font-size:0.9rem; }
  
  .feedback-options{ display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px; }
  .feedback-option{ 
    background:rgba(255,255,255,.03); border:2px solid rgba(255,255,255,.1); 
    border-radius:12px; padding:20px; cursor:pointer; transition:all 0.3s ease;
    display:flex; flex-direction:column; align-items:center; text-align:center;
  }
  .feedback-option:hover{ 
    border-color:rgba(52, 152, 219, 0.5); background:rgba(52, 152, 219, 0.08); 
    transform:translateY(-2px); box-shadow:0 8px 16px rgba(0,0,0,.2);
  }
  .feedback-option.recommended{ border-color:#3498db; background:rgba(52, 152, 219, 0.1); }
  .feedback-option.recommended::before{
    content:'Recommended'; position:absolute; top:-8px; right:8px;
    background:#3498db; color:#fff; padding:2px 8px; border-radius:12px;
    font-size:0.7rem; font-weight:600;
  }
  
  .option-icon{ 
    width:48px; height:48px; border-radius:50%; 
    background:rgba(52, 152, 219, 0.2); border:2px solid #3498db;
    display:flex; align-items:center; justify-content:center; margin-bottom:12px;
  }
  .option-icon i{ font-size:1.2rem; color:#3498db; }
  
  .option-content h6{ color:#ecf0f1; margin-bottom:8px; font-size:1rem; }
  .option-content p{ color:#bdc3c7; font-size:0.85rem; margin-bottom:12px; }
  
  .option-features{ display:flex; gap:6px; flex-wrap:wrap; justify-content:center; margin-bottom:16px; }
  .feature-tag{ 
    background:rgba(255,255,255,.1); color:#bdc3c7; padding:2px 8px; 
    border-radius:10px; font-size:0.7rem; display:flex; align-items:center; gap:3px;
  }
  .feature-tag i{ font-size:0.6rem; }
  
  .option-action .btn{ width:100%; }
  
  .preference-note{ text-align:center; }
  
  @media (max-width: 768px) {
    .feedback-options{ grid-template-columns:1fr; }
  }
  
  /* Detailed Critique Form */
  .detailed-critique-form{ margin-top:16px; }
  .form-header{ 
    display:flex; justify-content:space-between; align-items:center; 
    margin-bottom:24px; padding-bottom:12px; border-bottom:1px solid rgba(255,255,255,.1);
  }
  .form-header h6{ margin:0; color:#ecf0f1; display:flex; align-items:center; gap:8px; }
  
  /* Framework Selection */
  .framework-selection{ 
    background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.1); 
    border-radius:12px; padding:20px; margin-bottom:20px;
  }
  .framework-title{ color:#ecf0f1; margin-bottom:16px; }
  .framework-options{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
  .framework-option{ 
    background:rgba(255,255,255,.03); border:2px solid rgba(255,255,255,.1); 
    border-radius:12px; padding:16px; cursor:pointer; transition:all 0.3s ease;
    display:flex; flex-direction:column; align-items:center; text-align:center;
  }
  .framework-option:hover{ 
    border-color:rgba(52, 152, 219, 0.5); background:rgba(52, 152, 219, 0.08); 
    transform:translateY(-2px);
  }
  .framework-option.active{ 
    border-color:#3498db; background:rgba(52, 152, 219, 0.15); 
    box-shadow:0 4px 12px rgba(52, 152, 219, 0.3);
  }
  .framework-icon{ 
    width:40px; height:40px; border-radius:50%; 
    background:rgba(52, 152, 219, 0.2); border:2px solid #3498db;
    display:flex; align-items:center; justify-content:center; margin-bottom:12px;
  }
  .framework-icon i{ font-size:1.1rem; color:#3498db; }
  .framework-content h6{ color:#ecf0f1; margin-bottom:4px; }
  .framework-content p{ color:#bdc3c7; margin-bottom:8px; font-size:0.9rem; }
  
  /* Enhanced Scoring */
  .critique-scoring{ 
    background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.1); 
    border-radius:12px; padding:20px; margin-bottom:20px;
  }
  .scoring-title{ color:#ecf0f1; margin-bottom:16px; }
  .scoring-framework{ display:none; }
  .scoring-framework.active{ display:block; }
  .score-group{ margin-bottom:24px; }
  .score-group:last-child{ margin-bottom:0; }
  .score-group label{ 
    color:#ecf0f1; font-weight:600; margin-bottom:12px; 
    display:block; font-size:1rem;
  }
  
  /* Enhanced Score Controls */
  .score-dial-container{ text-align:center; position:relative; }
  
  /* Score Dial with Fixed Center - Clean Color Bands */
  .score-dial{ 
    width:100px; height:100px; border-radius:50%; margin:0 auto 8px; 
    background:conic-gradient(from 0deg, 
      #e74c3c 0deg 108deg,      /* Red: scores 1-3 (0-108°) */
      #f1c40f 108deg 252deg,    /* Yellow: scores 4-7 (108-252°) */ 
      #27ae60 252deg 360deg     /* Green: scores 8-10 (252-360°) */
    );
    display:flex; align-items:center; justify-content:center; position:relative;
    transition:all 0.3s ease; border:3px solid rgba(255,255,255,.1);
    /* Prevent color band overlap artifacts */
    image-rendering:-webkit-optimize-contrast;
    image-rendering:crisp-edges;
  }
  
  /* Score markers for visual reference - aligned with needle positions */
  .score-dial:after{ 
    content:''; position:absolute; inset:3px; border-radius:50%;
    background:repeating-conic-gradient(
      from 0deg,
      transparent 0deg 35deg,
      rgba(255,255,255,.2) 35deg 36deg,
      transparent 36deg 71deg,
      rgba(255,255,255,.2) 71deg 72deg
    );
    pointer-events:none;
  }
  
  /* Fixed center circle with score */
  .score-dial:before{ 
    content:''; position:absolute; width:70px; height:70px; 
    background:rgba(44, 62, 80, 0.95); border-radius:50%; 
    border:2px solid rgba(255,255,255,.15);
  }
  
  /* Fixed score number in center */
  .score-value-display{ 
    position:absolute; z-index:3; color:#ecf0f1; 
    font-weight:700; font-size:1.3rem; pointer-events:none;
  }
  
  /* Rotating indicator - starts at top, rotates clockwise */
  .score-indicator{ 
    position:absolute; width:4px; height:35px; 
    background:linear-gradient(to bottom, #fff, rgba(255,255,255,0.8));
    border-radius:2px; top:8px; left:calc(50% - 2px);
    transform-origin:50% 42px; transition:transform 0.3s ease;
    box-shadow:0 0 8px rgba(255,255,255,0.5);
    /* Start pointing upward at 12 o'clock (0 degrees) */
    transform:rotate(0deg);
  }
  
  /* Control buttons */
  .score-controls{ 
    display:flex; justify-content:center; gap:8px; margin-top:8px;
  }
  
  .score-btn{ 
    width:32px; height:32px; border:1px solid rgba(255,255,255,.2); 
    background:rgba(255,255,255,.05); border-radius:6px; 
    color:#bdc3c7; cursor:pointer; transition:all 0.2s ease;
    display:flex; align-items:center; justify-content:center;
    font-size:0.9rem; font-weight:600;
  }
  
  .score-btn:hover{ 
    background:rgba(255,255,255,.1); border-color:rgba(255,255,255,.4); 
    color:#ecf0f1; transform:translateY(-1px);
  }
  
  .score-btn:active{ transform:translateY(0); }
  
  /* Add tooltips for better UX */
  .score-btn[data-action="increase"]:before{ 
    content:"Increase score"; position:absolute; bottom:100%; left:50%; 
    transform:translateX(-50%); background:rgba(0,0,0,.8); color:#fff; 
    padding:4px 8px; border-radius:4px; font-size:0.7rem; white-space:nowrap;
    opacity:0; pointer-events:none; transition:opacity 0.2s ease; z-index:10;
  }
  .score-btn[data-action="decrease"]:before{ 
    content:"Decrease score"; position:absolute; bottom:100%; left:50%; 
    transform:translateX(-50%); background:rgba(0,0,0,.8); color:#fff; 
    padding:4px 8px; border-radius:4px; font-size:0.7rem; white-space:nowrap;
    opacity:0; pointer-events:none; transition:opacity 0.2s ease; z-index:10;
  }
  .score-btn:hover:before{ opacity:1; }
  
  /* Score indicator glow based on score value - matching color bands */
  .score-indicator.low-score{ 
    background:linear-gradient(to bottom, #e74c3c, rgba(231, 76, 60, 0.8));
    box-shadow:0 0 12px rgba(231, 76, 60, 0.6);
  }
  .score-indicator.medium-score{ 
    background:linear-gradient(to bottom, #f1c40f, rgba(241, 196, 15, 0.8));
    box-shadow:0 0 12px rgba(241, 196, 15, 0.6);
  }
  .score-indicator.high-score{ 
    background:linear-gradient(to bottom, #27ae60, rgba(39, 174, 96, 0.8));
    box-shadow:0 0 12px rgba(39, 174, 96, 0.6);
  }
  
  /* Alternative: Color gradient slider */
  .score-slider-container{ 
    display:none; /* Hidden by default, can be toggled */
    margin:8px 0;
  }
  
  .score-slider{ 
    width:100%; height:12px; border-radius:6px; cursor:pointer;
    background:linear-gradient(to right, #e74c3c 0%, #f39c12 25%, #f1c40f 50%, #2ecc71 75%, #27ae60 100%);
    position:relative; border:1px solid rgba(255,255,255,.2);
  }
  
  .score-slider-thumb{ 
    position:absolute; width:20px; height:20px; 
    background:#fff; border:2px solid #3498db; border-radius:50%;
    top:-4px; cursor:grab; transition:all 0.2s ease;
    box-shadow:0 2px 8px rgba(0,0,0,.3);
  }
  
  .score-slider-thumb:hover{ transform:scale(1.1); }
  .score-slider-thumb:active{ cursor:grabbing; }
  
  .score-description{ 
    color:#bdc3c7; font-size:0.85rem; margin-bottom:12px; 
    min-height:20px; transition:color 0.3s ease;
  }
  .score-description.positive{ color:#2ecc71; }
  .score-description.excellent{ color:#27ae60; }
  .score-description.needs-growth{ color:#e67e22; }
  .score-description.challenging{ color:#e74c3c; }
  
  /* Guided Feedback */
  .guided-feedback{ 
    background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.1); 
    border-radius:12px; padding:20px; margin-bottom:20px;
  }
  .feedback-title{ color:#ecf0f1; margin-bottom:16px; }
  .prompt-group{ margin-bottom:20px; }
  .prompt-group:last-child{ margin-bottom:0; }
  .prompt-group label{ 
    color:#ecf0f1; font-weight:600; margin-bottom:8px; 
    display:flex; align-items:center; gap:8px;
  }
  .prompt-group textarea{ 
    background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.2); 
    color:#ecf0f1; resize:vertical; transition:all 0.3s ease;
  }
  .prompt-group textarea:focus{ 
    background:rgba(255,255,255,.08); border-color:#3498db; 
    box-shadow:0 0 0 0.2rem rgba(52, 152, 219, 0.25);
  }
  .prompt-group textarea.completed{ 
    border-color:#27ae60; background:rgba(39, 174, 96, 0.1);
  }
  
  .feedback-status{ 
    margin-top:6px; display:flex; align-items:center; gap:6px; 
    transition:all 0.3s ease;
  }
  .feedback-status.completed{ color:#27ae60; }
  .feedback-status.completed i{ color:#27ae60; }
  
  /* Submission Progress */
  .submission-progress{ 
    background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.1); 
    border-radius:12px; padding:16px; margin-bottom:20px;
  }
  .progress-indicators{ display:flex; justify-content:space-around; gap:16px; }
  .progress-item{ 
    display:flex; align-items:center; gap:8px; color:#bdc3c7; 
    font-size:0.85rem; transition:all 0.3s ease;
  }
  .progress-item.completed{ color:#27ae60; }
  .progress-item.completed i{ color:#27ae60; }
  
  .form-actions{ display:flex; gap:12px; }
  .form-actions .btn{ flex:1; }
  .form-actions .btn:disabled{ opacity:0.6; cursor:not-allowed; }
  
  @media (max-width: 768px) {
    .framework-options{ grid-template-columns:1fr; }
    .progress-indicators{ flex-direction:column; text-align:center; }
  }

  .feedback-section {
    grid-column: 1 / -1;
    margin-top: 16px;
  }

  .action-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-top: 20px;
  }

  /* Mobile container */
  @media (max-width: 991px){
    #feed-container{ padding:0 15px 120px; }
    .critique-columns{ grid-template-columns:1fr; gap:16px; }
    body{ background:#f8f9fa; color:#333; }
    .artwork-display{ 
      background:#fff; box-shadow:0 6px 24px rgba(0,0,0,.1); 
      display:flex; justify-content:center; align-items:center;
    }
    .artwork-display .ratio-artwork{ 
      position:relative; display:flex; justify-content:center; align-items:center; 
      min-height:400px; transition:min-height 0.3s ease-out; width:100%;
    }
    .artwork-display .ratio-artwork.has-image{ 
      min-height:auto;
    }
    
    .artwork-info {
      background:#fff; border:1px solid #e0e0e0; 
      border-radius:16px; margin-top:20px; box-shadow:0 2px 12px rgba(0,0,0,.05);
    }
    .artwork-display img{ 
      max-width:100%; max-height:70vh; width:auto; height:auto; 
      object-fit:contain; border-radius:8px;
      opacity:0; transition:opacity 0.6s ease-in-out, transform 0.6s ease-in-out;
      transform:scale(0.98);
    }
    .artwork-display img.loaded{ 
      opacity:1; transform:scale(1);
    }
    .critique-interface{ background:#fff; border:1px solid #e0e0e0; }
  }

  /* Quickbar (mobile) */
  #quickbar{
    position:fixed; left:0; right:0; bottom:0; z-index:1000;
    backdrop-filter:blur(10px); background:rgba(33,37,41,.95);
    border-top:1px solid rgba(255,255,255,.1); max-height:40vh; overflow-y:auto;
    padding:15px;
  }
  .chip-row{ max-height:120px; overflow-x:auto; overflow-y:hidden; }
  
  /* Loading placeholder animations */
  .loading-placeholder {
    transition: opacity 0.4s ease-out;
    width: 100%; height: 100%;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  
  /* Enhanced spinner animation */
  .spinner-border {
    animation: spinner-grow 1.2s ease-in-out infinite;
  }
  
  @keyframes spinner-grow {
    0%, 100% { transform: scale(1); opacity: 0.8; }
    50% { transform: scale(1.1); opacity: 1; }
  }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}

<!-- Single Artwork Layout -->
<div id="feed-container" class="single-layout">
  <!-- Artwork Display -->
  <section id="artwork-section" class="artwork-section">
    <div class="artwork-display" data-artwork-id="">
      <div class="ratio-artwork">
        <img id="artwork-img" alt="Featured artwork" style="display:none;">
        <div class="loading-placeholder" style="position:absolute;inset:0;color:#bdc3c7;">
          <div class="spinner-border spinner-border-sm me-2" role="status"></div> Loading artwork...
        </div>
      </div>
    </div>
    
    <!-- Artwork Info - Separate from image container -->
    <div class="artwork-info">
      <div class="card-body p-3">
        <h5 id="artwork-title" class="card-title mb-2"></h5>
        <p id="artwork-caption" class="card-text text-muted small"></p>
        <div id="artwork-meta" class="d-flex justify-content-between align-items-center text-muted small">
          <span id="artwork-medium"></span>
          <span id="artwork-date"></span>
        </div>
      </div>
    </div>
  </section>

  <!-- Critique Interface -->
  <section class="critique-section">
    <!-- Entry Point Selection -->
    <div id="entry-point-selection" class="entry-point-container">
      <div class="entry-point-header">
        <h5><i class="bi bi-chat-left-text"></i> How would you like to give feedback?</h5>
        <p class="text-muted">Choose your preferred feedback style for this artwork</p>
      </div>
      
      <div class="feedback-options">
        <div class="feedback-option" data-type="quick">
          <div class="option-icon">
            <i class="bi bi-tags"></i>
          </div>
          <div class="option-content">
            <h6>Quick Feedback</h6>
            <p>Select from curated tags to highlight strengths and areas for improvement</p>
            <div class="option-features">
              <span class="feature-tag"><i class="bi bi-lightning"></i> Fast</span>
              <span class="feature-tag"><i class="bi bi-collection"></i> Organized</span>
              <span class="feature-tag"><i class="bi bi-search"></i> Searchable</span>
            </div>
          </div>
          <div class="option-action">
            <button class="btn btn-primary">Choose Tags</button>
          </div>
        </div>
        
        <div class="feedback-option" data-type="detailed">
          <div class="option-icon">
            <i class="bi bi-pencil-square"></i>
          </div>
          <div class="option-content">
            <h6>Detailed Critique</h6>
            <p>Write comprehensive feedback with structured scores and comments</p>
            <div class="option-features">
              <span class="feature-tag"><i class="bi bi-star"></i> Rated</span>
              <span class="feature-tag"><i class="bi bi-text-paragraph"></i> Written</span>
              <span class="feature-tag"><i class="bi bi-graph-up"></i> Detailed</span>
            </div>
          </div>
          <div class="option-action">
            <button class="btn btn-outline-primary">Write Critique</button>
          </div>
        </div>
      </div>
      
      <div class="preference-note">
        <small class="text-muted">
          <i class="bi bi-info-circle"></i> Your choice will be remembered for future artworks
        </small>
      </div>
    </div>

    <div class="critique-interface" style="display:none;">
      <!-- Quick Feedback Header with Back Button -->
      <div class="quick-feedback-header" style="display:none;">
        <div class="form-header">
          <h6><i class="bi bi-tags"></i> Quick Feedback</h6>
          <button class="btn btn-sm btn-outline-secondary back-to-selection">
            <i class="bi bi-arrow-left"></i> Back to Options
          </button>
        </div>
      </div>
      
      <!-- Tab Navigation -->
      <div class="tag-tabs mb-3">
        <button id="strengths-tab" class="tab-button active" data-tab="strengths">
          <i class="bi bi-hand-thumbs-up"></i> Strengths <span id="strengths-badge" class="badge bg-success">0</span>
        </button>
        <button id="opportunities-tab" class="tab-button" data-tab="opportunities">
          <i class="bi bi-lightbulb"></i> Opportunities <span id="opportunities-badge" class="badge bg-warning">0</span>
        </button>
      </div>

      <div class="critique-columns">
        <!-- Strengths Tab Content -->
        <div id="strengths-content" class="tab-content active">
          <div class="critique-column">
            <div class="tag-section-header">
              <h6>Strengths</h6>
              <button id="refresh-pro-tags" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-clockwise"></i>
              </button>
            </div>
            <div class="tag-search-container mb-2">
              <input type="text" id="pro-search" class="form-control form-control-sm" placeholder="Search strength tags...">
              <div id="pro-suggestions" class="tag-suggestions"></div>
            </div>
            
            <!-- Category Toggle -->
            <div class="category-toggle mb-2">
              <button id="toggle-pro-categories" class="btn btn-sm btn-outline-light">
                <i class="bi bi-collection"></i> Browse by Category
              </button>
            </div>
            
            <!-- Random Tags (Default View) -->
            <div id="pro-tags" class="chips-wrap"></div>
            
            <!-- Categorized Tags (Expandable View) -->
            <div id="pro-categories" class="tag-categories" style="display:none;">
              <div class="category-group">
                <div class="category-header" data-category="technique-pro">
                  <i class="bi bi-chevron-right category-icon"></i>
                  <span>Technique</span>
                  <small class="category-count">(8)</small>
                </div>
                <div class="category-content" id="technique-pro-tags"></div>
              </div>
              
              <div class="category-group">
                <div class="category-header" data-category="color-pro">
                  <i class="bi bi-chevron-right category-icon"></i>
                  <span>Color</span>
                  <small class="category-count">(8)</small>
                </div>
                <div class="category-content" id="color-pro-tags"></div>
              </div>
              
              <div class="category-group">
                <div class="category-header" data-category="lighting-pro">
                  <i class="bi bi-chevron-right category-icon"></i>
                  <span>Lighting & Mood</span>
                  <small class="category-count">(8)</small>
                </div>
                <div class="category-content" id="lighting-pro-tags"></div>
              </div>
              
              <div class="category-group">
                <div class="category-header" data-category="creativity-pro">
                  <i class="bi bi-chevron-right category-icon"></i>
                  <span>Creativity</span>
                  <small class="category-count">(8)</small>
                </div>
                <div class="category-content" id="creativity-pro-tags"></div>
              </div>
              
              <div class="category-group">
                <div class="category-header" data-category="impact-pro">
                  <i class="bi bi-chevron-right category-icon"></i>
                  <span>Overall Impact</span>
                  <small class="category-count">(8)</small>
                </div>
                <div class="category-content" id="impact-pro-tags"></div>
              </div>
            </div>
            
            <div class="selected-count">
              <small class="text-muted"><span id="pro-count">0</span>/5 selected</small>
            </div>
          </div>
        </div>

        <!-- Opportunities Tab Content -->
        <div id="opportunities-content" class="tab-content">
          <div class="critique-column">
            <div class="tag-section-header">
              <h6>Opportunities for Improvement</h6>
              <button id="refresh-con-tags" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-clockwise"></i>
              </button>
            </div>
            <div class="tag-search-container mb-2">
              <input type="text" id="con-search" class="form-control form-control-sm" placeholder="Search opportunity tags...">
              <div id="con-suggestions" class="tag-suggestions"></div>
            </div>
            
            <!-- Category Toggle -->
            <div class="category-toggle mb-2">
              <button id="toggle-con-categories" class="btn btn-sm btn-outline-light">
                <i class="bi bi-collection"></i> Browse by Category
              </button>
            </div>
            
            <!-- Random Tags (Default View) -->
            <div id="con-tags" class="chips-wrap"></div>
            
            <!-- Categorized Tags (Expandable View) -->
            <div id="con-categories" class="tag-categories" style="display:none;">
              <div class="category-group">
                <div class="category-header" data-category="composition-con">
                  <i class="bi bi-chevron-right category-icon"></i>
                  <span>Composition</span>
                  <small class="category-count">(7)</small>
                </div>
                <div class="category-content" id="composition-con-tags"></div>
              </div>
              
              <div class="category-group">
                <div class="category-header" data-category="technical-con">
                  <i class="bi bi-chevron-right category-icon"></i>
                  <span>Technical Areas</span>
                  <small class="category-count">(6)</small>
                </div>
                <div class="category-content" id="technical-con-tags"></div>
              </div>
              
              <div class="category-group">
                <div class="category-header" data-category="color-con">
                  <i class="bi bi-chevron-right category-icon"></i>
                  <span>Color Issues</span>
                  <small class="category-count">(7)</small>
                </div>
                <div class="category-content" id="color-con-tags"></div>
              </div>
              
              <div class="category-group">
                <div class="category-header" data-category="lighting-con">
                  <i class="bi bi-chevron-right category-icon"></i>
                  <span>Lighting Problems</span>
                  <small class="category-count">(7)</small>
                </div>
                <div class="category-content" id="lighting-con-tags"></div>
              </div>
              
              <div class="category-group">
                <div class="category-header" data-category="environment-con">
                  <i class="bi bi-chevron-right category-icon"></i>
                  <span>Background & Environment</span>
                  <small class="category-count">(5)</small>
                </div>
                <div class="category-content" id="environment-con-tags"></div>
              </div>
              
              <div class="category-group">
                <div class="category-header" data-category="polish-con">
                  <i class="bi bi-chevron-right category-icon"></i>
                  <span>Overall Polish</span>
                  <small class="category-count">(7)</small>
                </div>
                <div class="category-content" id="polish-con-tags"></div>
              </div>
            </div>
            
            <div class="selected-count">
              <small class="text-muted"><span id="con-count">0</span>/5 selected</small>
            </div>
          </div>
        </div>

        <!-- Selected Tags Summary Column -->
        <div class="selected-tags-column">
          <h6><i class="bi bi-check2-circle"></i> Your Selected Tags</h6>
          
          <div class="selected-summary">
            <div class="selected-group">
              <div class="selected-group-header">
                <span class="group-icon bg-success"><i class="bi bi-hand-thumbs-up"></i></span>
                <span>Strengths</span>
              </div>
              <div id="selected-pro-tags" class="selected-tags-list"></div>
            </div>
            
            <div class="selected-group">
              <div class="selected-group-header">
                <span class="group-icon bg-warning"><i class="bi bi-lightbulb"></i></span>
                <span>Opportunities</span>
              </div>
              <div id="selected-con-tags" class="selected-tags-list"></div>
            </div>
          </div>
          
          <div class="selection-stats mt-3">
            <small class="text-muted">
              Total: <span id="total-selected">0</span>/10 tags
            </small>
          </div>
        </div>
        <div class="feedback-section">
          <h6>Your Feedback</h6>
          <textarea id="general-feedback" class="form-control mb-3" rows="4" placeholder="Share your thoughts about this artwork..."></textarea>
          <div class="action-buttons">
            {% if user.is_authenticated %}
              <button id="submit-btn" class="btn btn-primary">Submit Feedback</button>
              <button id="skip-btn" class="btn btn-outline-secondary">Skip</button>
              <button id="next-btn" class="btn btn-outline-success" disabled>Next Artwork →</button>
            {% else %}
              <a href="/accounts/login/" class="btn btn-primary">Login to Submit Feedback</a>
              <button id="skip-btn" class="btn btn-outline-secondary">Skip</button>
              <button id="next-btn" class="btn btn-outline-success" disabled>Next Artwork →</button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Mobile Quickbar -->
<div id="quickbar" class="d-lg-none">
  <div class="row chip-row mb-3">
    <div class="col-6">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="small text-muted mb-0">Strengths</h6>
        <button id="refresh-pro-mobile" class="btn btn-sm btn-outline-secondary">
          <i class="bi bi-arrow-clockwise"></i>
        </button>
      </div>
      <div id="pro-tags-mobile" class="d-flex flex-wrap gap-2 mb-2" style="max-height:120px; overflow-y:auto;"></div>
      <small class="text-muted"><span id="pro-count-mobile">0</span>/5</small>
    </div>
    <div class="col-6">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="small text-muted mb-0">Opportunities</h6>
        <button id="refresh-con-mobile" class="btn btn-sm btn-outline-secondary">
          <i class="bi bi-arrow-clockwise"></i>
        </button>
      </div>
      <div id="con-tags-mobile" class="d-flex flex-wrap gap-2 mb-2" style="max-height:120px; overflow-y:auto;"></div>
      <small class="text-muted"><span id="con-count-mobile">0</span>/5</small>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <textarea id="general-feedback-mobile" class="form-control mb-2" rows="3" placeholder="Share your thoughts..."></textarea>
      <div class="d-flex gap-2">
        {% if user.is_authenticated %}
          <button id="mobile-submit-btn" class="btn btn-primary btn-sm">Submit</button>
        {% else %}
          <a href="/accounts/login/" class="btn btn-primary btn-sm">Login to Submit</a>
        {% endif %}
        <button id="mobile-skip-btn" class="btn btn-outline-secondary btn-sm">Skip</button>
        <button id="mobile-next-btn" class="btn btn-outline-success btn-sm ms-auto" disabled>Next →</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Load feed data and initialize interface
  loadFeedData();
  initializeFeedInterface();
});

function loadFeedData() {
  // Fetch single artwork for critique
  fetch('/api/feed/single/')
    .then(response => response.json())
    .then(data => {
      if (data.artwork) {
        displayArtwork(data.artwork);
      } else {
        console.error('No artwork available for feed');
        showNoArtworkMessage();
      }
    })
    .catch(error => {
      console.error('Error loading feed data:', error);
      // Fallback to artwork list API if single endpoint doesn't exist yet
      fetch('/api/artworks/')
        .then(response => response.json())
        .then(data => {
          if (data.results && data.results.length > 0) {
            // Pick a random artwork from the results
            const randomArtwork = data.results[Math.floor(Math.random() * data.results.length)];
            displayArtwork(randomArtwork);
          } else {
            showNoArtworkMessage();
          }
        })
        .catch(fallbackError => {
          console.error('Fallback API also failed:', fallbackError);
          showNoArtworkMessage();
        });
    });
}

function displayArtwork(artwork) {
  // Display the artwork
  const artworkImg = document.getElementById('artwork-img');
  const ratioContainer = document.querySelector('.ratio-artwork');
  const imageUrl = artwork.image_display_url || artwork.image_url || artwork.image;
  
  // Reset image state for new load
  artworkImg.classList.remove('loaded');
  artworkImg.style.display = 'none';
  ratioContainer.classList.remove('has-image');
  
  if (imageUrl) {
    // Create new image for preloading
    const tempImg = new Image();
    
    tempImg.onload = function() {
      // Image loaded successfully - show with smooth animation
      artworkImg.src = imageUrl;
      artworkImg.style.display = 'block';
      
      // Trigger animation after a brief delay to ensure display is rendered
      setTimeout(() => {
        artworkImg.classList.add('loaded');
        // Allow container to adapt to image dimensions
        ratioContainer.classList.add('has-image');
        
        // Fade out loading placeholder
        const placeholder = document.querySelector('.loading-placeholder');
        placeholder.style.opacity = '0';
        setTimeout(() => {
          placeholder.style.display = 'none';
        }, 400);
      }, 50);
    };
    
    tempImg.onerror = function() {
      // Handle image load errors
      const placeholder = document.querySelector('.loading-placeholder');
      placeholder.innerHTML = '<div class="text-center text-muted"><i class="bi bi-image" style="font-size: 3rem;"></i><br>Image not available</div>';
      placeholder.style.display = 'flex';
      placeholder.style.opacity = '1';
    };
    
    // Start loading the image
    tempImg.src = imageUrl;
  } else {
    // No image available
    const placeholder = document.querySelector('.loading-placeholder');
    placeholder.innerHTML = '<div class="text-center text-muted"><i class="bi bi-image" style="font-size: 3rem;"></i><br>No image available</div>';
    placeholder.style.display = 'flex';
    placeholder.style.opacity = '1';
  }
  
  document.getElementById('artwork-title').textContent = artwork.title || 'Untitled';
  document.getElementById('artwork-caption').textContent = artwork.description || 'No description available';
  document.getElementById('artwork-medium').textContent = artwork.medium || 'Mixed Media';
  
  const createdDate = artwork.created_at ? new Date(artwork.created_at).toLocaleDateString() : 'Recently';
  document.getElementById('artwork-date').textContent = createdDate;
  
  // Store artwork ID for critique submission
  document.querySelector('.artwork-display').dataset.artworkId = artwork.id || '';
}

function showNoArtworkMessage() {
  document.querySelector('.loading-placeholder').innerHTML = 
    '<div class="text-center"><i class="bi bi-palette2"></i><br>No artworks available for critique right now.<br><small>Check back later!</small></div>';
}

function initializeFeedInterface() {
  // Initialize critique tag selections
  loadCritiqueTags();
  
  // Bind event handlers
  document.getElementById('submit-btn').addEventListener('click', submitCritique);
  document.getElementById('skip-btn').addEventListener('click', skipArtwork);
  document.getElementById('next-btn').addEventListener('click', loadNextArtwork);
  
  // Mobile handlers
  document.getElementById('mobile-submit-btn').addEventListener('click', submitCritique);
  document.getElementById('mobile-skip-btn').addEventListener('click', skipArtwork);
  document.getElementById('mobile-next-btn').addEventListener('click', loadNextArtwork);
}

function loadCritiqueTags() {
  // Load initial tag sets
  loadTagSet('pro');
  loadTagSet('con');
  
  // Bind refresh handlers - desktop
  document.getElementById('refresh-pro-tags').addEventListener('click', () => loadTagSet('pro'));
  document.getElementById('refresh-con-tags').addEventListener('click', () => loadTagSet('con'));
  
  // Bind refresh handlers - mobile
  if (document.getElementById('refresh-pro-mobile')) {
    document.getElementById('refresh-pro-mobile').addEventListener('click', () => loadTagSet('pro'));
  }
  if (document.getElementById('refresh-con-mobile')) {
    document.getElementById('refresh-con-mobile').addEventListener('click', () => loadTagSet('con'));
  }
  
  // Bind search handlers
  setupTagSearch('pro');
  setupTagSearch('con');
  
  // Bind category toggle handlers
  setupCategoryToggle('pro');
  setupCategoryToggle('con');
  
  // Setup tab system
  setupTabSystem();
  
  // Setup entry point selection
  setupEntryPointSelection();
}

function loadTagSet(type) {
  // Store currently selected tags before refreshing
  const currentlySelected = getSelectedTags(type);
  
  const flatPool = getFlatTagPool(type);
  
  // Get random selection of 8-12 tags from the pool
  const shuffled = [...flatPool].sort(() => 0.5 - Math.random());
  const selectedTags = shuffled.slice(0, Math.floor(Math.random() * 5) + 8);
  
  const containerId = `${type}-tags`;
  const chipClass = `${type}-chip`;
  
  populateTags(containerId, selectedTags, chipClass, type);
  
  // Also populate mobile if exists
  const mobileContainerId = `${type}-tags-mobile`;
  if (document.getElementById(mobileContainerId)) {
    populateTags(mobileContainerId, selectedTags, chipClass, type);
  }
  
  // Load categorized tags as well
  loadCategorizedTags(type);
  
  // Restore previously selected tags
  restoreSelectedTags(type, currentlySelected);
  
  // Update counts and states
  updateTagCount(type);
  updateTagCount(`${type}-mobile`);
  updateTagStates(type);
}

function getTagPools() {
  return {
    pro: {
      technique: [
        'Strong composition', 'Excellent technique', 'Great brushwork', 'Skillful rendering',
        'Nice details', 'Good proportions', 'Solid drawing foundation', 'Clean linework'
      ],
      color: [
        'Great use of color', 'Beautiful color palette', 'Nice color harmony', 'Bold colors',
        'Subtle color choices', 'Good color temperature', 'Rich colors', 'Balanced tones'
      ],
      lighting: [
        'Good lighting', 'Dramatic lighting', 'Atmospheric mood', 'Great shadows',
        'Nice highlights', 'Moody atmosphere', 'Cinematic feel', 'Warm feeling'
      ],
      creativity: [
        'Creative concept', 'Original idea', 'Unique style', 'Imaginative',
        'Great storytelling', 'Expressive', 'Emotional impact', 'Compelling subject'
      ],
      impact: [
        'Eye-catching', 'Professional quality', 'Polished finish', 'Cohesive style',
        'Strong visual impact', 'Engaging composition', 'Dynamic energy', 'Balanced design'
      ]
    },
    
    con: {
      composition: [
        'Could improve composition', 'Needs better focal point', 'Unbalanced layout',
        'Confusing composition', 'Weak composition', 'Too busy', 'Lacks focus'
      ],
      technical: [
        'Technique could be refined', 'Anatomy needs work', 'Perspective issues',
        'Proportions off', 'Drawing needs improvement', 'Rough execution'
      ],
      color: [
        'Color balance needs work', 'Colors clash', 'Too saturated', 'Too muted',
        'Lacks color harmony', 'Muddy colors', 'Color temperature inconsistent'
      ],
      lighting: [
        'Needs more contrast', 'Lighting unclear', 'Shadows inconsistent',
        'Too flat', 'Lacks depth', 'Missing highlights', 'Confusing light source'
      ],
      environment: [
        'Background distracting', 'Background too busy', 'Environment unclear',
        'Background competes with subject', 'Needs more environment detail'
      ],
      polish: [
        'Needs more refinement', 'Feels unfinished', 'Could be more polished',
        'Lacks visual interest', 'Too simple', 'Needs more detail', 'Style inconsistent'
      ]
    }
  };
}

// Get flat array of all tags for random selection and search
function getFlatTagPool(type) {
  const pools = getTagPools()[type];
  return Object.values(pools).flat();
}

function populateTags(containerId, tags, chipClass, type) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  
  tags.forEach(tag => {
    const chip = document.createElement('span');
    chip.className = `tag-chip ${chipClass}`;
    chip.textContent = tag;
    chip.addEventListener('click', () => toggleTagSelection(chip, type));
    container.appendChild(chip);
  });
}

function toggleTagSelection(chip, type) {
  const baseType = type.replace('-mobile', '');
  const tagText = chip.textContent.trim();
  const isCurrentlySelected = chip.classList.contains('selected');
  
  if (isCurrentlySelected) {
    // Deselect this tag across all sections
    deselectTagEverywhere(baseType, tagText);
  } else {
    // Check if tag is already selected elsewhere
    if (isTagSelectedAnywhere(baseType, tagText)) {
      // Tag is already selected in another section, do nothing
      return;
    }
    
    const currentCount = getSelectedTagCount(baseType);
    if (currentCount >= 5) {
      showTagLimitWarning(baseType);
      return;
    }
    
    // Select this tag across all sections where it appears
    selectTagEverywhere(baseType, tagText);
  }
  
  // Update counts and states
  updateTagCount(baseType);
  updateTagCount(`${baseType}-mobile`);
  updateTagStates(baseType);
}

function getSelectedTagCount(type) {
  // Count unique selected tags to avoid duplicates across sections
  const uniqueSelectedTags = new Set();
  document.querySelectorAll(`.${type}-chip.selected`).forEach(chip => {
    uniqueSelectedTags.add(chip.textContent.trim());
  });
  return uniqueSelectedTags.size;
}

function updateTagCount(type) {
  const baseType = type.replace('-mobile', '');
  const count = getSelectedTagCount(baseType);
  
  // Update both desktop and mobile counters
  const countElement = document.getElementById(`${baseType}-count`);
  const mobileCountElement = document.getElementById(`${baseType}-count-mobile`);
  
  if (countElement) {
    countElement.textContent = count;
  }
  if (mobileCountElement) {
    mobileCountElement.textContent = count;
  }
  
  // Update tab badges
  const tabBadge = document.getElementById(`${baseType === 'pro' ? 'strengths' : 'opportunities'}-badge`);
  if (tabBadge) {
    tabBadge.textContent = count;
  }
  
  // Update selected tags summary
  updateSelectedTagsSummary(baseType);
  
  // Update total count
  const proCount = getSelectedTagCount('pro');
  const conCount = getSelectedTagCount('con');
  const totalElement = document.getElementById('total-selected');
  if (totalElement) {
    totalElement.textContent = proCount + conCount;
  }
}

function updateTagStates(type) {
  const selectedCount = getSelectedTagCount(type);
  const maxTags = 5;
  const chips = document.querySelectorAll(`.${type}-chip`);
  
  chips.forEach(chip => {
    if (selectedCount >= maxTags && !chip.classList.contains('selected')) {
      chip.classList.add('disabled');
    } else {
      chip.classList.remove('disabled');
    }
  });
}

function showTagLimitWarning(type) {
  const section = type === 'pro' ? 'strengths' : 'opportunities';
  alert(`Maximum of 5 ${section} tags reached. Please deselect a tag first.`);
}

function setupTagSearch(type) {
  const searchInput = document.getElementById(`${type}-search`);
  const suggestionsDiv = document.getElementById(`${type}-suggestions`);
  const flatPool = getFlatTagPool(type);
  
  searchInput.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase().trim();
    
    if (query.length < 2) {
      suggestionsDiv.classList.remove('show');
      return;
    }
    
    const matches = flatPool.filter(tag => 
      tag.toLowerCase().includes(query)
    ).slice(0, 5);
    
    if (matches.length > 0) {
      suggestionsDiv.innerHTML = matches
        .map(tag => `<div class="suggestion-item" data-tag="${tag}">${tag}</div>`)
        .join('');
      suggestionsDiv.classList.add('show');
      
      // Bind click handlers for suggestions
      suggestionsDiv.querySelectorAll('.suggestion-item').forEach(item => {
        item.addEventListener('click', () => {
          addCustomTag(item.dataset.tag, type);
          searchInput.value = '';
          suggestionsDiv.classList.remove('show');
        });
      });
    } else {
      suggestionsDiv.classList.remove('show');
    }
  });
  
  // Hide suggestions when clicking outside
  document.addEventListener('click', (e) => {
    if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
      suggestionsDiv.classList.remove('show');
    }
  });
}

function addCustomTag(tagText, type) {
  // Check if tag already exists
  const existingTags = document.querySelectorAll(`.${type}-chip`);
  for (let tag of existingTags) {
    if (tag.textContent === tagText) {
      // Tag exists, just select it if not already selected
      if (!tag.classList.contains('selected')) {
        toggleTagSelection(tag, type);
      }
      return;
    }
  }
  
  // Add new custom tag
  const container = document.getElementById(`${type}-tags`);
  const chip = document.createElement('span');
  chip.className = `tag-chip ${type}-chip custom-tag`;
  chip.textContent = tagText;
  chip.addEventListener('click', () => toggleTagSelection(chip, type));
  
  // Insert at beginning to make it prominent
  container.insertBefore(chip, container.firstChild);
  
  // Auto-select the new tag
  setTimeout(() => toggleTagSelection(chip, type), 100);
}

function setupCategoryToggle(type) {
  const toggleButton = document.getElementById(`toggle-${type}-categories`);
  const randomTags = document.getElementById(`${type}-tags`);
  const categories = document.getElementById(`${type}-categories`);
  
  toggleButton.addEventListener('click', () => {
    const isShowingCategories = categories.style.display !== 'none';
    
    if (isShowingCategories) {
      // Switch back to random view
      categories.style.display = 'none';
      randomTags.style.display = 'flex';
      toggleButton.innerHTML = '<i class="bi bi-collection"></i> Browse by Category';
    } else {
      // Switch to category view
      randomTags.style.display = 'none';
      categories.style.display = 'block';
      toggleButton.innerHTML = '<i class="bi bi-grid-3x3-gap"></i> Random Tags';
      
      // Load categorized tags if not already loaded
      loadCategorizedTags(type);
    }
  });
  
  // Setup category header click handlers
  setupCategoryHeaders(type);
}

function loadCategorizedTags(type) {
  const tagPools = getTagPools()[type];
  
  Object.keys(tagPools).forEach(categoryKey => {
    const tags = tagPools[categoryKey];
    const containerId = `${categoryKey}-${type}-tags`;
    const container = document.getElementById(containerId);
    
    if (container && container.innerHTML === '') {
      // Create chips wrap
      const chipsWrap = document.createElement('div');
      chipsWrap.className = 'chips-wrap';
      
      tags.forEach(tag => {
        const chip = document.createElement('span');
        chip.className = `tag-chip ${type}-chip`;
        chip.textContent = tag;
        chip.addEventListener('click', () => toggleTagSelection(chip, type));
        chipsWrap.appendChild(chip);
      });
      
      container.appendChild(chipsWrap);
    }
  });
}

function setupCategoryHeaders(type) {
  const categoryHeaders = document.querySelectorAll(`#${type}-categories .category-header`);
  
  categoryHeaders.forEach(header => {
    header.addEventListener('click', () => {
      const categoryId = header.dataset.category;
      const content = document.getElementById(`${categoryId}-tags`);
      const isExpanded = header.classList.contains('expanded');
      
      if (isExpanded) {
        // Collapse
        header.classList.remove('expanded');
        content.classList.remove('expanded');
      } else {
        // Expand
        header.classList.add('expanded');
        content.classList.add('expanded');
      }
    });
  });
}

async function submitCritique() {
  // Check if user is authenticated
  {% if not user.is_authenticated %}
    alert('Please log in to submit feedback.');
    window.location.href = '/accounts/login/';
    return;
  {% endif %}
  
  const feedback = document.getElementById('general-feedback').value || document.getElementById('general-feedback-mobile').value;
  const selectedProTags = getSelectedTags('pro-chip');
  const selectedConTags = getSelectedTags('con-chip');
  
  if (!feedback.trim() && selectedProTags.length === 0 && selectedConTags.length === 0) {
    alert('Please provide some feedback or select tags before submitting.');
    return;
  }
  
  const artworkId = document.querySelector('.artwork-display').dataset.artworkId;
  
  if (!artworkId) {
    alert('No artwork selected. Please refresh the page.');
    return;
  }
  
  // Build critique text combining feedback and selected tags
  let critiqueText = feedback.trim();
  
  if (selectedProTags.length > 0) {
    critiqueText += (critiqueText ? '\n\n' : '') + 'Strengths: ' + selectedProTags.join(', ');
  }
  
  if (selectedConTags.length > 0) {
    critiqueText += (critiqueText ? '\n\n' : '') + 'Areas for improvement: ' + selectedConTags.join(', ');
  }
  
  // Show loading state
  const submitBtn = document.getElementById('submit-btn');
  const mobileSubmitBtn = document.getElementById('mobile-submit-btn');
  
  const originalText = submitBtn.textContent;
  const originalMobileText = mobileSubmitBtn.textContent;
  
  submitBtn.textContent = 'Submitting...';
  submitBtn.disabled = true;
  mobileSubmitBtn.textContent = 'Submitting...';
  mobileSubmitBtn.disabled = true;
  
  try {
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                     getCookie('csrftoken');
    
    // Submit critique to API
    const response = await fetch(`/api/artworks/${artworkId}/add_critique/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,
      },
      credentials: 'same-origin',
      body: JSON.stringify({
        text: critiqueText,
        composition_score: null,
        technique_score: null,
        originality_score: null
      })
    });
    
    if (response.ok) {
      const result = await response.json();
      console.log('Critique submitted successfully:', result);
      
      // Show success state
      submitBtn.textContent = 'Submitted!';
      mobileSubmitBtn.textContent = 'Submitted!';
      
      // Enable next button
      document.getElementById('next-btn').disabled = false;
      document.getElementById('mobile-next-btn').disabled = false;
      
      // Reset button after delay
      setTimeout(() => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        mobileSubmitBtn.textContent = originalMobileText;
        mobileSubmitBtn.disabled = false;
      }, 2000);
      
    } else {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
  } catch (error) {
    console.error('Error submitting critique:', error);
    
    // Show error state
    submitBtn.textContent = 'Error - Try Again';
    mobileSubmitBtn.textContent = 'Error - Try Again';
    
    // Reset button after delay
    setTimeout(() => {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
      mobileSubmitBtn.textContent = originalMobileText;
      mobileSubmitBtn.disabled = false;
    }, 3000);
    
    alert('Failed to submit critique. Please try again.');
  }
}

// Helper function to get CSRF token from cookies
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function getSelectedTags(chipClass) {
  return Array.from(document.querySelectorAll(`.${chipClass}.selected`))
    .map(chip => chip.textContent);
}

function skipArtwork() {
  // Enable next button and move to next artwork
  document.getElementById('next-btn').disabled = false;
  document.getElementById('mobile-next-btn').disabled = false;
  loadNextArtwork();
}

function loadNextArtwork() {
  // Reset form
  const feedbackField = document.getElementById('general-feedback');
  const mobileFeedbackField = document.getElementById('general-feedback-mobile');
  
  if (feedbackField) feedbackField.value = '';
  if (mobileFeedbackField) mobileFeedbackField.value = '';
  
  document.querySelectorAll('.tag-chip.selected').forEach(chip => chip.classList.remove('selected'));
  
  // Disable next button
  document.getElementById('next-btn').disabled = true;
  document.getElementById('mobile-next-btn').disabled = true;
  
  // Show loading state with smooth transition
  const artworkImg = document.getElementById('artwork-img');
  const ratioContainer = document.querySelector('.ratio-artwork');
  const placeholder = document.querySelector('.loading-placeholder');
  
  // Fade out current image and reset container to loading state
  artworkImg.classList.remove('loaded');
  ratioContainer.classList.remove('has-image');
  
  setTimeout(() => {
    artworkImg.style.display = 'none';
    
    // Show loading placeholder with animation
    placeholder.style.display = 'flex';
    placeholder.style.opacity = '1';
    placeholder.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div> Loading next artwork...';
    
    // Reload to get new artwork (in real app, this would be AJAX)
    setTimeout(() => {
      window.location.reload();
    }, 1000);
  }, 300);
}

function getSelectedTags(type) {
  // Get unique selected tags to avoid duplicates
  const selectedTags = new Set();
  document.querySelectorAll(`.${type}-chip.selected`).forEach(chip => {
    selectedTags.add(chip.textContent.trim());
  });
  return Array.from(selectedTags);
}

function restoreSelectedTags(type, selectedTags) {
  if (!selectedTags || selectedTags.length === 0) return;
  
  // Use selectTagEverywhere to ensure consistency across all sections
  selectedTags.forEach(tagText => {
    selectTagEverywhere(type, tagText);
  });
}

function setupTabSystem() {
  const strengthsTab = document.getElementById('strengths-tab');
  const opportunitiesTab = document.getElementById('opportunities-tab');
  const strengthsContent = document.getElementById('strengths-content');
  const opportunitiesContent = document.getElementById('opportunities-content');
  
  strengthsTab.addEventListener('click', () => {
    // Switch to strengths tab
    strengthsTab.classList.add('active');
    opportunitiesTab.classList.remove('active');
    strengthsContent.classList.add('active');
    opportunitiesContent.classList.remove('active');
  });
  
  opportunitiesTab.addEventListener('click', () => {
    // Switch to opportunities tab
    opportunitiesTab.classList.add('active');
    strengthsTab.classList.remove('active');
    opportunitiesContent.classList.add('active');
    strengthsContent.classList.remove('active');
  });
}

function updateSelectedTagsSummary(type) {
  const selectedTags = getSelectedTags(type);
  const summaryContainer = document.getElementById(`selected-${type}-tags`);
  
  if (summaryContainer) {
    if (selectedTags.length === 0) {
      summaryContainer.innerHTML = '<small class="text-muted">No tags selected</small>';
    } else {
      summaryContainer.innerHTML = selectedTags
        .map(tag => `
          <span class="selected-tag-item ${type === 'pro' ? 'strength' : 'opportunity'}" data-tag="${tag}">
            ${tag}
            <span class="remove-tag" onclick="removeSelectedTag('${type}', '${tag}')">&times;</span>
          </span>
        `).join('');
    }
  }
}

function removeSelectedTag(type, tagText) {
  // Deselect this tag everywhere it appears
  deselectTagEverywhere(type, tagText);
  
  // Update counts and states
  updateTagCount(type);
  updateTagStates(type);
}

function isTagSelectedAnywhere(type, tagText) {
  const allChips = document.querySelectorAll(`.${type}-chip`);
  return Array.from(allChips).some(chip => 
    chip.textContent.trim() === tagText && chip.classList.contains('selected')
  );
}

function selectTagEverywhere(type, tagText) {
  const allChips = document.querySelectorAll(`.${type}-chip`);
  allChips.forEach(chip => {
    if (chip.textContent.trim() === tagText) {
      chip.classList.add('selected');
    }
  });
}

function deselectTagEverywhere(type, tagText) {
  const allChips = document.querySelectorAll(`.${type}-chip`);
  allChips.forEach(chip => {
    if (chip.textContent.trim() === tagText) {
      chip.classList.remove('selected');
    }
  });
}

function setupEntryPointSelection() {
  const entryPointContainer = document.getElementById('entry-point-selection');
  const critiqueInterface = document.querySelector('.critique-interface');
  const feedbackOptions = document.querySelectorAll('.feedback-option');
  
  // Check for saved preference
  const savedPreference = localStorage.getItem('brushup_feedback_preference');
  if (savedPreference) {
    const recommendedOption = document.querySelector(`[data-type="${savedPreference}"]`);
    if (recommendedOption) {
      recommendedOption.classList.add('recommended');
      recommendedOption.style.position = 'relative';
    }
  }
  
  feedbackOptions.forEach(option => {
    option.addEventListener('click', () => {
      const feedbackType = option.dataset.type;
      
      // Save preference
      localStorage.setItem('brushup_feedback_preference', feedbackType);
      
      // Hide entry point and show appropriate interface
      entryPointContainer.style.display = 'none';
      critiqueInterface.style.display = 'block';
      
      if (feedbackType === 'quick') {
        // Show tag-based interface (already loaded)
        setupQuickFeedbackInterface();
      } else {
        // Show detailed critique interface
        setupDetailedCritiqueInterface();
      }
    });
  });
  
  // Auto-select if user has strong preference (used 3+ times)
  const usageCount = parseInt(localStorage.getItem('brushup_usage_count') || '0');
  if (savedPreference && usageCount >= 3) {
    // Auto-show preferred interface after brief delay
    setTimeout(() => {
      const preferredOption = document.querySelector(`[data-type="${savedPreference}"]`);
      if (preferredOption) {
        preferredOption.click();
      }
    }, 1500);
  }
}

function setupQuickFeedbackInterface() {
  // Tag interface is already set up, just ensure visibility
  document.querySelector('.quick-feedback-header').style.display = 'block';
  document.querySelector('.tag-tabs').style.display = 'flex';
  document.querySelector('.critique-columns').style.display = 'grid';
  
  // Add back button functionality
  addBackToSelectionButton();
}

function setupDetailedCritiqueInterface() {
  const critiqueInterface = document.querySelector('.critique-interface');
  
  // Hide tag interface
  document.querySelector('.tag-tabs').style.display = 'none';
  document.querySelector('.critique-columns').style.display = 'none';
  
  // Create detailed critique form
  const detailedForm = document.createElement('div');
  detailedForm.className = 'detailed-critique-form';
  detailedForm.innerHTML = `
    <div class="form-header">
      <h6><i class="bi bi-pencil-square"></i> Detailed Critique</h6>
      <button class="btn btn-sm btn-outline-secondary back-to-selection">
        <i class="bi bi-arrow-left"></i> Back to Options
      </button>
    </div>
    
    <!-- Framework Selection -->
    <div class="framework-selection">
      <h6 class="framework-title">
        <i class="bi bi-palette"></i> Choose Your Critique Framework
        <small class="text-muted d-block mt-1">Select the approach that resonates with you</small>
      </h6>
      <div class="framework-options">
        <div class="framework-option active" data-framework="technical">
          <div class="framework-icon">
            <i class="bi bi-gear-fill"></i>
          </div>
          <div class="framework-content">
            <h6>Formalist</h6>
            <p>Focus on technique & composition</p>
            <small class="text-muted">Analyze technical execution and structural elements</small>
          </div>
        </div>
        <div class="framework-option" data-framework="expressive">
          <div class="framework-icon">
            <i class="bi bi-heart-fill"></i>
          </div>
          <div class="framework-content">
            <h6>Expressive</h6>
            <p>Focus on emotion & storytelling</p>
            <small class="text-muted">Explore emotional impact and narrative content</small>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Scoring Section -->
    <div class="critique-scoring">
      <h6 class="scoring-title">
        <i class="bi bi-star"></i> Rate Each Aspect
        <small class="text-muted d-block mt-1">Use the visual dials to express your assessment</small>
      </h6>
      
      <div id="technical-scores" class="scoring-framework active">
        <div class="score-group">
          <label>Composition</label>
          <div class="score-dial-container">
            <div class="score-dial" id="composition-dial">
              <div class="score-value-display" id="composition-value">5</div>
              <div class="score-indicator" id="composition-indicator"></div>
            </div>
            <div class="score-controls">
              <button type="button" class="score-btn" data-action="decrease" data-target="composition">−</button>
              <button type="button" class="score-btn" data-action="increase" data-target="composition">+</button>
            </div>
            <div class="score-description" id="composition-desc">Balanced and thoughtful</div>
          </div>
          <input type="range" id="composition-score" min="1" max="10" value="5" class="form-range d-none">
        </div>
        <div class="score-group">
          <label>Technique</label>
          <div class="score-dial-container">
            <div class="score-dial" id="technique-dial">
              <div class="score-value-display" id="technique-value">5</div>
              <div class="score-indicator" id="technique-indicator"></div>
            </div>
            <div class="score-controls">
              <button type="button" class="score-btn" data-action="decrease" data-target="technique">−</button>
              <button type="button" class="score-btn" data-action="increase" data-target="technique">+</button>
            </div>
            <div class="score-description" id="technique-desc">Solid foundation</div>
          </div>
          <input type="range" id="technique-score" min="1" max="10" value="5" class="form-range d-none">
        </div>
        <div class="score-group">
          <label>Originality</label>
          <div class="score-dial-container">
            <div class="score-dial" id="originality-dial">
              <div class="score-value-display" id="originality-value">5</div>
              <div class="score-indicator" id="originality-indicator"></div>
            </div>
            <div class="score-controls">
              <button type="button" class="score-btn" data-action="decrease" data-target="originality">−</button>
              <button type="button" class="score-btn" data-action="increase" data-target="originality">+</button>
            </div>
            <div class="score-description" id="originality-desc">Fresh perspective</div>
          </div>
          <input type="range" id="originality-score" min="1" max="10" value="5" class="form-range d-none">
        </div>
        <div class="score-group">
          <label>Impact</label>
          <div class="score-dial-container">
            <div class="score-dial" id="impact-dial">
              <div class="score-value-display" id="impact-value">5</div>
              <div class="score-indicator" id="impact-indicator"></div>
            </div>
            <div class="score-controls">
              <button type="button" class="score-btn" data-action="decrease" data-target="impact">−</button>
              <button type="button" class="score-btn" data-action="increase" data-target="impact">+</button>
            </div>
            <div class="score-description" id="impact-desc">Makes an impression</div>
          </div>
          <input type="range" id="impact-score" min="1" max="10" value="5" class="form-range d-none">
        </div>
      </div>
      
      <div id="expressive-scores" class="scoring-framework">
        <div class="score-group">
          <label>Emotional Resonance</label>
          <div class="score-dial-container">
            <div class="score-dial" id="emotion-dial">
              <div class="score-value-display" id="emotion-value">5</div>
              <div class="score-indicator" id="emotion-indicator"></div>
            </div>
            <div class="score-controls">
              <button type="button" class="score-btn" data-action="decrease" data-target="emotion">−</button>
              <button type="button" class="score-btn" data-action="increase" data-target="emotion">+</button>
            </div>
            <div class="score-description" id="emotion-desc">Evokes feeling</div>
          </div>
          <input type="range" id="emotion-score" min="1" max="10" value="5" class="form-range d-none">
        </div>
        <div class="score-group">
          <label>Storytelling</label>
          <div class="score-dial-container">
            <div class="score-dial" id="storytelling-dial">
              <div class="score-value-display" id="storytelling-value">5</div>
              <div class="score-indicator" id="storytelling-indicator"></div>
            </div>
            <div class="score-controls">
              <button type="button" class="score-btn" data-action="decrease" data-target="storytelling">−</button>
              <button type="button" class="score-btn" data-action="increase" data-target="storytelling">+</button>
            </div>
            <div class="score-description" id="storytelling-desc">Communicates clearly</div>
          </div>
          <input type="range" id="storytelling-score" min="1" max="10" value="5" class="form-range d-none">
        </div>
        <div class="score-group">
          <label>Atmosphere</label>
          <div class="score-dial-container">
            <div class="score-dial" id="atmosphere-dial">
              <div class="score-value-display" id="atmosphere-value">5</div>
              <div class="score-indicator" id="atmosphere-indicator"></div>
            </div>
            <div class="score-controls">
              <button type="button" class="score-btn" data-action="decrease" data-target="atmosphere">−</button>
              <button type="button" class="score-btn" data-action="increase" data-target="atmosphere">+</button>
            </div>
            <div class="score-description" id="atmosphere-desc">Creates mood</div>
          </div>
          <input type="range" id="atmosphere-score" min="1" max="10" value="5" class="form-range d-none">
        </div>
        <div class="score-group">
          <label>Personal Connection</label>
          <div class="score-dial-container">
            <div class="score-dial" id="connection-dial">
              <div class="score-value-display" id="connection-value">5</div>
              <div class="score-indicator" id="connection-indicator"></div>
            </div>
            <div class="score-controls">
              <button type="button" class="score-btn" data-action="decrease" data-target="connection">−</button>
              <button type="button" class="score-btn" data-action="increase" data-target="connection">+</button>
            </div>
            <div class="score-description" id="connection-desc">Speaks to me</div>
          </div>
          <input type="range" id="connection-score" min="1" max="10" value="5" class="form-range d-none">
        </div>
      </div>
    </div>
    
    <!-- Guided Written Feedback -->
    <div class="guided-feedback">
      <h6 class="feedback-title">
        <i class="bi bi-chat-quote"></i> Share Your Thoughts
        <small class="text-muted d-block mt-1">Help the artist grow with specific insights</small>
      </h6>
      
      <div class="feedback-prompts">
        <div class="prompt-group">
          <label for="positive-feedback">
            <i class="bi bi-hand-thumbs-up text-success"></i> What stood out to you?
            <small class="text-muted d-block">Highlight specific strengths and effective choices</small>
          </label>
          <textarea id="positive-feedback" class="form-control feedback-required" rows="3" 
                    placeholder="I'm drawn to how you..." data-type="positive"></textarea>
          <div class="feedback-status" id="positive-status">
            <i class="bi bi-circle text-muted"></i> <small>Add at least one positive observation</small>
          </div>
        </div>
        
        <div class="prompt-group">
          <label for="constructive-feedback">
            <i class="bi bi-lightbulb text-warning"></i> What could be improved?
            <small class="text-muted d-block">Suggest areas for growth and development</small>
          </label>
          <textarea id="constructive-feedback" class="form-control feedback-required" rows="3" 
                    placeholder="Consider exploring..." data-type="constructive"></textarea>
          <div class="feedback-status" id="constructive-status">
            <i class="bi bi-circle text-muted"></i> <small>Add at least one constructive suggestion</small>
          </div>
        </div>
        
        <div class="prompt-group">
          <label for="overall-feedback">
            <i class="bi bi-heart text-info"></i> Overall impression (Optional)
            <small class="text-muted d-block">Share your general thoughts and feelings</small>
          </label>
          <textarea id="overall-feedback" class="form-control" rows="2" 
                    placeholder="This piece makes me feel..." data-type="optional"></textarea>
        </div>
      </div>
    </div>
    
    <!-- Submission Progress -->
    <div class="submission-progress">
      <div class="progress-indicators">
        <div class="progress-item" id="positive-indicator">
          <i class="bi bi-circle"></i> <span>Positive insight</span>
        </div>
        <div class="progress-item" id="constructive-indicator">
          <i class="bi bi-circle"></i> <span>Constructive feedback</span>
        </div>
        <div class="progress-item" id="scores-indicator">
          <i class="bi bi-check-circle-fill text-success"></i> <span>Ratings complete</span>
        </div>
      </div>
    </div>
    
    <div class="form-actions">
      <button id="submit-detailed-btn" class="btn btn-primary" disabled>
        <i class="bi bi-send"></i> Submit Detailed Critique
      </button>
      <button id="skip-detailed-btn" class="btn btn-outline-secondary">
        <i class="bi bi-skip-forward"></i> Skip This Artwork
      </button>
    </div>
  `;
  
  critiqueInterface.appendChild(detailedForm);
  
  // Setup enhanced components
  setupFrameworkSelection();
  setupEmotionSafeScoring();
  setupGuidedFeedback();
  setupGamifiedValidation();
  
  // Add back button functionality
  addBackToSelectionButton();
}

// Enhanced framework and scoring system functions

function setupFrameworkSelection() {
  const frameworkOptions = document.querySelectorAll('.framework-option');
  const technicalScores = document.getElementById('technical-scores');
  const expressiveScores = document.getElementById('expressive-scores');
  
  frameworkOptions.forEach(option => {
    option.addEventListener('click', () => {
      // Update active framework option
      frameworkOptions.forEach(opt => opt.classList.remove('active'));
      option.classList.add('active');
      
      // Switch scoring framework
      const framework = option.dataset.framework;
      if (framework === 'technical') {
        technicalScores.classList.add('active');
        expressiveScores.classList.remove('active');
      } else {
        expressiveScores.classList.add('active');
        technicalScores.classList.remove('active');
      }
      
      // Reinitialize score dials for the new framework with small delay
      setTimeout(() => {
        setupEmotionSafeScoring();
      }, 50);
    });
  });
}

function setupEmotionSafeScoring() {
  const activeFramework = document.querySelector('.scoring-framework.active');
  if (!activeFramework) return;
  
  const scoreDials = activeFramework.querySelectorAll('.score-dial');
  
  scoreDials.forEach(dial => {
    const dialId = dial.id;
    const scoreType = dialId.replace('-dial', '');
    const hiddenInput = document.getElementById(`${scoreType}-score`);
    const description = document.getElementById(`${scoreType}-desc`);
    const valueDisplay = document.getElementById(`${scoreType}-value`);
    const indicator = document.getElementById(`${scoreType}-indicator`);
    
    // Initialize with default value
    updateImprovedScoreDial(scoreType, 5);
  });
  
  // Setup button controls for all score types - prevent double event binding
  const scoreButtons = activeFramework.querySelectorAll('.score-btn');
  scoreButtons.forEach(button => {
    // Remove any existing listeners to prevent double-triggering
    const newButton = button.cloneNode(true);
    button.parentNode.replaceChild(newButton, button);
    
    newButton.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      const action = newButton.dataset.action;
      const target = newButton.dataset.target;
      const currentScore = parseInt(document.getElementById(`${target}-score`).value);
      
      let newScore = currentScore;
      if (action === 'increase' && currentScore < 10) {
        newScore = currentScore + 1;
      } else if (action === 'decrease' && currentScore > 1) {
        newScore = currentScore - 1;
      }
      
      // Only update if the score actually changed
      if (newScore !== currentScore && newScore >= 1 && newScore <= 10) {
        updateImprovedScoreDial(target, newScore);
        
        // Add visual feedback
        newButton.style.transform = 'scale(0.9)';
        setTimeout(() => {
          newButton.style.transform = '';
        }, 150);
      }
    });
  });
}

function updateImprovedScoreDial(scoreType, score) {
  // Update all related elements
  const hiddenInput = document.getElementById(`${scoreType}-score`);
  const valueDisplay = document.getElementById(`${scoreType}-value`);
  const indicator = document.getElementById(`${scoreType}-indicator`);
  const description = document.getElementById(`${scoreType}-desc`);
  
  if (!hiddenInput || !valueDisplay || !indicator || !description) return;
  
  // Update hidden input
  hiddenInput.value = score;
  
  // Update fixed center display (number stays in place)
  valueDisplay.textContent = score;
  
  // Rotate needle to match score position - properly aligned with color bands
  // Score 1 at 0deg (top), Score 10 at 324deg, each score 36deg apart
  const rotation = (score - 1) * 36; // Score 1=0°, Score 2=36°, Score 3=72°, etc.
  indicator.style.transform = `rotate(${rotation}deg)`;
  
  // Update indicator styling to match color bands
  indicator.className = 'score-indicator';
  if (score >= 1 && score <= 3) {
    indicator.classList.add('low-score');    // Red zone: scores 1-3
  } else if (score >= 4 && score <= 7) {
    indicator.classList.add('medium-score'); // Yellow zone: scores 4-7  
  } else if (score >= 8 && score <= 10) {
    indicator.classList.add('high-score');   // Green zone: scores 8-10
  }
  
  // Update emotion-safe description
  const descriptions = getEmotionSafeDescriptions();
  const descriptionKey = scoreType;
  
  if (descriptions[descriptionKey]) {
    const scoreDescriptions = descriptions[descriptionKey];
    let descText, descClass;
    
    if (score >= 8) {
      descText = scoreDescriptions.excellent;
      descClass = 'excellent';
    } else if (score >= 6) {
      descText = scoreDescriptions.positive;
      descClass = 'positive';
    } else if (score >= 4) {
      descText = scoreDescriptions.neutral;
      descClass = '';
    } else if (score >= 2) {
      descText = scoreDescriptions.needsGrowth;
      descClass = 'needs-growth';
    } else {
      descText = scoreDescriptions.challenging;
      descClass = 'challenging';
    }
    
    description.textContent = descText;
    description.className = `score-description ${descClass}`;
  }
  
  // Add tooltip for clarity
  const dial = document.getElementById(`${scoreType}-dial`);
  if (dial) {
    dial.title = `Score: ${score}/10 - Use +/- buttons to adjust`;
  }
}

function getEmotionSafeDescriptions() {
  return {
    'composition': {
      excellent: 'Masterfully arranged',
      positive: 'Well balanced',
      neutral: 'Functional layout',
      needsGrowth: 'Room to explore balance',
      challenging: 'Could benefit from restructuring'
    },
    'technique': {
      excellent: 'Exceptional skill',
      positive: 'Strong execution',
      neutral: 'Solid foundation',
      needsGrowth: 'Developing technique',
      challenging: 'Focus on fundamentals'
    },
    'originality': {
      excellent: 'Groundbreaking approach',
      positive: 'Fresh perspective',
      neutral: 'Personal touch',
      needsGrowth: 'Explore your voice',
      challenging: 'Push creative boundaries'
    },
    'impact': {
      excellent: 'Deeply moving',
      positive: 'Makes an impression',
      neutral: 'Pleasant to view',
      needsGrowth: 'Building presence',
      challenging: 'Strengthen visual impact'
    },
    'emotion': {
      excellent: 'Deeply resonant',
      positive: 'Evokes feeling',
      neutral: 'Emotionally present',
      needsGrowth: 'Developing emotional depth',
      challenging: 'Explore emotional expression'
    },
    'storytelling': {
      excellent: 'Compelling narrative',
      positive: 'Clear communication',
      neutral: 'Tells a story',
      needsGrowth: 'Strengthen narrative',
      challenging: 'Focus on story clarity'
    },
    'atmosphere': {
      excellent: 'Immersive world',
      positive: 'Creates mood',
      neutral: 'Atmospheric quality',
      needsGrowth: 'Building atmosphere',
      challenging: 'Enhance mood creation'
    },
    'connection': {
      excellent: 'Deeply personal',
      positive: 'Speaks to me',
      neutral: 'Relatable content',
      needsGrowth: 'Building connection',
      challenging: 'Seek universal themes'
    }
  };
}

function setupGuidedFeedback() {
  const feedbackTextareas = document.querySelectorAll('.feedback-required');
  
  feedbackTextareas.forEach(textarea => {
    const type = textarea.dataset.type;
    const statusElement = document.getElementById(`${type}-status`);
    
    textarea.addEventListener('input', () => {
      const hasContent = textarea.value.trim().length >= 10; // Minimum 10 characters
      
      if (hasContent) {
        textarea.classList.add('completed');
        statusElement.classList.add('completed');
        statusElement.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i> <small>Great insight!</small>';
        
        // Update progress indicator
        const indicator = document.getElementById(`${type}-indicator`);
        if (indicator) {
          indicator.classList.add('completed');
          indicator.innerHTML = '<i class="bi bi-check-circle-fill"></i> <span>' + 
            (type === 'positive' ? 'Positive insight' : 'Constructive feedback') + '</span>';
        }
      } else {
        textarea.classList.remove('completed');
        statusElement.classList.remove('completed');
        const promptText = type === 'positive' ? 
          'Add at least one positive observation' : 
          'Add at least one constructive suggestion';
        statusElement.innerHTML = '<i class="bi bi-circle text-muted"></i> <small>' + promptText + '</small>';
        
        // Update progress indicator
        const indicator = document.getElementById(`${type}-indicator`);
        if (indicator) {
          indicator.classList.remove('completed');
          indicator.innerHTML = '<i class="bi bi-circle"></i> <span>' + 
            (type === 'positive' ? 'Positive insight' : 'Constructive feedback') + '</span>';
        }
      }
      
      // Check overall completion
      validateSubmissionReadiness();
    });
  });
}

function setupGamifiedValidation() {
  const submitButton = document.getElementById('submit-detailed-btn');
  
  // Add click handler for submission
  submitButton.addEventListener('click', () => {
    if (submitButton.disabled) return;
    
    submitDetailedCritique();
  });
}

function validateSubmissionReadiness() {
  const positiveText = document.getElementById('positive-feedback').value.trim();
  const constructiveText = document.getElementById('constructive-feedback').value.trim();
  const submitButton = document.getElementById('submit-detailed-btn');
  
  const hasPositive = positiveText.length >= 10;
  const hasConstructive = constructiveText.length >= 10;
  const isReady = hasPositive && hasConstructive;
  
  submitButton.disabled = !isReady;
  
  if (isReady) {
    submitButton.innerHTML = '<i class="bi bi-send"></i> Submit Detailed Critique';
    submitButton.classList.remove('btn-outline-primary');
    submitButton.classList.add('btn-primary');
  } else {
    submitButton.innerHTML = '<i class="bi bi-lock"></i> Complete Required Fields';
    submitButton.classList.remove('btn-primary');
    submitButton.classList.add('btn-outline-primary');
  }
}

async function submitDetailedCritique() {
  const submitButton = document.getElementById('submit-detailed-btn');
  const originalText = submitButton.innerHTML;
  
  // Show loading state
  submitButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Submitting...';
  submitButton.disabled = true;
  
  try {
    // Gather all form data
    const activeFramework = document.querySelector('.framework-option.active').dataset.framework;
    const scoringFramework = document.querySelector('.scoring-framework.active');
    const scores = {};
    
    // Collect scores from active framework
    const scoreInputs = scoringFramework.querySelectorAll('input[type="range"]');
    scoreInputs.forEach(input => {
      const scoreType = input.id.replace('-score', '');
      scores[scoreType] = parseInt(input.value);
    });
    
    // Gather feedback text
    const positiveText = document.getElementById('positive-feedback').value.trim();
    const constructiveText = document.getElementById('constructive-feedback').value.trim();
    const overallText = document.getElementById('overall-feedback').value.trim();
    
    // Combine feedback into structured text
    let critiqueText = `**What stood out:**\n${positiveText}`;
    critiqueText += `\n\n**Areas for improvement:**\n${constructiveText}`;
    if (overallText) {
      critiqueText += `\n\n**Overall impression:**\n${overallText}`;
    }
    critiqueText += `\n\n*Critique framework: ${activeFramework}*`;
    
    const artworkId = document.querySelector('.artwork-display').dataset.artworkId;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');
    
    // Submit to API
    const response = await fetch(`/api/artworks/${artworkId}/add_critique/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,
      },
      credentials: 'same-origin',
      body: JSON.stringify({
        text: critiqueText,
        composition_score: scores.composition || null,
        technique_score: scores.technique || null,
        originality_score: scores.originality || null,
        framework: activeFramework,
        detailed_scores: scores
      })
    });
    
    if (response.ok) {
      // Success state
      submitButton.innerHTML = '<i class="bi bi-check-circle-fill"></i> Submitted!';
      submitButton.classList.remove('btn-primary');
      submitButton.classList.add('btn-success');
      
      // Reset after delay and move to next artwork
      setTimeout(() => {
        loadNextArtwork();
      }, 2000);
    } else {
      throw new Error(`HTTP ${response.status}`);
    }
    
  } catch (error) {
    console.error('Error submitting detailed critique:', error);
    
    // Error state
    submitButton.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Error - Try Again';
    submitButton.classList.remove('btn-primary');
    submitButton.classList.add('btn-danger');
    
    // Reset after delay
    setTimeout(() => {
      submitButton.innerHTML = originalText;
      submitButton.classList.remove('btn-danger');
      submitButton.classList.add('btn-primary');
      submitButton.disabled = false;
    }, 3000);
  }
}

function addBackToSelectionButton() {
  const backButtons = document.querySelectorAll('.back-to-selection');
  
  backButtons.forEach(button => {
    // Remove existing event listeners to avoid duplicates
    const newButton = button.cloneNode(true);
    button.parentNode.replaceChild(newButton, button);
    
    newButton.addEventListener('click', () => {
      // Show entry point selection
      document.getElementById('entry-point-selection').style.display = 'block';
      document.querySelector('.critique-interface').style.display = 'none';
      
      // Hide quick feedback header
      const quickHeader = document.querySelector('.quick-feedback-header');
      if (quickHeader) {
        quickHeader.style.display = 'none';
      }
      
      // Clean up any detailed form
      const detailedForm = document.querySelector('.detailed-critique-form');
      if (detailedForm) {
        detailedForm.remove();
      }
    });
  });
}

function incrementUsageCount() {
  const currentCount = parseInt(localStorage.getItem('brushup_usage_count') || '0');
  localStorage.setItem('brushup_usage_count', (currentCount + 1).toString());
}
</script>

{% endblock %}
