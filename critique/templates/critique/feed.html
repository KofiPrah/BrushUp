{% extends "critique/base.html" %}
{% load static %}

{% block title %}Critique Feed - BrushUp{% endblock %}

{% block extra_head %}
<style>
  /* --- Desktop look & feel --- */
  @media (min-width: 992px){
    body{ background: linear-gradient(135deg,#2c3e50 0%,#34495e 100%); color:#fff; }
    #quickbar{ display:none !important; } /* hide bottom bar on desktop */
  }
  #feed-container{ max-width:800px; margin:0 auto; padding:20px; }
  .single-layout{ display:flex; flex-direction:column; gap:20px; }
  
  .artwork-display{ 
    border-radius:16px; overflow:hidden; box-shadow:0 12px 48px rgba(0,0,0,.35); 
    background:#111; margin-bottom:20px; display:flex; justify-content:center; align-items:center;
  }
  .artwork-display .ratio-artwork{ position:relative; display:flex; justify-content:center; align-items:center; }
  .artwork-display img{ 
    max-width:100%; max-height:80vh; width:auto; height:auto; 
    object-fit:contain; display:block; border-radius:8px;
  }

  .critique-interface{ 
    background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.12); 
    border-radius:16px; padding:24px; backdrop-filter:blur(10px); 
  }
  .critique-columns{ display:grid; grid-template-columns:1fr 1fr; gap:24px; }
  .critique-column h6{ color:#bdc3c7; font-size:.9rem; text-transform:uppercase; margin-bottom:12px; }

  /* Chips (collapse with Show more) */
  .chips-wrap{ display:flex; flex-wrap:wrap; gap:8px; max-height:200px; overflow:hidden; position:relative; }
  .chips-wrap.is-expanded{ max-height:none; }
  .chips-fade{ position:absolute; left:0; right:0; bottom:0; height:48px; background:linear-gradient(to bottom,rgba(0,0,0,0),rgba(255,255,255,.05)); pointer-events:none; }
  .more-chips{ margin-top:8px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.2); color:#bdc3c7; padding:6px 12px; border-radius:12px; font-size:.8rem; }

  .tag-chip{ background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.25); color:#ecf0f1; padding:6px 12px; border-radius:16px; font-size:.82rem; cursor:pointer; }
  .tag-chip.selected{ background:#3498db; border-color:#2980b9; color:#fff; }
  .pro-chip.selected{ background:#27ae60; border-color:#219a52; }
  .con-chip.selected{ background:#e67e22; border-color:#c86b17; }

  .feedback-section {
    grid-column: 1 / -1;
    margin-top: 16px;
  }

  .action-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-top: 20px;
  }

  /* Mobile container */
  @media (max-width: 991px){
    #feed-container{ padding:0 15px 120px; }
    .critique-columns{ grid-template-columns:1fr; gap:16px; }
    body{ background:#f8f9fa; color:#333; }
    .artwork-display{ 
      background:#fff; box-shadow:0 6px 24px rgba(0,0,0,.1); 
      display:flex; justify-content:center; align-items:center;
    }
    .artwork-display img{ 
      max-width:100%; max-height:70vh; width:auto; height:auto; 
      object-fit:contain; border-radius:8px;
    }
    .critique-interface{ background:#fff; border:1px solid #e0e0e0; }
  }

  /* Quickbar (mobile) */
  #quickbar{
    position:fixed; left:0; right:0; bottom:0; z-index:1000;
    backdrop-filter:blur(10px); background:rgba(33,37,41,.95);
    border-top:1px solid rgba(255,255,255,.1); max-height:40vh; overflow-y:auto;
    padding:15px;
  }
  .chip-row{ max-height:120px; overflow-x:auto; overflow-y:hidden; }
</style>
{% endblock %}

{% block content %}

<!-- Single Artwork Layout -->
<div id="feed-container" class="single-layout">
  <!-- Artwork Display -->
  <section id="artwork-section" class="artwork-section">
    <div class="artwork-display" data-artwork-id="">
      <div class="ratio-artwork">
        <img id="artwork-img" alt="Featured artwork" style="display:none;">
        <div class="loading-placeholder" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#bdc3c7;">
          <div class="spinner-border spinner-border-sm me-2" role="status"></div> Loading artwork...
        </div>
      </div>
      <div class="card-body p-3">
        <h5 id="artwork-title" class="card-title mb-2"></h5>
        <p id="artwork-caption" class="card-text text-muted small"></p>
        <div id="artwork-meta" class="d-flex justify-content-between align-items-center text-muted small">
          <span id="artwork-medium"></span>
          <span id="artwork-date"></span>
        </div>
      </div>
    </div>
  </section>

  <!-- Critique Interface -->
  <section class="critique-section">
    <div class="critique-interface">
      <div class="critique-columns">
        <div class="critique-column">
          <h6>Strengths</h6>
          <div id="pro-tags" class="chips-wrap"></div>
          <div class="chips-fade"></div>
          <button id="pro-more" class="more-chips" style="display:none;">Show more</button>
        </div>
        <div class="critique-column">
          <h6>Opportunities</h6>
          <div id="con-tags" class="chips-wrap"></div>
          <div class="chips-fade"></div>
          <button id="con-more" class="more-chips" style="display:none;">Show more</button>
        </div>
        <div class="feedback-section">
          <h6>Your Feedback</h6>
          <textarea id="general-feedback" class="form-control mb-3" rows="4" placeholder="Share your thoughts about this artwork..."></textarea>
          <div class="action-buttons">
            <button id="submit-btn" class="btn btn-primary">Submit Feedback</button>
            <button id="skip-btn" class="btn btn-outline-secondary">Skip</button>
            <button id="next-btn" class="btn btn-outline-success" disabled>Next Artwork →</button>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Mobile Quickbar -->
<div id="quickbar" class="d-lg-none">
  <div class="row chip-row mb-3">
    <div class="col-6">
      <h6 class="small text-muted mb-2">Strengths</h6>
      <div id="pro-tags-mobile" class="d-flex flex-wrap gap-2"></div>
    </div>
    <div class="col-6">
      <h6 class="small text-muted mb-2">Opportunities</h6>
      <div id="con-tags-mobile" class="d-flex flex-wrap gap-2"></div>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <textarea id="general-feedback-mobile" class="form-control mb-2" rows="3" placeholder="Share your thoughts..."></textarea>
      <div class="d-flex gap-2">
        <button id="mobile-submit-btn" class="btn btn-primary btn-sm">Submit</button>
        <button id="mobile-skip-btn" class="btn btn-outline-secondary btn-sm">Skip</button>
        <button id="mobile-next-btn" class="btn btn-outline-success btn-sm ms-auto" disabled>Next →</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Load feed data and initialize interface
  loadFeedData();
  initializeFeedInterface();
});

function loadFeedData() {
  // Fetch single artwork for critique
  fetch('/api/feed/single/')
    .then(response => response.json())
    .then(data => {
      if (data.artwork) {
        displayArtwork(data.artwork);
      } else {
        console.error('No artwork available for feed');
        showNoArtworkMessage();
      }
    })
    .catch(error => {
      console.error('Error loading feed data:', error);
      // Fallback to artwork list API if single endpoint doesn't exist yet
      fetch('/api/artworks/')
        .then(response => response.json())
        .then(data => {
          if (data.results && data.results.length > 0) {
            // Pick a random artwork from the results
            const randomArtwork = data.results[Math.floor(Math.random() * data.results.length)];
            displayArtwork(randomArtwork);
          } else {
            showNoArtworkMessage();
          }
        })
        .catch(fallbackError => {
          console.error('Fallback API also failed:', fallbackError);
          showNoArtworkMessage();
        });
    });
}

function displayArtwork(artwork) {
  // Display the artwork
  const artworkImg = document.getElementById('artwork-img');
  const imageUrl = artwork.image_display_url || artwork.image_url || artwork.image;
  
  if (imageUrl) {
    artworkImg.src = imageUrl;
    artworkImg.style.display = 'block';
    
    // Handle image load errors
    artworkImg.onerror = function() {
      this.style.display = 'none';
      const placeholder = document.querySelector('.loading-placeholder');
      placeholder.innerHTML = '<div class="text-center text-muted"><i class="bi bi-image" style="font-size: 3rem;"></i><br>Image not available</div>';
      placeholder.style.display = 'flex';
    };
  } else {
    // No image available
    const placeholder = document.querySelector('.loading-placeholder');
    placeholder.innerHTML = '<div class="text-center text-muted"><i class="bi bi-image" style="font-size: 3rem;"></i><br>No image available</div>';
    placeholder.style.display = 'flex';
  }
  
  document.getElementById('artwork-title').textContent = artwork.title || 'Untitled';
  document.getElementById('artwork-caption').textContent = artwork.description || 'No description available';
  document.getElementById('artwork-medium').textContent = artwork.medium || 'Mixed Media';
  
  const createdDate = artwork.created_at ? new Date(artwork.created_at).toLocaleDateString() : 'Recently';
  document.getElementById('artwork-date').textContent = createdDate;
  
  // Store artwork ID for critique submission
  document.querySelector('.artwork-display').dataset.artworkId = artwork.id || '';

  // Hide loading placeholders if image loads successfully
  if (imageUrl) {
    document.querySelectorAll('.loading-placeholder').forEach(el => el.style.display = 'none');
  }
}

function showNoArtworkMessage() {
  document.querySelector('.loading-placeholder').innerHTML = 
    '<div class="text-center"><i class="bi bi-palette2"></i><br>No artworks available for critique right now.<br><small>Check back later!</small></div>';
}

function initializeFeedInterface() {
  // Initialize critique tag selections
  loadCritiqueTags();
  
  // Bind event handlers
  document.getElementById('submit-btn').addEventListener('click', submitCritique);
  document.getElementById('skip-btn').addEventListener('click', skipArtwork);
  document.getElementById('next-btn').addEventListener('click', loadNextArtwork);
  
  // Mobile handlers
  document.getElementById('mobile-submit-btn').addEventListener('click', submitCritique);
  document.getElementById('mobile-skip-btn').addEventListener('click', skipArtwork);
  document.getElementById('mobile-next-btn').addEventListener('click', loadNextArtwork);
}

function loadCritiqueTags() {
  // Sample critique tags
  const proTags = ['Strong composition', 'Great use of color', 'Excellent technique', 'Creative concept', 'Good lighting', 'Nice details'];
  const conTags = ['Could improve composition', 'Color balance needs work', 'Technique could be refined', 'Needs more contrast', 'Background distracting'];
  
  populateTags('pro-tags', proTags, 'pro-chip');
  populateTags('con-tags', conTags, 'con-chip');
  populateTags('pro-tags-mobile', proTags, 'pro-chip');
  populateTags('con-tags-mobile', conTags, 'con-chip');
}

function populateTags(containerId, tags, chipClass) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  
  tags.forEach(tag => {
    const chip = document.createElement('span');
    chip.className = `tag-chip ${chipClass}`;
    chip.textContent = tag;
    chip.addEventListener('click', () => chip.classList.toggle('selected'));
    container.appendChild(chip);
  });
}

function submitCritique() {
  const feedback = document.getElementById('general-feedback').value || document.getElementById('general-feedback-mobile').value;
  const selectedProTags = getSelectedTags('pro-chip');
  const selectedConTags = getSelectedTags('con-chip');
  
  if (!feedback.trim() && selectedProTags.length === 0 && selectedConTags.length === 0) {
    alert('Please provide some feedback or select tags before submitting.');
    return;
  }
  
  const artworkId = document.querySelector('.artwork-display').dataset.artworkId;
  
  // Submit critique data
  const critiqueData = {
    artwork_id: artworkId,
    feedback: feedback.trim(),
    pro_tags: selectedProTags,
    con_tags: selectedConTags
  };
  
  console.log('Submitting critique:', critiqueData);
  
  // Show success message
  const submitBtn = document.getElementById('submit-btn');
  const mobileSubmitBtn = document.getElementById('mobile-submit-btn');
  
  submitBtn.textContent = 'Submitted!';
  submitBtn.disabled = true;
  mobileSubmitBtn.textContent = 'Submitted!';
  mobileSubmitBtn.disabled = true;
  
  // Enable next button
  document.getElementById('next-btn').disabled = false;
  document.getElementById('mobile-next-btn').disabled = false;
  
  setTimeout(() => {
    submitBtn.textContent = 'Submit Feedback';
    submitBtn.disabled = false;
    mobileSubmitBtn.textContent = 'Submit';
    mobileSubmitBtn.disabled = false;
  }, 2000);
}

function getSelectedTags(chipClass) {
  return Array.from(document.querySelectorAll(`.${chipClass}.selected`))
    .map(chip => chip.textContent);
}

function skipArtwork() {
  // Enable next button and move to next artwork
  document.getElementById('next-btn').disabled = false;
  document.getElementById('mobile-next-btn').disabled = false;
  loadNextArtwork();
}

function loadNextArtwork() {
  // Reset form
  const feedbackField = document.getElementById('general-feedback');
  const mobileFeedbackField = document.getElementById('general-feedback-mobile');
  
  if (feedbackField) feedbackField.value = '';
  if (mobileFeedbackField) mobileFeedbackField.value = '';
  
  document.querySelectorAll('.tag-chip.selected').forEach(chip => chip.classList.remove('selected'));
  
  // Disable next button
  document.getElementById('next-btn').disabled = true;
  document.getElementById('mobile-next-btn').disabled = true;
  
  // Show loading state
  document.getElementById('artwork-img').style.display = 'none';
  document.querySelectorAll('.loading-placeholder').forEach(el => {
    el.style.display = 'flex';
    el.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div> Loading next artwork...';
  });
  
  // Load new artwork
  loadFeedData();
}
</script>

{% endblock %}
