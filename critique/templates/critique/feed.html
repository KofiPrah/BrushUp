{% extends "critique/base.html" %}
{% load static %}

{% block title %}Critique Feed - BrushUp{% endblock %}

{% block extra_head %}
<style>
  /* --- Desktop look & feel --- */
  @media (min-width: 992px){
    body{ background: linear-gradient(135deg,#2c3e50 0%,#34495e 100%); color:#fff; }
    #quickbar{ display:none !important; } /* hide bottom bar on desktop */
  }
  #feed-container{ max-width:800px; margin:0 auto; padding:20px; }
  .single-layout{ display:flex; flex-direction:column; gap:20px; }
  
  .artwork-display{ 
    border-radius:16px; overflow:hidden; box-shadow:0 12px 48px rgba(0,0,0,.35); 
    background:#111; display:flex; justify-content:center; align-items:center;
  }
  .artwork-display .ratio-artwork{ 
    position:relative; display:flex; justify-content:center; align-items:center; 
    min-height:500px; transition:min-height 0.3s ease-out; width:100%;
  }
  .artwork-display .ratio-artwork.has-image{ 
    min-height:auto;
  }
  
  .artwork-info {
    background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.12); 
    border-radius:16px; margin-top:20px; backdrop-filter:blur(10px);
  }
  .artwork-display img{ 
    max-width:100%; max-height:80vh; width:auto; height:auto; 
    object-fit:contain; display:block; border-radius:8px;
    opacity:0; transition:opacity 0.6s ease-in-out, transform 0.6s ease-in-out;
    transform:scale(0.98);
  }
  .artwork-display img.loaded{ 
    opacity:1; transform:scale(1);
  }

  .critique-interface{ 
    background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.12); 
    border-radius:16px; padding:24px; backdrop-filter:blur(10px); 
  }
  .critique-columns{ display:grid; grid-template-columns:1fr 1fr; gap:20px; }
  .critique-column h6{ color:#bdc3c7; font-size:.9rem; text-transform:uppercase; margin-bottom:8px; }
  
  .tag-section-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  .tag-search-container{ position:relative; }
  .tag-suggestions{ 
    position:absolute; top:100%; left:0; right:0; z-index:10; 
    background:#fff; border:1px solid #ddd; border-radius:4px; 
    max-height:150px; overflow-y:auto; display:none;
  }
  .tag-suggestions.show{ display:block; }
  .suggestion-item{ 
    padding:8px 12px; cursor:pointer; border-bottom:1px solid #eee; 
    font-size:0.85rem; color:#333;
  }
  .suggestion-item:hover{ background:#f8f9fa; }
  .suggestion-item:last-child{ border-bottom:none; }

  /* Chips */
  .chips-wrap{ display:flex; flex-wrap:wrap; gap:8px; max-height:180px; overflow-y:auto; margin-bottom:8px; }
  .tag-chip{ 
    background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.25); 
    color:#ecf0f1; padding:6px 12px; border-radius:16px; font-size:.82rem; 
    cursor:pointer; transition:all 0.2s ease; user-select:none; position:relative;
  }
  .tag-chip:hover{ background:rgba(255,255,255,.2); }
  .tag-chip.selected{ background:#3498db; border-color:#2980b9; color:#fff; }
  .pro-chip.selected{ background:#27ae60; border-color:#219a52; }
  .con-chip.selected{ background:#e67e22; border-color:#c86b17; }
  .tag-chip.disabled{ opacity:0.5; cursor:not-allowed; }
  .tag-chip.custom-tag{ 
    background:rgba(52, 152, 219, 0.2); border-color:#3498db;
    position:relative;
  }
  .tag-chip.custom-tag:before{
    content:'âœ¨'; position:absolute; left:-2px; top:-2px;
    font-size:0.7rem; opacity:0.7;
  }
  
  .selected-count{ text-align:center; margin-top:5px; }
  
  /* Category System */
  .category-toggle{ text-align:center; }
  .tag-categories{ max-height:300px; overflow-y:auto; }
  .category-group{ margin-bottom:12px; }
  .category-header{ 
    display:flex; align-items:center; gap:6px; padding:8px 12px; 
    background:rgba(255,255,255,.08); border-radius:8px; cursor:pointer;
    transition:all 0.2s ease; user-select:none; font-size:0.85rem;
  }
  .category-header:hover{ background:rgba(255,255,255,.12); }
  .category-header.expanded{ background:rgba(255,255,255,.15); }
  .category-header.expanded .category-icon{ transform:rotate(90deg); }
  .category-icon{ transition:transform 0.2s ease; font-size:0.75rem; }
  .category-count{ margin-left:auto; opacity:0.7; }
  .category-content{ 
    display:none; padding:8px 16px; 
    border-left:2px solid rgba(255,255,255,.1); margin-left:8px; margin-top:6px;
  }
  .category-content.expanded{ display:block; }
  .category-content .chips-wrap{ max-height:120px; margin-bottom:0; }
  
  /* Tab System */
  .tag-tabs{ display:flex; gap:8px; justify-content:center; }
  .tab-button{ 
    padding:10px 16px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.2); 
    border-radius:8px; color:#bdc3c7; cursor:pointer; transition:all 0.2s ease;
    display:flex; align-items:center; gap:6px; font-size:0.9rem;
  }
  .tab-button:hover{ background:rgba(255,255,255,.12); }
  .tab-button.active{ background:#3498db; border-color:#2980b9; color:#fff; }
  .tab-button .badge{ font-size:0.75rem; margin-left:4px; }
  
  .tab-content{ display:none; }
  .tab-content.active{ display:block; }
  
  /* Selected Tags Summary */
  .selected-tags-column{ 
    background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.1); 
    border-radius:12px; padding:16px; min-height:300px;
  }
  .selected-tags-column h6{ 
    color:#bdc3c7; font-size:0.9rem; text-transform:uppercase; 
    margin-bottom:16px; display:flex; align-items:center; gap:6px;
  }
  
  .selected-group{ margin-bottom:20px; }
  .selected-group-header{ 
    display:flex; align-items:center; gap:8px; margin-bottom:8px; 
    font-size:0.85rem; font-weight:600; color:#ecf0f1;
  }
  .group-icon{ 
    width:20px; height:20px; border-radius:50%; display:flex; 
    align-items:center; justify-content:center; font-size:0.7rem; color:#fff;
  }
  
  .selected-tags-list{ min-height:40px; }
  .selected-tag-item{ 
    display:inline-block; padding:4px 8px; margin:2px; 
    background:rgba(255,255,255,.1); border-radius:12px; 
    font-size:0.75rem; color:#ecf0f1; position:relative;
  }
  .selected-tag-item.strength{ background:rgba(39, 174, 96, 0.2); border:1px solid #27ae60; }
  .selected-tag-item.opportunity{ background:rgba(230, 126, 34, 0.2); border:1px solid #e67e22; }
  .selected-tag-item .remove-tag{ 
    margin-left:4px; cursor:pointer; opacity:0.7; 
    font-size:0.7rem; font-weight:bold;
  }
  .selected-tag-item .remove-tag:hover{ opacity:1; }
  
  .selection-stats{ text-align:center; padding-top:12px; border-top:1px solid rgba(255,255,255,.1); }

  .feedback-section {
    grid-column: 1 / -1;
    margin-top: 16px;
  }

  .action-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-top: 20px;
  }

  /* Mobile container */
  @media (max-width: 991px){
    #feed-container{ padding:0 15px 120px; }
    .critique-columns{ grid-template-columns:1fr; gap:16px; }
    body{ background:#f8f9fa; color:#333; }
    .artwork-display{ 
      background:#fff; box-shadow:0 6px 24px rgba(0,0,0,.1); 
      display:flex; justify-content:center; align-items:center;
    }
    .artwork-display .ratio-artwork{ 
      position:relative; display:flex; justify-content:center; align-items:center; 
      min-height:400px; transition:min-height 0.3s ease-out; width:100%;
    }
    .artwork-display .ratio-artwork.has-image{ 
      min-height:auto;
    }
    
    .artwork-info {
      background:#fff; border:1px solid #e0e0e0; 
      border-radius:16px; margin-top:20px; box-shadow:0 2px 12px rgba(0,0,0,.05);
    }
    .artwork-display img{ 
      max-width:100%; max-height:70vh; width:auto; height:auto; 
      object-fit:contain; border-radius:8px;
      opacity:0; transition:opacity 0.6s ease-in-out, transform 0.6s ease-in-out;
      transform:scale(0.98);
    }
    .artwork-display img.loaded{ 
      opacity:1; transform:scale(1);
    }
    .critique-interface{ background:#fff; border:1px solid #e0e0e0; }
  }

  /* Quickbar (mobile) */
  #quickbar{
    position:fixed; left:0; right:0; bottom:0; z-index:1000;
    backdrop-filter:blur(10px); background:rgba(33,37,41,.95);
    border-top:1px solid rgba(255,255,255,.1); max-height:40vh; overflow-y:auto;
    padding:15px;
  }
  .chip-row{ max-height:120px; overflow-x:auto; overflow-y:hidden; }
  
  /* Loading placeholder animations */
  .loading-placeholder {
    transition: opacity 0.4s ease-out;
    width: 100%; height: 100%;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  
  /* Enhanced spinner animation */
  .spinner-border {
    animation: spinner-grow 1.2s ease-in-out infinite;
  }
  
  @keyframes spinner-grow {
    0%, 100% { transform: scale(1); opacity: 0.8; }
    50% { transform: scale(1.1); opacity: 1; }
  }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}

<!-- Single Artwork Layout -->
<div id="feed-container" class="single-layout">
  <!-- Artwork Display -->
  <section id="artwork-section" class="artwork-section">
    <div class="artwork-display" data-artwork-id="">
      <div class="ratio-artwork">
        <img id="artwork-img" alt="Featured artwork" style="display:none;">
        <div class="loading-placeholder" style="position:absolute;inset:0;color:#bdc3c7;">
          <div class="spinner-border spinner-border-sm me-2" role="status"></div> Loading artwork...
        </div>
      </div>
    </div>
    
    <!-- Artwork Info - Separate from image container -->
    <div class="artwork-info">
      <div class="card-body p-3">
        <h5 id="artwork-title" class="card-title mb-2"></h5>
        <p id="artwork-caption" class="card-text text-muted small"></p>
        <div id="artwork-meta" class="d-flex justify-content-between align-items-center text-muted small">
          <span id="artwork-medium"></span>
          <span id="artwork-date"></span>
        </div>
      </div>
    </div>
  </section>

  <!-- Critique Interface -->
  <section class="critique-section">
    <div class="critique-interface">
      <!-- Tab Navigation -->
      <div class="tag-tabs mb-3">
        <button id="strengths-tab" class="tab-button active" data-tab="strengths">
          <i class="bi bi-hand-thumbs-up"></i> Strengths <span id="strengths-badge" class="badge bg-success">0</span>
        </button>
        <button id="opportunities-tab" class="tab-button" data-tab="opportunities">
          <i class="bi bi-lightbulb"></i> Opportunities <span id="opportunities-badge" class="badge bg-warning">0</span>
        </button>
      </div>

      <div class="critique-columns">
        <!-- Strengths Tab Content -->
        <div id="strengths-content" class="tab-content active">
          <div class="critique-column">
            <div class="tag-section-header">
              <h6>Strengths</h6>
              <button id="refresh-pro-tags" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-clockwise"></i>
              </button>
            </div>
            <div class="tag-search-container mb-2">
              <input type="text" id="pro-search" class="form-control form-control-sm" placeholder="Search strength tags...">
              <div id="pro-suggestions" class="tag-suggestions"></div>
            </div>
            
            <!-- Category Toggle -->
            <div class="category-toggle mb-2">
              <button id="toggle-pro-categories" class="btn btn-sm btn-outline-light">
                <i class="bi bi-collection"></i> Browse by Category
              </button>
            </div>
            
            <!-- Random Tags (Default View) -->
            <div id="pro-tags" class="chips-wrap"></div>
            
            <!-- Categorized Tags (Expandable View) -->
            <div id="pro-categories" class="tag-categories" style="display:none;">
              <div class="category-group">
                <div class="category-header" data-category="technique-pro">
                  <i class="bi bi-chevron-right category-icon"></i>
                  <span>Technique</span>
                  <small class="category-count">(8)</small>
                </div>
                <div class="category-content" id="technique-pro-tags"></div>
              </div>
              
              <div class="category-group">
                <div class="category-header" data-category="color-pro">
                  <i class="bi bi-chevron-right category-icon"></i>
                  <span>Color</span>
                  <small class="category-count">(8)</small>
                </div>
                <div class="category-content" id="color-pro-tags"></div>
              </div>
              
              <div class="category-group">
                <div class="category-header" data-category="lighting-pro">
                  <i class="bi bi-chevron-right category-icon"></i>
                  <span>Lighting & Mood</span>
                  <small class="category-count">(8)</small>
                </div>
                <div class="category-content" id="lighting-pro-tags"></div>
              </div>
              
              <div class="category-group">
                <div class="category-header" data-category="creativity-pro">
                  <i class="bi bi-chevron-right category-icon"></i>
                  <span>Creativity</span>
                  <small class="category-count">(8)</small>
                </div>
                <div class="category-content" id="creativity-pro-tags"></div>
              </div>
              
              <div class="category-group">
                <div class="category-header" data-category="impact-pro">
                  <i class="bi bi-chevron-right category-icon"></i>
                  <span>Overall Impact</span>
                  <small class="category-count">(8)</small>
                </div>
                <div class="category-content" id="impact-pro-tags"></div>
              </div>
            </div>
            
            <div class="selected-count">
              <small class="text-muted"><span id="pro-count">0</span>/5 selected</small>
            </div>
          </div>
        </div>

        <!-- Opportunities Tab Content -->
        <div id="opportunities-content" class="tab-content">
          <div class="critique-column">
            <div class="tag-section-header">
              <h6>Opportunities for Improvement</h6>
              <button id="refresh-con-tags" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-clockwise"></i>
              </button>
            </div>
            <div class="tag-search-container mb-2">
              <input type="text" id="con-search" class="form-control form-control-sm" placeholder="Search opportunity tags...">
              <div id="con-suggestions" class="tag-suggestions"></div>
            </div>
            
            <!-- Category Toggle -->
            <div class="category-toggle mb-2">
              <button id="toggle-con-categories" class="btn btn-sm btn-outline-light">
                <i class="bi bi-collection"></i> Browse by Category
              </button>
            </div>
            
            <!-- Random Tags (Default View) -->
            <div id="con-tags" class="chips-wrap"></div>
            
            <!-- Categorized Tags (Expandable View) -->
            <div id="con-categories" class="tag-categories" style="display:none;">
              <div class="category-group">
                <div class="category-header" data-category="composition-con">
                  <i class="bi bi-chevron-right category-icon"></i>
                  <span>Composition</span>
                  <small class="category-count">(7)</small>
                </div>
                <div class="category-content" id="composition-con-tags"></div>
              </div>
              
              <div class="category-group">
                <div class="category-header" data-category="technical-con">
                  <i class="bi bi-chevron-right category-icon"></i>
                  <span>Technical Areas</span>
                  <small class="category-count">(6)</small>
                </div>
                <div class="category-content" id="technical-con-tags"></div>
              </div>
              
              <div class="category-group">
                <div class="category-header" data-category="color-con">
                  <i class="bi bi-chevron-right category-icon"></i>
                  <span>Color Issues</span>
                  <small class="category-count">(7)</small>
                </div>
                <div class="category-content" id="color-con-tags"></div>
              </div>
              
              <div class="category-group">
                <div class="category-header" data-category="lighting-con">
                  <i class="bi bi-chevron-right category-icon"></i>
                  <span>Lighting Problems</span>
                  <small class="category-count">(7)</small>
                </div>
                <div class="category-content" id="lighting-con-tags"></div>
              </div>
              
              <div class="category-group">
                <div class="category-header" data-category="environment-con">
                  <i class="bi bi-chevron-right category-icon"></i>
                  <span>Background & Environment</span>
                  <small class="category-count">(5)</small>
                </div>
                <div class="category-content" id="environment-con-tags"></div>
              </div>
              
              <div class="category-group">
                <div class="category-header" data-category="polish-con">
                  <i class="bi bi-chevron-right category-icon"></i>
                  <span>Overall Polish</span>
                  <small class="category-count">(7)</small>
                </div>
                <div class="category-content" id="polish-con-tags"></div>
              </div>
            </div>
            
            <div class="selected-count">
              <small class="text-muted"><span id="con-count">0</span>/5 selected</small>
            </div>
          </div>
        </div>

        <!-- Selected Tags Summary Column -->
        <div class="selected-tags-column">
          <h6><i class="bi bi-check2-circle"></i> Your Selected Tags</h6>
          
          <div class="selected-summary">
            <div class="selected-group">
              <div class="selected-group-header">
                <span class="group-icon bg-success"><i class="bi bi-hand-thumbs-up"></i></span>
                <span>Strengths</span>
              </div>
              <div id="selected-pro-tags" class="selected-tags-list"></div>
            </div>
            
            <div class="selected-group">
              <div class="selected-group-header">
                <span class="group-icon bg-warning"><i class="bi bi-lightbulb"></i></span>
                <span>Opportunities</span>
              </div>
              <div id="selected-con-tags" class="selected-tags-list"></div>
            </div>
          </div>
          
          <div class="selection-stats mt-3">
            <small class="text-muted">
              Total: <span id="total-selected">0</span>/10 tags
            </small>
          </div>
        </div>
        <div class="feedback-section">
          <h6>Your Feedback</h6>
          <textarea id="general-feedback" class="form-control mb-3" rows="4" placeholder="Share your thoughts about this artwork..."></textarea>
          <div class="action-buttons">
            {% if user.is_authenticated %}
              <button id="submit-btn" class="btn btn-primary">Submit Feedback</button>
              <button id="skip-btn" class="btn btn-outline-secondary">Skip</button>
              <button id="next-btn" class="btn btn-outline-success" disabled>Next Artwork â†’</button>
            {% else %}
              <a href="/accounts/login/" class="btn btn-primary">Login to Submit Feedback</a>
              <button id="skip-btn" class="btn btn-outline-secondary">Skip</button>
              <button id="next-btn" class="btn btn-outline-success" disabled>Next Artwork â†’</button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Mobile Quickbar -->
<div id="quickbar" class="d-lg-none">
  <div class="row chip-row mb-3">
    <div class="col-6">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="small text-muted mb-0">Strengths</h6>
        <button id="refresh-pro-mobile" class="btn btn-sm btn-outline-secondary">
          <i class="bi bi-arrow-clockwise"></i>
        </button>
      </div>
      <div id="pro-tags-mobile" class="d-flex flex-wrap gap-2 mb-2" style="max-height:120px; overflow-y:auto;"></div>
      <small class="text-muted"><span id="pro-count-mobile">0</span>/5</small>
    </div>
    <div class="col-6">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="small text-muted mb-0">Opportunities</h6>
        <button id="refresh-con-mobile" class="btn btn-sm btn-outline-secondary">
          <i class="bi bi-arrow-clockwise"></i>
        </button>
      </div>
      <div id="con-tags-mobile" class="d-flex flex-wrap gap-2 mb-2" style="max-height:120px; overflow-y:auto;"></div>
      <small class="text-muted"><span id="con-count-mobile">0</span>/5</small>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <textarea id="general-feedback-mobile" class="form-control mb-2" rows="3" placeholder="Share your thoughts..."></textarea>
      <div class="d-flex gap-2">
        {% if user.is_authenticated %}
          <button id="mobile-submit-btn" class="btn btn-primary btn-sm">Submit</button>
        {% else %}
          <a href="/accounts/login/" class="btn btn-primary btn-sm">Login to Submit</a>
        {% endif %}
        <button id="mobile-skip-btn" class="btn btn-outline-secondary btn-sm">Skip</button>
        <button id="mobile-next-btn" class="btn btn-outline-success btn-sm ms-auto" disabled>Next â†’</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Load feed data and initialize interface
  loadFeedData();
  initializeFeedInterface();
});

function loadFeedData() {
  // Fetch single artwork for critique
  fetch('/api/feed/single/')
    .then(response => response.json())
    .then(data => {
      if (data.artwork) {
        displayArtwork(data.artwork);
      } else {
        console.error('No artwork available for feed');
        showNoArtworkMessage();
      }
    })
    .catch(error => {
      console.error('Error loading feed data:', error);
      // Fallback to artwork list API if single endpoint doesn't exist yet
      fetch('/api/artworks/')
        .then(response => response.json())
        .then(data => {
          if (data.results && data.results.length > 0) {
            // Pick a random artwork from the results
            const randomArtwork = data.results[Math.floor(Math.random() * data.results.length)];
            displayArtwork(randomArtwork);
          } else {
            showNoArtworkMessage();
          }
        })
        .catch(fallbackError => {
          console.error('Fallback API also failed:', fallbackError);
          showNoArtworkMessage();
        });
    });
}

function displayArtwork(artwork) {
  // Display the artwork
  const artworkImg = document.getElementById('artwork-img');
  const ratioContainer = document.querySelector('.ratio-artwork');
  const imageUrl = artwork.image_display_url || artwork.image_url || artwork.image;
  
  // Reset image state for new load
  artworkImg.classList.remove('loaded');
  artworkImg.style.display = 'none';
  ratioContainer.classList.remove('has-image');
  
  if (imageUrl) {
    // Create new image for preloading
    const tempImg = new Image();
    
    tempImg.onload = function() {
      // Image loaded successfully - show with smooth animation
      artworkImg.src = imageUrl;
      artworkImg.style.display = 'block';
      
      // Trigger animation after a brief delay to ensure display is rendered
      setTimeout(() => {
        artworkImg.classList.add('loaded');
        // Allow container to adapt to image dimensions
        ratioContainer.classList.add('has-image');
        
        // Fade out loading placeholder
        const placeholder = document.querySelector('.loading-placeholder');
        placeholder.style.opacity = '0';
        setTimeout(() => {
          placeholder.style.display = 'none';
        }, 400);
      }, 50);
    };
    
    tempImg.onerror = function() {
      // Handle image load errors
      const placeholder = document.querySelector('.loading-placeholder');
      placeholder.innerHTML = '<div class="text-center text-muted"><i class="bi bi-image" style="font-size: 3rem;"></i><br>Image not available</div>';
      placeholder.style.display = 'flex';
      placeholder.style.opacity = '1';
    };
    
    // Start loading the image
    tempImg.src = imageUrl;
  } else {
    // No image available
    const placeholder = document.querySelector('.loading-placeholder');
    placeholder.innerHTML = '<div class="text-center text-muted"><i class="bi bi-image" style="font-size: 3rem;"></i><br>No image available</div>';
    placeholder.style.display = 'flex';
    placeholder.style.opacity = '1';
  }
  
  document.getElementById('artwork-title').textContent = artwork.title || 'Untitled';
  document.getElementById('artwork-caption').textContent = artwork.description || 'No description available';
  document.getElementById('artwork-medium').textContent = artwork.medium || 'Mixed Media';
  
  const createdDate = artwork.created_at ? new Date(artwork.created_at).toLocaleDateString() : 'Recently';
  document.getElementById('artwork-date').textContent = createdDate;
  
  // Store artwork ID for critique submission
  document.querySelector('.artwork-display').dataset.artworkId = artwork.id || '';
}

function showNoArtworkMessage() {
  document.querySelector('.loading-placeholder').innerHTML = 
    '<div class="text-center"><i class="bi bi-palette2"></i><br>No artworks available for critique right now.<br><small>Check back later!</small></div>';
}

function initializeFeedInterface() {
  // Initialize critique tag selections
  loadCritiqueTags();
  
  // Bind event handlers
  document.getElementById('submit-btn').addEventListener('click', submitCritique);
  document.getElementById('skip-btn').addEventListener('click', skipArtwork);
  document.getElementById('next-btn').addEventListener('click', loadNextArtwork);
  
  // Mobile handlers
  document.getElementById('mobile-submit-btn').addEventListener('click', submitCritique);
  document.getElementById('mobile-skip-btn').addEventListener('click', skipArtwork);
  document.getElementById('mobile-next-btn').addEventListener('click', loadNextArtwork);
}

function loadCritiqueTags() {
  // Load initial tag sets
  loadTagSet('pro');
  loadTagSet('con');
  
  // Bind refresh handlers - desktop
  document.getElementById('refresh-pro-tags').addEventListener('click', () => loadTagSet('pro'));
  document.getElementById('refresh-con-tags').addEventListener('click', () => loadTagSet('con'));
  
  // Bind refresh handlers - mobile
  if (document.getElementById('refresh-pro-mobile')) {
    document.getElementById('refresh-pro-mobile').addEventListener('click', () => loadTagSet('pro'));
  }
  if (document.getElementById('refresh-con-mobile')) {
    document.getElementById('refresh-con-mobile').addEventListener('click', () => loadTagSet('con'));
  }
  
  // Bind search handlers
  setupTagSearch('pro');
  setupTagSearch('con');
  
  // Bind category toggle handlers
  setupCategoryToggle('pro');
  setupCategoryToggle('con');
  
  // Setup tab system
  setupTabSystem();
}

function loadTagSet(type) {
  // Store currently selected tags before refreshing
  const currentlySelected = getSelectedTags(type);
  
  const flatPool = getFlatTagPool(type);
  
  // Get random selection of 8-12 tags from the pool
  const shuffled = [...flatPool].sort(() => 0.5 - Math.random());
  const selectedTags = shuffled.slice(0, Math.floor(Math.random() * 5) + 8);
  
  const containerId = `${type}-tags`;
  const chipClass = `${type}-chip`;
  
  populateTags(containerId, selectedTags, chipClass, type);
  
  // Also populate mobile if exists
  const mobileContainerId = `${type}-tags-mobile`;
  if (document.getElementById(mobileContainerId)) {
    populateTags(mobileContainerId, selectedTags, chipClass, type);
  }
  
  // Load categorized tags as well
  loadCategorizedTags(type);
  
  // Restore previously selected tags
  restoreSelectedTags(type, currentlySelected);
  
  // Update counts and states
  updateTagCount(type);
  updateTagCount(`${type}-mobile`);
  updateTagStates(type);
}

function getTagPools() {
  return {
    pro: {
      technique: [
        'Strong composition', 'Excellent technique', 'Great brushwork', 'Skillful rendering',
        'Nice details', 'Good proportions', 'Solid drawing foundation', 'Clean linework'
      ],
      color: [
        'Great use of color', 'Beautiful color palette', 'Nice color harmony', 'Bold colors',
        'Subtle color choices', 'Good color temperature', 'Rich colors', 'Balanced tones'
      ],
      lighting: [
        'Good lighting', 'Dramatic lighting', 'Atmospheric mood', 'Great shadows',
        'Nice highlights', 'Moody atmosphere', 'Cinematic feel', 'Warm feeling'
      ],
      creativity: [
        'Creative concept', 'Original idea', 'Unique style', 'Imaginative',
        'Great storytelling', 'Expressive', 'Emotional impact', 'Compelling subject'
      ],
      impact: [
        'Eye-catching', 'Professional quality', 'Polished finish', 'Cohesive style',
        'Strong visual impact', 'Engaging composition', 'Dynamic energy', 'Balanced design'
      ]
    },
    
    con: {
      composition: [
        'Could improve composition', 'Needs better focal point', 'Unbalanced layout',
        'Confusing composition', 'Weak composition', 'Too busy', 'Lacks focus'
      ],
      technical: [
        'Technique could be refined', 'Anatomy needs work', 'Perspective issues',
        'Proportions off', 'Drawing needs improvement', 'Rough execution'
      ],
      color: [
        'Color balance needs work', 'Colors clash', 'Too saturated', 'Too muted',
        'Lacks color harmony', 'Muddy colors', 'Color temperature inconsistent'
      ],
      lighting: [
        'Needs more contrast', 'Lighting unclear', 'Shadows inconsistent',
        'Too flat', 'Lacks depth', 'Missing highlights', 'Confusing light source'
      ],
      environment: [
        'Background distracting', 'Background too busy', 'Environment unclear',
        'Background competes with subject', 'Needs more environment detail'
      ],
      polish: [
        'Needs more refinement', 'Feels unfinished', 'Could be more polished',
        'Lacks visual interest', 'Too simple', 'Needs more detail', 'Style inconsistent'
      ]
    }
  };
}

// Get flat array of all tags for random selection and search
function getFlatTagPool(type) {
  const pools = getTagPools()[type];
  return Object.values(pools).flat();
}

function populateTags(containerId, tags, chipClass, type) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  
  tags.forEach(tag => {
    const chip = document.createElement('span');
    chip.className = `tag-chip ${chipClass}`;
    chip.textContent = tag;
    chip.addEventListener('click', () => toggleTagSelection(chip, type));
    container.appendChild(chip);
  });
}

function toggleTagSelection(chip, type) {
  const baseType = type.replace('-mobile', '');
  const tagText = chip.textContent.trim();
  const isCurrentlySelected = chip.classList.contains('selected');
  
  if (isCurrentlySelected) {
    // Deselect this tag across all sections
    deselectTagEverywhere(baseType, tagText);
  } else {
    // Check if tag is already selected elsewhere
    if (isTagSelectedAnywhere(baseType, tagText)) {
      // Tag is already selected in another section, do nothing
      return;
    }
    
    const currentCount = getSelectedTagCount(baseType);
    if (currentCount >= 5) {
      showTagLimitWarning(baseType);
      return;
    }
    
    // Select this tag across all sections where it appears
    selectTagEverywhere(baseType, tagText);
  }
  
  // Update counts and states
  updateTagCount(baseType);
  updateTagCount(`${baseType}-mobile`);
  updateTagStates(baseType);
}

function getSelectedTagCount(type) {
  return document.querySelectorAll(`.${type}-chip.selected`).length;
}

function updateTagCount(type) {
  const baseType = type.replace('-mobile', '');
  const count = getSelectedTagCount(baseType);
  
  // Update both desktop and mobile counters
  const countElement = document.getElementById(`${baseType}-count`);
  const mobileCountElement = document.getElementById(`${baseType}-count-mobile`);
  
  if (countElement) {
    countElement.textContent = count;
  }
  if (mobileCountElement) {
    mobileCountElement.textContent = count;
  }
  
  // Update tab badges
  const tabBadge = document.getElementById(`${baseType === 'pro' ? 'strengths' : 'opportunities'}-badge`);
  if (tabBadge) {
    tabBadge.textContent = count;
  }
  
  // Update selected tags summary
  updateSelectedTagsSummary(baseType);
  
  // Update total count
  const proCount = getSelectedTagCount('pro');
  const conCount = getSelectedTagCount('con');
  const totalElement = document.getElementById('total-selected');
  if (totalElement) {
    totalElement.textContent = proCount + conCount;
  }
}

function updateTagStates(type) {
  const selectedCount = getSelectedTagCount(type);
  const maxTags = 5;
  const chips = document.querySelectorAll(`.${type}-chip`);
  
  chips.forEach(chip => {
    if (selectedCount >= maxTags && !chip.classList.contains('selected')) {
      chip.classList.add('disabled');
    } else {
      chip.classList.remove('disabled');
    }
  });
}

function showTagLimitWarning(type) {
  const section = type === 'pro' ? 'Strengths' : 'Opportunities';
  alert(`Maximum of 5 ${section.toLowerCase()} tags reached. Please deselect a tag first.`);
}

function setupTagSearch(type) {
  const searchInput = document.getElementById(`${type}-search`);
  const suggestionsDiv = document.getElementById(`${type}-suggestions`);
  const flatPool = getFlatTagPool(type);
  
  searchInput.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase().trim();
    
    if (query.length < 2) {
      suggestionsDiv.classList.remove('show');
      return;
    }
    
    const matches = flatPool.filter(tag => 
      tag.toLowerCase().includes(query)
    ).slice(0, 5);
    
    if (matches.length > 0) {
      suggestionsDiv.innerHTML = matches
        .map(tag => `<div class="suggestion-item" data-tag="${tag}">${tag}</div>`)
        .join('');
      suggestionsDiv.classList.add('show');
      
      // Bind click handlers for suggestions
      suggestionsDiv.querySelectorAll('.suggestion-item').forEach(item => {
        item.addEventListener('click', () => {
          addCustomTag(item.dataset.tag, type);
          searchInput.value = '';
          suggestionsDiv.classList.remove('show');
        });
      });
    } else {
      suggestionsDiv.classList.remove('show');
    }
  });
  
  // Hide suggestions when clicking outside
  document.addEventListener('click', (e) => {
    if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
      suggestionsDiv.classList.remove('show');
    }
  });
}

function addCustomTag(tagText, type) {
  // Check if tag already exists
  const existingTags = document.querySelectorAll(`.${type}-chip`);
  for (let tag of existingTags) {
    if (tag.textContent === tagText) {
      // Tag exists, just select it if not already selected
      if (!tag.classList.contains('selected')) {
        toggleTagSelection(tag, type);
      }
      return;
    }
  }
  
  // Add new custom tag
  const container = document.getElementById(`${type}-tags`);
  const chip = document.createElement('span');
  chip.className = `tag-chip ${type}-chip custom-tag`;
  chip.textContent = tagText;
  chip.addEventListener('click', () => toggleTagSelection(chip, type));
  
  // Insert at beginning to make it prominent
  container.insertBefore(chip, container.firstChild);
  
  // Auto-select the new tag
  setTimeout(() => toggleTagSelection(chip, type), 100);
}

function setupCategoryToggle(type) {
  const toggleButton = document.getElementById(`toggle-${type}-categories`);
  const randomTags = document.getElementById(`${type}-tags`);
  const categories = document.getElementById(`${type}-categories`);
  
  toggleButton.addEventListener('click', () => {
    const isShowingCategories = categories.style.display !== 'none';
    
    if (isShowingCategories) {
      // Switch back to random view
      categories.style.display = 'none';
      randomTags.style.display = 'flex';
      toggleButton.innerHTML = '<i class="bi bi-collection"></i> Browse by Category';
    } else {
      // Switch to category view
      randomTags.style.display = 'none';
      categories.style.display = 'block';
      toggleButton.innerHTML = '<i class="bi bi-grid-3x3-gap"></i> Random Tags';
      
      // Load categorized tags if not already loaded
      loadCategorizedTags(type);
    }
  });
  
  // Setup category header click handlers
  setupCategoryHeaders(type);
}

function loadCategorizedTags(type) {
  const tagPools = getTagPools()[type];
  
  Object.keys(tagPools).forEach(categoryKey => {
    const tags = tagPools[categoryKey];
    const containerId = `${categoryKey}-${type}-tags`;
    const container = document.getElementById(containerId);
    
    if (container && container.innerHTML === '') {
      // Create chips wrap
      const chipsWrap = document.createElement('div');
      chipsWrap.className = 'chips-wrap';
      
      tags.forEach(tag => {
        const chip = document.createElement('span');
        chip.className = `tag-chip ${type}-chip`;
        chip.textContent = tag;
        chip.addEventListener('click', () => toggleTagSelection(chip, type));
        chipsWrap.appendChild(chip);
      });
      
      container.appendChild(chipsWrap);
    }
  });
}

function setupCategoryHeaders(type) {
  const categoryHeaders = document.querySelectorAll(`#${type}-categories .category-header`);
  
  categoryHeaders.forEach(header => {
    header.addEventListener('click', () => {
      const categoryId = header.dataset.category;
      const content = document.getElementById(`${categoryId}-tags`);
      const isExpanded = header.classList.contains('expanded');
      
      if (isExpanded) {
        // Collapse
        header.classList.remove('expanded');
        content.classList.remove('expanded');
      } else {
        // Expand
        header.classList.add('expanded');
        content.classList.add('expanded');
      }
    });
  });
}

async function submitCritique() {
  // Check if user is authenticated
  {% if not user.is_authenticated %}
    alert('Please log in to submit feedback.');
    window.location.href = '/accounts/login/';
    return;
  {% endif %}
  
  const feedback = document.getElementById('general-feedback').value || document.getElementById('general-feedback-mobile').value;
  const selectedProTags = getSelectedTags('pro-chip');
  const selectedConTags = getSelectedTags('con-chip');
  
  if (!feedback.trim() && selectedProTags.length === 0 && selectedConTags.length === 0) {
    alert('Please provide some feedback or select tags before submitting.');
    return;
  }
  
  const artworkId = document.querySelector('.artwork-display').dataset.artworkId;
  
  if (!artworkId) {
    alert('No artwork selected. Please refresh the page.');
    return;
  }
  
  // Build critique text combining feedback and selected tags
  let critiqueText = feedback.trim();
  
  if (selectedProTags.length > 0) {
    critiqueText += (critiqueText ? '\n\n' : '') + 'Strengths: ' + selectedProTags.join(', ');
  }
  
  if (selectedConTags.length > 0) {
    critiqueText += (critiqueText ? '\n\n' : '') + 'Areas for improvement: ' + selectedConTags.join(', ');
  }
  
  // Show loading state
  const submitBtn = document.getElementById('submit-btn');
  const mobileSubmitBtn = document.getElementById('mobile-submit-btn');
  
  const originalText = submitBtn.textContent;
  const originalMobileText = mobileSubmitBtn.textContent;
  
  submitBtn.textContent = 'Submitting...';
  submitBtn.disabled = true;
  mobileSubmitBtn.textContent = 'Submitting...';
  mobileSubmitBtn.disabled = true;
  
  try {
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                     getCookie('csrftoken');
    
    // Submit critique to API
    const response = await fetch(`/api/artworks/${artworkId}/add_critique/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,
      },
      credentials: 'same-origin',
      body: JSON.stringify({
        text: critiqueText,
        composition_score: null,
        technique_score: null,
        originality_score: null
      })
    });
    
    if (response.ok) {
      const result = await response.json();
      console.log('Critique submitted successfully:', result);
      
      // Show success state
      submitBtn.textContent = 'Submitted!';
      mobileSubmitBtn.textContent = 'Submitted!';
      
      // Enable next button
      document.getElementById('next-btn').disabled = false;
      document.getElementById('mobile-next-btn').disabled = false;
      
      // Reset button after delay
      setTimeout(() => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        mobileSubmitBtn.textContent = originalMobileText;
        mobileSubmitBtn.disabled = false;
      }, 2000);
      
    } else {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
  } catch (error) {
    console.error('Error submitting critique:', error);
    
    // Show error state
    submitBtn.textContent = 'Error - Try Again';
    mobileSubmitBtn.textContent = 'Error - Try Again';
    
    // Reset button after delay
    setTimeout(() => {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
      mobileSubmitBtn.textContent = originalMobileText;
      mobileSubmitBtn.disabled = false;
    }, 3000);
    
    alert('Failed to submit critique. Please try again.');
  }
}

// Helper function to get CSRF token from cookies
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function getSelectedTags(chipClass) {
  return Array.from(document.querySelectorAll(`.${chipClass}.selected`))
    .map(chip => chip.textContent);
}

function skipArtwork() {
  // Enable next button and move to next artwork
  document.getElementById('next-btn').disabled = false;
  document.getElementById('mobile-next-btn').disabled = false;
  loadNextArtwork();
}

function loadNextArtwork() {
  // Reset form
  const feedbackField = document.getElementById('general-feedback');
  const mobileFeedbackField = document.getElementById('general-feedback-mobile');
  
  if (feedbackField) feedbackField.value = '';
  if (mobileFeedbackField) mobileFeedbackField.value = '';
  
  document.querySelectorAll('.tag-chip.selected').forEach(chip => chip.classList.remove('selected'));
  
  // Disable next button
  document.getElementById('next-btn').disabled = true;
  document.getElementById('mobile-next-btn').disabled = true;
  
  // Show loading state with smooth transition
  const artworkImg = document.getElementById('artwork-img');
  const ratioContainer = document.querySelector('.ratio-artwork');
  const placeholder = document.querySelector('.loading-placeholder');
  
  // Fade out current image and reset container to loading state
  artworkImg.classList.remove('loaded');
  ratioContainer.classList.remove('has-image');
  
  setTimeout(() => {
    artworkImg.style.display = 'none';
    
    // Show loading placeholder with animation
    placeholder.style.display = 'flex';
    placeholder.style.opacity = '1';
    placeholder.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div> Loading next artwork...';
    
    // Reload to get new artwork (in real app, this would be AJAX)
    setTimeout(() => {
      window.location.reload();
    }, 1000);
  }, 300);
}

function getSelectedTags(type) {
  // Get unique selected tags to avoid duplicates
  const selectedTags = new Set();
  document.querySelectorAll(`.${type}-chip.selected`).forEach(chip => {
    selectedTags.add(chip.textContent.trim());
  });
  return Array.from(selectedTags);
}

function restoreSelectedTags(type, selectedTags) {
  if (!selectedTags || selectedTags.length === 0) return;
  
  // Use selectTagEverywhere to ensure consistency across all sections
  selectedTags.forEach(tagText => {
    selectTagEverywhere(type, tagText);
  });
}

function setupTabSystem() {
  const strengthsTab = document.getElementById('strengths-tab');
  const opportunitiesTab = document.getElementById('opportunities-tab');
  const strengthsContent = document.getElementById('strengths-content');
  const opportunitiesContent = document.getElementById('opportunities-content');
  
  strengthsTab.addEventListener('click', () => {
    // Switch to strengths tab
    strengthsTab.classList.add('active');
    opportunitiesTab.classList.remove('active');
    strengthsContent.classList.add('active');
    opportunitiesContent.classList.remove('active');
  });
  
  opportunitiesTab.addEventListener('click', () => {
    // Switch to opportunities tab
    opportunitiesTab.classList.add('active');
    strengthsTab.classList.remove('active');
    opportunitiesContent.classList.add('active');
    strengthsContent.classList.remove('active');
  });
}

function updateSelectedTagsSummary(type) {
  const selectedTags = getSelectedTags(type);
  const summaryContainer = document.getElementById(`selected-${type}-tags`);
  
  if (summaryContainer) {
    if (selectedTags.length === 0) {
      summaryContainer.innerHTML = '<small class="text-muted">No tags selected</small>';
    } else {
      summaryContainer.innerHTML = selectedTags
        .map(tag => `
          <span class="selected-tag-item ${type === 'pro' ? 'strength' : 'opportunity'}" data-tag="${tag}">
            ${tag}
            <span class="remove-tag" onclick="removeSelectedTag('${type}', '${tag}')">&times;</span>
          </span>
        `).join('');
    }
  }
}

function removeSelectedTag(type, tagText) {
  // Deselect this tag everywhere it appears
  deselectTagEverywhere(type, tagText);
  
  // Update counts and states
  updateTagCount(type);
  updateTagStates(type);
}

function isTagSelectedAnywhere(type, tagText) {
  const allChips = document.querySelectorAll(`.${type}-chip`);
  return Array.from(allChips).some(chip => 
    chip.textContent.trim() === tagText && chip.classList.contains('selected')
  );
}

function selectTagEverywhere(type, tagText) {
  const allChips = document.querySelectorAll(`.${type}-chip`);
  allChips.forEach(chip => {
    if (chip.textContent.trim() === tagText) {
      chip.classList.add('selected');
    }
  });
}

function deselectTagEverywhere(type, tagText) {
  const allChips = document.querySelectorAll(`.${type}-chip`);
  allChips.forEach(chip => {
    if (chip.textContent.trim() === tagText) {
      chip.classList.remove('selected');
    }
  });
}
</script>

{% endblock %}
