{% extends 'critique/base.html' %}

{% block title %}{{ artwork.title }} - Brush Up{% endblock %}

{% block extra_head %}
<style>
    /* Enhanced Critique System Styles */
    .critique-card {
        transition: all 0.3s ease;
        border: 1px solid rgba(108, 117, 125, 0.3) !important;
    }
    
    .critique-card:hover {
        border-color: rgba(13, 110, 253, 0.5) !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }
    
    .rating-bar-container {
        margin-bottom: 8px;
    }
    
    .progress {
        background-color: rgba(108, 117, 125, 0.2) !important;
    }
    
    .critique-collapse-btn svg {
        transition: transform 0.3s ease;
    }
    
    .reaction-btn {
        transition: all 0.2s ease;
        border-radius: 20px !important;
        padding: 4px 12px !important;
    }
    
    .reaction-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .reaction-btn.active {
        background-color: var(--bs-primary) !important;
        border-color: var(--bs-primary) !important;
        color: white !important;
    }
    
    .reply-form-container {
        animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .replies-container {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .reply-item {
        transition: background-color 0.2s ease;
    }
    
    .reply-item:hover {
        background-color: rgba(108, 117, 125, 0.2) !important;
    }
    
    .critique-text {
        line-height: 1.6;
    }
    
    .card-header {
        border-bottom: 1px solid rgba(108, 117, 125, 0.2) !important;
    }
    
    .card-footer {
        border-top: 1px solid rgba(108, 117, 125, 0.2) !important;
    }
    
    .dropdown-menu {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(108, 117, 125, 0.3);
    }
    
    .badge {
        font-size: 0.75em;
        font-weight: 500;
    }
    
    .toast {
        animation: slideInRight 0.3s ease;
    }
    
    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(100px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    /* Fix for toggle switch visibility */
    .form-check-input {
        width: 2em !important;
        height: 1em !important;
        background-color: #6c757d !important;
        border: none !important;
        border-radius: 1em !important;
        position: relative !important;
    }
    
    .form-check-input:checked {
        background-color: #0d6efd !important;
    }
    
    .form-check-input:focus {
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
    }
    
    .form-check-input::before {
        content: '';
        position: absolute;
        top: 0.125em;
        left: 0.125em;
        width: 0.75em;
        height: 0.75em;
        background-color: white;
        border-radius: 50%;
        transition: transform 0.15s ease-in-out;
    }
    
    .form-check-input:checked::before {
        transform: translateX(1em);
    }
    
    /* Drop zone styling with fixed dimensions */
    .drop-zone {
        border: 2px dashed #6c757d;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        transition: all 0.3s ease;
        background-color: rgba(108, 117, 125, 0.1);
        height: 140px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        position: relative;
    }
    
    .drop-zone.highlight {
        border-color: #0d6efd;
        background-color: rgba(13, 110, 253, 0.1);
    }
    
    .drop-zone-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
    }
    
    .dropped-version {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        padding: 8px;
        gap: 8px;
        text-align: center;
    }
    
    .dropped-version img {
        flex-shrink: 0;
    }
    
    .dropped-version .version-title {
        font-size: 0.75rem;
        line-height: 1.2;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .dropped-version .remove-btn {
        margin-top: auto;
        font-size: 0.7rem;
        padding: 2px 6px;
    }
    
    /* Extra small button class for Bootstrap 5 */
    .btn-xs {
        padding: 0.125rem 0.25rem;
        font-size: 0.625rem;
        line-height: 1.2;
        border-radius: 0.2rem;
    }
</style>
{% endblock %}

{% block content %}
    {% csrf_token %}
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <div class="card mb-4 bg-dark text-white">
                {% if current_version and current_version.image %}
                    <img src="{{ current_version.image.url }}" class="card-img-top img-fluid" alt="{{ artwork.title }}" style="max-height: 500px; object-fit: contain;" id="main-artwork-image">
                {% elif current_version and current_version.image_url %}
                    <img src="{{ current_version.image_url }}" class="card-img-top img-fluid" alt="{{ artwork.title }}" style="max-height: 500px; object-fit: contain;" id="main-artwork-image">
                {% elif artwork.image %}
                    <img src="{{ artwork.image.url }}" class="card-img-top img-fluid" alt="{{ artwork.title }}" style="max-height: 500px; object-fit: contain;" id="main-artwork-image">
                {% elif artwork.image_url %}
                    <img src="{{ artwork.image_url }}" class="card-img-top img-fluid" alt="{{ artwork.title }}" style="max-height: 500px; object-fit: contain;" id="main-artwork-image">
                {% else %}
                    <div class="bg-secondary text-white d-flex justify-content-center align-items-center" style="height: 400px;" id="main-artwork-image">
                        <span>No Image Available</span>
                    </div>
                {% endif %}
                <div class="card-body">
                    <h1 class="card-title">{{ artwork.title }}</h1>

                    <!-- Version Label -->
                    {% if total_versions > 0 %}
                    <div class="mb-2">
                        <span class="badge bg-secondary me-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-clock-history me-1" viewBox="0 0 16 16">
                                <path d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022l-.074.997zm2.004.45a7.003 7.003 0 0 0-.985-.299l.219-.976c.383.086.76.2 1.126.342l-.36.933zm1.37.71a7.01 7.01 0 0 0-.439-.27l.493-.87a8.025 8.025 0 0 1 .979.654l-.615.789a6.996 6.996 0 0 0-.418-.302zm1.834 1.79a6.99 6.99 0 0 0-.653-.796l.724-.69c.27.285.52.59.747.91l-.818.576zm.744 1.352a7.08 7.08 0 0 0-.214-.468l.893-.45a7.976 7.976 0 0 1 .45 1.088l-.942.313a7.023 7.023 0 0 0-.187-.483zm.53 2.507a6.991 6.991 0 0 0-.1-1.025l.985-.17c.067.386.106.778.116 1.17l-1.001.025zm-.131 1.538c.033-.17.06-.339.081-.51l.993.123a7.957 7.957 0 0 1-.23 1.155l-.964-.267c.046-.165.086-.332.12-.501zm-.952 2.379c.184-.29.346-.594.486-.908l.914.405c-.16.36-.345.706-.555 1.038l-.845-.535zm-1.442 1.633c.263-.226.509-.467.740-.722l.724.69a8.026 8.026 0 0 1-.989.912l-.475-.88zm-2.266.97c.342-.14.677-.296.99-.49l.546.837a7.972 7.972 0 0 1-1.198.596l-.338-.943zm-2.137.339c.37-.042.741-.111 1.106-.207l.238.971a7.998 7.998 0 0 1-1.425.267l.081-.031z"/>
                                <path d="M8 1a7 7 0 1 0 4.95 11.95l.707.707A8.001 8.001 0 1 1 8 0v1z"/>
                                <path d="M7.5 3a.5.5 0 0 1 .5.5v5.21l3.248 1.856a.5.5 0 0 1-.496.868l-3.5-2A.5.5 0 0 1 7 9V3.5a.5.5 0 0 1 .5-.5z"/>
                            </svg>
                            Current ({{ current_version_number }} of {{ total_versions }})
                        </span>

                    </div>
                    {% endif %}

                    <p class="card-text">{{ artwork.description }}</p>
                    <p class="card-text">
                        {% if artwork.medium %}<span class="badge bg-info me-2">{{ artwork.medium }}</span>{% endif %}
                        {% if artwork.dimensions %}<span class="badge bg-secondary me-2">{{ artwork.dimensions }}</span>{% endif %}
                    </p>
                    <p class="card-text"><small class="text-muted">Created: {{ artwork.created_at|date:"F d, Y" }}</small></p>
                    {% if artwork.author %}
                    <p class="card-text"><small class="text-muted">Artist: <a href="{% url 'critique:user_profile' artwork.author.username %}" class="text-info">{{ artwork.author.username }}</a></small></p>
                    {% endif %}

                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            {% if user.is_authenticated %}
                            <a href="{% url 'critique:like_artwork' artwork.id %}" class="btn {% if user in artwork.likes.all %}btn-primary{% else %}btn-outline-light{% endif %} me-2" id="likeButton" data-artwork-id="{{ artwork.id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi {% if user in artwork.likes.all %}bi-heart-fill{% else %}bi-heart{% endif %}" viewBox="0 0 16 16">
                                    {% if user in artwork.likes.all %}
                                    <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314z"/>
                                    {% else %}
                                    <path d="M8 2.748L7.775 2.454a.75.75 0 0 0-1.06-.02L8 1.314c4.438-4.562 15.534 2.421 0 13.686C-7.534 4.735 3.562-3.248 8 1.314l.225.296c.208.27.208.718 0 .988L8 2.748z"/>
                                    {% endif %}
                                </svg>
                                <span class="like-count">{{ artwork.likes.count }}</span>
                            </a>
                            {% endif %}
                            <a href="{% url 'critique:create_critique' artwork.id %}" class="btn btn-outline-success">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat-dots" viewBox="0 0 16 16">
                                    <path d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                                    <path d="M2.165 15.803l.02-.004c1.83-.363 2.948-.842 3.468-1.105A9.06 9.06 0 0 0 8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6a10.437 10.437 0 0 1-.524 2.318l-.003.011a10.722 10.722 0 0 1-.244.637c-.079.186.074.394.273.362a21.673 21.673 0 0 0 .693-.125zm.8-3.108a1 1 0 0 0-.287-.801C1.618 10.83 1 9.468 1 8c0-3.192 3.004-6 7-6s7 2.808 7 6c0 3.193-3.004 6-7 6a8.06 8.06 0 0 1-2.088-.272 1 1 0 0 0-.711.074c-.387.196-1.24.57-2.634.893a19.492 19.492 0 0 0 .398-2z"/>
                                </svg>
                                Add Critique
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar for Version History -->
        <div class="col-lg-4">
            {% if versions %}
            <div class="card bg-dark text-white mb-3 sticky-top" style="top: 20px;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <h6 class="mb-0 me-3">Version History</h6>
                        {% if user.is_authenticated and user == artwork.author %}
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="showArchivedVersions" onchange="toggleArchivedVersions()">
                            <label class="form-check-label text-muted small" for="showArchivedVersions">
                                Show Archived
                            </label>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body" style="max-height: 70vh; overflow-y: auto;">
                    <div class="row g-2">
                        <!-- Current Version -->
                        <div class="col-6">
                            <div class="version-thumbnail text-center" 
                                 data-version="current" 
                                 data-version-id="current"
                                 data-version-number="{{ current_version_number }}"
                                 data-artwork-id="{{ artwork.id }}"
                                 data-archived="false">
                                <div class="position-relative cursor-pointer" onclick="switchToCurrentVersion({{ artwork.id }})">
                                    {% if current_version and current_version.image %}
                                        <img src="{{ current_version.image.url }}" class="img-thumbnail border-primary" style="width: 100%; height: 80px; object-fit: cover;" alt="Current">
                                    {% elif current_version and current_version.image_url %}
                                        <img src="{{ current_version.image_url }}" class="img-thumbnail border-primary" style="width: 100%; height: 80px; object-fit: cover;" alt="Current">
                                    {% elif artwork.image %}
                                        <img src="{{ artwork.image.url }}" class="img-thumbnail border-primary" style="width: 100%; height: 80px; object-fit: cover;" alt="Current">
                                    {% elif artwork.image_url %}
                                        <img src="{{ artwork.image_url }}" class="img-thumbnail border-primary" style="width: 100%; height: 80px; object-fit: cover;" alt="Current">
                                    {% else %}
                                        <div class="bg-dark d-flex align-items-center justify-content-center border border-primary" style="width: 100%; height: 80px;">
                                            <span class="text-muted small">No Image</span>
                                        </div>
                                    {% endif %}
                                    <span class="position-absolute top-0 start-50 translate-middle badge rounded-pill bg-primary">
                                        Current
                                    </span>
                                </div>
                                <small class="d-block mt-1 fw-bold text-primary">Current</small>
                                <small class="d-block text-muted" style="font-size: 0.7rem;">v{{ current_version_number }}</small>
                            </div>
                        </div>

                        <!-- Version History Thumbnails -->
                        {% for version in versions reversed %}
                        {% if not version.is_archived or user.is_authenticated and user == artwork.author %}
                        <div class="col-6">
                            <div class="version-thumbnail text-center {% if version.is_archived %}archived-version{% endif %}" 
                                 data-version="{{ version.id }}" 
                                 data-version-id="{{ version.id }}"
                                 data-version-number="{{ version.version_number }}"
                                 data-artwork-id="{{ artwork.id }}"
                                 data-archived="{{ version.is_archived|yesno:'true,false' }}"
                                 {% if version.is_archived %}style="display: none;"{% endif %}>
                                <div class="position-relative cursor-pointer" onclick="switchToVersion({{ artwork.id }}, {{ version.id }})">
                                    {% if version.image %}
                                        <img src="{{ version.image.url }}" class="img-thumbnail" style="width: 100%; height: 80px; object-fit: cover;" alt="Version {{ version.version_number }}">
                                    {% elif version.image_url %}
                                        <img src="{{ version.image_url }}" class="img-thumbnail" style="width: 100%; height: 80px; object-fit: cover;" alt="Version {{ version.version_number }}">
                                    {% else %}
                                        <div class="bg-dark d-flex align-items-center justify-content-center" style="width: 100%; height: 80px;">
                                            <span class="text-muted small">No Image</span>
                                        </div>
                                    {% endif %}

                                    <!-- Version Actions Menu (only for artwork owner) -->
                                    {% if user.is_authenticated and user == artwork.author %}
                                    <div class="dropdown position-absolute" style="top: 2px; right: 2px;">
                                        <button class="btn btn-sm btn-dark btn-outline-secondary dropdown-toggle p-1" type="button" 
                                                data-bs-toggle="dropdown" aria-expanded="false" 
                                                style="font-size: 0.6rem; line-height: 1;"
                                                onclick="event.stopPropagation();">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" fill="currentColor" class="bi bi-three-dots-vertical" viewBox="0 0 16 16">
                                                <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                            </svg>
                                        </button>
                                        <ul class="dropdown-menu bg-dark border-secondary">
                                            {% if version.is_archived %}
                                            <li>
                                                <button class="dropdown-item text-success" onclick="event.stopPropagation(); unarchiveVersion({{ version.id }})">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="bi bi-arrow-up-circle me-1" viewBox="0 0 16 16">
                                                        <path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8zm15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-7.5 3.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V11.5z"/>
                                                    </svg>
                                                    Unarchive
                                                </button>
                                            </li>
                                            {% else %}
                                            <li>
                                                <button class="dropdown-item text-white" onclick="event.stopPropagation(); archiveVersion({{ version.id }}, {{ version.version_number }})">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="bi bi-archive me-1" viewBox="0 0 16 16">
                                                        <path d="M0 2a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1v7.5a2.5 2.5 0 0 1-2.5 2.5h-9A2.5 2.5 0 0 1 1 12.5V5a1 1 0 0 1-1-1V2zm2 3v7.5A1.5 1.5 0 0 0 3.5 14h9a1.5 1.5 0 0 0 1.5-1.5V5H2zm13-3H1v2h14V2zM5 7.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
                                                    </svg>
                                                    Archive
                                                </button>
                                            </li>
                                            {% endif %}
                                            <li><hr class="dropdown-divider bg-secondary"></li>
                                            <li>
                                                <button class="dropdown-item text-danger" onclick="event.stopPropagation(); deleteVersion({{ version.id }}, {{ version.version_number }})">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="bi bi-trash me-1" viewBox="0 0 16 16">
                                                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                                    </svg>
                                                    Delete
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                    {% endif %}
                                </div>
                                <small class="d-block mt-1">v{{ version.version_number }}</small>
                                {% if version.created_at %}
                                <small class="d-block text-muted" style="font-size: 0.7rem;">{{ version.created_at|date:"M d" }}</small>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    
                    <!-- Version Comparison Controls -->
                    {% if user.is_authenticated and user == artwork.author %}
                    <div class="mt-3 border-top border-secondary pt-3">
                        <!-- Comparison Mode Toggle -->
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="comparisonModeToggle" onchange="toggleComparisonMode()">
                            <label class="form-check-label text-primary small fw-bold" for="comparisonModeToggle">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-arrows-expand me-1" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 8zM7.646.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 1.707V5.5a.5.5 0 0 1-1 0V1.707L6.354 2.854a.5.5 0 1 1-.708-.708l2-2zM8 10a.5.5 0 0 1 .5.5v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 .708-.708L7.5 14.293V10.5A.5.5 0 0 1 8 10z"/>
                                </svg>
                                Compare Versions
                            </label>
                        </div>
                        

                        

                        
                        <!-- Drag & Drop Comparison Interface -->
                        <div id="comparisonInterface" class="comparison-interface" style="display: none;">
                            <div class="alert alert-info py-2 px-3 small mb-3">
                                <strong>Drag & Drop Comparison:</strong><br>
                                • Drag versions to compare them side-by-side<br>
                                • Drop zones will highlight when active<br>
                                • Click "Compare" to view differences
                            </div>
                            
                            <div class="row">
                                <!-- Left Drop Zone -->
                                <div class="col-6">
                                    <div class="drop-zone" id="leftDropZone" ondrop="handleDrop(event, 'left')" ondragover="allowDrop(event)" ondragenter="highlightDropZone(event)" ondragleave="unhighlightDropZone(event)">
                                        <div class="drop-zone-content">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-image text-muted mb-2" viewBox="0 0 16 16">
                                                <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                                <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
                                            </svg>
                                            <p class="text-muted mb-0">Drop Version Here</p>
                                            <small class="text-muted">Version A</small>
                                        </div>
                                        <div class="dropped-version" id="leftDroppedVersion" style="display: none;"></div>
                                    </div>
                                </div>
                                
                                <!-- Right Drop Zone -->
                                <div class="col-6">
                                    <div class="drop-zone" id="rightDropZone" ondrop="handleDrop(event, 'right')" ondragover="allowDrop(event)" ondragenter="highlightDropZone(event)" ondragleave="unhighlightDropZone(event)">
                                        <div class="drop-zone-content">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-image text-muted mb-2" viewBox="0 0 16 16">
                                                <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                                <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
                                            </svg>
                                            <p class="text-muted mb-0">Drop Version Here</p>
                                            <small class="text-muted">Version B</small>
                                        </div>
                                        <div class="dropped-version" id="rightDroppedVersion" style="display: none;"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Compare Button -->
                            <div class="text-center mt-3">
                                <button class="btn btn-primary" id="compareButton" onclick="openVersionComparison()" disabled>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrows-expand me-2" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 8zM7.646.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 1.707V5.5a.5.5 0 0 1-1 0V1.707L6.354 2.854a.5.5 0 1 1-.708-.708l2-2zM8 10a.5.5 0 0 1 .5.5v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 .708-.708L7.5 14.293V10.5A.5.5 0 0 1 8 10z"/>
                                    </svg>
                                    Compare Versions
                                </button>
                                <button class="btn btn-outline-secondary ms-2" onclick="clearComparison()">
                                    Clear
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Version Comparison Modal -->
    <div class="modal fade" id="versionComparisonModal" tabindex="-1" aria-labelledby="versionComparisonModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen-lg-down modal-xl modal-dialog-scrollable">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary d-flex justify-content-between align-items-center">
                    <h5 class="modal-title" id="versionComparisonModalLabel">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-arrows-expand me-2" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 8zM7.646.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 1.707V5.5a.5.5 0 0 1-1 0V1.707L6.354 2.854a.5.5 0 1 1-.708-.708l2-2zM8 10a.5.5 0 0 1 .5.5v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 .708-.708L7.5 14.293V10.5A.5.5 0 0 1 8 10z"/>
                        </svg>
                        Version Comparison
                    </h5>
                    <!-- All controls aligned to the right -->
                    <div class="d-flex align-items-center gap-2">
                        <!-- View Mode Toggle -->
                        <div class="btn-group" role="group" aria-label="View mode">
                            <input type="radio" class="btn-check" name="viewMode" id="sideBySideMode" checked>
                            <label class="btn btn-outline-light btn-sm" for="sideBySideMode">Side-by-Side</label>
                            
                            <input type="radio" class="btn-check" name="viewMode" id="overlayMode">
                            <label class="btn btn-outline-light btn-sm" for="overlayMode">Overlay</label>
                        </div>
                        <div class="vr text-secondary mx-2"></div>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body p-0">
                    <!-- Comparison Status Bar -->
                    <div class="bg-secondary p-3 border-bottom border-dark">
                        <div class="d-flex justify-content-between align-items-center">
                            <div id="comparisonStatus" class="text-light">
                                <span class="badge bg-info me-2">Analyzing</span>
                                Comparing selected versions...
                            </div>
                            <button class="btn btn-sm btn-outline-light" onclick="swapVersions()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-arrow-left-right me-1" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M1 11.5a.5.5 0 0 0 .5.5h11.793l-3.147 3.146a.5.5 0 0 0 .708.708l4-4a.5.5 0 0 0 0-.708l-4-4a.5.5 0 0 0-.708.708L13.293 11H1.5a.5.5 0 0 0-.5.5zm14-7a.5.5 0 0 1-.5.5H2.707l3.147 3.146a.5.5 0 1 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 4H14.5a.5.5 0 0 1 .5.5z"/>
                                </svg>
                                Swap
                            </button>
                        </div>
                    </div>
                    
                    <!-- Side-by-Side View -->
                    <div id="sideBySideView" class="p-3">
                        <div class="row g-4" id="comparisonContent">
                            <!-- Comparison content will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Overlay View -->
                    <div id="overlayView" class="p-0" style="display: none;">
                        <div class="position-relative" id="overlayContainer">
                            <!-- Overlay comparison content -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <div class="d-flex justify-content-between w-100">
                        <div>
                            <span class="text-muted small">Differences found: <span id="diffCount">0</span></span>
                        </div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Critiques Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card mb-4 bg-dark text-white">
                <div class="card-header">
                    <h4>Critiques ({{ critiques.count }})</h4>
                    {% if user.is_authenticated %}
                    <p class="mb-0"><small class="text-muted">Share your thoughts to help the artist improve</small></p>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if critiques %}
                        <!-- Critique Sorting Controls -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="collapseMode">
                                <label class="form-check-label text-muted" for="collapseMode">
                                    Compact view
                                </label>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-sort-down me-1" viewBox="0 0 16 16">
                                        <path d="M3.5 2.5a.5.5 0 0 0-1 0v8.793l-1.146-1.147a.5.5 0 0 0-.708.708l2 1.999.007.007a.497.497 0 0 0 .7-.006l2-2a.5.5 0 0 0-.707-.708L3.5 11.293V2.5zm3.5 1a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zM7.5 6a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5zm0 3a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1h-3zm0 3a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1z"/>
                                    </svg>
                                    Sort by
                                </button>
                                <ul class="dropdown-menu bg-dark border-secondary">
                                    <li><button class="dropdown-item text-light" onclick="sortCritiques('helpful')">Most Helpful</button></li>
                                    <li><button class="dropdown-item text-light" onclick="sortCritiques('recent')">Newest First</button></li>
                                    <li><button class="dropdown-item text-light" onclick="sortCritiques('oldest')">Oldest First</button></li>
                                    <li><button class="dropdown-item text-light" onclick="sortCritiques('rating')">Highest Rating</button></li>
                                </ul>
                            </div>
                        </div>

                        {% for critique in critiques %}
                            <div class="card mb-4 bg-dark text-white critique-card border-secondary rounded-3 shadow-sm" id="critique-{{ critique.id }}" data-critique-id="{{ critique.id }}" data-helpful-count="{{ critique.helpful_count|default:0 }}" data-created="{{ critique.created_at|date:'c' }}" data-rating="{{ critique.get_overall_score|default:0 }}">
                                <!-- Critique Header -->
                                <div class="card-header bg-secondary bg-opacity-25 border-0 pb-2">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="d-flex align-items-center">
                                            <!-- Author Avatar Placeholder -->
                                            <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-size: 14px; font-weight: bold;">
                                                {{ critique.author.username|first|upper }}
                                            </div>
                                            <div>
                                                <div class="d-flex align-items-center">
                                                    <a href="{% url 'critique:user_profile' critique.author.username %}" class="text-decoration-none text-info fw-bold">
                                                        {{ critique.author.username }}
                                                    </a>
                                                    {% if critique.author.profile.karma > 50 %}
                                                        <span class="badge bg-warning text-dark ms-2" title="Expert Critic">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-award" viewBox="0 0 16 16">
                                                                <path d="M9.669.864 8 0 6.331.864l-1.858.282-.842 1.68-1.337 1.32L2.6 6l-.306 1.854 1.337 1.32.842 1.68 1.858.282L8 12l1.669-.864 1.858-.282.842-1.68 1.337-1.32L13.4 6l.306-1.854-1.337-1.32-.842-1.68L9.669.864zm1.196 1.193.684 1.365 1.086 1.072L12.387 6l.248 1.506-1.086 1.072-.684 1.365-1.51.229L8 10.874l-1.355-.702-1.51-.229-.684-1.365-1.086-1.072L3.614 6l-.25-1.506 1.087-1.072.684-1.365 1.51-.229L8 1.126l1.356.702 1.509.229z"/>
                                                                <path d="M4 11.794V16l4-1 4 1v-4.206l-2.018.306L8 13.126 6.018 12.1 4 11.794z"/>
                                                            </svg>
                                                            Expert Eye
                                                        </span>
                                                    {% endif %}
                                                    {% if critique.author.profile.karma > 0 %}
                                                        <span class="badge bg-secondary ms-2" title="Karma Score">
                                                            {{ critique.author.profile.karma }} karma
                                                        </span>
                                                    {% endif %}
                                                </div>
                                                <small class="text-muted">{{ critique.created_at|timesince }} ago</small>
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            {% if critique.get_overall_score %}
                                                <span class="badge bg-primary me-2">{{ critique.get_overall_score }}/10</span>
                                            {% endif %}
                                            <button class="btn btn-sm btn-outline-secondary critique-collapse-btn" data-bs-toggle="collapse" data-bs-target="#critique-body-{{ critique.id }}" aria-expanded="true">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                                                    <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Collapsible Critique Body -->
                                <div class="collapse show" id="critique-body-{{ critique.id }}">
                                    <div class="card-body pt-3">
                                        <!-- Rating Bars Section -->
                                        {% if critique.composition_score or critique.technique_score or critique.originality_score %}
                                        <div class="rating-section mb-3">
                                            <h6 class="text-muted mb-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-bar-chart me-1" viewBox="0 0 16 16">
                                                    <path d="M4 11H2v3h2v-3zm5-4H7v7h2V7zm5-5v12h-2V2h2zm-2-1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1h-2zM6 7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zM4 11a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-3z"/>
                                                </svg>
                                                Ratings
                                            </h6>
                                            <div class="row g-2">
                                                {% if critique.technique_score %}
                                                <div class="col-md-4">
                                                    <div class="rating-bar-container">
                                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                                            <small class="text-muted">Technique</small>
                                                            <small class="text-white fw-bold">{{ critique.technique_score }}/10</small>
                                                            {% if critique.technique_score >= 9 %}
                                                                <span class="badge bg-success" title="Outstanding">✅</span>
                                                            {% elif critique.technique_score <= 2 %}
                                                                <span class="badge bg-warning text-dark" title="Needs improvement">⚠️</span>
                                                            {% endif %}
                                                        </div>
                                                        <div class="progress bg-secondary" style="height: 6px;">
                                                            <div class="progress-bar bg-info" style="width: {{ critique.technique_score }}0%"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if critique.originality_score %}
                                                <div class="col-md-4">
                                                    <div class="rating-bar-container">
                                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                                            <small class="text-muted">Originality</small>
                                                            <small class="text-white fw-bold">{{ critique.originality_score }}/10</small>
                                                            {% if critique.originality_score >= 9 %}
                                                                <span class="badge bg-success" title="Outstanding">✅</span>
                                                            {% elif critique.originality_score <= 2 %}
                                                                <span class="badge bg-warning text-dark" title="Needs improvement">⚠️</span>
                                                            {% endif %}
                                                        </div>
                                                        <div class="progress bg-secondary" style="height: 6px;">
                                                            <div class="progress-bar bg-warning" style="width: {{ critique.originality_score }}0%"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if critique.composition_score %}
                                                <div class="col-md-4">
                                                    <div class="rating-bar-container">
                                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                                            <small class="text-muted">Composition</small>
                                                            <small class="text-white fw-bold">{{ critique.composition_score }}/10</small>
                                                            {% if critique.composition_score >= 9 %}
                                                                <span class="badge bg-success" title="Outstanding">✅</span>
                                                            {% elif critique.composition_score <= 2 %}
                                                                <span class="badge bg-warning text-dark" title="Needs improvement">⚠️</span>
                                                            {% endif %}
                                                        </div>
                                                        <div class="progress bg-secondary" style="height: 6px;">
                                                            <div class="progress-bar bg-success" style="width: {{ critique.composition_score }}0%"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endif %}

                                        <!-- Written Feedback -->
                                        <div class="critique-text mb-3">
                                            <p class="card-text lh-base">{{ critique.text|linebreaks }}</p>
                                        </div>

                                        <!-- Threaded Replies -->
                                        {% if critique.replies.exists %}
                                        <div class="replies-section mb-3">
                                            <h6 class="text-muted mb-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-chat-dots me-1" viewBox="0 0 16 16">
                                                    <path d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                                                    <path d="M2.165 15.803l.02-.004c1.83-.363 2.948-.842 3.468-1.105A9.06 9.06 0 0 0 8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6a10.437 10.437 0 0 1-.524 2.318l-.003.011a10.722 10.722 0 0 1-.244.637c-.079.186.074.394.273.362a21.673 21.673 0 0 0 .693-.125zm.8-3.108a1 1 0 0 0-.287-.801C1.618 10.83 1 9.468 1 8c0-3.192 3.004-6 7-6s7 2.808 7 6c0 3.193-3.004 6-7 6a8.06 8.06 0 0 1-2.088-.272 1 1 0 0 0-.711.074c-.387.196-1.24.57-2.634.893a19.492 19.492 0 0 0 .398-2z"/>
                                                </svg>
                                                Replies ({{ critique.replies.count }})
                                            </h6>
                                            <div class="replies-container ps-3 border-start border-info border-opacity-50">
                                                {% for reply in critique.replies.all %}
                                                <div class="reply-item mb-2 p-2 bg-secondary bg-opacity-25 rounded">
                                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                                        <div class="d-flex align-items-center">
                                                            <div class="rounded-circle bg-info d-flex align-items-center justify-content-center me-2" style="width: 24px; height: 24px; font-size: 11px; font-weight: bold;">
                                                                {{ reply.author.username|first|upper }}
                                                            </div>
                                                            <a href="{% url 'critique:user_profile' reply.author.username %}" class="text-decoration-none text-info fw-bold small">
                                                                {{ reply.author.username }}
                                                            </a>
                                                        </div>
                                                        <small class="text-muted">{{ reply.created_at|timesince }} ago</small>
                                                    </div>
                                                    <p class="mb-0 small">{{ reply.text|linebreaks }}</p>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}

                                        <!-- Inline Reply Form -->
                                        <div class="reply-form-container" id="reply-form-{{ critique.id }}" style="display: none;">
                                            <div class="bg-secondary bg-opacity-25 p-3 rounded mb-3">
                                                <h6 class="text-muted mb-2">Reply to {{ critique.author.username }}</h6>
                                                <form class="reply-form" data-critique-id="{{ critique.id }}">
                                                    {% csrf_token %}
                                                    <div class="mb-2">
                                                        <textarea class="form-control bg-dark text-white border-secondary" rows="3" placeholder="Share your thoughts on this critique..." required></textarea>
                                                    </div>
                                                    <div class="d-flex justify-content-end gap-2">
                                                        <button type="button" class="btn btn-sm btn-outline-secondary cancel-reply">Cancel</button>
                                                        <button type="submit" class="btn btn-sm btn-primary">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-send me-1" viewBox="0 0 16 16">
                                                                <path d="M15.854.146a.5.5 0 0 1 .11.54L13.026 8.12a.5.5 0 0 1-.542.225l-4.57-.985a.5.5 0 0 0-.218 0l-4.57.985a.5.5 0 0 1-.542-.225L.126.686a.5.5 0 0 1 .11-.54A.5.5 0 0 1 .82.2l5.6 2.95L13.8.2a.5.5 0 0 1 .554-.054z"/>
                                                            </svg>
                                                            Post Reply
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    
                                    </div>
                                </div>

                                <!-- Critique Footer with Reactions and Actions -->
                                <div class="card-footer bg-secondary bg-opacity-10 border-0">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <!-- Reaction Buttons -->
                                        <div class="reaction-buttons d-flex gap-1">
                                            {% if user.is_authenticated %}
                                            <button class="btn btn-sm btn-outline-success me-1 reaction-btn {% if critique.user_reactions and 'HELPFUL' in critique.user_reactions %}active{% endif %}" 
                                                    data-critique-id="{{ critique.id }}" 
                                                    data-reaction-type="HELPFUL"
                                                    onclick="toggleReaction(this, {{ critique.id }}, 'HELPFUL')">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-hand-thumbs-up" viewBox="0 0 16 16">
                                                    <path d="M8.864.046C7.908-.193 7.02.53 6.956 1.466c-.072 1.051-.23 2.016-.428 2.59-.125.36-.479 1.013-1.04 1.639-.557.623-1.282 1.178-2.131 1.41C2.685 7.288 2 7.87 2 8.72v4.001c0 .845.682 1.464 1.448 1.545 1.07.114 1.564.415 2.068.723l.048.03c.272.165.578.348.97.484.397.136.861.217 1.466.217h3.5c.937 0 1.599-.477 1.934-1.064a1.86 1.86 0 0 0 .254-.912c0-.152-.023-.312-.077-.464.201-.263.38-.578.488-.901.11-.33.172-.762.004-1.149.069-.13.12-.269.159-.403.077-.27.113-.568.113-.857 0-.288-.036-.585-.113-.856a2.144 2.144 0 0 0-.138-.362 1.9 1.9 0 0 0 .234-1.734c-.206-.592-.682-1.1-1.2-1.272-.847-.282-1.803-.276-2.516-.211a9.84 9.84 0 0 0-.443.05 9.365 9.365 0 0 0-.062-4.509A1.38 1.38 0 0 0 9.125.111L8.864.046zM11.5 14.721H8c-.51 0-.863-.069-1.14-.164-.281-.097-.506-.228-.776-.393l-.04-.024c-.555-.339-1.198-.731-2.49-.868-.333-.036-.554-.29-.554-.55V8.72c0-.254.226-.543.62-.65 1.095-.3 1.977-.996 2.614-1.708.635-.71 1.064-1.475 1.238-1.978.243-.7.407-1.768.482-2.85.025-.362.36-.594.667-.518l.262.066c.16.04.258.143.288.255a8.34 8.34 0 0 1-.145 4.725.5.5 0 0 0 .595.644l.003-.001.014-.003.058-.014a8.908 8.908 0 0 1 1.036-.157c.663-.06 1.457-.054 2.11.164.175.058.45.3.57.65.107.308.087.67-.266 1.022l-.353.353.353.354c.043.043.105.141.154.315.048.167.075.37.075.581 0 .212-.027.414-.075.582-.05.174-.111.272-.154.315l-.353.353.353.354c.047.047.109.177.005.488a2.224 2.224 0 0 1-.505.805l-.353.353.353.354c.006.005.041.05.041.17a.866.866 0 0 1-.121.416c-.165.288-.503.56-1.066.56z"/>
                                                </svg>
                                                <span class="helpful-count">{{ critique.helpful_count|default:0 }}</span>
                                            </button>
                                            <button class="btn btn-sm btn-outline-warning me-1 reaction-btn {% if critique.user_reactions and 'INSPIRING' in critique.user_reactions %}active{% endif %}" 
                                                    data-critique-id="{{ critique.id }}" 
                                                    data-reaction-type="INSPIRING"
                                                    onclick="toggleReaction(this, {{ critique.id }}, 'INSPIRING')">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-lightbulb" viewBox="0 0 16 16">
                                                    <path d="M2 6a6 6 0 1 1 10.174 4.31c-.203.196-.359.4-.453.619l-.762 1.769A.5.5 0 0 1 10.5 13a.5.5 0 0 1 0 1 .5.5 0 0 1 0 1l-.224.447a1 1 0 0 1-.894.553H6.618a1 1 0 0 1-.894-.553L5.5 15a.5.5 0 0 1 0-1 .5.5 0 0 1 0-1 .5.5 0 0 1-.46-.302l-.761-1.77a1.964 1.964 0 0 0-.453-.618A5.984 5.984 0 0 1 2 6zm6-5a5 5 0 0 0-3.479 8.592c.263.254.514.564.676.941L5.83 12h4.342l.632-1.467c.162-.377.413-.687.676-.941A5 5 0 0 0 8 1z"/>
                                                </svg>
                                                <span class="inspiring-count">{{ critique.inspiring_count|default:0 }}</span>
                                            </button>
                                            <button class="btn btn-sm btn-outline-info reaction-btn {% if critique.user_reactions and 'DETAILED' in critique.user_reactions %}active{% endif %}" 
                                                    data-critique-id="{{ critique.id }}" 
                                                    data-reaction-type="DETAILED"
                                                    onclick="toggleReaction(this, {{ critique.id }}, 'DETAILED')">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-card-text" viewBox="0 0 16 16">
                                                    <path d="M14.5 3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h13zm-13-1A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-13z"/>
                                                    <path d="M3 5.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 8a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 8zm0 2.5a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5z"/>
                                                </svg>
                                                <span class="detailed-count">{{ critique.detailed_count|default:0 }}</span>
                                            </button>
                                            {% endif %}
                                        </div>
                                        
                                        {% if user.is_authenticated and user == artwork.author %}
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                Actions
                                            </button>
                                            <ul class="dropdown-menu bg-dark border-secondary">
                                                {% if critique.is_hidden %}
                                                <li><button class="dropdown-item text-success" onclick="unhideCritique({{ critique.id }})">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-eye me-1" viewBox="0 0 16 16">
                                                        <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                                                        <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                                                    </svg>
                                                    Unhide
                                                </button></li>
                                                {% else %}
                                                <li><button class="dropdown-item text-warning" onclick="hideCritique({{ critique.id }})">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-eye-slash me-1" viewBox="0 0 16 16">
                                                        <path d="M13.359 11.238C15.06 9.72 16 8 16 8s-3-5.5-8-5.5a7.028 7.028 0 0 0-2.79.588l.77.771A5.944 5.944 0 0 1 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.134 13.134 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755-.165.165-.337.328-.517.486l.708.709z"/>
                                                        <path d="M11.297 9.176a3.5 3.5 0 0 0-4.474-4.474l.823.823a2.5 2.5 0 0 1 2.829 2.829l.822.822zm-2.943 1.299.822.822a3.5 3.5 0 0 1-4.474-4.474l.823.823a2.5 2.5 0 0 0 2.829 2.829z"/>
                                                        <path d="M3.35 5.47c-.18.16-.353.322-.518.487A13.134 13.134 0 0 0 1.172 8l.195.288c.335.48.83 1.12 1.465 1.755C4.121 11.332 5.881 12.5 8 12.5c.716 0 1.39-.133 2.02-.36l.77.772A7.029 7.029 0 0 1 8 13.5C3 13.5 0 8 0 8s.939-1.721 2.641-3.238l.708.709zm10.296 8.884-12-12 .708-.708 12 12-.708.708z"/>
                                                    </svg>
                                                    Hide
                                                </button></li>
                                                {% endif %}
                                                {% if user == critique.author %}
                                                <li><hr class="dropdown-divider border-secondary"></li>
                                                <li><button class="dropdown-item text-danger" onclick="deleteCritique({{ critique.id }})">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-trash me-1" viewBox="0 0 16 16">
                                                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                                    </svg>
                                                    Delete
                                                </button></li>
                                                {% endif %}
                                            </ul>
                                        </div>
                                        {% endif %}

                                        <!-- Action Controls -->
                                        <div class="action-controls d-flex gap-2">
                                            {% if user.is_authenticated %}
                                            <button class="btn btn-sm btn-outline-info reply-btn" onclick="toggleReplyForm({{ critique.id }})">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-reply me-1" viewBox="0 0 16 16">
                                                    <path d="M6.598 5.013a.144.144 0 0 1 .202.134V6.3a.5.5 0 0 0 .5.5c.667 0 2.013.005 3.3.822.984.624 1.99 1.76 2.595 3.876-1.02-.983-2.185-1.516-3.205-1.799a8.74 8.74 0 0 0-1.921-.306 7.404 7.404 0 0 0-.798.008h-.013l-.005.001h-.001L7.3 9.9l-.05-.498a.5.5 0 0 0-.45.498v1.153c0 .108-.11.176-.202.134L2.614 8.254a.503.503 0 0 0-.042-.028.147.147 0 0 1 0-.252.499.499 0 0 0 .042-.028l3.984-2.933zM7.8 10.386c.068 0 .143.003.223.006.434.02 1.034.086 1.7.271 1.326.368 2.896 1.202 3.94 3.08a.5.5 0 0 0 .933-.305c-.464-3.71-1.886-5.662-3.46-6.66-1.245-.79-2.527-.942-3.336-.971v-.66a1.144 1.144 0 0 0-1.767-.96l-3.994 2.94a1.147 1.147 0 0 0 0 1.946l3.994 2.94a1.144 1.144 0 0 0 1.767-.96v-.667z"/>
                                                </svg>
                                                Reply
                                            </button>
                                            {% endif %}

                                            {% if user.is_authenticated and user == artwork.author %}
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-three-dots me-1" viewBox="0 0 16 16">
                                                        <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
                                                    </svg>
                                                    Actions
                                                </button>
                                                <ul class="dropdown-menu bg-dark border-secondary">
                                                    {% if critique.is_hidden %}
                                                    <li><button class="dropdown-item text-success" onclick="unhideCritique({{ critique.id }})">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-eye me-1" viewBox="0 0 16 16">
                                                            <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                                                            <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                                                        </svg>
                                                        Unhide
                                                    </button></li>
                                                    {% else %}
                                                    <li><button class="dropdown-item text-warning" onclick="hideCritique({{ critique.id }})">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-eye-slash me-1" viewBox="0 0 16 16">
                                                            <path d="M13.359 11.238C15.06 9.72 16 8 16 8s-3-5.5-8-5.5a7.028 7.028 0 0 0-2.79.588l.77.771A5.944 5.944 0 0 1 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.134 13.134 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755-.165.165-.337.328-.517.486l.708.709z"/>
                                                            <path d="M11.297 9.176a3.5 3.5 0 0 0-4.474-4.474l.823.823a2.5 2.5 0 0 1 2.829 2.829l.822.822zm-2.943 1.299.822.822a3.5 3.5 0 0 1-4.474-4.474l.823.823a2.5 2.5 0 0 0 2.829 2.829z"/>
                                                            <path d="M3.35 5.47c-.18.16-.353.322-.518.487A13.134 13.134 0 0 0 1.172 8l.195.288c.335.48.83 1.12 1.465 1.755C4.121 11.332 5.881 12.5 8 12.5c.716 0 1.39-.133 2.02-.36l.77.772A7.029 7.029 0 0 1 8 13.5C3 13.5 0 8 0 8s.939-1.721 2.641-3.238l.708.709zm10.296 8.884-12-12 .708-.708 12 12-.708.708z"/>
                                                        </svg>
                                                        Hide
                                                    </button></li>
                                                    {% endif %}
                                                    {% if user == critique.author %}
                                                    <li><hr class="dropdown-divider border-secondary"></li>
                                                    <li><button class="dropdown-item text-danger" onclick="deleteCritique({{ critique.id }})">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-trash me-1" viewBox="0 0 16 16">
                                                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                                        </svg>
                                                        Delete
                                                    </button></li>
                                                    {% endif %}
                                                </ul>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No critiques yet. Be the first to share your feedback!</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script>
        // Toggle archived versions visibility (only for artwork authors)
        function toggleArchivedVersions() {
            const checkbox = document.getElementById('showArchivedVersions');
            
            // If toggle doesn't exist (non-author), do nothing
            if (!checkbox) {
                return;
            }
            
            const archivedVersions = document.querySelectorAll('.version-thumbnail[data-archived="true"]');
            
            if (checkbox.checked) {
                // Show archived versions
                archivedVersions.forEach(function(thumbnail) {
                    thumbnail.style.display = 'block';
                    thumbnail.style.opacity = '0.7';
                    // Add archived badge if not already present
                    if (!thumbnail.querySelector('.archived-badge')) {
                        const badge = document.createElement('div');
                        badge.className = 'archived-badge position-absolute top-0 start-0 m-1';
                        badge.innerHTML = '<span class="badge bg-secondary" style="font-size: 0.6rem;">Archived</span>';
                        thumbnail.querySelector('.position-relative').appendChild(badge);
                    }
                });
            } else {
                // Hide archived versions
                archivedVersions.forEach(function(thumbnail) {
                    thumbnail.style.display = 'none';
                });
            }
        }

        // Initialize archived version visibility on page load
        function initializeArchivedVersions() {
            const archivedVersions = document.querySelectorAll('.version-thumbnail[data-archived="true"]');
            archivedVersions.forEach(function(thumbnail) {
                thumbnail.style.display = 'none';
            });
        }

        // Call initialization when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeArchivedVersions();
            initializeDragAndDrop();
        });

        // Global variables for comparison
        let comparisonMode = false;
        let leftDroppedVersion = null;
        let rightDroppedVersion = null;

        // Toggle comparison mode
        function toggleComparisonMode() {
            const checkbox = document.getElementById('comparisonModeToggle');
            const comparisonInterface = document.getElementById('comparisonInterface');
            const versionThumbnails = document.querySelectorAll('.version-thumbnail');
            
            comparisonMode = checkbox.checked;
            
            if (comparisonMode) {
                comparisonInterface.style.display = 'block';
                // Enable drag functionality on version thumbnails
                versionThumbnails.forEach(thumbnail => {
                    thumbnail.classList.add('comparison-mode');
                    thumbnail.draggable = true;
                });
            } else {
                comparisonInterface.style.display = 'none';
                clearComparison();
                // Disable drag functionality
                versionThumbnails.forEach(thumbnail => {
                    thumbnail.classList.remove('comparison-mode');
                    thumbnail.draggable = false;
                });
            }
        }

        // Initialize drag and drop functionality
        function initializeDragAndDrop() {
            const versionThumbnails = document.querySelectorAll('.version-thumbnail');
            
            versionThumbnails.forEach(thumbnail => {
                thumbnail.addEventListener('dragstart', handleDragStart);
                thumbnail.addEventListener('dragend', handleDragEnd);
            });
        }

        // Handle drag start
        function handleDragStart(e) {
            if (!comparisonMode) return;
            
            e.target.classList.add('dragging');
            
            // Get the version data from the element's data attributes
            const versionElement = e.target.closest('.version-thumbnail') || e.target;
            const imgElement = versionElement.querySelector('img');
            const titleElement = versionElement.querySelector('small');
            
            const versionData = {
                id: versionElement.dataset.versionId || versionElement.dataset.version,
                artworkId: {{ artwork.id }},
                version_number: versionElement.dataset.versionNumber,
                number: versionElement.dataset.versionNumber,
                title: titleElement?.textContent?.trim() || `Version ${versionElement.dataset.versionNumber}`,
                image: imgElement?.src || null,
                image_url: imgElement?.src || null,
                description: versionElement.dataset.description || `Version ${versionElement.dataset.versionNumber}`,
                tags: versionElement.dataset.tags ? versionElement.dataset.tags.split(',') : [],
                created_at: versionElement.dataset.createdAt || new Date().toISOString(),
                status: versionElement.dataset.status || 'draft'
            };
            
            console.log('Dragging version data:', versionData); // Debug logging
            e.dataTransfer.setData('text/plain', JSON.stringify(versionData));
        }

        // Handle drag end
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        // Allow drop
        function allowDrop(e) {
            e.preventDefault();
        }

        // Highlight drop zone
        function highlightDropZone(e) {
            e.preventDefault();
            e.target.closest('.drop-zone').classList.add('highlight');
        }

        // Unhighlight drop zone
        function unhighlightDropZone(e) {
            e.target.closest('.drop-zone').classList.remove('highlight');
        }

        // Handle drop
        function handleDrop(e, side) {
            e.preventDefault();
            const dropZone = e.target.closest('.drop-zone');
            dropZone.classList.remove('highlight');
            
            try {
                const versionData = JSON.parse(e.dataTransfer.getData('text/plain'));
                addVersionToDropZone(versionData, side);
                updateCompareButton();
            } catch (error) {
                console.error('Error handling drop:', error);
                showToast('Error', 'Failed to add version to comparison', 'danger');
            }
        }

        // Add version to drop zone
        function addVersionToDropZone(versionData, side) {
            const dropZoneContent = document.querySelector(`#${side}DropZone .drop-zone-content`);
            const droppedVersionDiv = document.querySelector(`#${side}DroppedVersion`);
            
            // Hide the placeholder content
            dropZoneContent.style.display = 'none';
            
            // Show and populate the dropped version with proper vertical layout
            droppedVersionDiv.style.display = 'flex';
            droppedVersionDiv.style.flexDirection = 'column';
            droppedVersionDiv.style.alignItems = 'center';
            droppedVersionDiv.style.gap = '0.5rem';
            droppedVersionDiv.style.padding = '0.75rem';
            droppedVersionDiv.innerHTML = `
                <div class="version-thumbnail-container d-flex flex-column align-items-center" style="gap: 0.25rem;">
                    ${versionData.image ? 
                        `<img src="${versionData.image}" alt="${versionData.title}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px; border: 2px solid #28a745;">` : 
                        '<div class="bg-secondary d-flex align-items-center justify-content-center" style="width: 60px; height: 60px; border-radius: 6px; border: 2px solid #28a745;"><span class="text-muted small">No Image</span></div>'
                    }
                    <small class="text-white fw-bold text-center version-title" style="margin: 0.25rem 0; line-height: 1.2;">${versionData.title}</small>
                </div>
                <button class="btn btn-sm btn-outline-danger remove-btn" onclick="removeVersionFromDropZone('${side}')" style="margin-top: 0.25rem; font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-x me-1" viewBox="0 0 16 16">
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                    Remove
                </button>
            `;
            
            // Store the version data
            if (side === 'left') {
                leftDroppedVersion = versionData;
            } else {
                rightDroppedVersion = versionData;
            }
        }

        // Remove version from drop zone
        function removeVersionFromDropZone(side) {
            const dropZoneContent = document.querySelector(`#${side}DropZone .drop-zone-content`);
            const droppedVersionDiv = document.querySelector(`#${side}DroppedVersion`);
            
            // Show the placeholder content
            dropZoneContent.style.display = 'block';
            
            // Hide the dropped version
            droppedVersionDiv.style.display = 'none';
            droppedVersionDiv.innerHTML = '';
            
            // Clear the stored data
            if (side === 'left') {
                leftDroppedVersion = null;
            } else {
                rightDroppedVersion = null;
            }
            
            updateCompareButton();
        }

        // Clear comparison
        function clearComparison() {
            removeVersionFromDropZone('left');
            removeVersionFromDropZone('right');
        }

        // Update compare button state
        function updateCompareButton() {
            const compareButton = document.getElementById('compareButton');
            const canCompare = leftDroppedVersion && rightDroppedVersion;
            
            compareButton.disabled = !canCompare;
            compareButton.classList.toggle('btn-primary', canCompare);
            compareButton.classList.toggle('btn-secondary', !canCompare);
        }

        // Open version comparison modal
        function openVersionComparison() {
            if (!leftDroppedVersion || !rightDroppedVersion) {
                showToast('Error', 'Please select two versions to compare', 'warning');
                return;
            }
            
            // Get artwork ID from the page context or version data
            const artworkId = leftDroppedVersion.artworkId || rightDroppedVersion.artworkId || window.artworkId || {{ artwork.id }};
            const version1Id = leftDroppedVersion.id === 'current' ? 'current' : leftDroppedVersion.id;
            const version2Id = rightDroppedVersion.id === 'current' ? 'current' : rightDroppedVersion.id;
            
            // Debug logging
            console.log('Comparison data:', { 
                artworkId, 
                version1Id, 
                version2Id, 
                leftDroppedVersion, 
                rightDroppedVersion 
            });
            
            // Validate we have the required IDs - allow 'current' and numeric IDs
            if (!artworkId || 
                (version1Id !== 'current' && (!version1Id || version1Id === 'undefined')) || 
                (version2Id !== 'current' && (!version2Id || version2Id === 'undefined'))) {
                showToast('Error', 'Missing artwork or version data. Please try again.', 'danger');
                console.error('Missing data for comparison:', { 
                    artworkId, 
                    version1Id, 
                    version2Id, 
                    leftDroppedVersion, 
                    rightDroppedVersion 
                });
                return;
            }
            
            // Show loading animation
            const modalElement = document.getElementById('versionComparisonModal');
            const modal = new bootstrap.Modal(modalElement);
            const comparisonContent = document.getElementById('comparisonContent');
            
            // Add proper cleanup event handlers to prevent backdrop issues
            modalElement.addEventListener('hidden.bs.modal', function (event) {
                // Force removal of any lingering backdrop elements
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => backdrop.remove());
                
                // Reset body classes that might block interaction
                document.body.classList.remove('modal-open');
                document.body.style.removeProperty('padding-right');
                document.body.style.removeProperty('overflow');
                
                // Reset modal state
                modalElement.style.display = 'none';
                modalElement.setAttribute('aria-hidden', 'true');
                modalElement.removeAttribute('aria-modal');
                
                console.log('Modal cleanup completed - page interaction restored');
            });
            
            comparisonContent.innerHTML = `
                <div class="col-12 text-center py-5">
                    <div class="paintbrush-loader mx-auto mb-3"></div>
                    <p class="text-muted">Loading comparison...</p>
                </div>
            `;
            
            modal.show();
            
            // Use client-side comparison with available data
            setTimeout(() => {
                const mockData = {
                    version1: leftDroppedVersion,
                    version2: rightDroppedVersion,
                    differences: {}
                };
                
                // Calculate differences using proper property names
                const leftImage = leftDroppedVersion.image_url || leftDroppedVersion.image;
                const rightImage = rightDroppedVersion.image_url || rightDroppedVersion.image;
                
                if (leftImage !== rightImage) {
                    mockData.differences.image = true;
                }
                if (leftDroppedVersion.title !== rightDroppedVersion.title) {
                    mockData.differences.title = true;
                }
                if (leftDroppedVersion.description !== rightDroppedVersion.description) {
                    mockData.differences.description = true;
                }
                
                displayComparisonResults(mockData);
            }, 500); // Small delay to show loading animation
        }

        // Display comparison results with comprehensive analysis
        function displayComparisonResults(data) {
            const comparisonContent = document.getElementById('comparisonContent');
            const version1 = data.version1;
            const version2 = data.version2;
            const differences = data.differences || {};
            
            // Analyze and count differences
            const diffCount = analyzeDifferences(version1, version2, differences);
            updateComparisonStatus(diffCount, differences);
            
            comparisonContent.innerHTML = `
                <div class="col-6">
                    <div class="card bg-secondary h-100">
                        <div class="card-header bg-primary d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Version ${version1.version_number || 'Current'}</h6>
                            <span class="badge bg-light text-dark">${formatDate(version1.created_at)}</span>
                        </div>
                        <div class="card-body">
                            <!-- Image Section with Diff Highlighting -->
                            <div class="mb-3 position-relative">
                                ${(version1.image_url || version1.image) ? 
                                    `<img src="${version1.image_url || version1.image}" class="img-fluid rounded ${differences.image ? 'border border-warning border-3' : ''}" alt="Version ${version1.version_number}" style="max-height: 600px; width: 100%; object-fit: contain; cursor: pointer;" onclick="openImageModal('${version1.image_url || version1.image}', 'Version ${version1.version_number}')">
                                     ${differences.image ? '<div class="position-absolute top-0 end-0 m-2"><span class="badge bg-warning"><i class="bi bi-exclamation-triangle"></i> Changed</span></div>' : ''}` : 
                                    '<div class="bg-dark p-5 rounded text-center"><span class="text-muted">No Image</span></div>'
                                }
                            </div>
                            
                            <!-- Metadata with Diff Highlighting -->
                            <div class="small">
                                <div class="mb-3">
                                    <strong>Title:</strong>
                                    <div class="p-2 rounded ${differences.title ? 'bg-warning bg-opacity-25 border border-warning' : 'bg-dark'}">
                                        <span class="${differences.title ? 'text-warning fw-bold' : 'text-light'}">${version1.title || 'Untitled'}</span>
                                        ${differences.title ? '<span class="badge bg-warning ms-2">Changed</span>' : ''}
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <strong>Description:</strong>
                                    <div class="p-2 rounded ${differences.description ? 'bg-warning bg-opacity-25 border border-warning' : 'bg-dark'}">
                                        <span class="${differences.description ? 'text-warning' : 'text-muted'}">${version1.description || 'No description'}</span>
                                        ${differences.description ? '<span class="badge bg-warning ms-2">Changed</span>' : ''}
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <strong>Tags:</strong>
                                    <div class="p-2 rounded ${differences.tags ? 'bg-warning bg-opacity-25 border border-warning' : 'bg-dark'}">
                                        ${version1.tags && version1.tags.length > 0 ? 
                                            version1.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('') : 
                                            '<span class="text-muted">No tags</span>'
                                        }
                                        ${differences.tags ? '<span class="badge bg-warning ms-2">Changed</span>' : ''}
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <strong>Status:</strong>
                                    <div class="p-2 rounded ${differences.status ? 'bg-warning bg-opacity-25 border border-warning' : 'bg-dark'}">
                                        <span class="badge ${getStatusBadgeClass(version1.status)}">${version1.status || 'Draft'}</span>
                                        ${differences.status ? '<span class="badge bg-warning ms-2">Changed</span>' : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card bg-secondary h-100">
                        <div class="card-header bg-success d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Version ${version2.version_number || 'Current'}</h6>
                            <span class="badge bg-light text-dark">${formatDate(version2.created_at)}</span>
                        </div>
                        <div class="card-body">
                            <!-- Image Section with Diff Highlighting -->
                            <div class="mb-3 position-relative">
                                ${(version2.image_url || version2.image) ? 
                                    `<img src="${version2.image_url || version2.image}" class="img-fluid rounded ${differences.image ? 'border border-warning border-3' : ''}" alt="Version ${version2.version_number}" style="max-height: 600px; width: 100%; object-fit: contain; cursor: pointer;" onclick="openImageModal('${version2.image_url || version2.image}', 'Version ${version2.version_number}')">
                                     ${differences.image ? '<div class="position-absolute top-0 end-0 m-2"><span class="badge bg-warning"><i class="bi bi-exclamation-triangle"></i> Changed</span></div>' : ''}` : 
                                    '<div class="bg-dark p-5 rounded text-center"><span class="text-muted">No Image</span></div>'
                                }
                            </div>
                            
                            <!-- Metadata with Diff Highlighting -->
                            <div class="small">
                                <div class="mb-3">
                                    <strong>Title:</strong>
                                    <div class="p-2 rounded ${differences.title ? 'bg-warning bg-opacity-25 border border-warning' : 'bg-dark'}">
                                        <span class="${differences.title ? 'text-warning fw-bold' : 'text-light'}">${version2.title || 'Untitled'}</span>
                                        ${differences.title ? '<span class="badge bg-warning ms-2">Changed</span>' : ''}
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <strong>Description:</strong>
                                    <div class="p-2 rounded ${differences.description ? 'bg-warning bg-opacity-25 border border-warning' : 'bg-dark'}">
                                        <span class="${differences.description ? 'text-warning' : 'text-muted'}">${version2.description || 'No description'}</span>
                                        ${differences.description ? '<span class="badge bg-warning ms-2">Changed</span>' : ''}
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <strong>Tags:</strong>
                                    <div class="p-2 rounded ${differences.tags ? 'bg-warning bg-opacity-25 border border-warning' : 'bg-dark'}">
                                        ${version2.tags && version2.tags.length > 0 ? 
                                            version2.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('') : 
                                            '<span class="text-muted">No tags</span>'
                                        }
                                        ${differences.tags ? '<span class="badge bg-warning ms-2">Changed</span>' : ''}
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <strong>Status:</strong>
                                    <div class="p-2 rounded ${differences.status ? 'bg-warning bg-opacity-25 border border-warning' : 'bg-dark'}">
                                        <span class="badge ${getStatusBadgeClass(version2.status)}">${version2.status || 'Draft'}</span>
                                        ${differences.status ? '<span class="badge bg-warning ms-2">Changed</span>' : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                ${Object.keys(differences).length > 0 ? `
                <div class="col-12 mt-3">
                    <div class="card bg-dark">
                        <div class="card-header">
                            <h6 class="mb-0">Detected Differences</h6>
                        </div>
                        <div class="card-body">
                            ${Object.entries(differences).map(([field, diff]) => `
                                <div class="mb-2">
                                    <strong>${field.charAt(0).toUpperCase() + field.slice(1)}:</strong>
                                    <span class="text-warning">${diff}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
            
            // Setup overlay view with actual version data
            setupOverlayView(version1, version2);
        }
        
        // Analyze differences between versions
        function analyzeDifferences(version1, version2, differences) {
            let diffCount = 0;
            
            // Count existing differences from backend
            diffCount = Object.keys(differences).length;
            
            // Add client-side analysis for additional fields
            if (version1.title !== version2.title) diffCount++;
            if (version1.description !== version2.description) diffCount++;
            if (version1.image_url !== version2.image_url) diffCount++;
            
            return diffCount;
        }
        
        // Update comparison status display
        function updateComparisonStatus(diffCount, differences) {
            const statusElement = document.getElementById('comparisonStatus');
            const diffCountElement = document.getElementById('diffCount');
            
            if (diffCountElement) {
                diffCountElement.textContent = diffCount;
            }
            
            if (statusElement) {
                if (diffCount === 0) {
                    statusElement.innerHTML = '<span class="badge bg-success me-2">Identical</span>These versions are identical';
                } else {
                    const severity = diffCount > 3 ? 'danger' : diffCount > 1 ? 'warning' : 'info';
                    statusElement.innerHTML = `<span class="badge bg-${severity} me-2">${diffCount} Difference${diffCount > 1 ? 's' : ''}</span>Found changes between versions`;
                }
            }
        }
        
        // Setup advanced overlay view for image comparison
        function setupOverlayView(version1, version2) {
            const overlayContainer = document.getElementById('overlayContainer');
            
            if (!overlayContainer) return;
            
            const version1Image = version1.image_url || version1.image;
            const version2Image = version2.image_url || version2.image;
            
            if (version1Image && version2Image) {
                overlayContainer.innerHTML = `
                    <!-- Advanced Image Overlay Container -->
                    <div class="bg-dark" style="min-height: 75vh;">
                        <!-- Zoom and Blend Controls -->
                        <div class="p-2 bg-secondary border-bottom d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <label class="form-label text-light me-2 mb-0">Blend Mode:</label>
                                <select id="blendModeSelect" class="form-select form-select-sm" style="width: 140px;">
                                    <option value="normal">Normal</option>
                                    <option value="multiply">Multiply</option>
                                    <option value="screen">Screen</option>
                                    <option value="overlay">Overlay</option>
                                    <option value="difference">Difference</option>
                                    <option value="lighten">Lighten</option>
                                    <option value="darken">Darken</option>
                                    <option value="color-dodge">Color Dodge</option>
                                    <option value="color-burn">Color Burn</option>
                                    <option value="hard-light">Hard Light</option>
                                    <option value="soft-light">Soft Light</option>
                                    <option value="exclusion">Exclusion</option>
                                </select>
                            </div>
                            <div class="d-flex align-items-center">
                                <button id="zoomOut" class="btn btn-sm btn-outline-light me-2">-</button>
                                <span id="zoomLevel" class="text-light me-2">100%</span>
                                <button id="zoomIn" class="btn btn-sm btn-outline-light me-3">+</button>
                                <button id="resetZoom" class="btn btn-sm btn-outline-light">Reset</button>
                            </div>
                        </div>
                        
                        <!-- Zoomable Image Container -->
                        <div id="zoomContainer" class="position-relative overflow-hidden" style="height: 70vh; cursor: grab;">
                            <div id="imageWrapper" class="position-relative d-flex justify-content-center align-items-center h-100" 
                                 style="transform-origin: center center; transition: transform 0.2s ease;">
                                <img id="overlayBaseImage" src="${version1Image}" class="img-fluid" alt="Version ${version1.version_number}" 
                                     style="opacity: 1; display: block; max-height: 70vh; width: auto; object-fit: contain; pointer-events: none;"
                                     onload="initializeOverlayImages()">
                                <img id="overlayTopImage" src="${version2Image}" class="position-absolute top-0 start-0" alt="Version ${version2.version_number}" 
                                     style="opacity: 0.5; max-height: 70vh; width: auto; object-fit: contain; pointer-events: none; mix-blend-mode: normal;"
                                     onload="initializeOverlayImages()">
                            </div>
                        </div>
                        
                        <!-- Opacity and Position Controls -->
                        <div class="p-3 bg-secondary border-top">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <span class="badge bg-primary me-2">Base: v${version1.version_number || 'Current'}</span>
                                    <span class="badge bg-success">Overlay: v${version2.version_number || 'Current'}</span>
                                </div>
                                <div class="col-md-4 text-center">
                                    <label for="overlaySlider" class="form-label text-light mb-1">Overlay Opacity:</label>
                                    <div class="d-flex align-items-center justify-content-center">
                                        <input type="range" class="form-range" min="0" max="100" value="50" id="overlaySlider" style="width: 150px;">
                                        <span id="opacityValue" class="text-light ms-2">50%</span>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="d-flex justify-content-end align-items-center">
                                        <button id="toggleDraggable" class="btn btn-sm btn-outline-light me-2">
                                            <i class="bi bi-arrows-move"></i> Drag Mode
                                        </button>
                                        <button id="resetPosition" class="btn btn-sm btn-outline-light">
                                            <i class="bi bi-arrow-clockwise"></i> Reset
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Initialize all overlay functionality
                initializeOverlayControls();
                
                // Force immediate overlay setup - ensure both images are visible
                setTimeout(() => {
                    const baseImage = document.getElementById('overlayBaseImage');
                    const topImage = document.getElementById('overlayTopImage');
                    
                    if (baseImage && topImage) {
                        // Ensure base image is visible
                        baseImage.style.display = 'block';
                        baseImage.style.opacity = '1';
                        
                        // Ensure overlay image is visible with 50% opacity
                        topImage.style.display = 'block';
                        topImage.style.opacity = '0.5';
                        topImage.style.position = 'absolute';
                        topImage.style.top = '0';
                        topImage.style.left = '0';
                        
                        // Force image synchronization
                        initializeOverlayImages();
                        syncImageDimensions();
                        
                        console.log('Overlay comparison initialized:', {
                            baseVisible: baseImage.style.display !== 'none',
                            overlayVisible: topImage.style.display !== 'none',
                            overlayOpacity: topImage.style.opacity
                        });
                    }
                }, 200);
                
            } else {
                overlayContainer.innerHTML = `
                    <div class="text-center text-muted p-5 bg-dark" style="min-height: 60vh; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-image mb-3" viewBox="0 0 16 16">
                            <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                            <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093L6.5 10.5l-2.5-2.5a.5.5 0 0 0-.707 0L.002 10.5V3a1 1 0 0 1 1-1h12z"/>
                        </svg>
                        <p>Overlay view requires both versions to have images</p>
                    </div>
                `;
            }
        }
        
        // Global overlay state
        let overlayState = {
            zoom: 1,
            panX: 0,
            panY: 0,
            isDraggableMode: false,
            isDragging: false,
            lastMouseX: 0,
            lastMouseY: 0,
            overlayOffsetX: 0,
            overlayOffsetY: 0
        };
        
        // Initialize overlay images with perfect synchronization
        function initializeOverlayImages() {
            const baseImage = document.getElementById('overlayBaseImage');
            const topImage = document.getElementById('overlayTopImage');
            
            if (baseImage && topImage) {
                // Force overlay image to be visible and properly positioned
                topImage.style.display = 'block';
                topImage.style.opacity = '0.5';
                topImage.style.position = 'absolute';
                topImage.style.top = '0';
                topImage.style.left = '0';
                topImage.style.transform = 'translate(0px, 0px)';
                topImage.style.pointerEvents = 'none';
                
                // Reset overlay state
                overlayState.overlayOffsetX = 0;
                overlayState.overlayOffsetY = 0;
                
                // Wait for base image to load, then sync dimensions
                if (baseImage.complete) {
                    syncImageDimensions();
                } else {
                    baseImage.onload = syncImageDimensions;
                }
                
                // Also sync when overlay image loads
                if (topImage.complete) {
                    syncImageDimensions();
                } else {
                    topImage.onload = syncImageDimensions;
                }
            }
        }
        
        // Synchronize image dimensions for perfect overlay alignment
        function syncImageDimensions() {
            const baseImage = document.getElementById('overlayBaseImage');
            const topImage = document.getElementById('overlayTopImage');
            
            if (baseImage && topImage && baseImage.complete && topImage.complete) {
                // Get the actual displayed dimensions of the base image
                const baseRect = baseImage.getBoundingClientRect();
                
                // Apply exact same dimensions to overlay image
                topImage.style.width = baseRect.width + 'px';
                topImage.style.height = baseRect.height + 'px';
                topImage.style.objectFit = 'contain';
                
                console.log('Overlay images synchronized:', {
                    baseSize: { width: baseRect.width, height: baseRect.height },
                    overlayOpacity: topImage.style.opacity
                });
            }
        }
        
        // Initialize all overlay controls
        function initializeOverlayControls() {
            // Opacity slider - ensure it works immediately
            const slider = document.getElementById('overlaySlider');
            const opacityValue = document.getElementById('opacityValue');
            if (slider && opacityValue) {
                // Set initial opacity value
                slider.value = 50;
                opacityValue.textContent = '50%';
                
                slider.addEventListener('input', function() {
                    const topImage = document.getElementById('overlayTopImage');
                    if (topImage) {
                        const newOpacity = this.value / 100;
                        topImage.style.opacity = newOpacity;
                        opacityValue.textContent = this.value + '%';
                        
                        // Ensure image is visible
                        if (newOpacity > 0) {
                            topImage.style.display = 'block';
                        }
                    }
                });
                
                // Force initial overlay visibility
                setTimeout(() => {
                    const topImage = document.getElementById('overlayTopImage');
                    if (topImage) {
                        topImage.style.opacity = '0.5';
                        topImage.style.display = 'block';
                    }
                }, 100);
            }
            
            // Blend mode selector
            const blendSelect = document.getElementById('blendModeSelect');
            if (blendSelect) {
                blendSelect.addEventListener('change', function() {
                    const topImage = document.getElementById('overlayTopImage');
                    if (topImage) {
                        topImage.style.mixBlendMode = this.value;
                    }
                });
            }
            
            // Zoom controls
            const zoomIn = document.getElementById('zoomIn');
            const zoomOut = document.getElementById('zoomOut');
            const resetZoom = document.getElementById('resetZoom');
            const zoomLevel = document.getElementById('zoomLevel');
            
            if (zoomIn) {
                zoomIn.addEventListener('click', () => {
                    overlayState.zoom = Math.min(overlayState.zoom * 1.2, 5);
                    updateZoom();
                });
            }
            
            if (zoomOut) {
                zoomOut.addEventListener('click', () => {
                    overlayState.zoom = Math.max(overlayState.zoom / 1.2, 0.1);
                    updateZoom();
                });
            }
            
            if (resetZoom) {
                resetZoom.addEventListener('click', () => {
                    overlayState.zoom = 1;
                    overlayState.panX = 0;
                    overlayState.panY = 0;
                    updateZoom();
                });
            }
            
            // Draggable toggle
            const toggleDraggable = document.getElementById('toggleDraggable');
            if (toggleDraggable) {
                toggleDraggable.addEventListener('click', () => {
                    overlayState.isDraggableMode = !overlayState.isDraggableMode;
                    toggleDraggable.innerHTML = overlayState.isDraggableMode ? 
                        '<i class="bi bi-arrows-move"></i> Exit Drag' : 
                        '<i class="bi bi-arrows-move"></i> Drag Mode';
                    toggleDraggable.classList.toggle('btn-outline-light');
                    toggleDraggable.classList.toggle('btn-warning');
                    
                    const topImage = document.getElementById('overlayTopImage');
                    if (topImage) {
                        topImage.style.cursor = overlayState.isDraggableMode ? 'move' : 'pointer';
                        topImage.style.pointerEvents = overlayState.isDraggableMode ? 'auto' : 'none';
                    }
                });
            }
            
            // Reset position
            const resetPosition = document.getElementById('resetPosition');
            if (resetPosition) {
                resetPosition.addEventListener('click', () => {
                    overlayState.overlayOffsetX = 0;
                    overlayState.overlayOffsetY = 0;
                    updateOverlayPosition();
                });
            }
            
            // Pan and zoom with mouse wheel - zoom toward cursor
            const zoomContainer = document.getElementById('zoomContainer');
            if (zoomContainer) {
                zoomContainer.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const rect = zoomContainer.getBoundingClientRect();
                    
                    // Capture mouse position only during zoom event
                    const mouseX = e.clientX - rect.left;
                    const mouseY = e.clientY - rect.top;
                    
                    // Set transform origin to current mouse position for this zoom
                    const imageWrapper = document.getElementById('imageWrapper');
                    if (imageWrapper) {
                        const originX = (mouseX / rect.width) * 100;
                        const originY = (mouseY / rect.height) * 100;
                        imageWrapper.style.transformOrigin = `${originX}% ${originY}%`;
                    }
                    
                    const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
                    const newZoom = Math.min(Math.max(overlayState.zoom * zoomFactor, 0.1), 5);
                    
                    overlayState.zoom = newZoom;
                    updateZoom();
                });
                
                // Pan with mouse drag
                let isPanning = false;
                let lastPanX = 0;
                let lastPanY = 0;
                
                zoomContainer.addEventListener('mousedown', (e) => {
                    if (!overlayState.isDraggableMode) {
                        isPanning = true;
                        lastPanX = e.clientX;
                        lastPanY = e.clientY;
                        zoomContainer.style.cursor = 'grabbing';
                    }
                });
                
                zoomContainer.addEventListener('mousemove', (e) => {
                    if (isPanning && !overlayState.isDraggableMode) {
                        const deltaX = e.clientX - lastPanX;
                        const deltaY = e.clientY - lastPanY;
                        overlayState.panX += deltaX;
                        overlayState.panY += deltaY;
                        lastPanX = e.clientX;
                        lastPanY = e.clientY;
                        updateZoom();
                    }
                });
                
                zoomContainer.addEventListener('mouseup', () => {
                    isPanning = false;
                    zoomContainer.style.cursor = 'grab';
                });
                
                zoomContainer.addEventListener('mouseleave', () => {
                    isPanning = false;
                    zoomContainer.style.cursor = 'grab';
                });
            }
            
            // Overlay image dragging
            setupOverlayDragging();
        }
        
        // Update zoom transform with proper transform origin
        function updateZoom() {
            const imageWrapper = document.getElementById('imageWrapper');
            const zoomLevel = document.getElementById('zoomLevel');
            
            if (imageWrapper) {
                // Apply both pan and zoom transformations
                imageWrapper.style.transform = `translate(${overlayState.panX}px, ${overlayState.panY}px) scale(${overlayState.zoom})`;
                
                // Ensure transform origin is maintained (set by mousemove event)
                if (!imageWrapper.style.transformOrigin) {
                    imageWrapper.style.transformOrigin = 'center center';
                }
            }
            
            if (zoomLevel) {
                zoomLevel.textContent = Math.round(overlayState.zoom * 100) + '%';
            }
        }
        
        // Setup overlay image dragging
        function setupOverlayDragging() {
            const topImage = document.getElementById('overlayTopImage');
            if (!topImage) return;
            
            topImage.addEventListener('mousedown', (e) => {
                if (overlayState.isDraggableMode) {
                    overlayState.isDragging = true;
                    overlayState.lastMouseX = e.clientX;
                    overlayState.lastMouseY = e.clientY;
                    e.preventDefault();
                }
            });
            
            document.addEventListener('mousemove', (e) => {
                if (overlayState.isDragging && overlayState.isDraggableMode) {
                    const deltaX = e.clientX - overlayState.lastMouseX;
                    const deltaY = e.clientY - overlayState.lastMouseY;
                    
                    overlayState.overlayOffsetX += deltaX / overlayState.zoom;
                    overlayState.overlayOffsetY += deltaY / overlayState.zoom;
                    
                    overlayState.lastMouseX = e.clientX;
                    overlayState.lastMouseY = e.clientY;
                    
                    updateOverlayPosition();
                }
            });
            
            document.addEventListener('mouseup', () => {
                overlayState.isDragging = false;
            });
        }
        
        // Update overlay image position
        function updateOverlayPosition() {
            const topImage = document.getElementById('overlayTopImage');
            if (topImage) {
                topImage.style.transform = `translate(${overlayState.overlayOffsetX}px, ${overlayState.overlayOffsetY}px)`;
            }
        }
        
        // Swap versions in comparison
        function swapVersions() {
            if (!leftDroppedVersion || !rightDroppedVersion) return;
            
            // Swap the global variables
            const temp = leftDroppedVersion;
            leftDroppedVersion = rightDroppedVersion;
            rightDroppedVersion = temp;
            
            // Re-fetch and display comparison
            openVersionComparison();
            
            showToast('Success', 'Versions swapped successfully', 'success');
        }
        
        // Helper function to format dates
        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            try {
                return new Date(dateString).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (e) {
                return 'Invalid date';
            }
        }
        
        // Helper function to get status badge class
        function getStatusBadgeClass(status) {
            switch(status?.toLowerCase()) {
                case 'published': return 'bg-success';
                case 'draft': return 'bg-secondary';
                case 'archived': return 'bg-warning';
                case 'private': return 'bg-info';
                default: return 'bg-secondary';
            }
        }
        
        // Initialize view mode switching for comparison modal
        document.addEventListener('DOMContentLoaded', function() {
            // Setup view mode toggle functionality
            const versionModal = document.getElementById('versionComparisonModal');
            if (versionModal) {
                versionModal.addEventListener('shown.bs.modal', function() {
                    setupViewModeToggle();
                });
            }
        });
        
        // Open image in fullscreen modal overlay
        function openImageModal(imageUrl, title) {
            if (!imageUrl) return;
            
            // Create modal if it doesn't exist
            let imageModal = document.getElementById('imageModal');
            if (!imageModal) {
                const modalHtml = `
                    <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-fullscreen">
                            <div class="modal-content bg-dark">
                                <div class="modal-header border-0">
                                    <h5 class="modal-title text-white" id="imageModalTitle">${title || 'Image'}</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body d-flex align-items-center justify-content-center p-0">
                                    <img id="modalImage" src="${imageUrl}" class="img-fluid" style="max-height: 100vh; max-width: 100vw; object-fit: contain;">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                imageModal = document.getElementById('imageModal');
            } else {
                // Update existing modal
                document.getElementById('imageModalTitle').textContent = title || 'Image';
                document.getElementById('modalImage').src = imageUrl;
            }
            
            // Show the modal
            const modal = new bootstrap.Modal(imageModal);
            modal.show();
        }

        // Setup view mode toggle functionality
        function setupViewModeToggle() {
            const sideBySideMode = document.getElementById('sideBySideMode');
            const overlayMode = document.getElementById('overlayMode');
            const sideBySideView = document.getElementById('sideBySideView');
            const overlayView = document.getElementById('overlayView');
            
            if (sideBySideMode && overlayMode && sideBySideView && overlayView) {
                sideBySideMode.addEventListener('change', function() {
                    if (this.checked) {
                        sideBySideView.style.display = 'block';
                        overlayView.style.display = 'none';
                    }
                });
                
                overlayMode.addEventListener('change', function() {
                    if (this.checked) {
                        sideBySideView.style.display = 'none';
                        overlayView.style.display = 'block';
                    }
                });
            }
        }

        // Function to show delete version modal
        function deleteVersion(versionId, versionNumber) {
            const modalHtml = `
                <div class="modal fade" id="deleteVersionModal" tabindex="-1" aria-labelledby="deleteVersionModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content bg-dark text-white">
                            <div class="modal-header border-secondary">
                                <h5 class="modal-title" id="deleteVersionModalLabel">Delete Version ${versionNumber}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p>Are you sure you want to permanently delete version ${versionNumber}? This action cannot be undone.</p>
                                <div class="alert alert-warning">
                                    <strong>Warning:</strong> This will permanently remove the version and all associated data.
                                </div>
                            </div>
                            <div class="modal-footer border-secondary">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger" onclick="confirmDeleteVersion(${versionId})">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash me-1" viewBox="0 0 16 16">
                                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                    </svg>
                                    Delete Version
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('deleteVersionModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('deleteVersionModal'));
            modal.show();
        }

        function confirmDeleteVersion(versionId) {
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // Show loading state
            const deleteBtn = document.querySelector('#deleteVersionModal .btn-danger');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span>Deleting...';
            deleteBtn.disabled = true;

            // Send delete request
            fetch(`/api/artworks/versions/${versionId}/delete/`, {
                method: 'DELETE',
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteVersionModal'));
                modal.hide();

                // Show success message
                showToast('Success', 'Version deleted successfully.', 'success');

                // Remove the version thumbnail from the page
                const versionThumbnail = document.querySelector(`[data-version="${versionId}"]`);
                if (versionThumbnail) {
                    versionThumbnail.remove();
                }

                // Refresh page after a delay
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            })
            .catch(error => {
                console.error('Error deleting version:', error);

                // Reset button
                deleteBtn.innerHTML = originalText;
                deleteBtn.disabled = false;

                // Show error message
                showToast('Error', 'Failed to delete version. Please try again.', 'danger');
            });
        }

        // Function to unarchive a version
        function unarchiveVersion(versionId) {
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // Send unarchive request
            fetch(`/api/versions/${versionId}/unarchive/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // Show success message
                showToast('Success', 'Version unarchived successfully.', 'success');

                // Refresh page after a delay
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            })
            .catch(error => {
                console.error('Error unarchiving version:', error);
                // Show error message
                showToast('Error', 'Failed to unarchive version. Please try again.', 'danger');
            });
        }

        // Archive version function (existing)
        function archiveVersion(versionId, versionNumber) {
            const modalHtml = `
                <div class="modal fade" id="archiveVersionModal" tabindex="-1" aria-labelledby="archiveVersionModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content bg-dark text-white">
                            <div class="modal-header border-secondary">
                                <h5 class="modal-title" id="archiveVersionModalLabel">Archive Version ${versionNumber}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p>Are you sure you want to archive version ${versionNumber}? Archived versions are hidden from public view but can be restored later.</p>
                                <div class="mb-3">
                                    <label for="archiveReason" class="form-label">Reason for archiving (optional):</label>
                                    <textarea id="archiveReason" class="form-control bg-dark text-white border-secondary" rows="3" placeholder="Why are you archiving this version?"></textarea>
                                </div>
                            </div>
                            <div class="modal-footer border-secondary">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-warning" onclick="confirmArchiveVersion(${versionId})">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-archive me-1" viewBox="0 0 16 16">
                                        <path d="M0 2a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1v7.5a2.5 2.5 0 0 1-2.5 2.5h-9A2.5 2.5 0 0 1 1 12.5V5a1 1 0 0 1-1-1V2zm2 3v7.5A1.5 1.5 0 0 0 3.5 14h9a1.5 1.5 0 0 0 1.5-1.5V5H2zm13-3H1v2h14V2zM5 7.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
                                    </svg>
                                    Archive Version
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('archiveVersionModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('archiveVersionModal'));
            modal.show();
        }

        function confirmArchiveVersion(versionId) {
            // Get CSRF token and reason
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const reason = document.getElementById('archiveReason').value;

            // Show loading state
            const archiveBtn = document.querySelector('#archiveVersionModal .btn-warning');
            const originalText = archiveBtn.innerHTML;
            archiveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span>Archiving...';
            archiveBtn.disabled = true;

            // Send archive request
            fetch(`/api/versions/${versionId}/archive/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    reason: reason
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('archiveVersionModal'));
                modal.hide();

                // Show success message
                showToast('Success', 'Version archived successfully.', 'success');

                // Refresh page after a delay
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            })
            .catch(error => {
                console.error('Error archiving version:', error);

                // Reset button
                archiveBtn.innerHTML = originalText;
                archiveBtn.disabled = false;

                // Show error message
                showToast('Error', 'Failed to archive version. Please try again.', 'danger');
            });
        }

        // Function to unarchive a version
        function unarchiveVersion(versionId) {
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // Send unarchive request
            fetch(`/api/versions/${versionId}/unarchive/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // Show success message
                showToast('Success', 'Version unarchived successfully.', 'success');

                // Refresh page after a delay
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            })
            .catch(error => {
                console.error('Error unarchiving version:', error);
                showToast('Error', 'Failed to unarchive version. Please try again.', 'danger');
            });
        }

        // Helper function to show toast notifications
        function showToast(title, message, type) {
            // Implementation depends on your toast system
            const alertType = type === 'success' ? 'alert-success' : 'alert-danger';
            const toast = document.createElement('div');
            toast.className = `alert ${alertType} position-fixed top-0 end-0 m-3`;
            toast.style.zIndex = '9999';
            toast.innerHTML = `<strong>${title}:</strong> ${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Function to delete critique
        function deleteCritique(critiqueId) {
            if (!confirm('Are you sure you want to delete this critique? This action cannot be undone.')) {
                return;
            }

            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // Send delete request
            fetch(`/api/critiques/${critiqueId}/`, {
                method: 'DELETE',
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.detail || 'Failed to delete critique');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Hide the critique card
                const critiqueCard = document.getElementById(`critique-${critiqueId}`);
                if (critiqueCard) {
                    critiqueCard.style.opacity = '0.5';
                    critiqueCard.innerHTML = '<div class="card-body text-center text-muted">Critique deleted successfully. Page will refresh...</div>';
                }
                
                // Show success message
                showToast('Success', 'Critique deleted successfully.', 'success');
                
                // Refresh page after a delay
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            })
            .catch(error => {
                console.error('Error deleting critique:', error);
                showToast('Error', error.message || 'Failed to delete critique. Please try again.', 'danger');
            });
        }

        // Enhanced Critique Sorting System
        function sortCritiques(sortBy) {
            const critiqueContainer = document.querySelector('.card-body');
            const critiques = Array.from(document.querySelectorAll('.critique-card'));
            
            critiques.sort((a, b) => {
                switch (sortBy) {
                    case 'helpful':
                        return parseInt(b.dataset.helpfulCount) - parseInt(a.dataset.helpfulCount);
                    case 'recent':
                        return new Date(b.dataset.created) - new Date(a.dataset.created);
                    case 'oldest':
                        return new Date(a.dataset.created) - new Date(b.dataset.created);
                    case 'rating':
                        return parseInt(b.dataset.rating) - parseInt(a.dataset.rating);
                    default:
                        return 0;
                }
            });
            
            // Reorder DOM elements
            const sortingControls = document.querySelector('.d-flex.justify-content-between.align-items-center.mb-3');
            critiques.forEach(critique => critiqueContainer.appendChild(critique));
            
            // Move sorting controls back to top
            critiqueContainer.insertBefore(sortingControls, critiqueContainer.firstChild);
            
            showToast('Sorted', `Critiques sorted by ${sortBy}`, 'success');
        }

        // Compact View Toggle
        document.addEventListener('DOMContentLoaded', function() {
            const compactToggle = document.getElementById('collapseMode');
            if (compactToggle) {
                compactToggle.addEventListener('change', function() {
                    const critiqueBodies = document.querySelectorAll('[id^="critique-body-"]');
                    critiqueBodies.forEach(body => {
                        if (this.checked) {
                            // Collapse all critiques
                            const collapse = new bootstrap.Collapse(body, { toggle: false });
                            collapse.hide();
                        } else {
                            // Expand all critiques
                            const collapse = new bootstrap.Collapse(body, { toggle: false });
                            collapse.show();
                        }
                    });
                });
            }
        });

        // Toggle Reply Form
        function toggleReplyForm(critiqueId) {
            const replyForm = document.getElementById(`reply-form-${critiqueId}`);
            const isVisible = replyForm.style.display !== 'none';
            
            // Hide all other reply forms
            document.querySelectorAll('.reply-form-container').forEach(form => {
                form.style.display = 'none';
            });
            
            // Toggle current form
            if (!isVisible) {
                replyForm.style.display = 'block';
                const textarea = replyForm.querySelector('textarea');
                textarea.focus();
            }
        }

        // Handle Reply Form Submission
        document.addEventListener('DOMContentLoaded', function() {
            // Reply form submission
            document.querySelectorAll('.reply-form').forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const critiqueId = this.dataset.critiqueId;
                    const textarea = this.querySelector('textarea');
                    const replyText = textarea.value.trim();
                    
                    if (!replyText) {
                        showToast('Error', 'Please enter a reply message.', 'danger');
                        return;
                    }
                    
                    // Get CSRF token
                    const csrfToken = this.querySelector('[name=csrfmiddlewaretoken]').value;
                    
                    // Submit reply
                    fetch(`/api/critiques/${critiqueId}/replies/`, {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'X-Requested-With': 'XMLHttpRequest',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ text: replyText })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to post reply');
                        }
                        return response.json();
                    })
                    .then(data => {
                        showToast('Success', 'Reply posted successfully!', 'success');
                        // Refresh page to show new reply
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    })
                    .catch(error => {
                        console.error('Error posting reply:', error);
                        showToast('Error', 'Failed to post reply. Please try again.', 'danger');
                    });
                });
            });
            
            // Cancel reply buttons
            document.querySelectorAll('.cancel-reply').forEach(button => {
                button.addEventListener('click', function() {
                    const replyForm = this.closest('.reply-form-container');
                    replyForm.style.display = 'none';
                    replyForm.querySelector('textarea').value = '';
                });
            });
        });

        // Enhanced Collapse Button Rotation
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.critique-collapse-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const icon = this.querySelector('svg');
                    const targetId = this.getAttribute('data-bs-target');
                    const target = document.querySelector(targetId);
                    
                    target.addEventListener('shown.bs.collapse', function() {
                        icon.style.transform = 'rotate(0deg)';
                    });
                    
                    target.addEventListener('hidden.bs.collapse', function() {
                        icon.style.transform = 'rotate(-90deg)';
                    });
                });
            });
        });

        // Function to switch back to current version
        function switchToCurrentVersion(artworkId) {
            // Simply reload the page to show the current version
            window.location.href = `/artworks/${artworkId}/`;
        }

        // Function to switch to a different version
        function switchToVersion(artworkId, versionId) {
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // Show loading state
            const mainImage = document.getElementById('main-artwork-image');
            const originalContent = mainImage.outerHTML;
            
            mainImage.innerHTML = '<div class="d-flex justify-content-center align-items-center" style="height: 200px;"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

            // Send switch request
            fetch(`/api/artworks/${artworkId}/switch-version/${versionId}/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // Update the main image
                if (data.image_url) {
                    const newImg = document.createElement('img');
                    newImg.src = data.image_url;
                    newImg.className = 'card-img-top img-fluid';
                    newImg.alt = data.title || 'Artwork';
                    newImg.style.maxHeight = '500px';
                    newImg.style.objectFit = 'contain';
                    newImg.id = 'main-artwork-image';
                    
                    mainImage.parentNode.replaceChild(newImg, mainImage);
                } else {
                    // No image available
                    const noImageDiv = document.createElement('div');
                    noImageDiv.className = 'bg-secondary text-white d-flex justify-content-center align-items-center';
                    noImageDiv.style.height = '400px';
                    noImageDiv.id = 'main-artwork-image';
                    noImageDiv.innerHTML = '<span>No Image Available</span>';
                    
                    mainImage.parentNode.replaceChild(noImageDiv, mainImage);
                }

                // Update version badge if it exists
                const versionBadge = document.querySelector('.badge.bg-secondary');
                if (versionBadge && data.version_number) {
                    versionBadge.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-clock-history me-1" viewBox="0 0 16 16">
                            <path d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022l-.074.997zm2.004.45a7.003 7.003 0 0 0-.985-.299l.219-.976c.383.086.76.2 1.126.342l-.36.933zm1.37.71a7.01 7.01 0 0 0-.439-.27l.493-.87a8.025 8.025 0 0 1 .979.654l-.615.789a6.996 6.996 0 0 0-.418-.302zm1.834 1.79a6.99 6.99 0 0 0-.653-.796l.724-.69c.27.285.52.59.747.91l-.818.576zm.744 1.352a7.08 7.08 0 0 0-.214-.468l.893-.45a7.976 7.976 0 0 1 .45 1.088l-.942.313a7.023 7.023 0 0 0-.187-.483zm.53 2.507a6.991 6.991 0 0 0-.1-1.025l.985-.17c.067.386.106.778.116 1.17l-1.001.025zm-.131 1.538c.033-.17.06-.339.081-.51l.993.123a7.957 7.957 0 0 1-.23 1.155l-.964-.267c.046-.165.086-.332.12-.501zm-.952 2.379c.184-.29.346-.594.486-.908l.914.405c-.16.36-.345.706-.555 1.038l-.845-.535zm-1.442 1.633c.263-.226.509-.467.740-.722l.724.69a8.026 8.026 0 0 1-.989.912l-.475-.88zm-2.266.97c.342-.14.677-.296.99-.49l.546.837a7.972 7.972 0 0 1-1.198.596l-.338-.943zm-2.137.339c.37-.042.741-.111 1.106-.207l.238.971a7.998 7.998 0 0 1-1.425.267l.081-.031z"/>
                            <path d="M8 1a7 7 0 1 0 4.95 11.95l.707.707A8.001 8.001 0 1 1 8 0v1z"/>
                            <path d="M7.5 3a.5.5 0 0 1 .5.5v5.21l3.248 1.856a.5.5 0 0 1-.496.868l-3.5-2A.5.5 0 0 1 7 9V3.5a.5.5 0 0 1 .5-.5z"/>
                        </svg>
                        Version ${data.version_number} of ${data.total_versions}
                    `;
                }

                // Show success message
                showToast('Success', `Switched to version ${data.version_number}`, 'success');
            })
            .catch(error => {
                console.error('Error switching version:', error);
                
                // Restore original content
                mainImage.outerHTML = originalContent;
                
                // Show error message
                showToast('Error', 'Failed to switch version. Please try again.', 'danger');
            });
        }

        // Function to hide a critique
        function hideCritique(critiqueId) {
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch(`/api/critiques/${critiqueId}/hide/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // Hide the critique card
                const critiqueCard = document.getElementById(`critique-${critiqueId}`);
                if (critiqueCard) {
                    critiqueCard.style.opacity = '0.5';
                    critiqueCard.innerHTML += '<div class="position-absolute top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-flex align-items-center justify-content-center"><span class="badge bg-warning">Hidden</span></div>';
                }
                showToast('Success', 'Critique hidden successfully.', 'success');
            })
            .catch(error => {
                console.error('Error hiding critique:', error);
                showToast('Error', 'Failed to hide critique. Please try again.', 'danger');
            });
        }

        // Function to unhide a critique
        function unhideCritique(critiqueId) {
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch(`/api/critiques/${critiqueId}/unhide/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // Restore the critique card
                const critiqueCard = document.getElementById(`critique-${critiqueId}`);
                if (critiqueCard) {
                    critiqueCard.style.opacity = '1';
                    const hiddenOverlay = critiqueCard.querySelector('.position-absolute');
                    if (hiddenOverlay) {
                        hiddenOverlay.remove();
                    }
                }
                showToast('Success', 'Critique unhidden successfully.', 'success');
            })
            .catch(error => {
                console.error('Error unhiding critique:', error);
                showToast('Error', 'Failed to unhide critique. Please try again.', 'danger');
            });
        }

        // Function to open image in full-size modal
        function openImageModal(imageSrc, title) {
            // Create modal HTML
            const modalHTML = `
                <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl modal-dialog-centered">
                        <div class="modal-content bg-dark">
                            <div class="modal-header border-secondary">
                                <h5 class="modal-title text-white" id="imageModalLabel">${title}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body text-center p-2">
                                <img src="${imageSrc}" class="img-fluid" style="max-height: 80vh; max-width: 100%; object-fit: contain;" alt="${title}">
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('imageModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('imageModal'));
            modal.show();

            // Clean up modal when hidden
            document.getElementById('imageModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        }


    </script>
{% endblock %}