{% extends 'critique/base.html' %}

{% block title %}{{ artwork.title }} - Brush Up{% endblock %}

{% block extra_head %}
<style>
    /* Focus Mode Styles */
    #focus-mode {
        position: relative;
        height: 100vh;
        background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
    }

    #focus-artwork {
        max-width: 90vw;
        max-height: 90vh;
        object-fit: contain;
        cursor: pointer;
        box-shadow: 0 20px 60px rgba(0,0,0,0.8);
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    #focus-artwork:hover {
        transform: scale(1.02);
        box-shadow: 0 25px 80px rgba(0,0,0,0.9);
    }

    #delayed-ui {
        position: absolute;
        bottom: 10%;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
        justify-content: center;
        opacity: 0;
        animation: fadeInDelayed 1.5s ease 2s forwards;
    }

    @keyframes fadeInDelayed {
        to { opacity: 1; }
    }

    .focus-ui-element {
        background: rgba(255,255,255,0.15);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.2);
        color: white;
        padding: 12px 24px;
        text-decoration: none;
        border-radius: 25px;
        transition: all 0.3s ease;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .focus-ui-element:hover {
        background: rgba(255,255,255,0.25);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .favorite-btn {
        background: rgba(220,53,69,0.15);
        border: 1px solid rgba(220,53,69,0.3);
        color: #dc3545;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
    }

    .favorite-btn:hover {
        background: rgba(220,53,69,0.25);
        transform: scale(1.1);
    }

    .version-chip {
        background: rgba(13,110,253,0.15);
        border: 1px solid rgba(13,110,253,0.3);
        color: #0d6efd;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .btn-add-critique {
        background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%) !important;
        border: none !important;
        box-shadow: 0 4px 15px rgba(13,110,253,0.4);
    }

    .btn-add-critique:hover {
        background: linear-gradient(135deg, #0056b3 0%, #004085 100%) !important;
        transform: translateY(-2px);
        box-shadow: 0 6px 25px rgba(13,110,253,0.6);
    }

    .scroll-indicator {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: white;
        animation: bounce 2s infinite;
        transition: all 0.3s ease;
    }

    .scroll-indicator:hover {
        background: rgba(255,255,255,0.2);
        transform: translateX(-50%) translateY(-3px);
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {
            transform: translateX(-50%) translateY(0);
        }
        40% {
            transform: translateX(-50%) translateY(-10px);
        }
        60% {
            transform: translateX(-50%) translateY(-5px);
        }
    }

    /* Hide main content initially */
    #main-content {
        opacity: 0;
        transition: opacity 0.5s ease;
    }

    #main-content.visible {
        opacity: 1;
    }

    /* Smooth scroll behavior */
    html {
        scroll-behavior: smooth;
    }
    /* Enhanced Critique System Styles */
    .critique-card {
        transition: all 0.3s ease;
        border: 1px solid rgba(108, 117, 125, 0.3) !important;
    }
    
    .critique-card:hover {
        border-color: rgba(13, 110, 253, 0.5) !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }
    
    .rating-bar-container {
        margin-bottom: 8px;
    }
    
    .progress {
        background-color: rgba(108, 117, 125, 0.2) !important;
    }
    
    .critique-collapse-btn svg {
        transition: transform 0.3s ease;
    }
    
    .reaction-btn {
        transition: all 0.2s ease;
        border-radius: 20px !important;
        padding: 4px 12px !important;
    }
    
    .reaction-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .reaction-btn.active {
        background-color: var(--bs-primary) !important;
        border-color: var(--bs-primary) !important;
        color: white !important;
    }
    
    .reply-form-container {
        animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .replies-container {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .reply-item {
        transition: background-color 0.2s ease;
    }
    
    .reply-item:hover {
        background-color: rgba(108, 117, 125, 0.2) !important;
    }
    
    .critique-text {
        line-height: 1.6;
    }
    
    .card-header {
        border-bottom: 1px solid rgba(108, 117, 125, 0.2) !important;
    }
    
    .card-footer {
        border-top: 1px solid rgba(108, 117, 125, 0.2) !important;
    }
    
    .dropdown-menu {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(108, 117, 125, 0.3);
    }
    
    .badge {
        font-size: 0.75em;
        font-weight: 500;
    }
    
    .toast {
        animation: slideInRight 0.3s ease;
    }
    
    /* Fix navbar positioning during sorting */
    .critique-sorting-controls {
        position: static !important;
        z-index: 1;
    }
    
    /* Prevent critique card resizing during sorting */
    .critique-card {
        min-height: auto !important;
        transition: none !important;
    }
    
    .critique-card .card-body {
        min-height: auto !important;
    }
    
    /* Style for hidden critiques */
    .critique-card.hidden-critique {
        opacity: 0.8;
        border-color: #ffc107 !important;
    }
    
    /* Nested reply styling */
    .reply-item {
        position: relative;
        margin-bottom: 1rem;
    }
    
    .reply-actions {
        opacity: 0.8;
        transition: opacity 0.2s ease;
    }
    
    .reply-item:hover .reply-actions {
        opacity: 1;
    }
    
    .nested-reply {
        margin-left: 20px;
        border-left: 2px solid #6c757d;
        padding-left: 10px;
    }
    
    /* Better spacing for reply buttons */
    .btn-xs {
        font-size: 0.7rem;
        padding: 0.15rem 0.4rem;
        line-height: 1.2;
    }
    
    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(100px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    /* Fix for toggle switch visibility */
    .form-check-input {
        width: 2em !important;
        height: 1em !important;
        background-color: #6c757d !important;
        border: none !important;
        border-radius: 1em !important;
        position: relative !important;
    }
    
    .form-check-input:checked {
        background-color: #0d6efd !important;
    }
    
    .form-check-input:focus {
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
    }
    
    .form-check-input::before {
        content: '';
        position: absolute;
        top: 0.125em;
        left: 0.125em;
        width: 0.75em;
        height: 0.75em;
        background-color: white;
        border-radius: 50%;
        transition: transform 0.15s ease-in-out;
    }
    
    .form-check-input:checked::before {
        transform: translateX(1em);
    }
    
    /* Drop zone styling with fixed dimensions */
    .drop-zone {
        border: 2px dashed #6c757d;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        transition: all 0.3s ease;
        background-color: rgba(108, 117, 125, 0.1);
        height: 140px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        position: relative;
    }
    
    .drop-zone.highlight {
        border-color: #0d6efd;
        background-color: rgba(13, 110, 253, 0.1);
    }
    
    .drop-zone-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
    }
    
    .dropped-version {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        padding: 8px;
        gap: 8px;
        text-align: center;
    }
    
    .dropped-version img {
        flex-shrink: 0;
    }
    
    .dropped-version .version-title {
        font-size: 0.75rem;
        line-height: 1.2;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .dropped-version .remove-btn {
        margin-top: auto;
        font-size: 0.7rem;
        padding: 2px 6px;
    }
    
    /* Extra small button class for Bootstrap 5 */
    .btn-xs {
        padding: 0.125rem 0.25rem;
        font-size: 0.625rem;
        line-height: 1.2;
        border-radius: 0.2rem;
    }
    
    /* Enhanced Artwork Image Styling */
    .artwork-image {
        box-shadow: 0 0 20px rgba(255,255,255,0.1);
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    .artwork-image:hover {
        box-shadow: 0 0 30px rgba(255,255,255,0.15);
        transform: translateY(-2px);
    }
    
    /* Enhanced metadata spacing */
    .artwork-metadata .mb-2 {
        margin-bottom: 0.75rem !important;
    }
    
    /* Artwork Info Sidebar Enhancement */
    .artwork-info-sidebar {
        border-left: 2px solid rgba(255, 255, 255, 0.1);
        padding-left: 1.5rem;
    }
    
    .artwork-metadata .mb-3 {
        margin-bottom: 0.25rem !important;
    }
    
    /* Call-to-Action Area */
    .cta-container {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        padding: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        margin-top: 1rem;
    }
    
    .cta-container .btn {
        transition: all 0.3s ease;
    }
    
    @media (max-width: 768px) {
        .cta-container .btn {
            width: 100% !important;
        }
    }
    
    /* Version History Sidebar Sticky */
    @media (min-width: 992px) {
        .version-history {
            position: sticky;
            top: 80px;
        }
    }
    
    /* Version Thumbnail Hover Enhancement */
    .version-thumb:hover {
        outline: 2px solid #6c63ff;
        cursor: pointer;
        transform: translateY(-2px);
    }
    
    .version-thumb {
        padding: 0.125rem;
        transition: all 0.2s ease;
    }
    
    /* Enhanced Critique Card Styling */
    .critique-card {
        box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        border-radius: 6px;
        transition: all 0.3s ease;
    }
    
    .critique-card:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    /* Rating Labels with Icons */
    .rating-section {
        border-top: 1px solid rgba(255,255,255,0.1);
        padding-top: 0.75rem;
        margin-top: 0.75rem;
    }
    
    .rating-section .fw-bold {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #adb5bd;
    }
    
    /* Reaction Bar Enhancement */
    .reaction-btn {
        gap: 0.5rem;
        justify-content: space-between;
        padding: 0.5rem 0.75rem;
        border-radius: 20px;
        transition: all 0.3s ease;
    }
    
    .reaction-btn:hover {
        background: rgba(255,255,255,0.1) !important;
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .reaction-btn.active {
        background: rgba(13, 110, 253, 0.2) !important;
        border-color: #0d6efd !important;
    }
    
    /* Enhanced Dividers */
    .critique-divider {
        border-color: rgba(255,255,255,0.1) !important;
        margin: 1.5rem 0 !important;
    }
    
    /* Compact Mode Toggle Alignment */
    .critique-controls {
        align-items: center !important;
        gap: 1rem;
    }
    
    /* Visual Polish - Consistent Shadows */
    .card, .version-history-card, .critique-card {
        box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }
    
    /* Filter Bar Enhancement */
    .filter-bar {
        background-color: rgba(255,255,255,0.02);
        border-radius: 8px;
        padding: 0.5rem 1rem;
        border: 1px solid rgba(255,255,255,0.05);
    }
    
    /* Critique Card Left Border Accent */
    .critique-card:hover {
        border-left: 4px solid var(--bs-primary);
        margin-left: -4px;
    }
    
    /* Highly Rated Critique Accent */
    .critique-card.highly-rated {
        border-left: 4px solid #28a745;
        background: linear-gradient(135deg, rgba(40, 167, 69, 0.05) 0%, transparent 50%);
    }
    
    /* Refined Reaction Count Styling */
    .reaction-count-badge {
        background: rgba(255,255,255,0.08) !important;
        color: #adb5bd !important;
        border: 1px solid rgba(255,255,255,0.1);
    }
    
    /* Enhanced Add Critique Button */
    .btn-add-critique {
        background: linear-gradient(135deg, var(--bs-primary) 0%, #4c6ef5 100%);
        border: 2px solid transparent;
        background-clip: padding-box;
        transition: all 0.3s ease;
    }
    
    .btn-add-critique:hover {
        background: transparent;
        border: 2px solid var(--bs-primary);
        color: var(--bs-primary);
    }
    
    /* Artwork Info Section Enhancement */
    .artwork-meta-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }
    
    /* Focus Mode Styles */
    #focus-mode {
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        overflow: hidden;
    }
    
    #focus-artwork {
        max-height: 90vh;
        max-width: 90vw;
        width: auto;
        height: auto;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        transition: transform 0.3s ease;
    }
    
    #focus-artwork:hover {
        transform: scale(1.02);
    }
    
    #delayed-ui {
        position: absolute;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        gap: 1rem;
        opacity: 0;
        transition: opacity 1s ease;
        z-index: 10;
    }
    
    #delayed-ui.visible {
        opacity: 1;
    }
    
    .focus-ui-element {
        background: rgba(0,0,0,0.7);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 0.75rem 1rem;
        border: 1px solid rgba(255,255,255,0.1);
        color: white;
        text-decoration: none;
        transition: all 0.3s ease;
    }
    
    .focus-ui-element:hover {
        background: rgba(255,255,255,0.1);
        transform: translateY(-2px);
        color: white;
    }
    
    .scroll-indicator {
        position: absolute;
        bottom: 1rem;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 1s ease;
        animation: bounce 2s infinite;
        cursor: pointer;
    }
    
    .scroll-indicator.visible {
        opacity: 0.7;
    }
    
    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {
            transform: translateX(-50%) translateY(0);
        }
        40% {
            transform: translateX(-50%) translateY(-10px);
        }
        60% {
            transform: translateX(-50%) translateY(-5px);
        }
    }
    
    #scroll-anchor {
        min-height: 100vh;
        padding-top: 2rem;
        transform: translateY(50px);
        opacity: 0;
        transition: all 0.8s ease;
    }
    
    #scroll-anchor.visible {
        transform: translateY(0);
        opacity: 1;
    }
    
    .focus-mode-active {
        overflow: hidden;
    }
    
    .version-chip {
        background: rgba(108, 99, 255, 0.2);
        border: 1px solid rgba(108, 99, 255, 0.3);
        color: #6c63ff;
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-weight: 500;
    }
    
    .favorite-btn {
        background: rgba(220, 53, 69, 0.2);
        border: 1px solid rgba(220, 53, 69, 0.3);
        color: #dc3545;
        width: 44px;
        height: 44px;
        border-radius: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }
    
    .favorite-btn:hover {
        background: rgba(220, 53, 69, 0.3);
        transform: scale(1.1);
    }
    
    .favorite-btn.active {
        background: #dc3545;
        color: white;
    }
    
    /* Responsive Focus Mode */
    @media (max-width: 768px) {
        #focus-artwork {
            max-height: 80vh;
            max-width: 95vw;
        }
        
        #delayed-ui {
            bottom: 1rem;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .focus-ui-element {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }
    }
    
    /* Improved Version History Layout */
    .version-history-card {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
    }
    
    .version-thumbnail {
        transition: all 0.2s ease;
    }
    
    .version-thumbnail:hover {
        transform: translateY(-2px);
    }
    
    .version-thumbnail img {
        transition: all 0.2s ease;
        border: 2px solid transparent;
    }
    
    .version-thumbnail:hover img {
        border-color: rgba(13, 110, 253, 0.5);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    /* Enhanced Action Button */
    .actions-dropdown .dropdown-toggle {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
        position: relative;
    }
    
    .actions-dropdown .dropdown-toggle:after {
        margin-left: 0.5em;
    }
    
    /* Add Critique Button Enhancement */
    .add-critique-btn {
        background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
        border: none;
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
        transition: all 0.3s ease;
        font-weight: 600;
    }
    
    .add-critique-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(13, 110, 253, 0.4);
        background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
    }
    
    /* Critique Cards Enhancement */
    .critique-card {
        background: linear-gradient(145deg, #1a1a1a 0%, #2d2d2d 100%) !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(108, 117, 125, 0.2) !important;
    }
    
    .critique-card:hover {
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        border-color: rgba(13, 110, 253, 0.3) !important;
    }
    
    /* Rating Section Enhancement */
    .rating-section {
        background: rgba(108, 117, 125, 0.1);
        border-radius: 8px;
        padding: 1rem;
        border-left: 4px solid #0d6efd;
    }
    
    /* Progress bars with better colors */
    .progress-bar {
        transition: all 0.3s ease;
    }
    
    /* Dynamic rating colors based on score */
    .rating-excellent .progress-bar { background: linear-gradient(90deg, #28a745, #20c997); }
    .rating-good .progress-bar { background: linear-gradient(90deg, #20c997, #17a2b8); }
    .rating-average .progress-bar { background: linear-gradient(90deg, #ffc107, #fd7e14); }
    .rating-poor .progress-bar { background: linear-gradient(90deg, #fd7e14, #dc3545); }
    
    /* Rating icons */
    .rating-icon {
        font-size: 0.75rem;
        margin-left: 0.25rem;
    }
    
    .rating-label {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    /* Reaction buttons enhancement */
    .reaction-btn {
        background: rgba(108, 117, 125, 0.2);
        border: 1px solid rgba(108, 117, 125, 0.3);
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
    }
    
    .reaction-btn:before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        transition: left 0.5s;
    }
    
    .reaction-btn:hover:before {
        left: 100%;
    }
    
    .reaction-btn.active {
        background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%) !important;
        border-color: #0d6efd !important;
        box-shadow: 0 0 15px rgba(13, 110, 253, 0.4);
    }
</style>
{% endblock %}

{% block content %}

<!-- Focus Mode Section -->
<section id="focus-mode">
    <img id="focus-artwork" 
         src="{% if current_version and current_version.image %}{{ current_version.image.url }}{% elif current_version and current_version.image_url %}{{ current_version.image_url }}{% elif artwork.image %}{{ artwork.image.url }}{% elif artwork.image_url %}{{ artwork.image_url }}{% endif %}" 
         alt="{{ artwork.title }}" 
         onclick="enterFullscreen(this)">
    
    <!-- Delayed UI Elements -->
    <div id="delayed-ui">
        <button class="favorite-btn focus-ui-element" onclick="toggleFavorite({{ artwork.id }})" title="Add to Favorites">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-heart" viewBox="0 0 16 16">
                <path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01L8 2.748zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15z"/>
            </svg>
        </button>
        
        <div class="version-chip">
            v{{ current_version_number|default:"1" }} (Current)
        </div>
        
        <a href="#scroll-anchor" class="focus-ui-element" onclick="exitFocusMode()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat-left-text me-2" viewBox="0 0 16 16">
                <path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4.414A2 2 0 0 0 3 11.586l-2 2V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                <path d="M3 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 6a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 6zm0 2.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
            </svg>
            See Critiques
        </a>
        
        <a href="{% url 'critique:create_critique' artwork.id %}" class="focus-ui-element btn-add-critique">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle me-2" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
            </svg>
            Add Critique
        </a>
    </div>
    
    <!-- Scroll Indicator -->
    <div class="scroll-indicator" onclick="exitFocusMode()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
        </svg>
    </div>
</section>

<!-- Main Content (Initially Hidden) -->
<div id="main-content">
    <div id="scroll-anchor"></div>

{% block content %}
    {% csrf_token %}
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <div class="card mb-4 bg-dark text-white">
                {% if current_version and current_version.image %}
                    <img src="{{ current_version.image.url }}" class="card-img-top img-fluid artwork-image" alt="{{ artwork.title }}" style="max-height: 500px; object-fit: contain;" id="main-artwork-image">
                {% elif current_version and current_version.image_url %}
                    <img src="{{ current_version.image_url }}" class="card-img-top img-fluid artwork-image" alt="{{ artwork.title }}" style="max-height: 500px; object-fit: contain;" id="main-artwork-image">
                {% elif artwork.image %}
                    <img src="{{ artwork.image.url }}" class="card-img-top img-fluid artwork-image" alt="{{ artwork.title }}" style="max-height: 500px; object-fit: contain;" id="main-artwork-image">
                {% elif artwork.image_url %}
                    <img src="{{ artwork.image_url }}" class="card-img-top img-fluid artwork-image" alt="{{ artwork.title }}" style="max-height: 500px; object-fit: contain;" id="main-artwork-image">
                {% else %}
                    <div class="bg-secondary text-white d-flex justify-content-center align-items-center artwork-image" style="height: 400px;" id="main-artwork-image">
                        <span>No Image Available</span>
                    </div>
                {% endif %}
                <div class="card-body artwork-metadata">
                    <h1 class="card-title mb-3">{{ artwork.title }}</h1>

                    <!-- Version Label -->
                    {% if total_versions > 0 %}
                    <div class="mb-3">
                        <span class="badge bg-secondary me-2 px-3 py-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-clock-history me-1" viewBox="0 0 16 16">
                                <path d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022l-.074.997zm2.004.45a7.003 7.003 0 0 0-.985-.299l.219-.976c.383.086.76.2 1.126.342l-.36.933zm1.37.71a7.01 7.01 0 0 0-.439-.27l.493-.87a8.025 8.025 0 0 1 .979.654l-.615.789a6.996 6.996 0 0 0-.418-.302zm1.834 1.79a6.99 6.99 0 0 0-.653-.796l.724-.69c.27.285.52.59.747.91l-.818.576zm.744 1.352a7.08 7.08 0 0 0-.214-.468l.893-.45a7.976 7.976 0 0 1 .45 1.088l-.942.313a7.023 7.023 0 0 0-.187-.483zm.53 2.507a6.991 6.991 0 0 0-.1-1.025l.985-.17c.067.386.106.778.116 1.17l-1.001.025zm-.131 1.538c.033-.17.06-.339.081-.51l.993.123a7.957 7.957 0 0 1-.23 1.155l-.964-.267c.046-.165.086-.332.12-.501zm-.952 2.379c.184-.29.346-.594.486-.908l.914.405c-.16.36-.345.706-.555 1.038l-.845-.535zm-1.442 1.633c.263-.226.509-.467.740-.722l.724.69a8.026 8.026 0 0 1-.989.912l-.475-.88zm-2.266.97c.342-.14.677-.296.99-.49l.546.837a7.972 7.972 0 0 1-1.198.596l-.338-.943zm-2.137.339c.37-.042.741-.111 1.106-.207l.238.971a7.998 7.998 0 0 1-1.425.267l.081-.031z"/>
                                <path d="M8 1a7 7 0 1 0 4.95 11.95l.707.707A8.001 8.001 0 1 1 8 0v1z"/>
                                <path d="M7.5 3a.5.5 0 0 1 .5.5v5.21l3.248 1.856a.5.5 0 0 1-.496.868l-3.5-2A.5.5 0 0 1 7 9V3.5a.5.5 0 0 1 .5-.5z"/>
                            </svg>
                            Current ({{ current_version_number }} of {{ total_versions }})
                        </span>

                    </div>
                    {% endif %}

                    {% if artwork.description %}
                    <div class="mb-3">
                        <p class="card-text text-white-50 lh-lg">{{ artwork.description }}</p>
                    </div>
                    {% endif %}
                    
                    {% if artwork.medium or artwork.dimensions %}
                    <div class="mb-3">
                        {% if artwork.medium %}<span class="badge bg-info me-2 px-3 py-2">{{ artwork.medium }}</span>{% endif %}
                        {% if artwork.dimensions %}<span class="badge bg-secondary me-2 px-3 py-2">{{ artwork.dimensions }}</span>{% endif %}
                    </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <strong class="text-muted">Created:</strong> 
                        <span class="text-white">{{ artwork.created_at|date:"F d, Y" }}</span>
                    </div>
                    
                    {% if artwork.author %}
                    <div class="mb-3">
                        <strong class="text-muted">Artist:</strong> 
                        <a href="{% url 'critique:user_profile' artwork.author.username %}" class="text-decoration-none text-info fw-bold">{{ artwork.author.username }}</a>
                    </div>
                    {% endif %}
                    
                    {% if artwork.folder %}
                    <div class="mb-3">
                        <strong class="text-muted">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-folder me-1" viewBox="0 0 16 16">
                                <path d="M.54 3.87.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3h4.672a2 2 0 0 1 2 2l-.54.87a1 1 0 0 1-.94.63H1.48a1 1 0 0 1-.94-.63zM2.5 4a.5.5 0 0 0-.5.5v8a.5.5 0 0 0 .5.5h11a.5.5 0 0 0 .5-.5v-8a.5.5 0 0 0-.5-.5H2.5z"/>
                            </svg>
                            Portfolio:
                        </strong> 
                        <a href="/folders/{{ artwork.folder.id }}/" class="text-decoration-none text-info">{{ artwork.folder.name }}</a>
                    </div>
                    {% endif %}

                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            {% if user.is_authenticated %}
                            <a href="{% url 'critique:like_artwork' artwork.id %}" class="btn {% if user in artwork.likes.all %}btn-primary{% else %}btn-outline-light{% endif %} me-2" id="likeButton" data-artwork-id="{{ artwork.id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi {% if user in artwork.likes.all %}bi-heart-fill{% else %}bi-heart{% endif %}" viewBox="0 0 16 16">
                                    {% if user in artwork.likes.all %}
                                    <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314z"/>
                                    {% else %}
                                    <path d="M8 2.748L7.775 2.454a.75.75 0 0 0-1.06-.02L8 1.314c4.438-4.562 15.534 2.421 0 13.686C-7.534 4.735 3.562-3.248 8 1.314l.225.296c.208.27.208.718 0 .988L8 2.748z"/>
                                    {% endif %}
                                </svg>
                                <span class="like-count">{{ artwork.likes.count }}</span>
                            </a>
                            {% endif %}
                            <a href="{% url 'critique:create_critique' artwork.id %}" class="btn add-critique-btn px-4 py-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle me-2" viewBox="0 0 16 16">
                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                                </svg>
                                Add Critique
                            </a>
                        </div>
                        
                        <!-- Artwork Owner Actions -->
                        {% if user.is_authenticated and user == artwork.author %}
                        <div class="dropdown actions-dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle px-3 py-2" type="button" data-bs-toggle="dropdown">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear me-1" viewBox="0 0 16 16">
                                    <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                                    <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/>
                                </svg>
                                Actions
                            </button>
                            <ul class="dropdown-menu bg-dark border-secondary">
                                <li>
                                    <a class="dropdown-item text-light" href="{% url 'critique:artwork_edit' artwork.id %}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil me-2" viewBox="0 0 16 16">
                                            <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708L10.5 8.207l-3-3L12.146.146zM11.207 9L14 6.207l-3-3L8.207 6 11.207 9zM10.5 11.207L3.293 4 .146 7.146a.5.5 0 0 0-.146.354v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .354-.146L10.5 11.207zM4 2a1 1 0 0 1 1-1h3.5a.5.5 0 0 1 0 1H5a.5.5 0 0 0-.5.5v3H4V2z"/>
                                        </svg>
                                        Edit Artwork
                                    </a>
                                </li>
                                {% if artwork.folder %}
                                <li>
                                    <a class="dropdown-item text-warning" href="#" onclick="removeArtworkFromFolder({{ artwork.id }})">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-folder-x me-2" viewBox="0 0 16 16">
                                            <path d="M.54 3.87.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3h4.672a2 2 0 0 1 2 2l-.54.87a1 1 0 0 1-.94.63H1.48a1 1 0 0 1-.94-.63zM2.5 4a.5.5 0 0 0-.5.5v8a.5.5 0 0 0 .5.5h11a.5.5 0 0 0 .5-.5v-8a.5.5 0 0 0-.5-.5H2.5z"/>
                                            <path d="M6.146 6.146a.5.5 0 0 1 .708 0L8 7.293l1.146-1.147a.5.5 0 1 1 .708.708L8.707 8l1.147 1.146a.5.5 0 0 1-.708.708L8 8.707 6.854 9.854a.5.5 0 0 1-.708-.708L7.293 8 6.146 6.854a.5.5 0 0 1 0-.708z"/>
                                        </svg>
                                        Remove from Folder
                                    </a>
                                </li>
                                {% endif %}
                                <li><hr class="dropdown-divider border-secondary"></li>
                                <li>
                                    <a class="dropdown-item text-danger" href="{% url 'critique:artwork_delete' artwork.id %}" onclick="return confirm('Are you sure you want to delete this artwork? This action cannot be undone and will also delete all associated critiques and reactions.')">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash me-2" viewBox="0 0 16 16">
                                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                        </svg>
                                        Delete Artwork
                                    </a>
                                </li>
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar for Version History -->
        <div class="col-lg-4">
            {% if versions %}
            <div class="card bg-dark text-white mb-3 sticky-top version-history-card" style="top: 20px; z-index: 1;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <h6 class="mb-0 me-3">Version History</h6>
                        {% if user.is_authenticated and user == artwork.author %}
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="showArchivedVersions" onchange="toggleArchivedVersions()">
                            <label class="form-check-label text-muted small" for="showArchivedVersions">
                                Show Archived
                            </label>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body" style="max-height: 70vh; overflow-y: auto;">
                    <div class="row g-2">
                        <!-- Current Version -->
                        <div class="col-6">
                            <div class="version-thumbnail text-center" 
                                 data-version="current" 
                                 data-version-id="current"
                                 data-version-number="{{ current_version_number }}"
                                 data-artwork-id="{{ artwork.id }}"
                                 data-archived="false">
                                <div class="position-relative cursor-pointer" onclick="switchToCurrentVersion({{ artwork.id }})">
                                    {% if current_version and current_version.image %}
                                        <img src="{{ current_version.image.url }}" class="img-thumbnail border-primary" style="width: 100%; height: 80px; object-fit: cover;" alt="Current">
                                    {% elif current_version and current_version.image_url %}
                                        <img src="{{ current_version.image_url }}" class="img-thumbnail border-primary" style="width: 100%; height: 80px; object-fit: cover;" alt="Current">
                                    {% elif artwork.image %}
                                        <img src="{{ artwork.image.url }}" class="img-thumbnail border-primary" style="width: 100%; height: 80px; object-fit: cover;" alt="Current">
                                    {% elif artwork.image_url %}
                                        <img src="{{ artwork.image_url }}" class="img-thumbnail border-primary" style="width: 100%; height: 80px; object-fit: cover;" alt="Current">
                                    {% else %}
                                        <div class="bg-dark d-flex align-items-center justify-content-center border border-primary" style="width: 100%; height: 80px;">
                                            <span class="text-muted small">No Image</span>
                                        </div>
                                    {% endif %}
                                    <span class="position-absolute top-0 start-50 translate-middle badge rounded-pill bg-primary">
                                        Current
                                    </span>
                                </div>
                                <small class="d-block mt-1 fw-bold text-primary">Current</small>
                                <small class="d-block text-muted" style="font-size: 0.7rem;">v{{ current_version_number }}</small>
                            </div>
                        </div>

                        <!-- Version History Thumbnails -->
                        {% for version in versions reversed %}
                        {% if not version.is_archived or user.is_authenticated and user == artwork.author %}
                        <div class="col-6">
                            <div class="version-thumbnail text-center {% if version.is_archived %}archived-version{% endif %}" 
                                 data-version="{{ version.id }}" 
                                 data-version-id="{{ version.id }}"
                                 data-version-number="{{ version.version_number }}"
                                 data-artwork-id="{{ artwork.id }}"
                                 data-archived="{{ version.is_archived|yesno:'true,false' }}"
                                 {% if version.is_archived %}style="display: none;"{% endif %}>
                                <div class="position-relative cursor-pointer" onclick="switchToVersion({{ artwork.id }}, {{ version.id }})">
                                    {% if version.image %}
                                        <img src="{{ version.image.url }}" class="img-thumbnail" style="width: 100%; height: 80px; object-fit: cover;" alt="Version {{ version.version_number }}">
                                    {% elif version.image_url %}
                                        <img src="{{ version.image_url }}" class="img-thumbnail" style="width: 100%; height: 80px; object-fit: cover;" alt="Version {{ version.version_number }}">
                                    {% else %}
                                        <div class="bg-dark d-flex align-items-center justify-content-center" style="width: 100%; height: 80px;">
                                            <span class="text-muted small">No Image</span>
                                        </div>
                                    {% endif %}

                                    <!-- Version Actions Menu (only for artwork owner) -->
                                    {% if user.is_authenticated and user == artwork.author %}
                                    <div class="dropdown position-absolute" style="top: 2px; right: 2px;">
                                        <button class="btn btn-sm btn-dark btn-outline-secondary dropdown-toggle p-1" type="button" 
                                                data-bs-toggle="dropdown" aria-expanded="false" 
                                                style="font-size: 0.6rem; line-height: 1;"
                                                onclick="event.stopPropagation();">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" fill="currentColor" class="bi bi-three-dots-vertical" viewBox="0 0 16 16">
                                                <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                            </svg>
                                        </button>
                                        <ul class="dropdown-menu bg-dark border-secondary">
                                            {% if version.is_archived %}
                                            <li>
                                                <button class="dropdown-item text-success" onclick="event.stopPropagation(); unarchiveVersion({{ version.id }})">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="bi bi-arrow-up-circle me-1" viewBox="0 0 16 16">
                                                        <path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8zm15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-7.5 3.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V11.5z"/>
                                                    </svg>
                                                    Unarchive
                                                </button>
                                            </li>
                                            {% else %}
                                            <li>
                                                <button class="dropdown-item text-white" onclick="event.stopPropagation(); archiveVersion({{ version.id }}, {{ version.version_number }})">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="bi bi-archive me-1" viewBox="0 0 16 16">
                                                        <path d="M0 2a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1v7.5a2.5 2.5 0 0 1-2.5 2.5h-9A2.5 2.5 0 0 1 1 12.5V5a1 1 0 0 1-1-1V2zm2 3v7.5A1.5 1.5 0 0 0 3.5 14h9a1.5 1.5 0 0 0 1.5-1.5V5H2zm13-3H1v2h14V2zM5 7.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
                                                    </svg>
                                                    Archive
                                                </button>
                                            </li>
                                            {% endif %}
                                            <li><hr class="dropdown-divider bg-secondary"></li>
                                            <li>
                                                <button class="dropdown-item text-danger" onclick="event.stopPropagation(); deleteVersion({{ version.id }}, {{ version.version_number }})">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="bi bi-trash me-1" viewBox="0 0 16 16">
                                                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                                    </svg>
                                                    Delete
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                    {% endif %}
                                </div>
                                <small class="d-block mt-1">v{{ version.version_number }}</small>
                                {% if version.created_at %}
                                <small class="d-block text-muted" style="font-size: 0.7rem;">{{ version.created_at|date:"M d" }}</small>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    
                    <!-- Version Comparison Controls -->
                    {% if user.is_authenticated and user == artwork.author %}
                    <div class="mt-3 border-top border-secondary pt-3">
                        <!-- Comparison Mode Toggle -->
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="comparisonModeToggle" onchange="toggleComparisonMode()">
                            <label class="form-check-label text-primary small fw-bold" for="comparisonModeToggle">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-arrows-expand me-1" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 8zM7.646.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 1.707V5.5a.5.5 0 0 1-1 0V1.707L6.354 2.854a.5.5 0 1 1-.708-.708l2-2zM8 10a.5.5 0 0 1 .5.5v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 .708-.708L7.5 14.293V10.5A.5.5 0 0 1 8 10z"/>
                                </svg>
                                Compare Versions
                            </label>
                        </div>
                        

                        

                        
                        <!-- Drag & Drop Comparison Interface -->
                        <div id="comparisonInterface" class="comparison-interface" style="display: none;">
                            <div class="alert alert-info py-2 px-3 small mb-3">
                                <strong>Drag & Drop Comparison:</strong><br>
                                • Drag versions to compare them side-by-side<br>
                                • Drop zones will highlight when active<br>
                                • Click "Compare" to view differences
                            </div>
                            
                            <div class="row">
                                <!-- Left Drop Zone -->
                                <div class="col-6">
                                    <div class="drop-zone" id="leftDropZone" ondrop="handleDrop(event, 'left')" ondragover="allowDrop(event)" ondragenter="highlightDropZone(event)" ondragleave="unhighlightDropZone(event)">
                                        <div class="drop-zone-content">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-image text-muted mb-2" viewBox="0 0 16 16">
                                                <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                                <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
                                            </svg>
                                            <p class="text-muted mb-0">Drop Version Here</p>
                                            <small class="text-muted">Version A</small>
                                        </div>
                                        <div class="dropped-version" id="leftDroppedVersion" style="display: none;"></div>
                                    </div>
                                </div>
                                
                                <!-- Right Drop Zone -->
                                <div class="col-6">
                                    <div class="drop-zone" id="rightDropZone" ondrop="handleDrop(event, 'right')" ondragover="allowDrop(event)" ondragenter="highlightDropZone(event)" ondragleave="unhighlightDropZone(event)">
                                        <div class="drop-zone-content">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-image text-muted mb-2" viewBox="0 0 16 16">
                                                <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                                <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
                                            </svg>
                                            <p class="text-muted mb-0">Drop Version Here</p>
                                            <small class="text-muted">Version B</small>
                                        </div>
                                        <div class="dropped-version" id="rightDroppedVersion" style="display: none;"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Compare Button -->
                            <div class="text-center mt-3">
                                <button class="btn btn-primary" id="compareButton" onclick="openVersionComparison()" disabled>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrows-expand me-2" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 8zM7.646.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 1.707V5.5a.5.5 0 0 1-1 0V1.707L6.354 2.854a.5.5 0 1 1-.708-.708l2-2zM8 10a.5.5 0 0 1 .5.5v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 .708-.708L7.5 14.293V10.5A.5.5 0 0 1 8 10z"/>
                                    </svg>
                                    Compare Versions
                                </button>
                                <button class="btn btn-outline-secondary ms-2" onclick="clearComparison()">
                                    Clear
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Version Comparison Modal -->
    <div class="modal fade" id="versionComparisonModal" tabindex="-1" aria-labelledby="versionComparisonModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen-lg-down modal-xl modal-dialog-scrollable">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary d-flex justify-content-between align-items-center">
                    <h5 class="modal-title" id="versionComparisonModalLabel">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-arrows-expand me-2" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 8zM7.646.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 1.707V5.5a.5.5 0 0 1-1 0V1.707L6.354 2.854a.5.5 0 1 1-.708-.708l2-2zM8 10a.5.5 0 0 1 .5.5v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 .708-.708L7.5 14.293V10.5A.5.5 0 0 1 8 10z"/>
                        </svg>
                        Version Comparison
                    </h5>
                    <!-- All controls aligned to the right -->
                    <div class="d-flex align-items-center gap-2">
                        <!-- View Mode Toggle -->
                        <div class="btn-group" role="group" aria-label="View mode">
                            <input type="radio" class="btn-check" name="viewMode" id="sideBySideMode" checked>
                            <label class="btn btn-outline-light btn-sm" for="sideBySideMode">Side-by-Side</label>
                            
                            <input type="radio" class="btn-check" name="viewMode" id="overlayMode">
                            <label class="btn btn-outline-light btn-sm" for="overlayMode">Overlay</label>
                        </div>
                        <div class="vr text-secondary mx-2"></div>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body p-0">
                    <!-- Comparison Status Bar -->
                    <div class="bg-secondary p-3 border-bottom border-dark">
                        <div class="d-flex justify-content-between align-items-center">
                            <div id="comparisonStatus" class="text-light">
                                <span class="badge bg-info me-2">Analyzing</span>
                                Comparing selected versions...
                            </div>
                            <button class="btn btn-sm btn-outline-light" onclick="swapVersions()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-arrow-left-right me-1" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M1 11.5a.5.5 0 0 0 .5.5h11.793l-3.147 3.146a.5.5 0 0 0 .708.708l4-4a.5.5 0 0 0 0-.708l-4-4a.5.5 0 0 0-.708.708L13.293 11H1.5a.5.5 0 0 0-.5.5zm14-7a.5.5 0 0 1-.5.5H2.707l3.147 3.146a.5.5 0 1 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 4H14.5a.5.5 0 0 1 .5.5z"/>
                                </svg>
                                Swap
                            </button>
                        </div>
                    </div>
                    
                    <!-- Side-by-Side View -->
                    <div id="sideBySideView" class="p-3">
                        <div class="row g-4" id="comparisonContent">
                            <!-- Comparison content will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Overlay View -->
                    <div id="overlayView" class="p-0" style="display: none;">
                        <div class="position-relative" id="overlayContainer">
                            <!-- Overlay comparison content -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <div class="d-flex justify-content-between w-100">
                        <div>
                            <span class="text-muted small">Differences found: <span id="diffCount">0</span></span>
                        </div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Critiques Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card mb-4 bg-dark text-white">
                <div class="card-header">
                    <h4>Critiques ({{ critiques.count }})</h4>
                    {% if user.is_authenticated %}
                    <p class="mb-0"><small class="text-muted">Share your thoughts to help the artist improve</small></p>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if critiques %}
                        <!-- Enhanced Critique Sorting Controls -->
                        <div class="critique-sorting-controls mb-4 p-3 rounded-3" style="background: linear-gradient(135deg, rgba(52, 58, 64, 0.8), rgba(33, 37, 41, 0.6)); border: 1px solid rgba(108, 117, 125, 0.3);">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center gap-3">
                                    <!-- View Mode Toggle -->
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="collapseMode" style="filter: hue-rotate(120deg);">
                                        <label class="form-check-label text-light d-flex align-items-center" for="collapseMode">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-layout-three-columns me-2 text-info" viewBox="0 0 16 16">
                                                <path d="M0 1.5A1.5 1.5 0 0 1 1.5 0h13A1.5 1.5 0 0 1 16 1.5v13a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 14.5v-13zM1.5 1a.5.5 0 0 0-.5.5v13a.5.5 0 0 0 .5.5H5V1H1.5zM10 15h4.5a.5.5 0 0 0 .5-.5v-13a.5.5 0 0 0-.5-.5H10v14zm-1 0V1H6v14h3z"/>
                                            </svg>
                                            Compact view
                                        </label>
                                    </div>
                                    <div class="vr text-secondary"></div>
                                    <!-- Filter by Rating -->
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showRatedOnly" style="filter: hue-rotate(240deg);">
                                        <label class="form-check-label text-light d-flex align-items-center" for="showRatedOnly">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-star-fill me-2 text-warning" viewBox="0 0 16 16">
                                                <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                                            </svg>
                                            Rated only
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="d-flex align-items-center gap-2">
                                    <!-- Critique Count Badge -->
                                    <span class="badge bg-primary px-3 py-2 rounded-pill">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-chat-dots-fill me-1" viewBox="0 0 16 16">
                                            <path d="M16 8c0 3.866-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.584.296-1.925.864-4.181 1.234-.2.032-.352-.176-.273-.362.354-.836.674-1.95.77-2.966C.744 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7zM5 8a1 1 0 1 0-2 0 1 1 0 0 0 2 0zm4 0a1 1 0 1 0-2 0 1 1 0 0 0 2 0zm3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                                        </svg>
                                        {{ critiques.count }} Critique{{ critiques.count|pluralize }}
                                    </span>
                                    
                                    <!-- Enhanced Sort Dropdown -->
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-info dropdown-toggle px-3 py-2 d-flex align-items-center" type="button" data-bs-toggle="dropdown" style="border-radius: 20px;">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-sort-down me-2" viewBox="0 0 16 16">
                                                <path d="M3.5 2.5a.5.5 0 0 0-1 0v8.793l-1.146-1.147a.5.5 0 0 0-.708.708l2 1.999.007.007a.497.497 0 0 0 .7-.006l2-2a.5.5 0 0 0-.707-.708L3.5 11.293V2.5zm3.5 1a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zM7.5 6a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5zm0 3a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1h-3zm0 3a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1z"/>
                                            </svg>
                                            <span id="currentSort">Sort by</span>
                                        </button>
                                        <ul class="dropdown-menu bg-dark border-secondary shadow-lg" style="border-radius: 12px;">
                                            <li><h6 class="dropdown-header text-info">Sort Options</h6></li>
                                            <li><button class="dropdown-item text-light d-flex align-items-center" onclick="sortCritiques('helpful')">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-hand-thumbs-up me-2 text-success" viewBox="0 0 16 16">
                                                    <path d="M8.864.046C7.908-.193 7.02.53 6.956 1.466c-.072 1.051-.23 2.016-.428 2.59-.125.36-.479 1.013-1.04 1.639-.557.623-1.282 1.178-2.131 1.41C2.685 7.288 2 7.87 2 8.72v4.001c0 .845.682 1.464 1.448 1.545 1.07.114 1.564.415 2.068.723l.048.03c.272.165.578.348.97.484.397.136.861.217 1.466.217h3.5c.937 0 1.599-.477 1.934-1.064a1.86 1.86 0 0 0 .254-.912c0-.152-.023-.312-.077-.464.201-.263.38-.578.488-.901.11-.33.172-.762.004-1.149.069-.13.12-.269.159-.403.077-.27.113-.568.113-.857 0-.288-.036-.585-.113-.856a2.144 2.144 0 0 0-.138-.362 1.9 1.9 0 0 0 .234-1.734c-.206-.592-.682-1.1-1.2-1.272-.847-.282-1.803-.276-2.516-.211a9.84 9.84 0 0 0-.443.05 9.365 9.365 0 0 0-.062-4.509A1.38 1.38 0 0 0 9.125.111L8.864.046zM11.5 14.721H8c-.51 0-.863-.069-1.14-.164-.281-.097-.506-.228-.776-.393l-.04-.024c-.555-.339-1.198-.731-2.49-.868-.333-.036-.554-.29-.554-.55V8.72c0-.254.226-.543.62-.65 1.095-.3 1.977-.996 2.614-1.708.635-.71 1.064-1.475 1.238-1.978.243-.7.407-1.768.482-2.85.025-.362.36-.594.667-.518l.262.066c.16.04.258.143.288.255a8.34 8.34 0 0 1-.145 4.725.5.5 0 0 0 .595.644l.003-.001.014-.003.058-.014a8.908 8.908 0 0 1 1.036-.157c.663-.06 1.457-.054 2.11.164.175.058.45.3.57.65.107.308.087.67-.266 1.022l-.353.353.353.354c.043.043.105.141.154.315.048.167.075.37.075.581 0 .212-.027.414-.075.582-.05.174-.111.272-.154.315l-.353.353.353.354c.047.047.109.177.005.488a2.224 2.224 0 0 1-.505.805l-.353.353.353.354c.006.005.041.05.041.17a.866.866 0 0 1-.121.416c-.165.288-.503.56-1.066.56z"/>
                                                </svg>
                                                Most Helpful
                                            </button></li>
                                            <li><button class="dropdown-item text-light d-flex align-items-center" onclick="sortCritiques('recent')">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-clock-fill me-2 text-primary" viewBox="0 0 16 16">
                                                    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                                                </svg>
                                                Newest First
                                            </button></li>
                                            <li><button class="dropdown-item text-light d-flex align-items-center" onclick="sortCritiques('oldest')">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-hourglass-split me-2 text-warning" viewBox="0 0 16 16">
                                                    <path d="M2.5 15a.5.5 0 1 1 0-1h1v-1a4.5 4.5 0 0 1 2.557-4.06c.29-.139.443-.377.443-.59v-.7c0-.213-.154-.451-.443-.59A4.5 4.5 0 0 1 3.5 3V2h-1a.5.5 0 0 1 0-1h11a.5.5 0 0 1 0 1h-1v1a4.5 4.5 0 0 1-2.557 4.06c-.29.139-.443.377-.443.59v.7c0 .213.154.451.443.59A4.5 4.5 0 0 1 12.5 13v1h1a.5.5 0 0 1 0 1h-11zm2-13v1c0 .537.12 1.045.337 1.5h6.326c.216-.455.337-.963.337-1.5V2h-7zm3 6.35c0 .701-.478 1.236-1.011 1.492A3.5 3.5 0 0 0 4.5 13s.866-1.299 3-1.48V8.35z"/>
                                                </svg>
                                                Oldest First
                                            </button></li>
                                            <li><hr class="dropdown-divider border-secondary"></li>
                                            <li><button class="dropdown-item text-light d-flex align-items-center" onclick="sortCritiques('rating')">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-star-fill me-2 text-warning" viewBox="0 0 16 16">
                                                    <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                                                </svg>
                                                Highest Rating
                                            </button></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% for critique in critiques %}
                            <div class="card mb-4 bg-dark text-white critique-card border-secondary rounded-3 shadow-sm {% if critique.is_hidden %}border-warning{% endif %}" id="critique-{{ critique.id }}" data-critique-id="{{ critique.id }}" data-helpful-count="{{ critique.helpful_count|default:0 }}" data-created="{{ critique.created_at|date:'c' }}" data-rating="{{ critique.get_overall_score|default:0 }}">
                                
                                <!-- Hidden Critique Alert (only shown to artwork author) -->
                                {% if critique.is_hidden and user.is_authenticated and user == artwork.author %}
                                <div class="alert alert-warning border-0 mb-0 rounded-0 rounded-top" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);">
                                    <div class="d-flex align-items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-slash text-warning me-2" viewBox="0 0 16 16">
                                            <path d="M13.359 11.238C15.06 9.72 16 8 16 8s-3-5.5-8-5.5a7.028 7.028 0 0 0-2.79.588l.77.771A5.944 5.944 0 0 1 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.134 13.134 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755-.165.165-.337.328-.517.486l.708.709z"/>
                                            <path d="M11.297 9.176a3.5 3.5 0 0 0-4.474-4.474l.823.823a2.5 2.5 0 0 1 2.829 2.829l.822.822zm-2.943 1.299.822.822a3.5 3.5 0 0 1-4.474-4.474l.823.823a2.5 2.5 0 0 0 2.829 2.829z"/>
                                            <path d="M3.35 5.47c-.18.16-.353.322-.518.487A13.134 13.134 0 0 0 1.172 8l.195.288c.335.48.83 1.12 1.465 1.755C4.121 11.332 5.881 12.5 8 12.5c.716 0 1.39-.133 2.02-.36l.77.772A7.029 7.029 0 0 1 8 13.5C3 13.5 0 8 0 8s.939-1.721 2.641-3.238l.708.709zm10.296 8.884-12-12 .708-.708 12 12-.708.708z"/>
                                        </svg>
                                        <span class="text-dark fw-bold small">This critique is hidden from public view</span>
                                        {% if critique.hidden_reason %}
                                            <span class="text-muted small ms-2">• {{ critique.hidden_reason }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                                <!-- Critique Header -->
                                <div class="card-header bg-secondary bg-opacity-25 border-0 pb-2">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="d-flex align-items-center">
                                            <!-- Author Avatar Placeholder -->
                                            <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-size: 14px; font-weight: bold;">
                                                {{ critique.author.username|first|upper }}
                                            </div>
                                            <div>
                                                <div class="d-flex align-items-center">
                                                    <a href="{% url 'critique:user_profile' critique.author.username %}" class="text-decoration-none text-info fw-bold">
                                                        {{ critique.author.username }}
                                                    </a>
                                                    {% if critique.author.profile.karma > 50 %}
                                                        <span class="badge bg-warning text-dark ms-2" title="Expert Critic">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-award" viewBox="0 0 16 16">
                                                                <path d="M9.669.864 8 0 6.331.864l-1.858.282-.842 1.68-1.337 1.32L2.6 6l-.306 1.854 1.337 1.32.842 1.68 1.858.282L8 12l1.669-.864 1.858-.282.842-1.68 1.337-1.32L13.4 6l.306-1.854-1.337-1.32-.842-1.68L9.669.864zm1.196 1.193.684 1.365 1.086 1.072L12.387 6l.248 1.506-1.086 1.072-.684 1.365-1.51.229L8 10.874l-1.355-.702-1.51-.229-.684-1.365-1.086-1.072L3.614 6l-.25-1.506 1.087-1.072.684-1.365 1.51-.229L8 1.126l1.356.702 1.509.229z"/>
                                                                <path d="M4 11.794V16l4-1 4 1v-4.206l-2.018.306L8 13.126 6.018 12.1 4 11.794z"/>
                                                            </svg>
                                                            Expert Eye
                                                        </span>
                                                    {% endif %}
                                                    {% if critique.author.profile.karma > 0 %}
                                                        <span class="badge bg-secondary ms-2" title="Karma Score">
                                                            {{ critique.author.profile.karma }} karma
                                                        </span>
                                                    {% endif %}
                                                </div>
                                                <small class="text-muted">{{ critique.created_at|timesince }} ago</small>
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            {% if critique.get_overall_score %}
                                                <span class="badge bg-primary me-2">{{ critique.get_overall_score|floatformat:1 }}/10</span>
                                            {% endif %}
                                            
                                            <!-- Delete button for critique author -->
                                            {% if user.is_authenticated and user == critique.author %}
                                            <button class="btn btn-sm btn-outline-danger me-2" 
                                                    onclick="deleteCritique({{ critique.id }})"
                                                    title="Delete this critique">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                                </svg>
                                            </button>
                                            {% endif %}
                                            
                                            <button class="btn btn-sm btn-outline-secondary critique-collapse-btn" data-bs-toggle="collapse" data-bs-target="#critique-body-{{ critique.id }}" aria-expanded="true">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                                                    <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Collapsible Critique Body -->
                                <div class="collapse show" id="critique-body-{{ critique.id }}">
                                    <div class="card-body pt-3">
                                        <!-- Rating Bars Section -->
                                        {% if critique.composition_score or critique.technique_score or critique.originality_score %}
                                        <div class="rating-section mb-3">
                                            <h6 class="text-muted mb-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-bar-chart me-1" viewBox="0 0 16 16">
                                                    <path d="M4 11H2v3h2v-3zm5-4H7v7h2V7zm5-5v12h-2V2h2zm-2-1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1h-2zM6 7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zM4 11a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-3z"/>
                                                </svg>
                                                Ratings
                                            </h6>
                                            <div class="row g-2">
                                                {% if critique.technique_score %}
                                                <div class="col-md-4">
                                                    <div class="rating-bar-container {% if critique.technique_score >= 8 %}rating-excellent{% elif critique.technique_score >= 6 %}rating-good{% elif critique.technique_score >= 4 %}rating-average{% else %}rating-poor{% endif %}">
                                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                                            <div class="rating-label">
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-gear-fill text-primary" viewBox="0 0 16 16">
                                                                    <path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"/>
                                                                </svg>
                                                                <small class="text-muted">Technique</small>
                                                            </div>
                                                            <small class="text-white fw-bold">{{ critique.technique_score }}/10</small>
                                                        </div>
                                                        <div class="progress bg-secondary" style="height: 8px; border-radius: 4px;">
                                                            <div class="progress-bar" style="width: {{ critique.technique_score }}0%; border-radius: 4px;"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if critique.originality_score %}
                                                <div class="col-md-4">
                                                    <div class="rating-bar-container {% if critique.originality_score >= 8 %}rating-excellent{% elif critique.originality_score >= 6 %}rating-good{% elif critique.originality_score >= 4 %}rating-average{% else %}rating-poor{% endif %}">
                                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                                            <div class="rating-label">
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-lightbulb-fill text-warning" viewBox="0 0 16 16">
                                                                    <path d="M2 6a6 6 0 1 1 10.174 4.31c-.203.196-.359.4-.453.619l-.762 1.769A.5.5 0 0 1 10.5 13h-5a.5.5 0 0 1-.459-.302L4.28 10.93c-.094-.218-.25-.423-.453-.618A5.984 5.984 0 0 1 2 6zm3 8.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1l-.224.447a1 1 0 0 1-.894.553H6.618a1 1 0 0 1-.894-.553L5.5 15a.5.5 0 0 1-.5-.5z"/>
                                                                </svg>
                                                                <small class="text-muted">Originality</small>
                                                            </div>
                                                            <small class="text-white fw-bold">{{ critique.originality_score }}/10</small>
                                                        </div>
                                                        <div class="progress bg-secondary" style="height: 8px; border-radius: 4px;">
                                                            <div class="progress-bar" style="width: {{ critique.originality_score }}0%; border-radius: 4px;"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if critique.composition_score %}
                                                <div class="col-md-4">
                                                    <div class="rating-bar-container {% if critique.composition_score >= 8 %}rating-excellent{% elif critique.composition_score >= 6 %}rating-good{% elif critique.composition_score >= 4 %}rating-average{% else %}rating-poor{% endif %}">
                                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                                            <div class="rating-label">
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-grid-3x3-gap-fill text-success" viewBox="0 0 16 16">
                                                                    <path d="M1 2a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V2zM1 7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V7zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V7zM1 12a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1v-2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-2z"/>
                                                                </svg>
                                                                <small class="text-muted">Composition</small>
                                                            </div>
                                                            <small class="text-white fw-bold">{{ critique.composition_score }}/10</small>
                                                        </div>
                                                        <div class="progress bg-secondary" style="height: 8px; border-radius: 4px;">
                                                            <div class="progress-bar" style="width: {{ critique.composition_score }}0%; border-radius: 4px;"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endif %}

                                        <!-- Written Feedback -->
                                        <div class="critique-text mb-3">
                                            <p class="card-text lh-base">{{ critique.text|linebreaks }}</p>
                                        </div>

                                        <!-- Threaded Replies -->
                                        {% if critique.replies.exists %}
                                        <div class="replies-section mb-3">
                                            <h6 class="text-muted mb-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-chat-dots me-1" viewBox="0 0 16 16">
                                                    <path d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                                                    <path d="M2.165 15.803l.02-.004c1.83-.363 2.948-.842 3.468-1.105A9.06 9.06 0 0 0 8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6a10.437 10.437 0 0 1-.524 2.318l-.003.011a10.722 10.722 0 0 1-.244.637c-.079.186.074.394.273.362a21.673 21.673 0 0 0 .693-.125zm.8-3.108a1 1 0 0 0-.287-.801C1.618 10.83 1 9.468 1 8c0-3.192 3.004-6 7-6s7 2.808 7 6c0 3.193-3.004 6-7 6a8.06 8.06 0 0 1-2.088-.272 1 1 0 0 0-.711.074c-.387.196-1.24.57-2.634.893a19.492 19.492 0 0 0 .398-2z"/>
                                                </svg>
                                                Replies ({{ critique.replies.count }})
                                            </h6>
                                            <div class="replies-container ps-3 border-start border-info border-opacity-50">
                                                {% for reply in critique.replies.all %}
                                                <div class="reply-item mb-2 p-2 bg-secondary bg-opacity-25 rounded" data-reply-id="{{ reply.id }}">
                                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                                        <div class="d-flex align-items-center">
                                                            <div class="rounded-circle bg-info d-flex align-items-center justify-content-center me-2" style="width: 24px; height: 24px; font-size: 11px; font-weight: bold;">
                                                                {{ reply.author.username|first|upper }}
                                                            </div>
                                                            <a href="{% url 'critique:user_profile' reply.author.username %}" class="text-decoration-none text-info fw-bold small">
                                                                {{ reply.author.username }}
                                                            </a>
                                                        </div>
                                                        <div class="d-flex align-items-center gap-1">
                                                            <small class="text-muted">{{ reply.created_at|timesince }} ago</small>
                                                        </div>
                                                    </div>
                                                    <p class="mb-2 small">{{ reply.text|linebreaks }}</p>
                                                    
                                                    <!-- Reply Actions -->
                                                    <div class="reply-actions d-flex gap-1 mt-2">
                                                        {% if user.is_authenticated %}
                                                        <button class="btn btn-xs btn-outline-info" onclick="showReplyToReply({{ reply.id }})" style="font-size: 0.7rem; padding: 0.25rem 0.5rem;">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" fill="currentColor" class="bi bi-reply me-1" viewBox="0 0 16 16">
                                                                <path d="M6.598 5.013a.144.144 0 0 1 .202.134V6.3a.5.5 0 0 0 .5.5c.667 0 2.013.005 3.3.822.984.624 1.99 1.76 2.595 3.876-1.02-.983-2.185-1.516-3.205-1.799a8.74 8.74 0 0 0-1.921-.306 7.404 7.404 0 0 0-.798.008h-.013l-.005.001h-.001L7.3 9.9l-.05-.498a.5.5 0 0 0-.45.498v1.153c0 .108-.11.176-.202.134L2.614 8.254a.503.503 0 0 0-.042-.028.147.147 0 0 1 0-.252.499.499 0 0 0 .042-.028l3.984-2.933zM7.8 10.386c.068 0 .143.003.223.006.434.02 1.034.086 1.7.271 1.326.368 2.896 1.202 3.94 3.08a.5.5 0 0 0 .933-.305c-.464-3.71-1.886-5.662-3.46-6.66-1.245-.79-2.527-.942-3.336-.971v-.66a1.144 1.144 0 0 0-1.767-.96l-3.994 2.94a1.147 1.147 0 0 0 0 1.946l3.994 2.94a1.144 1.144 0 0 0 1.767-.96v-.667z"/>
                                                            </svg>
                                                            Reply
                                                        </button>
                                                        {% endif %}
                                                        
                                                        {% if user.is_authenticated and user == reply.author %}
                                                        <button class="btn btn-xs btn-outline-danger" onclick="deleteReply({{ reply.id }})" style="font-size: 0.7rem; padding: 0.25rem 0.5rem;">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" fill="currentColor" class="bi bi-trash me-1" viewBox="0 0 16 16">
                                                                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                                                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                                            </svg>
                                                            Delete
                                                        </button>
                                                        {% endif %}
                                                        
                                                        {% if user.is_authenticated %}
                                                        <button class="btn btn-xs btn-outline-warning" onclick="flagReply({{ reply.id }})" style="font-size: 0.7rem; padding: 0.25rem 0.5rem;">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" fill="currentColor" class="bi bi-flag me-1" viewBox="0 0 16 16">
                                                                <path d="M14.778.085A.5.5 0 0 1 15 .5V8a.5.5 0 0 1-.314.464L9.5 10.385v.615a3 3 0 0 1-6 0V4.5a.5.5 0 0 1 .5-.5h1.053c.326 0 .653-.086.94-.252C6.781 2.981 7.787 1.5 9.5 1.5c1.712 0 2.719 1.481 3.547 2.248.287.266.614.352.94.352H15a.5.5 0 0 1 .278.915l-5.686 2.885v.615a3 3 0 0 1-6 0V9.5a.5.5 0 0 1 .5-.5h1.053c.326 0 .653-.086.94-.252C6.781 7.981 7.787 6.5 9.5 6.5c1.712 0 2.719 1.481 3.547 2.248.287.266.614.352.94.352H15a.5.5 0 0 1 .278.915z"/>
                                                            </svg>
                                                            Flag
                                                        </button>
                                                        {% endif %}
                                                    </div>
                                                    
                                                    <!-- Nested reply form -->
                                                    <div class="nested-reply-form mt-2" id="nested-reply-form-{{ reply.id }}" style="display: none;">
                                                        <div class="bg-dark bg-opacity-50 p-2 rounded">
                                                            <form class="nested-reply-form" data-reply-id="{{ reply.id }}">
                                                                {% csrf_token %}
                                                                <div class="mb-2">
                                                                    <textarea class="form-control form-control-sm bg-dark text-white border-secondary" rows="2" placeholder="Reply to {{ reply.author.username }}..." required></textarea>
                                                                </div>
                                                                <div class="d-flex justify-content-end gap-1">
                                                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="hideReplyToReply({{ reply.id }})">Cancel</button>
                                                                    <button type="submit" class="btn btn-sm btn-info">Post</button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Nested replies container -->
                                                    <div class="nested-replies mt-2" id="nested-replies-{{ reply.id }}">
                                                        <!-- Nested replies will be loaded here via AJAX -->
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}

                                        <!-- Inline Reply Form -->
                                        <div class="reply-form-container" id="reply-form-{{ critique.id }}" style="display: none;">
                                            <div class="bg-secondary bg-opacity-25 p-3 rounded mb-3">
                                                <h6 class="text-muted mb-2">Reply to {{ critique.author.username }}</h6>
                                                <form class="reply-form" data-critique-id="{{ critique.id }}">
                                                    {% csrf_token %}
                                                    <div class="mb-2">
                                                        <textarea class="form-control bg-dark text-white border-secondary" rows="3" placeholder="Share your thoughts on this critique..." required></textarea>
                                                    </div>
                                                    <div class="d-flex justify-content-end gap-2">
                                                        <button type="button" class="btn btn-sm btn-outline-secondary cancel-reply">Cancel</button>
                                                        <button type="submit" class="btn btn-sm btn-primary">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-send me-1" viewBox="0 0 16 16">
                                                                <path d="M15.854.146a.5.5 0 0 1 .11.54L13.026 8.12a.5.5 0 0 1-.542.225l-4.57-.985a.5.5 0 0 0-.218 0l-4.57.985a.5.5 0 0 1-.542-.225L.126.686a.5.5 0 0 1 .11-.54A.5.5 0 0 1 .82.2l5.6 2.95L13.8.2a.5.5 0 0 1 .554-.054z"/>
                                                            </svg>
                                                            Post Reply
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    
                                    </div>
                                </div>

                                <!-- Critique Footer with Reactions and Actions -->
                                <div class="card-footer bg-secondary bg-opacity-10 border-0">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <!-- Reaction Buttons -->
                                        <div class="reaction-buttons d-flex gap-1">
                                            {% if user.is_authenticated and user != critique.author %}
                                                <!-- Interactive reaction buttons for non-authors -->
                                                <button class="btn btn-sm btn-outline-success me-1 reaction-btn {% if critique.user_reactions and 'HELPFUL' in critique.user_reactions %}active{% endif %}" 
                                                        data-critique-id="{{ critique.id }}" 
                                                        data-reaction-type="HELPFUL"
                                                        onclick="toggleReaction(this, {{ critique.id }}, 'HELPFUL')">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-hand-thumbs-up" viewBox="0 0 16 16">
                                                        <path d="M8.864.046C7.908-.193 7.02.53 6.956 1.466c-.072 1.051-.23 2.016-.428 2.59-.125.36-.479 1.013-1.04 1.639-.557.623-1.282 1.178-2.131 1.41C2.685 7.288 2 7.87 2 8.72v4.001c0 .845.682 1.464 1.448 1.545 1.07.114 1.564.415 2.068.723l.048.03c.272.165.578.348.97.484.397.136.861.217 1.466.217h3.5c.937 0 1.599-.477 1.934-1.064a1.86 1.86 0 0 0 .254-.912c0-.152-.023-.312-.077-.464.201-.263.38-.578.488-.901.11-.33.172-.762.004-1.149.069-.13.12-.269.159-.403.077-.27.113-.568.113-.857 0-.288-.036-.585-.113-.856a2.144 2.144 0 0 0-.138-.362 1.9 1.9 0 0 0 .234-1.734c-.206-.592-.682-1.1-1.2-1.272-.847-.282-1.803-.276-2.516-.211a9.84 9.84 0 0 0-.443.05 9.365 9.365 0 0 0-.062-4.509A1.38 1.38 0 0 0 9.125.111L8.864.046zM11.5 14.721H8c-.51 0-.863-.069-1.14-.164-.281-.097-.506-.228-.776-.393l-.04-.024c-.555-.339-1.198-.731-2.49-.868-.333-.036-.554-.29-.554-.55V8.72c0-.254.226-.543.62-.65 1.095-.3 1.977-.996 2.614-1.708.635-.71 1.064-1.475 1.238-1.978.243-.7.407-1.768.482-2.85.025-.362.36-.594.667-.518l.262.066c.16.04.258.143.288.255a8.34 8.34 0 0 1-.145 4.725.5.5 0 0 0 .595.644l.003-.001.014-.003.058-.014a8.908 8.908 0 0 1 1.036-.157c.663-.06 1.457-.054 2.11.164.175.058.45.3.57.65.107.308.087.67-.266 1.022l-.353.353.353.354c.043.043.105.141.154.315.048.167.075.37.075.581 0 .212-.027.414-.075.582-.05.174-.111.272-.154.315l-.353.353.353.354c.047.047.109.177.005.488a2.224 2.224 0 0 1-.505.805l-.353.353.353.354c.006.005.041.05.041.17a.866.866 0 0 1-.121.416c-.165.288-.503.56-1.066.56z"/>
                                                    </svg>
                                                    <span class="helpful-count">{{ critique.helpful_count|default:0 }}</span>
                                                </button>
                                                <button class="btn btn-sm btn-outline-warning me-1 reaction-btn {% if critique.user_reactions and 'INSPIRING' in critique.user_reactions %}active{% endif %}" 
                                                        data-critique-id="{{ critique.id }}" 
                                                        data-reaction-type="INSPIRING"
                                                        onclick="toggleReaction(this, {{ critique.id }}, 'INSPIRING')">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-lightbulb" viewBox="0 0 16 16">
                                                        <path d="M2 6a6 6 0 1 1 10.174 4.31c-.203.196-.359.4-.453.619l-.762 1.769A.5.5 0 0 1 10.5 13a.5.5 0 0 1 0 1 .5.5 0 0 1 0 1l-.224.447a1 1 0 0 1-.894.553H6.618a1 1 0 0 1-.894-.553L5.5 15a.5.5 0 0 1 0-1 .5.5 0 0 1 0-1 .5.5 0 0 1-.46-.302l-.761-1.77a1.964 1.964 0 0 0-.453-.618A5.984 5.984 0 0 1 2 6zm6-5a5 5 0 0 0-3.479 8.592c.263.254.514.564.676.941L5.83 12h4.342l.632-1.467c.162-.377.413-.687.676-.941A5 5 0 0 0 8 1z"/>
                                                    </svg>
                                                    <span class="inspiring-count">{{ critique.inspiring_count|default:0 }}</span>
                                                </button>
                                                <button class="btn btn-sm btn-outline-info reaction-btn {% if critique.user_reactions and 'DETAILED' in critique.user_reactions %}active{% endif %}" 
                                                        data-critique-id="{{ critique.id }}" 
                                                        data-reaction-type="DETAILED"
                                                        onclick="toggleReaction(this, {{ critique.id }}, 'DETAILED')">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-card-text" viewBox="0 0 16 16">
                                                        <path d="M14.5 3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h13zm-13-1A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-13z"/>
                                                        <path d="M3 5.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 8a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 8zm0 2.5a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5z"/>
                                                    </svg>
                                                    <span class="detailed-count">{{ critique.detailed_count|default:0 }}</span>
                                                </button>
                                            {% elif user.is_authenticated and user == critique.author %}
                                                <!-- Read-only reaction summary for critique author -->
                                                <div class="d-flex flex-wrap gap-2 small text-muted">
                                                    <div>
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-hand-thumbs-up me-1" viewBox="0 0 16 16">
                                                            <path d="M8.864.046C7.908-.193 7.02.53 6.956 1.466c-.072 1.051-.23 2.016-.428 2.59-.125.36-.479 1.013-1.04 1.639-.557.623-1.282 1.178-2.131 1.41C2.685 7.288 2 7.87 2 8.72v4.001c0 .845.682 1.464 1.448 1.545 1.07.114 1.564.415 2.068.723l.048.03c.272.165.578.348.97.484.397.136.861.217 1.466.217h3.5c.937 0 1.599-.477 1.934-1.064a1.86 1.86 0 0 0 .254-.912c0-.152-.023-.312-.077-.464.201-.263.38-.578.488-.901.11-.33.172-.762.004-1.149.069-.13.12-.269.159-.403.077-.27.113-.568.113-.857 0-.288-.036-.585-.113-.856a2.144 2.144 0 0 0-.138-.362 1.9 1.9 0 0 0 .234-1.734c-.206-.592-.682-1.1-1.2-1.272-.847-.282-1.803-.276-2.516-.211a9.84 9.84 0 0 0-.443.05 9.365 9.365 0 0 0-.062-4.509A1.38 1.38 0 0 0 9.125.111L8.864.046zM11.5 14.721H8c-.51 0-.863-.069-1.14-.164-.281-.097-.506-.228-.776-.393l-.04-.024c-.555-.339-1.198-.731-2.49-.868-.333-.036-.554-.29-.554-.55V8.72c0-.254.226-.543.62-.65 1.095-.3 1.977-.996 2.614-1.708.635-.71 1.064-1.475 1.238-1.978.243-.7.407-1.768.482-2.85.025-.362.36-.594.667-.518l.262.066c.16.04.258.143.288.255a8.34 8.34 0 0 1-.145 4.725.5.5 0 0 0 .595.644l.003-.001.014-.003.058-.014a8.908 8.908 0 0 1 1.036-.157c.663-.06 1.457-.054 2.11.164.175.058.45.3.57.65.107.308.087.67-.266 1.022l-.353.353.353.354c.043.043.105.141.154.315.048.167.075.37.075.581 0 .212-.027.414-.075.582-.05.174-.111.272-.154.315l-.353.353.353.354c.047.047.109.177.005.488a2.224 2.224 0 0 1-.505.805l-.353.353.353.354c.006.005.041.05.041.17a.866.866 0 0 1-.121.416c-.165.288-.503.56-1.066.56z"/>
                                                        </svg>
                                                        Helpful: {{ critique.get_helpful_count }}
                                                    </div>
                                                    <div>
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-lightbulb me-1" viewBox="0 0 16 16">
                                                            <path d="M2 6a6 6 0 1 1 10.174 4.31c-.203.196-.359.4-.453.619l-.762 1.769A.5.5 0 0 1 10.5 13a.5.5 0 0 1 0 1 .5.5 0 0 1 0 1l-.224.447a1 1 0 0 1-.894.553H6.618a1 1 0 0 1-.894-.553L5.5 15a.5.5 0 0 1 0-1 .5.5 0 0 1 0-1 .5.5 0 0 1-.46-.302l-.761-1.77a1.964 1.964 0 0 0-.453-.618A5.984 5.984 0 0 1 2 6zm6-5a5 5 0 0 0-3.479 8.592c.263.254.514.564.676.941L5.83 12h4.342l.632-1.467c.162-.377.413-.687.676-.941A5 5 0 0 0 8 1z"/>
                                                        </svg>
                                                        Inspiring: {{ critique.get_inspiring_count }}
                                                    </div>
                                                    <div>
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-list-check me-1" viewBox="0 0 16 16">
                                                            <path fill-rule="evenodd" d="M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3.854 2.146a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0l-.5-.5a.5.5 0 1 1 .708-.708L2 3.293l1.146-1.147a.5.5 0 0 1 .708 0zm0 4a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0l-.5-.5a.5.5 0 1 1 .708-.708L2 7.293l1.146-1.147a.5.5 0 0 1 .708 0zm0 4a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0l-.5-.5a.5.5 0 0 1 .708-.708l.146.147 1.146-1.147a.5.5 0 0 1 .708 0z"/>
                                                        </svg>
                                                        Detailed: {{ critique.get_detailed_count }}
                                                    </div>
                                                </div>
                                            {% else %}
                                                <!-- Login prompt for unauthenticated users -->
                                                <a href="{% url 'account_login' %}" class="btn btn-sm btn-outline-secondary">
                                                    Log in to react
                                                </a>
                                            {% endif %}
                                        </div>


                                        <!-- Action Controls -->
                                        <div class="action-controls d-flex gap-2">
                                            {% if user.is_authenticated %}
                                            <button class="btn btn-sm btn-outline-info reply-btn" onclick="toggleReplyForm({{ critique.id }})">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-reply me-1" viewBox="0 0 16 16">
                                                    <path d="M6.598 5.013a.144.144 0 0 1 .202.134V6.3a.5.5 0 0 0 .5.5c.667 0 2.013.005 3.3.822.984.624 1.99 1.76 2.595 3.876-1.02-.983-2.185-1.516-3.205-1.799a8.74 8.74 0 0 0-1.921-.306 7.404 7.404 0 0 0-.798.008h-.013l-.005.001h-.001L7.3 9.9l-.05-.498a.5.5 0 0 0-.45.498v1.153c0 .108-.11.176-.202.134L2.614 8.254a.503.503 0 0 0-.042-.028.147.147 0 0 1 0-.252.499.499 0 0 0 .042-.028l3.984-2.933zM7.8 10.386c.068 0 .143.003.223.006.434.02 1.034.086 1.7.271 1.326.368 2.896 1.202 3.94 3.08a.5.5 0 0 0 .933-.305c-.464-3.71-1.886-5.662-3.46-6.66-1.245-.79-2.527-.942-3.336-.971v-.66a1.144 1.144 0 0 0-1.767-.96l-3.994 2.94a1.147 1.147 0 0 0 0 1.946l3.994 2.94a1.144 1.144 0 0 0 1.767-.96v-.667z"/>
                                                </svg>
                                                Reply
                                            </button>
                                            {% endif %}

                                            {% if user.is_authenticated and user == artwork.author %}
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-three-dots me-1" viewBox="0 0 16 16">
                                                        <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
                                                    </svg>
                                                    Actions
                                                </button>
                                                <ul class="dropdown-menu bg-dark border-secondary">
                                                    {% if critique.is_hidden %}
                                                    <li><button class="dropdown-item text-success" onclick="unhideCritique({{ critique.id }})">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-eye me-1" viewBox="0 0 16 16">
                                                            <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                                                            <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                                                        </svg>
                                                        Unhide
                                                    </button></li>
                                                    {% else %}
                                                    <li><button class="dropdown-item text-warning" onclick="hideCritique({{ critique.id }})">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-eye-slash me-1" viewBox="0 0 16 16">
                                                            <path d="M13.359 11.238C15.06 9.72 16 8 16 8s-3-5.5-8-5.5a7.028 7.028 0 0 0-2.79.588l.77.771A5.944 5.944 0 0 1 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.134 13.134 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755-.165.165-.337.328-.517.486l.708.709z"/>
                                                            <path d="M11.297 9.176a3.5 3.5 0 0 0-4.474-4.474l.823.823a2.5 2.5 0 0 1 2.829 2.829l.822.822zm-2.943 1.299.822.822a3.5 3.5 0 0 1-4.474-4.474l.823.823a2.5 2.5 0 0 0 2.829 2.829z"/>
                                                            <path d="M3.35 5.47c-.18.16-.353.322-.518.487A13.134 13.134 0 0 0 1.172 8l.195.288c.335.48.83 1.12 1.465 1.755C4.121 11.332 5.881 12.5 8 12.5c.716 0 1.39-.133 2.02-.36l.77.772A7.029 7.029 0 0 1 8 13.5C3 13.5 0 8 0 8s.939-1.721 2.641-3.238l.708.709zm10.296 8.884-12-12 .708-.708 12 12-.708.708z"/>
                                                        </svg>
                                                        Hide
                                                    </button></li>
                                                    {% endif %}
                                                    {% if user == critique.author %}
                                                    <li><hr class="dropdown-divider border-secondary"></li>
                                                    <li><button class="dropdown-item text-danger" onclick="deleteCritique({{ critique.id }})">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-trash me-1" viewBox="0 0 16 16">
                                                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                                        </svg>
                                                        Delete
                                                    </button></li>
                                                    {% endif %}
                                                    <li><hr class="dropdown-divider border-secondary"></li>
                                                    <li><button class="dropdown-item text-warning" onclick="flagCritique({{ critique.id }})">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-flag me-1" viewBox="0 0 16 16">
                                                            <path d="M14.778.085A.5.5 0 0 1 15 .5V8a.5.5 0 0 1-.314.464L9.5 10.385v.615a3 3 0 0 1-6 0V4.5a.5.5 0 0 1 .5-.5h1.053c.326 0 .653-.086.94-.252C6.781 2.981 7.787 1.5 9.5 1.5c1.712 0 2.719 1.481 3.547 2.248.287.266.614.352.94.352H15a.5.5 0 0 1 .278.915l-5.686 2.885v.615a3 3 0 0 1-6 0V9.5a.5.5 0 0 1 .5-.5h1.053c.326 0 .653-.086.94-.252C6.781 7.981 7.787 6.5 9.5 6.5c1.712 0 2.719 1.481 3.547 2.248.287.266.614.352.94.352H15a.5.5 0 0 1 .278.915z"/>
                                                        </svg>
                                                        Flag for Moderation
                                                    </button></li>
                                                </ul>
                                            </div>
                                            {% elif user.is_authenticated %}
                                            <button class="btn btn-sm btn-outline-warning" onclick="flagCritique({{ critique.id }})">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-flag me-1" viewBox="0 0 16 16">
                                                    <path d="M14.778.085A.5.5 0 0 1 15 .5V8a.5.5 0 0 1-.314.464L9.5 10.385v.615a3 3 0 0 1-6 0V4.5a.5.5 0 0 1 .5-.5h1.053c.326 0 .653-.086.94-.252C6.781 2.981 7.787 1.5 9.5 1.5c1.712 0 2.719 1.481 3.547 2.248.287.266.614.352.94.352H15a.5.5 0 0 1 .278.915l-5.686 2.885v.615a3 3 0 0 1-6 0V9.5a.5.5 0 0 1 .5-.5h1.053c.326 0 .653-.086.94-.252C6.781 7.981 7.787 6.5 9.5 6.5c1.712 0 2.719 1.481 3.547 2.248.287.266.614.352.94.352H15a.5.5 0 0 1 .278.915z"/>
                                                </svg>
                                                Flag
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No critiques yet. Be the first to share your feedback!</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script>
        // Toggle archived versions visibility (only for artwork authors)
        function toggleArchivedVersions() {
            const checkbox = document.getElementById('showArchivedVersions');
            
            // If toggle doesn't exist (non-author), do nothing
            if (!checkbox) {
                return;
            }
            
            const archivedVersions = document.querySelectorAll('.version-thumbnail[data-archived="true"]');
            
            if (checkbox.checked) {
                // Show archived versions
                archivedVersions.forEach(function(thumbnail) {
                    thumbnail.style.display = 'block';
                    thumbnail.style.opacity = '0.7';
                    // Add archived badge if not already present
                    if (!thumbnail.querySelector('.archived-badge')) {
                        const badge = document.createElement('div');
                        badge.className = 'archived-badge position-absolute top-0 start-0 m-1';
                        badge.innerHTML = '<span class="badge bg-secondary" style="font-size: 0.6rem;">Archived</span>';
                        thumbnail.querySelector('.position-relative').appendChild(badge);
                    }
                });
            } else {
                // Hide archived versions
                archivedVersions.forEach(function(thumbnail) {
                    thumbnail.style.display = 'none';
                });
            }
        }

        // Initialize archived version visibility on page load
        function initializeArchivedVersions() {
            const archivedVersions = document.querySelectorAll('.version-thumbnail[data-archived="true"]');
            archivedVersions.forEach(function(thumbnail) {
                thumbnail.style.display = 'none';
            });
        }

        // Call initialization when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeArchivedVersions();
            initializeDragAndDrop();
        });

        // Global variables for comparison
        let comparisonMode = false;
        let leftDroppedVersion = null;
        let rightDroppedVersion = null;

        // Toggle comparison mode
        function toggleComparisonMode() {
            const checkbox = document.getElementById('comparisonModeToggle');
            const comparisonInterface = document.getElementById('comparisonInterface');
            const versionThumbnails = document.querySelectorAll('.version-thumbnail');
            
            comparisonMode = checkbox.checked;
            
            if (comparisonMode) {
                comparisonInterface.style.display = 'block';
                // Enable drag functionality on version thumbnails
                versionThumbnails.forEach(thumbnail => {
                    thumbnail.classList.add('comparison-mode');
                    thumbnail.draggable = true;
                });
            } else {
                comparisonInterface.style.display = 'none';
                clearComparison();
                // Disable drag functionality
                versionThumbnails.forEach(thumbnail => {
                    thumbnail.classList.remove('comparison-mode');
                    thumbnail.draggable = false;
                });
            }
        }

        // Initialize drag and drop functionality
        function initializeDragAndDrop() {
            const versionThumbnails = document.querySelectorAll('.version-thumbnail');
            
            versionThumbnails.forEach(thumbnail => {
                thumbnail.addEventListener('dragstart', handleDragStart);
                thumbnail.addEventListener('dragend', handleDragEnd);
            });
        }

        // Handle drag start
        function handleDragStart(e) {
            if (!comparisonMode) return;
            
            e.target.classList.add('dragging');
            
            // Get the version data from the element's data attributes
            const versionElement = e.target.closest('.version-thumbnail') || e.target;
            const imgElement = versionElement.querySelector('img');
            const titleElement = versionElement.querySelector('small');
            
            const versionData = {
                id: versionElement.dataset.versionId || versionElement.dataset.version,
                artworkId: {{ artwork.id }},
                version_number: versionElement.dataset.versionNumber,
                number: versionElement.dataset.versionNumber,
                title: titleElement?.textContent?.trim() || `Version ${versionElement.dataset.versionNumber}`,
                image: imgElement?.src || null,
                image_url: imgElement?.src || null,
                description: versionElement.dataset.description || `Version ${versionElement.dataset.versionNumber}`,
                tags: versionElement.dataset.tags ? versionElement.dataset.tags.split(',') : [],
                created_at: versionElement.dataset.createdAt || new Date().toISOString(),
                status: versionElement.dataset.status || 'draft'
            };
            
            console.log('Dragging version data:', versionData); // Debug logging
            e.dataTransfer.setData('text/plain', JSON.stringify(versionData));
        }

        // Handle drag end
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        // Allow drop
        function allowDrop(e) {
            e.preventDefault();
        }

        // Highlight drop zone
        function highlightDropZone(e) {
            e.preventDefault();
            e.target.closest('.drop-zone').classList.add('highlight');
        }

        // Unhighlight drop zone
        function unhighlightDropZone(e) {
            e.target.closest('.drop-zone').classList.remove('highlight');
        }

        // Handle drop
        function handleDrop(e, side) {
            e.preventDefault();
            const dropZone = e.target.closest('.drop-zone');
            dropZone.classList.remove('highlight');
            
            try {
                const versionData = JSON.parse(e.dataTransfer.getData('text/plain'));
                addVersionToDropZone(versionData, side);
                updateCompareButton();
            } catch (error) {
                console.error('Error handling drop:', error);
                showToast('Error', 'Failed to add version to comparison', 'danger');
            }
        }

        // Add version to drop zone
        function addVersionToDropZone(versionData, side) {
            const dropZoneContent = document.querySelector(`#${side}DropZone .drop-zone-content`);
            const droppedVersionDiv = document.querySelector(`#${side}DroppedVersion`);
            
            // Hide the placeholder content
            dropZoneContent.style.display = 'none';
            
            // Show and populate the dropped version with proper vertical layout
            droppedVersionDiv.style.display = 'flex';
            droppedVersionDiv.style.flexDirection = 'column';
            droppedVersionDiv.style.alignItems = 'center';
            droppedVersionDiv.style.gap = '0.5rem';
            droppedVersionDiv.style.padding = '0.75rem';
            droppedVersionDiv.innerHTML = `
                <div class="version-thumbnail-container d-flex flex-column align-items-center" style="gap: 0.25rem;">
                    ${versionData.image ? 
                        `<img src="${versionData.image}" alt="${versionData.title}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px; border: 2px solid #28a745;">` : 
                        '<div class="bg-secondary d-flex align-items-center justify-content-center" style="width: 60px; height: 60px; border-radius: 6px; border: 2px solid #28a745;"><span class="text-muted small">No Image</span></div>'
                    }
                    <small class="text-white fw-bold text-center version-title" style="margin: 0.25rem 0; line-height: 1.2;">${versionData.title}</small>
                </div>
                <button class="btn btn-sm btn-outline-danger remove-btn" onclick="removeVersionFromDropZone('${side}')" style="margin-top: 0.25rem; font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-x me-1" viewBox="0 0 16 16">
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                    Remove
                </button>
            `;
            
            // Store the version data
            if (side === 'left') {
                leftDroppedVersion = versionData;
            } else {
                rightDroppedVersion = versionData;
            }
        }

        // Remove version from drop zone
        function removeVersionFromDropZone(side) {
            const dropZoneContent = document.querySelector(`#${side}DropZone .drop-zone-content`);
            const droppedVersionDiv = document.querySelector(`#${side}DroppedVersion`);
            
            // Show the placeholder content
            dropZoneContent.style.display = 'block';
            
            // Hide the dropped version
            droppedVersionDiv.style.display = 'none';
            droppedVersionDiv.innerHTML = '';
            
            // Clear the stored data
            if (side === 'left') {
                leftDroppedVersion = null;
            } else {
                rightDroppedVersion = null;
            }
            
            updateCompareButton();
        }

        // Clear comparison
        function clearComparison() {
            removeVersionFromDropZone('left');
            removeVersionFromDropZone('right');
        }

        // Update compare button state
        function updateCompareButton() {
            const compareButton = document.getElementById('compareButton');
            const canCompare = leftDroppedVersion && rightDroppedVersion;
            
            compareButton.disabled = !canCompare;
            compareButton.classList.toggle('btn-primary', canCompare);
            compareButton.classList.toggle('btn-secondary', !canCompare);
        }

        // Open version comparison modal
        function openVersionComparison() {
            if (!leftDroppedVersion || !rightDroppedVersion) {
                showToast('Error', 'Please select two versions to compare', 'warning');
                return;
            }
            
            // Get artwork ID from the page context or version data
            const artworkId = leftDroppedVersion.artworkId || rightDroppedVersion.artworkId || window.artworkId || {{ artwork.id }};
            const version1Id = leftDroppedVersion.id === 'current' ? 'current' : leftDroppedVersion.id;
            const version2Id = rightDroppedVersion.id === 'current' ? 'current' : rightDroppedVersion.id;
            
            // Debug logging
            console.log('Comparison data:', { 
                artworkId, 
                version1Id, 
                version2Id, 
                leftDroppedVersion, 
                rightDroppedVersion 
            });
            
            // Validate we have the required IDs - allow 'current' and numeric IDs
            if (!artworkId || 
                (version1Id !== 'current' && (!version1Id || version1Id === 'undefined')) || 
                (version2Id !== 'current' && (!version2Id || version2Id === 'undefined'))) {
                showToast('Error', 'Missing artwork or version data. Please try again.', 'danger');
                console.error('Missing data for comparison:', { 
                    artworkId, 
                    version1Id, 
                    version2Id, 
                    leftDroppedVersion, 
                    rightDroppedVersion 
                });
                return;
            }
            
            // Show loading animation
            const modalElement = document.getElementById('versionComparisonModal');
            const modal = new bootstrap.Modal(modalElement);
            const comparisonContent = document.getElementById('comparisonContent');
            
            // Add proper cleanup event handlers to prevent backdrop issues
            modalElement.addEventListener('hidden.bs.modal', function (event) {
                // Force removal of any lingering backdrop elements
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => backdrop.remove());
                
                // Reset body classes that might block interaction
                document.body.classList.remove('modal-open');
                document.body.style.removeProperty('padding-right');
                document.body.style.removeProperty('overflow');
                
                // Reset modal state
                modalElement.style.display = 'none';
                modalElement.setAttribute('aria-hidden', 'true');
                modalElement.removeAttribute('aria-modal');
                
                console.log('Modal cleanup completed - page interaction restored');
            });
            
            comparisonContent.innerHTML = `
                <div class="col-12 text-center py-5">
                    <div class="paintbrush-loader mx-auto mb-3"></div>
                    <p class="text-muted">Loading comparison...</p>
                </div>
            `;
            
            modal.show();
            
            // Use client-side comparison with available data
            setTimeout(() => {
                const mockData = {
                    version1: leftDroppedVersion,
                    version2: rightDroppedVersion,
                    differences: {}
                };
                
                // Calculate differences using proper property names
                const leftImage = leftDroppedVersion.image_url || leftDroppedVersion.image;
                const rightImage = rightDroppedVersion.image_url || rightDroppedVersion.image;
                
                if (leftImage !== rightImage) {
                    mockData.differences.image = true;
                }
                if (leftDroppedVersion.title !== rightDroppedVersion.title) {
                    mockData.differences.title = true;
                }
                if (leftDroppedVersion.description !== rightDroppedVersion.description) {
                    mockData.differences.description = true;
                }
                
                displayComparisonResults(mockData);
            }, 500); // Small delay to show loading animation
        }

        // Display comparison results with comprehensive analysis
        function displayComparisonResults(data) {
            const comparisonContent = document.getElementById('comparisonContent');
            const version1 = data.version1;
            const version2 = data.version2;
            const differences = data.differences || {};
            
            // Analyze and count differences
            const diffCount = analyzeDifferences(version1, version2, differences);
            updateComparisonStatus(diffCount, differences);
            
            comparisonContent.innerHTML = `
                <div class="col-6">
                    <div class="card bg-secondary h-100">
                        <div class="card-header bg-primary d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Version ${version1.version_number || 'Current'}</h6>
                            <span class="badge bg-light text-dark">${formatDate(version1.created_at)}</span>
                        </div>
                        <div class="card-body">
                            <!-- Image Section with Diff Highlighting -->
                            <div class="mb-3 position-relative">
                                ${(version1.image_url || version1.image) ? 
                                    `<img src="${version1.image_url || version1.image}" class="img-fluid rounded ${differences.image ? 'border border-warning border-3' : ''}" alt="Version ${version1.version_number}" style="max-height: 600px; width: 100%; object-fit: contain; cursor: pointer;" onclick="openImageModal('${version1.image_url || version1.image}', 'Version ${version1.version_number}')">
                                     ${differences.image ? '<div class="position-absolute top-0 end-0 m-2"><span class="badge bg-warning"><i class="bi bi-exclamation-triangle"></i> Changed</span></div>' : ''}` : 
                                    '<div class="bg-dark p-5 rounded text-center"><span class="text-muted">No Image</span></div>'
                                }
                            </div>
                            
                            <!-- Metadata with Diff Highlighting -->
                            <div class="small">
                                <div class="mb-3">
                                    <strong>Title:</strong>
                                    <div class="p-2 rounded ${differences.title ? 'bg-warning bg-opacity-25 border border-warning' : 'bg-dark'}">
                                        <span class="${differences.title ? 'text-warning fw-bold' : 'text-light'}">${version1.title || 'Untitled'}</span>
                                        ${differences.title ? '<span class="badge bg-warning ms-2">Changed</span>' : ''}
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <strong>Description:</strong>
                                    <div class="p-2 rounded ${differences.description ? 'bg-warning bg-opacity-25 border border-warning' : 'bg-dark'}">
                                        <span class="${differences.description ? 'text-warning' : 'text-muted'}">${version1.description || 'No description'}</span>
                                        ${differences.description ? '<span class="badge bg-warning ms-2">Changed</span>' : ''}
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <strong>Tags:</strong>
                                    <div class="p-2 rounded ${differences.tags ? 'bg-warning bg-opacity-25 border border-warning' : 'bg-dark'}">
                                        ${version1.tags && version1.tags.length > 0 ? 
                                            version1.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('') : 
                                            '<span class="text-muted">No tags</span>'
                                        }
                                        ${differences.tags ? '<span class="badge bg-warning ms-2">Changed</span>' : ''}
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <strong>Status:</strong>
                                    <div class="p-2 rounded ${differences.status ? 'bg-warning bg-opacity-25 border border-warning' : 'bg-dark'}">
                                        <span class="badge ${getStatusBadgeClass(version1.status)}">${version1.status || 'Draft'}</span>
                                        ${differences.status ? '<span class="badge bg-warning ms-2">Changed</span>' : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card bg-secondary h-100">
                        <div class="card-header bg-success d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Version ${version2.version_number || 'Current'}</h6>
                            <span class="badge bg-light text-dark">${formatDate(version2.created_at)}</span>
                        </div>
                        <div class="card-body">
                            <!-- Image Section with Diff Highlighting -->
                            <div class="mb-3 position-relative">
                                ${(version2.image_url || version2.image) ? 
                                    `<img src="${version2.image_url || version2.image}" class="img-fluid rounded ${differences.image ? 'border border-warning border-3' : ''}" alt="Version ${version2.version_number}" style="max-height: 600px; width: 100%; object-fit: contain; cursor: pointer;" onclick="openImageModal('${version2.image_url || version2.image}', 'Version ${version2.version_number}')">
                                     ${differences.image ? '<div class="position-absolute top-0 end-0 m-2"><span class="badge bg-warning"><i class="bi bi-exclamation-triangle"></i> Changed</span></div>' : ''}` : 
                                    '<div class="bg-dark p-5 rounded text-center"><span class="text-muted">No Image</span></div>'
                                }
                            </div>
                            
                            <!-- Metadata with Diff Highlighting -->
                            <div class="small">
                                <div class="mb-3">
                                    <strong>Title:</strong>
                                    <div class="p-2 rounded ${differences.title ? 'bg-warning bg-opacity-25 border border-warning' : 'bg-dark'}">
                                        <span class="${differences.title ? 'text-warning fw-bold' : 'text-light'}">${version2.title || 'Untitled'}</span>
                                        ${differences.title ? '<span class="badge bg-warning ms-2">Changed</span>' : ''}
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <strong>Description:</strong>
                                    <div class="p-2 rounded ${differences.description ? 'bg-warning bg-opacity-25 border border-warning' : 'bg-dark'}">
                                        <span class="${differences.description ? 'text-warning' : 'text-muted'}">${version2.description || 'No description'}</span>
                                        ${differences.description ? '<span class="badge bg-warning ms-2">Changed</span>' : ''}
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <strong>Tags:</strong>
                                    <div class="p-2 rounded ${differences.tags ? 'bg-warning bg-opacity-25 border border-warning' : 'bg-dark'}">
                                        ${version2.tags && version2.tags.length > 0 ? 
                                            version2.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('') : 
                                            '<span class="text-muted">No tags</span>'
                                        }
                                        ${differences.tags ? '<span class="badge bg-warning ms-2">Changed</span>' : ''}
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <strong>Status:</strong>
                                    <div class="p-2 rounded ${differences.status ? 'bg-warning bg-opacity-25 border border-warning' : 'bg-dark'}">
                                        <span class="badge ${getStatusBadgeClass(version2.status)}">${version2.status || 'Draft'}</span>
                                        ${differences.status ? '<span class="badge bg-warning ms-2">Changed</span>' : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                ${Object.keys(differences).length > 0 ? `
                <div class="col-12 mt-3">
                    <div class="card bg-dark">
                        <div class="card-header">
                            <h6 class="mb-0">Detected Differences</h6>
                        </div>
                        <div class="card-body">
                            ${Object.entries(differences).map(([field, diff]) => `
                                <div class="mb-2">
                                    <strong>${field.charAt(0).toUpperCase() + field.slice(1)}:</strong>
                                    <span class="text-warning">${diff}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
            
            // Setup overlay view with actual version data
            setupOverlayView(version1, version2);
        }
        
        // Analyze differences between versions
        function analyzeDifferences(version1, version2, differences) {
            let diffCount = 0;
            
            // Count existing differences from backend
            diffCount = Object.keys(differences).length;
            
            // Add client-side analysis for additional fields
            if (version1.title !== version2.title) diffCount++;
            if (version1.description !== version2.description) diffCount++;
            if (version1.image_url !== version2.image_url) diffCount++;
            
            return diffCount;
        }
        
        // Update comparison status display
        function updateComparisonStatus(diffCount, differences) {
            const statusElement = document.getElementById('comparisonStatus');
            const diffCountElement = document.getElementById('diffCount');
            
            if (diffCountElement) {
                diffCountElement.textContent = diffCount;
            }
            
            if (statusElement) {
                if (diffCount === 0) {
                    statusElement.innerHTML = '<span class="badge bg-success me-2">Identical</span>These versions are identical';
                } else {
                    const severity = diffCount > 3 ? 'danger' : diffCount > 1 ? 'warning' : 'info';
                    statusElement.innerHTML = `<span class="badge bg-${severity} me-2">${diffCount} Difference${diffCount > 1 ? 's' : ''}</span>Found changes between versions`;
                }
            }
        }
        
        // Setup advanced overlay view for image comparison
        function setupOverlayView(version1, version2) {
            const overlayContainer = document.getElementById('overlayContainer');
            
            if (!overlayContainer) return;
            
            const version1Image = version1.image_url || version1.image;
            const version2Image = version2.image_url || version2.image;
            
            if (version1Image && version2Image) {
                overlayContainer.innerHTML = `
                    <!-- Advanced Image Overlay Container -->
                    <div class="bg-dark" style="min-height: 75vh;">
                        <!-- Zoom and Blend Controls -->
                        <div class="p-2 bg-secondary border-bottom d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <label class="form-label text-light me-2 mb-0">Blend Mode:</label>
                                <select id="blendModeSelect" class="form-select form-select-sm" style="width: 140px;">
                                    <option value="normal">Normal</option>
                                    <option value="multiply">Multiply</option>
                                    <option value="screen">Screen</option>
                                    <option value="overlay">Overlay</option>
                                    <option value="difference">Difference</option>
                                    <option value="lighten">Lighten</option>
                                    <option value="darken">Darken</option>
                                    <option value="color-dodge">Color Dodge</option>
                                    <option value="color-burn">Color Burn</option>
                                    <option value="hard-light">Hard Light</option>
                                    <option value="soft-light">Soft Light</option>
                                    <option value="exclusion">Exclusion</option>
                                </select>
                            </div>
                            <div class="d-flex align-items-center">
                                <button id="zoomOut" class="btn btn-sm btn-outline-light me-2">-</button>
                                <span id="zoomLevel" class="text-light me-2">100%</span>
                                <button id="zoomIn" class="btn btn-sm btn-outline-light me-3">+</button>
                                <button id="resetZoom" class="btn btn-sm btn-outline-light">Reset</button>
                            </div>
                        </div>
                        
                        <!-- Zoomable Image Container -->
                        <div id="zoomContainer" class="position-relative overflow-hidden" style="height: 70vh; cursor: grab;">
                            <div id="imageWrapper" class="position-relative d-flex justify-content-center align-items-center h-100" 
                                 style="transform-origin: center center; transition: transform 0.2s ease;">
                                <img id="overlayBaseImage" src="${version1Image}" class="img-fluid" alt="Version ${version1.version_number}" 
                                     style="opacity: 1; display: block; max-height: 70vh; width: auto; object-fit: contain; pointer-events: none;"
                                     onload="initializeOverlayImages()">
                                <img id="overlayTopImage" src="${version2Image}" class="position-absolute top-0 start-0" alt="Version ${version2.version_number}" 
                                     style="opacity: 0.5; max-height: 70vh; width: auto; object-fit: contain; pointer-events: none; mix-blend-mode: normal;"
                                     onload="initializeOverlayImages()">
                            </div>
                        </div>
                        
                        <!-- Opacity and Position Controls -->
                        <div class="p-3 bg-secondary border-top">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <span class="badge bg-primary me-2">Base: v${version1.version_number || 'Current'}</span>
                                    <span class="badge bg-success">Overlay: v${version2.version_number || 'Current'}</span>
                                </div>
                                <div class="col-md-4 text-center">
                                    <label for="overlaySlider" class="form-label text-light mb-1">Overlay Opacity:</label>
                                    <div class="d-flex align-items-center justify-content-center">
                                        <input type="range" class="form-range" min="0" max="100" value="50" id="overlaySlider" style="width: 150px;">
                                        <span id="opacityValue" class="text-light ms-2">50%</span>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="d-flex justify-content-end align-items-center">
                                        <button id="toggleDraggable" class="btn btn-sm btn-outline-light me-2">
                                            <i class="bi bi-arrows-move"></i> Drag Mode
                                        </button>
                                        <button id="resetPosition" class="btn btn-sm btn-outline-light">
                                            <i class="bi bi-arrow-clockwise"></i> Reset
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Initialize all overlay functionality
                initializeOverlayControls();
                
                // Force immediate overlay setup - ensure both images are visible
                setTimeout(() => {
                    const baseImage = document.getElementById('overlayBaseImage');
                    const topImage = document.getElementById('overlayTopImage');
                    
                    if (baseImage && topImage) {
                        // Ensure base image is visible
                        baseImage.style.display = 'block';
                        baseImage.style.opacity = '1';
                        
                        // Ensure overlay image is visible with 50% opacity
                        topImage.style.display = 'block';
                        topImage.style.opacity = '0.5';
                        topImage.style.position = 'absolute';
                        topImage.style.top = '0';
                        topImage.style.left = '0';
                        
                        // Force image synchronization
                        initializeOverlayImages();
                        syncImageDimensions();
                        
                        console.log('Overlay comparison initialized:', {
                            baseVisible: baseImage.style.display !== 'none',
                            overlayVisible: topImage.style.display !== 'none',
                            overlayOpacity: topImage.style.opacity
                        });
                    }
                }, 200);
                
            } else {
                overlayContainer.innerHTML = `
                    <div class="text-center text-muted p-5 bg-dark" style="min-height: 60vh; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-image mb-3" viewBox="0 0 16 16">
                            <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                            <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093L6.5 10.5l-2.5-2.5a.5.5 0 0 0-.707 0L.002 10.5V3a1 1 0 0 1 1-1h12z"/>
                        </svg>
                        <p>Overlay view requires both versions to have images</p>
                    </div>
                `;
            }
        }
        
        // Global overlay state
        let overlayState = {
            zoom: 1,
            panX: 0,
            panY: 0,
            isDraggableMode: false,
            isDragging: false,
            lastMouseX: 0,
            lastMouseY: 0,
            overlayOffsetX: 0,
            overlayOffsetY: 0
        };
        
        // Initialize overlay images with perfect synchronization
        function initializeOverlayImages() {
            const baseImage = document.getElementById('overlayBaseImage');
            const topImage = document.getElementById('overlayTopImage');
            
            if (baseImage && topImage) {
                // Force overlay image to be visible and properly positioned
                topImage.style.display = 'block';
                topImage.style.opacity = '0.5';
                topImage.style.position = 'absolute';
                topImage.style.top = '0';
                topImage.style.left = '0';
                topImage.style.transform = 'translate(0px, 0px)';
                topImage.style.pointerEvents = 'none';
                
                // Reset overlay state
                overlayState.overlayOffsetX = 0;
                overlayState.overlayOffsetY = 0;
                
                // Wait for base image to load, then sync dimensions
                if (baseImage.complete) {
                    syncImageDimensions();
                } else {
                    baseImage.onload = syncImageDimensions;
                }
                
                // Also sync when overlay image loads
                if (topImage.complete) {
                    syncImageDimensions();
                } else {
                    topImage.onload = syncImageDimensions;
                }
            }
        }
        
        // Synchronize image dimensions for perfect overlay alignment
        function syncImageDimensions() {
            const baseImage = document.getElementById('overlayBaseImage');
            const topImage = document.getElementById('overlayTopImage');
            
            if (baseImage && topImage && baseImage.complete && topImage.complete) {
                // Get the actual displayed dimensions of the base image
                const baseRect = baseImage.getBoundingClientRect();
                
                // Apply exact same dimensions to overlay image
                topImage.style.width = baseRect.width + 'px';
                topImage.style.height = baseRect.height + 'px';
                topImage.style.objectFit = 'contain';
                
                console.log('Overlay images synchronized:', {
                    baseSize: { width: baseRect.width, height: baseRect.height },
                    overlayOpacity: topImage.style.opacity
                });
            }
        }
        
        // Initialize all overlay controls
        function initializeOverlayControls() {
            // Opacity slider - ensure it works immediately
            const slider = document.getElementById('overlaySlider');
            const opacityValue = document.getElementById('opacityValue');
            if (slider && opacityValue) {
                // Set initial opacity value
                slider.value = 50;
                opacityValue.textContent = '50%';
                
                slider.addEventListener('input', function() {
                    const topImage = document.getElementById('overlayTopImage');
                    if (topImage) {
                        const newOpacity = this.value / 100;
                        topImage.style.opacity = newOpacity;
                        opacityValue.textContent = this.value + '%';
                        
                        // Ensure image is visible
                        if (newOpacity > 0) {
                            topImage.style.display = 'block';
                        }
                    }
                });
                
                // Force initial overlay visibility
                setTimeout(() => {
                    const topImage = document.getElementById('overlayTopImage');
                    if (topImage) {
                        topImage.style.opacity = '0.5';
                        topImage.style.display = 'block';
                    }
                }, 100);
            }
            
            // Blend mode selector
            const blendSelect = document.getElementById('blendModeSelect');
            if (blendSelect) {
                blendSelect.addEventListener('change', function() {
                    const topImage = document.getElementById('overlayTopImage');
                    if (topImage) {
                        topImage.style.mixBlendMode = this.value;
                    }
                });
            }
            
            // Zoom controls
            const zoomIn = document.getElementById('zoomIn');
            const zoomOut = document.getElementById('zoomOut');
            const resetZoom = document.getElementById('resetZoom');
            const zoomLevel = document.getElementById('zoomLevel');
            
            if (zoomIn) {
                zoomIn.addEventListener('click', () => {
                    overlayState.zoom = Math.min(overlayState.zoom * 1.2, 5);
                    updateZoom();
                });
            }
            
            if (zoomOut) {
                zoomOut.addEventListener('click', () => {
                    overlayState.zoom = Math.max(overlayState.zoom / 1.2, 0.1);
                    updateZoom();
                });
            }
            
            if (resetZoom) {
                resetZoom.addEventListener('click', () => {
                    overlayState.zoom = 1;
                    overlayState.panX = 0;
                    overlayState.panY = 0;
                    updateZoom();
                });
            }
            
            // Draggable toggle
            const toggleDraggable = document.getElementById('toggleDraggable');
            if (toggleDraggable) {
                toggleDraggable.addEventListener('click', () => {
                    overlayState.isDraggableMode = !overlayState.isDraggableMode;
                    toggleDraggable.innerHTML = overlayState.isDraggableMode ? 
                        '<i class="bi bi-arrows-move"></i> Exit Drag' : 
                        '<i class="bi bi-arrows-move"></i> Drag Mode';
                    toggleDraggable.classList.toggle('btn-outline-light');
                    toggleDraggable.classList.toggle('btn-warning');
                    
                    const topImage = document.getElementById('overlayTopImage');
                    if (topImage) {
                        topImage.style.cursor = overlayState.isDraggableMode ? 'move' : 'pointer';
                        topImage.style.pointerEvents = overlayState.isDraggableMode ? 'auto' : 'none';
                    }
                });
            }
            
            // Reset position
            const resetPosition = document.getElementById('resetPosition');
            if (resetPosition) {
                resetPosition.addEventListener('click', () => {
                    overlayState.overlayOffsetX = 0;
                    overlayState.overlayOffsetY = 0;
                    updateOverlayPosition();
                });
            }
            
            // Pan and zoom with mouse wheel - zoom toward cursor
            const zoomContainer = document.getElementById('zoomContainer');
            if (zoomContainer) {
                zoomContainer.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const rect = zoomContainer.getBoundingClientRect();
                    
                    // Capture mouse position only during zoom event
                    const mouseX = e.clientX - rect.left;
                    const mouseY = e.clientY - rect.top;
                    
                    // Set transform origin to current mouse position for this zoom
                    const imageWrapper = document.getElementById('imageWrapper');
                    if (imageWrapper) {
                        const originX = (mouseX / rect.width) * 100;
                        const originY = (mouseY / rect.height) * 100;
                        imageWrapper.style.transformOrigin = `${originX}% ${originY}%`;
                    }
                    
                    const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
                    const newZoom = Math.min(Math.max(overlayState.zoom * zoomFactor, 0.1), 5);
                    
                    overlayState.zoom = newZoom;
                    updateZoom();
                });
                
                // Pan with mouse drag
                let isPanning = false;
                let lastPanX = 0;
                let lastPanY = 0;
                
                zoomContainer.addEventListener('mousedown', (e) => {
                    if (!overlayState.isDraggableMode) {
                        isPanning = true;
                        lastPanX = e.clientX;
                        lastPanY = e.clientY;
                        zoomContainer.style.cursor = 'grabbing';
                    }
                });
                
                zoomContainer.addEventListener('mousemove', (e) => {
                    if (isPanning && !overlayState.isDraggableMode) {
                        const deltaX = e.clientX - lastPanX;
                        const deltaY = e.clientY - lastPanY;
                        overlayState.panX += deltaX;
                        overlayState.panY += deltaY;
                        lastPanX = e.clientX;
                        lastPanY = e.clientY;
                        updateZoom();
                    }
                });
                
                zoomContainer.addEventListener('mouseup', () => {
                    isPanning = false;
                    zoomContainer.style.cursor = 'grab';
                });
                
                zoomContainer.addEventListener('mouseleave', () => {
                    isPanning = false;
                    zoomContainer.style.cursor = 'grab';
                });
            }
            
            // Overlay image dragging
            setupOverlayDragging();
        }
        
        // Update zoom transform with proper transform origin
        function updateZoom() {
            const imageWrapper = document.getElementById('imageWrapper');
            const zoomLevel = document.getElementById('zoomLevel');
            
            if (imageWrapper) {
                // Apply both pan and zoom transformations
                imageWrapper.style.transform = `translate(${overlayState.panX}px, ${overlayState.panY}px) scale(${overlayState.zoom})`;
                
                // Ensure transform origin is maintained (set by mousemove event)
                if (!imageWrapper.style.transformOrigin) {
                    imageWrapper.style.transformOrigin = 'center center';
                }
            }
            
            if (zoomLevel) {
                zoomLevel.textContent = Math.round(overlayState.zoom * 100) + '%';
            }
        }
        
        // Setup overlay image dragging
        function setupOverlayDragging() {
            const topImage = document.getElementById('overlayTopImage');
            if (!topImage) return;
            
            topImage.addEventListener('mousedown', (e) => {
                if (overlayState.isDraggableMode) {
                    overlayState.isDragging = true;
                    overlayState.lastMouseX = e.clientX;
                    overlayState.lastMouseY = e.clientY;
                    e.preventDefault();
                }
            });
            
            document.addEventListener('mousemove', (e) => {
                if (overlayState.isDragging && overlayState.isDraggableMode) {
                    const deltaX = e.clientX - overlayState.lastMouseX;
                    const deltaY = e.clientY - overlayState.lastMouseY;
                    
                    overlayState.overlayOffsetX += deltaX / overlayState.zoom;
                    overlayState.overlayOffsetY += deltaY / overlayState.zoom;
                    
                    overlayState.lastMouseX = e.clientX;
                    overlayState.lastMouseY = e.clientY;
                    
                    updateOverlayPosition();
                }
            });
            
            document.addEventListener('mouseup', () => {
                overlayState.isDragging = false;
            });
        }
        
        // Update overlay image position
        function updateOverlayPosition() {
            const topImage = document.getElementById('overlayTopImage');
            if (topImage) {
                topImage.style.transform = `translate(${overlayState.overlayOffsetX}px, ${overlayState.overlayOffsetY}px)`;
            }
        }
        
        // Swap versions in comparison
        function swapVersions() {
            if (!leftDroppedVersion || !rightDroppedVersion) return;
            
            // Swap the global variables
            const temp = leftDroppedVersion;
            leftDroppedVersion = rightDroppedVersion;
            rightDroppedVersion = temp;
            
            // Re-fetch and display comparison
            openVersionComparison();
            
            showToast('Success', 'Versions swapped successfully', 'success');
        }
        
        // Helper function to format dates
        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            try {
                return new Date(dateString).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (e) {
                return 'Invalid date';
            }
        }
        
        // Helper function to get status badge class
        function getStatusBadgeClass(status) {
            switch(status?.toLowerCase()) {
                case 'published': return 'bg-success';
                case 'draft': return 'bg-secondary';
                case 'archived': return 'bg-warning';
                case 'private': return 'bg-info';
                default: return 'bg-secondary';
            }
        }
        
        // Initialize view mode switching for comparison modal
        document.addEventListener('DOMContentLoaded', function() {
            // Setup view mode toggle functionality
            const versionModal = document.getElementById('versionComparisonModal');
            if (versionModal) {
                versionModal.addEventListener('shown.bs.modal', function() {
                    setupViewModeToggle();
                });
            }
        });
        
        // Nested reply functions
        function showReplyToReply(replyId) {
            const form = document.getElementById(`nested-reply-form-${replyId}`);
            if (form) {
                form.style.display = 'block';
                const textarea = form.querySelector('textarea');
                if (textarea) textarea.focus();
            }
        }

        function hideReplyToReply(replyId) {
            const form = document.getElementById(`nested-reply-form-${replyId}`);
            if (form) {
                form.style.display = 'none';
                const textarea = form.querySelector('textarea');
                if (textarea) textarea.value = '';
            }
        }

        // Delete reply function
        function deleteReply(replyId) {
            if (!confirm('Are you sure you want to delete this reply? This action cannot be undone.')) {
                return;
            }

            fetch(`/api/replies/${replyId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    const replyElement = document.querySelector(`[data-reply-id="${replyId}"]`);
                    if (replyElement) {
                        replyElement.remove();
                        showToast('Reply deleted successfully', 'success');
                    }
                } else {
                    throw new Error('Failed to delete reply');
                }
            })
            .catch(error => {
                console.error('Error deleting reply:', error);
                showToast('Failed to delete reply', 'error');
            });
        }

        // Flag reply function
        function flagReply(replyId) {
            const reason = prompt('Please provide a reason for flagging this reply:');
            if (!reason || reason.trim() === '') return;

            fetch(`/api/replies/${replyId}/flag/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ reason: reason.trim() })
            })
            .then(response => {
                if (response.ok) {
                    showToast('Reply flagged for moderation', 'success');
                } else {
                    throw new Error('Failed to flag reply');
                }
            })
            .catch(error => {
                console.error('Error flagging reply:', error);
                showToast('Failed to flag reply', 'error');
            });
        }

        // Flag critique function
        function flagCritique(critiqueId) {
            const reason = prompt('Please provide a reason for flagging this critique:');
            if (!reason || reason.trim() === '') return;

            fetch(`/api/critiques/${critiqueId}/flag/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ reason: reason.trim() })
            })
            .then(response => {
                if (response.ok) {
                    showToast('Critique flagged for moderation', 'success');
                } else {
                    throw new Error('Failed to flag critique');
                }
            })
            .catch(error => {
                console.error('Error flagging critique:', error);
                showToast('Failed to flag critique', 'error');
            });
        }

        // Delete critique function
        function deleteCritique(critiqueId) {
            if (!confirm('Are you sure you want to delete this critique? This action cannot be undone.')) {
                return;
            }

            fetch(`/api/critiques/${critiqueId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    const critiqueElement = document.querySelector(`[data-critique-id="${critiqueId}"]`);
                    if (critiqueElement) {
                        critiqueElement.remove();
                        showToast('Critique deleted successfully', 'success');
                    }
                    // Refresh page to update critique count
                    setTimeout(() => location.reload(), 1000);
                } else {
                    throw new Error('Failed to delete critique');
                }
            })
            .catch(error => {
                console.error('Error deleting critique:', error);
                showToast('Failed to delete critique', 'error');
            });
        }

        // Open image in fullscreen modal overlay
        function openImageModal(imageUrl, title) {
            if (!imageUrl) return;
            
            // Create modal if it doesn't exist
            let imageModal = document.getElementById('imageModal');
            if (!imageModal) {
                const modalHtml = `
                    <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-fullscreen">
                            <div class="modal-content bg-dark">
                                <div class="modal-header border-0">
                                    <h5 class="modal-title text-white" id="imageModalTitle">${title || 'Image'}</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body d-flex align-items-center justify-content-center p-0">
                                    <img id="modalImage" src="${imageUrl}" class="img-fluid" style="max-height: 100vh; max-width: 100vw; object-fit: contain;">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                imageModal = document.getElementById('imageModal');
            } else {
                // Update existing modal
                document.getElementById('imageModalTitle').textContent = title || 'Image';
                document.getElementById('modalImage').src = imageUrl;
            }
            
            // Show the modal
            const modal = new bootstrap.Modal(imageModal);
            modal.show();
        }

        // Setup view mode toggle functionality
        function setupViewModeToggle() {
            const sideBySideMode = document.getElementById('sideBySideMode');
            const overlayMode = document.getElementById('overlayMode');
            const sideBySideView = document.getElementById('sideBySideView');
            const overlayView = document.getElementById('overlayView');
            
            if (sideBySideMode && overlayMode && sideBySideView && overlayView) {
                sideBySideMode.addEventListener('change', function() {
                    if (this.checked) {
                        sideBySideView.style.display = 'block';
                        overlayView.style.display = 'none';
                    }
                });
                
                overlayMode.addEventListener('change', function() {
                    if (this.checked) {
                        sideBySideView.style.display = 'none';
                        overlayView.style.display = 'block';
                    }
                });
            }
        }

        // Enhanced critique sorting functionality
        function sortCritiques(sortBy) {
            const critiqueCards = Array.from(document.querySelectorAll('.critique-card'));
            const container = critiqueCards[0]?.parentElement;
            
            if (!container || critiqueCards.length === 0) return;
            
            // Update the sort button text
            const currentSortText = document.getElementById('currentSort');
            const sortLabels = {
                'helpful': 'Most Helpful',
                'recent': 'Newest First',
                'oldest': 'Oldest First',
                'rating': 'Highest Rating'
            };
            if (currentSortText) {
                currentSortText.textContent = sortLabels[sortBy] || 'Sort by';
            }
            
            // Sort the cards
            critiqueCards.sort((a, b) => {
                switch(sortBy) {
                    case 'helpful':
                        const helpfulA = parseInt(a.dataset.helpfulCount) || 0;
                        const helpfulB = parseInt(b.dataset.helpfulCount) || 0;
                        return helpfulB - helpfulA;
                    
                    case 'recent':
                        const dateA = new Date(a.dataset.created);
                        const dateB = new Date(b.dataset.created);
                        return dateB - dateA;
                    
                    case 'oldest':
                        const oldDateA = new Date(a.dataset.created);
                        const oldDateB = new Date(b.dataset.created);
                        return oldDateA - oldDateB;
                    
                    case 'rating':
                        const ratingA = parseFloat(a.dataset.rating) || 0;
                        const ratingB = parseFloat(b.dataset.rating) || 0;
                        return ratingB - ratingA;
                    
                    default:
                        return 0;
                }
            });
            
            // Re-append sorted cards with smooth animation
            critiqueCards.forEach((card, index) => {
                card.style.opacity = '0.7';
                card.style.transform = 'translateY(10px)';
                setTimeout(() => {
                    container.appendChild(card);
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                    card.style.transition = 'all 0.3s ease';
                }, index * 50);
            });
            
            showToast(`Sorted by ${sortLabels[sortBy]}`, 'info');
        }
        
        // Enhanced compact view toggle
        function setupCompactView() {
            const collapseToggle = document.getElementById('collapseMode');
            const critiqueCards = document.querySelectorAll('.critique-card');
            
            if (collapseToggle) {
                collapseToggle.addEventListener('change', function() {
                    critiqueCards.forEach(card => {
                        const body = card.querySelector('.card-body');
                        const ratingSection = card.querySelector('.rating-section');
                        const critiqueText = card.querySelector('.critique-text');
                        
                        if (this.checked) {
                            // Compact mode - hide ratings and truncate text
                            if (ratingSection) ratingSection.style.display = 'none';
                            if (critiqueText) {
                                critiqueText.style.maxHeight = '60px';
                                critiqueText.style.overflow = 'hidden';
                                critiqueText.classList.add('text-truncate');
                            }
                            card.classList.add('compact-view');
                        } else {
                            // Full mode - show everything
                            if (ratingSection) ratingSection.style.display = 'block';
                            if (critiqueText) {
                                critiqueText.style.maxHeight = 'none';
                                critiqueText.style.overflow = 'visible';
                                critiqueText.classList.remove('text-truncate');
                            }
                            card.classList.remove('compact-view');
                        }
                    });
                    
                    const mode = this.checked ? 'compact' : 'full';
                    showToast(`Switched to ${mode} view`, 'info');
                });
            }
        }
        
        // Filter by rated critiques only
        function setupRatedFilter() {
            const ratedToggle = document.getElementById('showRatedOnly');
            const critiqueCards = document.querySelectorAll('.critique-card');
            
            if (ratedToggle) {
                ratedToggle.addEventListener('change', function() {
                    let visibleCount = 0;
                    
                    critiqueCards.forEach(card => {
                        const hasRating = parseFloat(card.dataset.rating) > 0;
                        
                        if (this.checked) {
                            // Show only rated critiques
                            if (hasRating) {
                                card.style.display = 'block';
                                visibleCount++;
                            } else {
                                card.style.display = 'none';
                            }
                        } else {
                            // Show all critiques
                            card.style.display = 'block';
                            visibleCount++;
                        }
                    });
                    
                    const filterText = this.checked ? `Showing ${visibleCount} rated critiques` : 'Showing all critiques';
                    showToast(filterText, 'info');
                });
            }
        }

        // Function to show delete version modal
        function deleteVersion(versionId, versionNumber) {
            const modalHtml = `
                <div class="modal fade" id="deleteVersionModal" tabindex="-1" aria-labelledby="deleteVersionModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content bg-dark text-white">
                            <div class="modal-header border-secondary">
                                <h5 class="modal-title" id="deleteVersionModalLabel">Delete Version ${versionNumber}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p>Are you sure you want to permanently delete version ${versionNumber}? This action cannot be undone.</p>
                                <div class="alert alert-warning">
                                    <strong>Warning:</strong> This will permanently remove the version and all associated data.
                                </div>
                            </div>
                            <div class="modal-footer border-secondary">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger" onclick="confirmDeleteVersion(${versionId})">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash me-1" viewBox="0 0 16 16">
                                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                    </svg>
                                    Delete Version
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('deleteVersionModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('deleteVersionModal'));
            modal.show();
        }

        function confirmDeleteVersion(versionId) {
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // Show loading state
            const deleteBtn = document.querySelector('#deleteVersionModal .btn-danger');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span>Deleting...';
            deleteBtn.disabled = true;

            // Send delete request
            fetch(`/api/artworks/versions/${versionId}/delete/`, {
                method: 'DELETE',
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteVersionModal'));
                modal.hide();

                // Show success message
                showToast('Success', 'Version deleted successfully.', 'success');

                // Remove the version thumbnail from the page
                const versionThumbnail = document.querySelector(`[data-version="${versionId}"]`);
                if (versionThumbnail) {
                    versionThumbnail.remove();
                }

                // Refresh page after a delay
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            })
            .catch(error => {
                console.error('Error deleting version:', error);

                // Reset button
                deleteBtn.innerHTML = originalText;
                deleteBtn.disabled = false;

                // Show error message
                showToast('Error', 'Failed to delete version. Please try again.', 'danger');
            });
        }

        // Function to unarchive a version
        function unarchiveVersion(versionId) {
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // Send unarchive request
            fetch(`/api/versions/${versionId}/unarchive/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // Show success message
                showToast('Success', 'Version unarchived successfully.', 'success');

                // Refresh page after a delay
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            })
            .catch(error => {
                console.error('Error unarchiving version:', error);
                // Show error message
                showToast('Error', 'Failed to unarchive version. Please try again.', 'danger');
            });
        }

        // Archive version function (existing)
        function archiveVersion(versionId, versionNumber) {
            const modalHtml = `
                <div class="modal fade" id="archiveVersionModal" tabindex="-1" aria-labelledby="archiveVersionModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content bg-dark text-white">
                            <div class="modal-header border-secondary">
                                <h5 class="modal-title" id="archiveVersionModalLabel">Archive Version ${versionNumber}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p>Are you sure you want to archive version ${versionNumber}? Archived versions are hidden from public view but can be restored later.</p>
                                <div class="mb-3">
                                    <label for="archiveReason" class="form-label">Reason for archiving (optional):</label>
                                    <textarea id="archiveReason" class="form-control bg-dark text-white border-secondary" rows="3" placeholder="Why are you archiving this version?"></textarea>
                                </div>
                            </div>
                            <div class="modal-footer border-secondary">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-warning" onclick="confirmArchiveVersion(${versionId})">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-archive me-1" viewBox="0 0 16 16">
                                        <path d="M0 2a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1v7.5a2.5 2.5 0 0 1-2.5 2.5h-9A2.5 2.5 0 0 1 1 12.5V5a1 1 0 0 1-1-1V2zm2 3v7.5A1.5 1.5 0 0 0 3.5 14h9a1.5 1.5 0 0 0 1.5-1.5V5H2zm13-3H1v2h14V2zM5 7.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
                                    </svg>
                                    Archive Version
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('archiveVersionModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('archiveVersionModal'));
            modal.show();
        }

        function confirmArchiveVersion(versionId) {
            // Get CSRF token and reason
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const reason = document.getElementById('archiveReason').value;

            // Show loading state
            const archiveBtn = document.querySelector('#archiveVersionModal .btn-warning');
            const originalText = archiveBtn.innerHTML;
            archiveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span>Archiving...';
            archiveBtn.disabled = true;

            // Send archive request
            fetch(`/api/versions/${versionId}/archive/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    reason: reason
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('archiveVersionModal'));
                modal.hide();

                // Show success message
                showToast('Success', 'Version archived successfully.', 'success');

                // Refresh page after a delay
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            })
            .catch(error => {
                console.error('Error archiving version:', error);

                // Reset button
                archiveBtn.innerHTML = originalText;
                archiveBtn.disabled = false;

                // Show error message
                showToast('Error', 'Failed to archive version. Please try again.', 'danger');
            });
        }

        // Function to unarchive a version
        function unarchiveVersion(versionId) {
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // Send unarchive request
            fetch(`/api/versions/${versionId}/unarchive/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // Show success message
                showToast('Success', 'Version unarchived successfully.', 'success');

                // Refresh page after a delay
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            })
            .catch(error => {
                console.error('Error unarchiving version:', error);
                showToast('Error', 'Failed to unarchive version. Please try again.', 'danger');
            });
        }

        // Helper function to show toast notifications
        function showToast(title, message, type) {
            // Implementation depends on your toast system
            const alertType = type === 'success' ? 'alert-success' : 'alert-danger';
            const toast = document.createElement('div');
            toast.className = `alert ${alertType} position-fixed top-0 end-0 m-3`;
            toast.style.zIndex = '9999';
            toast.innerHTML = `<strong>${title}:</strong> ${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Function to delete critique
        function deleteCritique(critiqueId) {
            if (!confirm('Are you sure you want to delete this critique? This action cannot be undone.')) {
                return;
            }

            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // Send delete request
            fetch(`/api/critiques/${critiqueId}/`, {
                method: 'DELETE',
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.detail || 'Failed to delete critique');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Hide the critique card
                const critiqueCard = document.getElementById(`critique-${critiqueId}`);
                if (critiqueCard) {
                    critiqueCard.style.opacity = '0.5';
                    critiqueCard.innerHTML = '<div class="card-body text-center text-muted">Critique deleted successfully. Page will refresh...</div>';
                }
                
                // Show success message
                showToast('Success', 'Critique deleted successfully.', 'success');
                
                // Refresh page after a delay
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            })
            .catch(error => {
                console.error('Error deleting critique:', error);
                showToast('Error', error.message || 'Failed to delete critique. Please try again.', 'danger');
            });
        }

        // Enhanced Critique Sorting System
        function sortCritiques(sortBy) {
            const critiqueContainer = document.querySelector('.card-body');
            const critiques = Array.from(document.querySelectorAll('.critique-card'));
            
            critiques.sort((a, b) => {
                switch (sortBy) {
                    case 'helpful':
                        return parseInt(b.dataset.helpfulCount) - parseInt(a.dataset.helpfulCount);
                    case 'recent':
                        return new Date(b.dataset.created) - new Date(a.dataset.created);
                    case 'oldest':
                        return new Date(a.dataset.created) - new Date(b.dataset.created);
                    case 'rating':
                        return parseInt(b.dataset.rating) - parseInt(a.dataset.rating);
                    default:
                        return 0;
                }
            });
            
            // Reorder DOM elements
            const sortingControls = document.querySelector('.d-flex.justify-content-between.align-items-center.mb-3');
            critiques.forEach(critique => critiqueContainer.appendChild(critique));
            
            // Move sorting controls back to top
            critiqueContainer.insertBefore(sortingControls, critiqueContainer.firstChild);
            
            showToast('Sorted', `Critiques sorted by ${sortBy}`, 'success');
        }

        // Enhanced initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize enhanced critique controls
            setupCompactView();
            setupRatedFilter();
            setupViewModeToggle();
            
            // Initialize tooltips for reaction buttons
            initializeTooltips();
            
            // Legacy compact view toggle (maintaining existing functionality)
            const compactToggle = document.getElementById('collapseMode');
            if (compactToggle) {
                compactToggle.addEventListener('change', function() {
                    const critiqueBodies = document.querySelectorAll('[id^="critique-body-"]');
                    critiqueBodies.forEach(body => {
                        if (this.checked) {
                            // Collapse all critiques
                            const collapse = new bootstrap.Collapse(body, { toggle: false });
                            collapse.hide();
                        } else {
                            // Expand all critiques
                            const collapse = new bootstrap.Collapse(body, { toggle: false });
                            collapse.show();
                        }
                    });
                });
            }
        });
        
        // Initialize Bootstrap tooltips
        function initializeTooltips() {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
        
        // Mark highly rated critiques
        function markHighlyRatedCritiques() {
            document.querySelectorAll('.critique-card').forEach(card => {
                const ratingElements = card.querySelectorAll('.progress-bar');
                let totalScore = 0;
                let ratingCount = 0;
                
                ratingElements.forEach(bar => {
                    const value = parseFloat(bar.getAttribute('aria-valuenow'));
                    if (!isNaN(value)) {
                        totalScore += value;
                        ratingCount++;
                    }
                });
                
                if (ratingCount > 0) {
                    const averageRating = totalScore / ratingCount;
                    if (averageRating >= 8) {
                        card.classList.add('highly-rated');
                    }
                }
            });
        }
        
        // Enhanced initialization
        document.addEventListener('DOMContentLoaded', function() {
            markHighlyRatedCritiques();
        });

        // Toggle Reply Form
        function toggleReplyForm(critiqueId) {
            const replyForm = document.getElementById(`reply-form-${critiqueId}`);
            const isVisible = replyForm.style.display !== 'none';
            
            // Hide all other reply forms
            document.querySelectorAll('.reply-form-container').forEach(form => {
                form.style.display = 'none';
            });
            
            // Toggle current form
            if (!isVisible) {
                replyForm.style.display = 'block';
                const textarea = replyForm.querySelector('textarea');
                textarea.focus();
            }
        }

        // Handle Reply Form Submission
        document.addEventListener('DOMContentLoaded', function() {
            // Reply form submission
            document.querySelectorAll('.reply-form').forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const critiqueId = this.dataset.critiqueId;
                    const textarea = this.querySelector('textarea');
                    const replyText = textarea.value.trim();
                    
                    if (!replyText) {
                        showToast('Error', 'Please enter a reply message.', 'danger');
                        return;
                    }
                    
                    // Get CSRF token
                    const csrfToken = this.querySelector('[name=csrfmiddlewaretoken]').value;
                    
                    // Submit reply
                    fetch(`/api/critiques/${critiqueId}/replies/`, {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'X-Requested-With': 'XMLHttpRequest',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ text: replyText })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to post reply');
                        }
                        return response.json();
                    })
                    .then(data => {
                        showToast('Success', 'Reply posted successfully!', 'success');
                        // Refresh page to show new reply
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    })
                    .catch(error => {
                        console.error('Error posting reply:', error);
                        showToast('Error', 'Failed to post reply. Please try again.', 'danger');
                    });
                });
            });
            
            // Cancel reply buttons
            document.querySelectorAll('.cancel-reply').forEach(button => {
                button.addEventListener('click', function() {
                    const replyForm = this.closest('.reply-form-container');
                    replyForm.style.display = 'none';
                    replyForm.querySelector('textarea').value = '';
                });
            });
        });

        // Enhanced Collapse Button Rotation
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.critique-collapse-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const icon = this.querySelector('svg');
                    const targetId = this.getAttribute('data-bs-target');
                    const target = document.querySelector(targetId);
                    
                    target.addEventListener('shown.bs.collapse', function() {
                        icon.style.transform = 'rotate(0deg)';
                    });
                    
                    target.addEventListener('hidden.bs.collapse', function() {
                        icon.style.transform = 'rotate(-90deg)';
                    });
                });
            });
        });

        // Function to switch back to current version
        function switchToCurrentVersion(artworkId) {
            // Simply reload the page to show the current version
            window.location.href = `/artworks/${artworkId}/`;
        }

        // Function to switch to a different version
        function switchToVersion(artworkId, versionId) {
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // Show loading state
            const mainImage = document.getElementById('main-artwork-image');
            const originalContent = mainImage.outerHTML;
            
            mainImage.innerHTML = '<div class="d-flex justify-content-center align-items-center" style="height: 200px;"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

            // Send switch request
            fetch(`/api/artworks/${artworkId}/switch-version/${versionId}/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // Update the main image
                if (data.image_url) {
                    const newImg = document.createElement('img');
                    newImg.src = data.image_url;
                    newImg.className = 'card-img-top img-fluid';
                    newImg.alt = data.title || 'Artwork';
                    newImg.style.maxHeight = '500px';
                    newImg.style.objectFit = 'contain';
                    newImg.id = 'main-artwork-image';
                    
                    mainImage.parentNode.replaceChild(newImg, mainImage);
                } else {
                    // No image available
                    const noImageDiv = document.createElement('div');
                    noImageDiv.className = 'bg-secondary text-white d-flex justify-content-center align-items-center';
                    noImageDiv.style.height = '400px';
                    noImageDiv.id = 'main-artwork-image';
                    noImageDiv.innerHTML = '<span>No Image Available</span>';
                    
                    mainImage.parentNode.replaceChild(noImageDiv, mainImage);
                }

                // Update version badge if it exists
                const versionBadge = document.querySelector('.badge.bg-secondary');
                if (versionBadge && data.version_number) {
                    versionBadge.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-clock-history me-1" viewBox="0 0 16 16">
                            <path d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022l-.074.997zm2.004.45a7.003 7.003 0 0 0-.985-.299l.219-.976c.383.086.76.2 1.126.342l-.36.933zm1.37.71a7.01 7.01 0 0 0-.439-.27l.493-.87a8.025 8.025 0 0 1 .979.654l-.615.789a6.996 6.996 0 0 0-.418-.302zm1.834 1.79a6.99 6.99 0 0 0-.653-.796l.724-.69c.27.285.52.59.747.91l-.818.576zm.744 1.352a7.08 7.08 0 0 0-.214-.468l.893-.45a7.976 7.976 0 0 1 .45 1.088l-.942.313a7.023 7.023 0 0 0-.187-.483zm.53 2.507a6.991 6.991 0 0 0-.1-1.025l.985-.17c.067.386.106.778.116 1.17l-1.001.025zm-.131 1.538c.033-.17.06-.339.081-.51l.993.123a7.957 7.957 0 0 1-.23 1.155l-.964-.267c.046-.165.086-.332.12-.501zm-.952 2.379c.184-.29.346-.594.486-.908l.914.405c-.16.36-.345.706-.555 1.038l-.845-.535zm-1.442 1.633c.263-.226.509-.467.740-.722l.724.69a8.026 8.026 0 0 1-.989.912l-.475-.88zm-2.266.97c.342-.14.677-.296.99-.49l.546.837a7.972 7.972 0 0 1-1.198.596l-.338-.943zm-2.137.339c.37-.042.741-.111 1.106-.207l.238.971a7.998 7.998 0 0 1-1.425.267l.081-.031z"/>
                            <path d="M8 1a7 7 0 1 0 4.95 11.95l.707.707A8.001 8.001 0 1 1 8 0v1z"/>
                            <path d="M7.5 3a.5.5 0 0 1 .5.5v5.21l3.248 1.856a.5.5 0 0 1-.496.868l-3.5-2A.5.5 0 0 1 7 9V3.5a.5.5 0 0 1 .5-.5z"/>
                        </svg>
                        Version ${data.version_number} of ${data.total_versions}
                    `;
                }

                // Show success message
                showToast('Success', `Switched to version ${data.version_number}`, 'success');
            })
            .catch(error => {
                console.error('Error switching version:', error);
                
                // Restore original content
                mainImage.outerHTML = originalContent;
                
                // Show error message
                showToast('Error', 'Failed to switch version. Please try again.', 'danger');
            });
        }

        // Function to hide a critique
        function hideCritique(critiqueId) {
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch(`/api/critiques/${critiqueId}/hide/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // Hide the critique card
                const critiqueCard = document.getElementById(`critique-${critiqueId}`);
                if (critiqueCard) {
                    critiqueCard.style.opacity = '0.5';
                    critiqueCard.innerHTML += '<div class="position-absolute top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-flex align-items-center justify-content-center"><span class="badge bg-warning">Hidden</span></div>';
                }
                showToast('Success', 'Critique hidden successfully.', 'success');
            })
            .catch(error => {
                console.error('Error hiding critique:', error);
                showToast('Error', 'Failed to hide critique. Please try again.', 'danger');
            });
        }

        // Function to unhide a critique
        function unhideCritique(critiqueId) {
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch(`/api/critiques/${critiqueId}/unhide/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // Restore the critique card
                const critiqueCard = document.getElementById(`critique-${critiqueId}`);
                if (critiqueCard) {
                    critiqueCard.style.opacity = '1';
                    const hiddenOverlay = critiqueCard.querySelector('.position-absolute');
                    if (hiddenOverlay) {
                        hiddenOverlay.remove();
                    }
                }
                showToast('Success', 'Critique unhidden successfully.', 'success');
            })
            .catch(error => {
                console.error('Error unhiding critique:', error);
                showToast('Error', 'Failed to unhide critique. Please try again.', 'danger');
            });
        }

        // Function to open image in full-size modal
        function openImageModal(imageSrc, title) {
            // Create modal HTML
            const modalHTML = `
                <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl modal-dialog-centered">
                        <div class="modal-content bg-dark">
                            <div class="modal-header border-secondary">
                                <h5 class="modal-title text-white" id="imageModalLabel">${title}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body text-center p-2">
                                <img src="${imageSrc}" class="img-fluid" style="max-height: 80vh; max-width: 100%; object-fit: contain;" alt="${title}">
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('imageModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('imageModal'));
            modal.show();

            // Clean up modal when hidden
            document.getElementById('imageModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        }


        // Function to toggle reactions
        function toggleReaction(button, critiqueId, reactionType) {
            console.log(`Toggling reaction: ${reactionType} for critique ${critiqueId}`);
            
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            if (!csrfToken) {
                console.error('CSRF token not found');
                showToast('Error', 'Security token missing. Please refresh the page.', 'danger');
                return;
            }
            
            // Store original state for rollback
            const originalActive = button.classList.contains('active');
            const countSpan = button.querySelector(`.${reactionType.toLowerCase()}-count`);
            const originalCount = parseInt(countSpan?.textContent) || 0;
            
            // Optimistic UI update
            button.classList.toggle('active');
            if (countSpan) {
                countSpan.textContent = originalActive ? Math.max(0, originalCount - 1) : originalCount + 1;
            }
            
            // Send API request
            fetch(`/api/critiques/${critiqueId}/react/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ type: reactionType })
            })
            .then(response => {
                console.log(`Reaction API response status: ${response.status}`);
                
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('Reaction API error response:', text);
                        throw new Error(`HTTP ${response.status}: ${text}`);
                    });
                }
                
                return response.json();
            })
            .then(data => {
                console.log('Reaction API success:', data);
                
                // Update all reaction counts for this critique
                const critiqueContainer = document.querySelector(`[data-critique-id="${critiqueId}"]`)?.closest('.critique-container');
                if (critiqueContainer) {
                    // Update helpful count
                    const helpfulSpan = critiqueContainer.querySelector('.helpful-count');
                    if (helpfulSpan && typeof data.helpful_count !== 'undefined') {
                        helpfulSpan.textContent = data.helpful_count;
                    }
                    
                    // Update inspiring count
                    const inspiringSpan = critiqueContainer.querySelector('.inspiring-count');
                    if (inspiringSpan && typeof data.inspiring_count !== 'undefined') {
                        inspiringSpan.textContent = data.inspiring_count;
                    }
                    
                    // Update detailed count
                    const detailedSpan = critiqueContainer.querySelector('.detailed-count');
                    if (detailedSpan && typeof data.detailed_count !== 'undefined') {
                        detailedSpan.textContent = data.detailed_count;
                    }
                    
                    // Update button states based on user reactions
                    if (data.user_reactions) {
                        const reactionButtons = critiqueContainer.querySelectorAll('.reaction-btn');
                        reactionButtons.forEach(btn => {
                            const btnType = btn.getAttribute('onclick')?.match(/'(\w+)'/)?.[1];
                            if (btnType && data.user_reactions.includes(btnType)) {
                                btn.classList.add('active');
                            } else if (btnType) {
                                btn.classList.remove('active');
                            }
                        });
                    }
                }
                
                showToast('Success', `Reaction ${data.created ? 'added' : 'removed'} successfully`, 'success');
            })
            .catch(error => {
                console.error('Error toggling reaction:', error);
                
                // Revert optimistic update
                if (originalActive) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
                if (countSpan) {
                    countSpan.textContent = originalCount;
                }
                
                showToast('Error', 'Failed to update reaction. Please try again.', 'danger');
            });
        }

        // Update reaction counts from server response
        function updateReactionCounts(critiqueId, data) {
            const helpfulCount = document.querySelector(`[data-critique-id="${critiqueId}"][data-reaction-type="HELPFUL"] .helpful-count`);
            const inspiringCount = document.querySelector(`[data-critique-id="${critiqueId}"][data-reaction-type="INSPIRING"] .inspiring-count`);
            const detailedCount = document.querySelector(`[data-critique-id="${critiqueId}"][data-reaction-type="DETAILED"] .detailed-count`);
            
            if (helpfulCount) helpfulCount.textContent = data.helpful_count || 0;
            if (inspiringCount) inspiringCount.textContent = data.inspiring_count || 0;
            if (detailedCount) detailedCount.textContent = data.detailed_count || 0;
        }

        // Add reply to DOM
        function addReplyToDOM(critiqueId, replyData) {
            const repliesContainer = document.querySelector(`#replies-${critiqueId}`);
            if (!repliesContainer) return;
            
            const replyHtml = `
                <div class="border-start border-2 border-secondary ps-3 mb-2">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="d-flex align-items-center">
                            <span class="fw-semibold text-info me-2">${replyData.author.username || 'Anonymous'}</span>
                            <small class="text-muted">${new Date(replyData.created_at).toLocaleDateString()}</small>
                        </div>
                    </div>
                    <p class="mb-0 text-light">${replyData.text}</p>
                </div>
            `;
            
            repliesContainer.insertAdjacentHTML('beforeend', replyHtml);
        }

        // Handle critique deletion
        function deleteCritique(critiqueId) {
            if (!confirm('Are you sure you want to delete this critique? This action cannot be undone.')) {
                return;
            }
            
            console.log(`Deleting critique: ${critiqueId}`);
            
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            if (!csrfToken) {
                console.error('CSRF token not found');
                showToast('Error', 'Security token missing. Please refresh the page.', 'danger');
                return;
            }
            
            // Show loading state on button
            const deleteBtn = document.querySelector(`[onclick="deleteCritique(${critiqueId})"]`);
            const originalButtonHtml = deleteBtn?.innerHTML;
            if (deleteBtn) {
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Deleting...';
            }
            
            // Send delete request
            fetch(`/api/critiques/${critiqueId}/`, {
                method: 'DELETE',
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log(`Delete API response status: ${response.status}`);
                
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('Delete API error response:', text);
                        let errorData;
                        try {
                            errorData = JSON.parse(text);
                        } catch (e) {
                            errorData = { error: text };
                        }
                        
                        if (response.status === 403) {
                            // Extract detailed error message from API response
                            const errorMessage = errorData.error || 'This critique has feedback from others and cannot be deleted. You can edit it or request to hide it.';
                            const details = errorData.details || '';
                            const suggestion = errorData.suggestion || '';
                            
                            let fullMessage = errorMessage;
                            if (details) {
                                fullMessage += ` (${details})`;
                            }
                            if (suggestion) {
                                fullMessage += ` ${suggestion}`;
                            }
                            
                            throw new Error(fullMessage);
                        } else if (response.status === 404) {
                            throw new Error('Critique not found');
                        } else {
                            throw new Error(errorData.error || 'Failed to delete critique');
                        }
                    });
                }
                
                // Handle successful deletion (204 No Content)
                if (response.status === 204) {
                    return { success: true };
                }
                
                return response.json();
            })
            .then(data => {
                console.log('Delete API success:', data);
                
                // Remove the critique card from the page
                const critiqueCard = document.getElementById(`critique-${critiqueId}`);
                if (critiqueCard) {
                    critiqueCard.style.transition = 'opacity 0.3s ease';
                    critiqueCard.style.opacity = '0';
                    setTimeout(() => {
                        critiqueCard.remove();
                    }, 300);
                }
                
                showToast('Success', 'Critique deleted successfully', 'success');
            })
            .catch(error => {
                console.error('Error deleting critique:', error);
                
                // Restore button state
                if (deleteBtn && originalButtonHtml) {
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = originalButtonHtml;
                }
                
                showToast('Error', error.message, 'danger');
            });
        }

        // Handle reply form submission
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('submit-reply-btn')) {
                const form = e.target.closest('form');
                const critiqueId = form.querySelector('input[name="critique_id"]').value;
                const replyText = form.querySelector('textarea[name="reply_text"]').value.trim();
                
                if (!replyText) {
                    showToast('Error', 'Please enter a reply message.', 'danger');
                    return;
                }
                
                // Get CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                // Send reply request to corrected endpoint
                fetch(`/api/critiques/${critiqueId}/replies/`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text: replyText })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to submit reply');
                    }
                    return response.json();
                })
                .then(data => {
                    // Clear the form
                    form.querySelector('textarea[name="reply_text"]').value = '';
                    
                    // Add new reply to the DOM
                    addReplyToDOM(critiqueId, data);
                    
                    // Show success message
                    showToast('Success', 'Reply posted successfully!', 'success');
                })
                .catch(error => {
                    console.error('Error submitting reply:', error);
                    showToast('Error', 'Failed to submit reply. Please try again.', 'danger');
                });
            }
        });

        // Fix float precision for all score displays on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Fix scores with proper precision formatting
            document.querySelectorAll('.score-display').forEach(element => {
                const score = parseFloat(element.textContent);
                if (!isNaN(score)) {
                    element.textContent = score.toFixed(1);
                }
            });
            
            // Fix rating display elements
            document.querySelectorAll('[data-score]').forEach(element => {
                const score = parseFloat(element.dataset.score);
                if (!isNaN(score)) {
                    const textElement = element.querySelector('.score-text') || element;
                    textElement.textContent = score.toFixed(1);
                }
            });
        });

        // Handle nested reply form submission
        function createNestedReplyElement(reply) {
            const div = document.createElement('div');
            div.className = 'nested-reply bg-dark bg-opacity-25 p-2 rounded mb-2';
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-start mb-1">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-info d-flex align-items-center justify-content-center me-2" style="width: 20px; height: 20px; font-size: 10px; font-weight: bold;">
                            ${reply.author.username.charAt(0).toUpperCase()}
                        </div>
                        <a href="/profile/${reply.author.username}/" class="text-decoration-none text-info fw-bold small">
                            ${reply.author.username}
                        </a>
                    </div>
                    <small class="text-muted">Just now</small>
                </div>
                <p class="mb-0 small">${reply.text}</p>
            `;
            return div;
        }

        // Initialize nested reply form handling
        document.addEventListener('submit', function(e) {
            if (e.target.classList.contains('nested-reply-form')) {
                e.preventDefault();
                
                const form = e.target;
                const replyId = form.dataset.replyId;
                const textarea = form.querySelector('textarea');
                const text = textarea.value.trim();
                
                if (!text) return;
                
                // Submit nested reply via API
                fetch(`/api/replies/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        parent_reply: replyId,
                        text: text
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Add new nested reply to the DOM
                        const nestedContainer = document.getElementById(`nested-replies-${replyId}`);
                        if (nestedContainer) {
                            const newReply = createNestedReplyElement(data.reply);
                            nestedContainer.appendChild(newReply);
                        }
                        
                        // Clear and hide form
                        textarea.value = '';
                        hideReplyToReply(replyId);
                        
                        showToast('Reply posted successfully', 'success');
                    } else {
                        throw new Error(data.error || 'Failed to post reply');
                    }
                })
                .catch(error => {
                    console.error('Error posting nested reply:', error);
                    showToast('Failed to post reply', 'error');
                });
            }
        });

        // Remove artwork from folder function
        function removeArtworkFromFolder(artworkId) {
            if (!confirm('Remove this artwork from its folder? It will still be visible in your main gallery.')) {
                return;
            }

            fetch('/api/artworks/move-to-folder/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    artwork_id: artworkId,
                    folder_id: null  // Remove from folder by setting to null
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to remove artwork from folder');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showToast('Artwork removed from folder successfully', 'success');
                    // Refresh the page to show updated folder status
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    throw new Error(data.error || 'Failed to remove artwork from folder');
                }
            })
            .catch(error => {
                console.error('Error removing artwork from folder:', error);
                showToast('Failed to remove artwork from folder', 'error');
            });
        }

        // Focus Mode Functions
        function enterFullscreen(img) {
            if (img.requestFullscreen) {
                img.requestFullscreen();
            } else if (img.webkitRequestFullscreen) {
                img.webkitRequestFullscreen();
            } else if (img.msRequestFullscreen) {
                img.msRequestFullscreen();
            }
        }
        
        function exitFocusMode() {
            const mainContent = document.getElementById('main-content');
            const focusMode = document.getElementById('focus-mode');
            
            // Hide focus mode
            focusMode.style.display = 'none';
            
            // Show main content with animation
            mainContent.classList.add('visible');
            
            // Smooth scroll to anchor
            document.getElementById('scroll-anchor').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }
        
        function toggleFavorite(artworkId) {
            const btn = event.target.closest('.favorite-btn');
            const heart = btn.querySelector('svg');
            
            // Toggle visual state
            if (heart.classList.contains('bi-heart')) {
                heart.classList.remove('bi-heart');
                heart.classList.add('bi-heart-fill');
                btn.style.background = 'rgba(220,53,69,0.3)';
                btn.style.color = '#dc3545';
            } else {
                heart.classList.remove('bi-heart-fill');
                heart.classList.add('bi-heart');
                btn.style.background = 'rgba(220,53,69,0.15)';
            }
            
            // Show success message
            showToast('Favorite', heart.classList.contains('bi-heart-fill') ? 'Added to favorites' : 'Removed from favorites', 'info');
        }

        // Focus Mode initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-transition after delay if user doesn't interact
            setTimeout(() => {
                const mainContent = document.getElementById('main-content');
                if (!mainContent.classList.contains('visible')) {
                    // Auto-transition after 8 seconds if user doesn't interact
                    setTimeout(exitFocusMode, 8000);
                }
            }, 2000);
        });

    </script>
{% endblock %}