{% extends "critique/base.html" %}
{% load static %}

{% block title %}Artist Studio - My Artworks{% endblock %}

{% block extra_head %}
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block extra_css %}
<style>
/* Studio Workspace Styling */
.studio-filters-panel {
    background: linear-gradient(135deg, #343a40 0%, #495057 100%) !important;
    border: 1px solid #495057 !important;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3) !important;
}

.studio-filters-panel .form-label {
    color: #ffffff;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.studio-filters-panel .form-control,
.studio-filters-panel .form-select {
    background-color: #495057;
    border: 2px solid #6c757d;
    color: #ffffff;
    transition: all 0.2s ease;
}

.studio-filters-panel .form-control:focus,
.studio-filters-panel .form-select:focus {
    background-color: #495057;
    border-color: #0d6efd;
    color: #ffffff;
    box-shadow: 0 0 0 0.2rem rgba(13,110,253,0.25);
}

.studio-filters-panel .form-control::placeholder {
    color: #adb5bd;
}

.studio-filters-panel .form-select option {
    background-color: #495057;
    color: #ffffff;
}

.studio-filters-panel .border-primary {
    border-color: #0d6efd !important;
}

.artwork-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border: 1px solid #e0e0e0;
    position: relative;
    overflow: hidden;
}

.artwork-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.artwork-card:hover .quick-actions {
    opacity: 1;
    visibility: visible;
}

.quick-actions {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(8px);
    border-radius: 0 0 0.375rem 0.375rem;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 10;
}

.artwork-image-container {
    position: relative;
    overflow: hidden;
}

.artwork-image-container:hover .quick-actions {
    opacity: 1;
    visibility: visible;
}

.edit-icon {
    opacity: 0;
    transition: opacity 0.2s ease;
}

.artwork-title:hover .edit-icon,
.artwork-description:hover .edit-icon,
.artwork-tags:hover .edit-icon {
    opacity: 0.7;
}

.artwork-title,
.artwork-description,
.artwork-tags {
    cursor: pointer;
    padding: 2px 4px;
    border-radius: 4px;
    transition: background-color 0.2s ease;
}

.artwork-title:hover,
.artwork-description:hover,
.artwork-tags:hover {
    background-color: rgba(0,123,255,0.1);
}

/* Folder Sidebar Styling */
.folder-sidebar {
    min-height: 400px;
    position: sticky;
    top: 20px;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
    transition: all 0.3s ease;
}

.folder-sidebar.collapsed .sidebar-content {
    display: none;
}

.folder-sidebar.collapsed {
    min-height: auto;
    width: 60px;
    padding: 0.75rem 0.5rem !important;
}

.sidebar-wrapper.collapsed {
    flex: 0 0 60px;
    max-width: 60px;
}

.sidebar-content {
    transition: opacity 0.3s ease;
}

.folder-sidebar.collapsed h6 {
    display: none;
}

.folder-sidebar.collapsed #sidebarCollapseBtn {
    margin: 0 auto;
    display: block;
}

#sidebarCollapseBtn i {
    transition: transform 0.3s ease;
}

.folder-sidebar.collapsed #sidebarCollapseBtn i {
    transform: rotate(180deg);
}

.folder-sidebar::-webkit-scrollbar {
    width: 6px;
}

.folder-sidebar::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.1);
    border-radius: 3px;
}

.folder-sidebar::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.3);
    border-radius: 3px;
}

.folder-sidebar::-webkit-scrollbar-thumb:hover {
    background: rgba(255,255,255,0.5);
}

.folder-card {
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid transparent;
}

.folder-card:hover, .folder-card.active {
    background: rgba(13, 110, 253, 0.2) !important;
    border-color: rgba(13, 110, 253, 0.5);
    transform: translateX(2px);
}

.hover-highlight {
    transition: all 0.2s ease;
}

.folder-thumbnails img {
    transition: transform 0.2s ease;
}

.folder-card:hover .folder-thumbnails img {
    transform: scale(1.05);
}

/* Mobile sidebar toggle */
@media (max-width: 991.98px) {
    .folder-sidebar {
        position: fixed;
        top: 0;
        left: -100%;
        width: 280px;
        height: 100vh;
        z-index: 1050;
        transition: left 0.3s ease;
        box-shadow: 2px 0 10px rgba(0,0,0,0.3);
    }
    
    .folder-sidebar.show {
        left: 0;
    }
    
    .sidebar-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: rgba(0,0,0,0.5);
        z-index: 1040;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }
    
    .sidebar-backdrop.show {
        opacity: 1;
        visibility: visible;
    }
}

.artwork-checkbox {
    background: rgba(255,255,255,0.9);
    border-radius: 8px;
    z-index: 1000;
    backdrop-filter: blur(4px);
    border: 1px solid rgba(0,0,0,0.1);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    width: 40px !important;
    height: 40px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}

.artwork-checkbox.bulk-hidden {
    display: none !important;
}

.artwork-checkbox.bulk-visible {
    display: block !important;
}

.artwork-checkbox .form-check-input {
    margin: 0 !important;
    width: 20px !important;
    height: 20px !important;
    opacity: 1 !important;
    position: relative !important;
    z-index: 9999 !important;
    transform: scale(1.2) !important;
    appearance: auto !important;
    -webkit-appearance: checkbox !important;
    -moz-appearance: checkbox !important;
}

.badge {
    font-size: 0.7rem;
    letter-spacing: 0.5px;
}

/* Studio Statistics */
.border-end.border-light {
    border-color: rgba(255,255,255,0.3) !important;
}

/* Filter buttons */
.btn-outline-primary:hover,
.btn-outline-success:hover,
.btn-outline-warning:hover,
.btn-outline-info:hover {
    transform: translateY(-1px);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .d-flex.gap-2 {
        flex-wrap: wrap;
    }
    
    .quick-actions {
        padding: 1rem !important;
    }
    
    .position-absolute.top-0.end-0 {
        position: relative !important;
        top: auto !important;
        end: auto !important;
        padding: 0.5rem !important;
        margin-bottom: 0.5rem;
    }
}

/* Loading states */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

/* Success/Error states */
.status-success {
    border-left: 4px solid #28a745;
}

.status-error {
    border-left: 4px solid #dc3545;
}

/* Active filter indicator */
.filter-active {
    background-color: #0d6efd !important;
    color: white !important;
}

/* Drag and Drop Styling */
.version-card {
    cursor: grab;
    transition: all 0.3s ease;
}

.version-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
}

.version-card.dragging {
    opacity: 0.6;
    transform: rotate(5deg) scale(0.95);
    cursor: grabbing;
}

.comparison-area {
    animation: slideDown 0.4s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.comparison-slot {
    transition: all 0.3s ease;
}

.comparison-slot .drop-zone {
    min-height: 200px;
    transition: all 0.3s ease;
}

.comparison-slot.drag-over .drop-zone {
    border-color: #0dcaf0 !important;
    background-color: rgba(13, 202, 240, 0.1);
    transform: scale(1.02);
    box-shadow: 0 0 20px rgba(13, 202, 240, 0.3);
}

.comparison-slot .drop-zone.border-solid {
    border-style: solid !important;
}

.comparison-slot .drop-zone:hover {
    border-color: #6c757d;
}

/* Visual feedback for active comparison mode */
.version-card[draggable="true"]:not(.dragging) {
    position: relative;
}

.version-card[draggable="true"]:not(.dragging)::before {
    content: "⋮⋮";
    position: absolute;
    top: 10px;
    right: 10px;
    color: rgba(255,255,255,0.7);
    font-size: 16px;
    font-weight: bold;
    z-index: 10;
    pointer-events: none;
}

/* Button state transitions */
#compareSelectedBtn {
    transition: all 0.3s ease;
}

#compareSelectedBtn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Portfolio Folder Cards */
.folder-preview-card {
    transition: all 0.3s ease;
    border: 1px solid rgba(0,0,0,0.125);
}

.folder-preview-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.folder-thumbnail {
    transition: transform 0.2s ease;
}

.folder-thumbnail:hover {
    transform: scale(1.05);
}

.portfolio-folders-section {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    padding: 2rem;
    border: 1px solid rgba(0,0,0,0.1);
}

.folder-cover-preview {
    position: relative;
    overflow: hidden;
}

.folder-cover-image {
    transition: transform 0.3s ease;
}

.folder-cover-image:hover {
    transform: scale(1.02);
}

.btn-cover-edit {
    opacity: 0;
    transition: opacity 0.3s ease;
}

.folder-cover-preview:hover .btn-cover-edit,
.folder-artworks-preview:hover .btn-cover-edit {
    opacity: 1;
}

/* Comparison modal styling */
#versionComparisonModal .card {
    border: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

#versionComparisonModal .card-header {
    font-weight: 600;
    font-size: 0.9rem;
}

/* Enhanced visual hierarchy */
.comparison-area .alert {
    border-width: 2px;
    font-weight: 500;
}

.comparison-slot .card {
    transition: all 0.3s ease;
}

.comparison-slot .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-dark text-white">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-palette me-2" viewBox="0 0 16 16">
                        <path d="M8 5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zm4 3a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zM5.5 7a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm.5 6a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/>
                        <path d="M16 8c0 3.15-1.866 2.585-3.567 2.07C11.42 9.763 10.465 9.473 10 10c-.603.683-.475 1.819-.351 2.92C9.826 14.495 9.996 16 8 16a8 8 0 1 1 8-8z"/>
                    </svg>
                    Artist Studio - My Artworks
                </h2>
                <div class="d-flex gap-2">
                    <a href="{% url 'critique:portfolio_builder' %}" class="btn btn-success btn-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-collection me-2" viewBox="0 0 16 16">
                            <path d="M2.5 3.5a.5.5 0 0 1 0-1h11a.5.5 0 0 1 0 1h-11zm2-2a.5.5 0 0 1 0-1h7a.5.5 0 0 1 0 1h-7zM0 13a1.5 1.5 0 0 0 1.5 1.5h13A1.5 1.5 0 0 0 16 13V6a1.5 1.5 0 0 0-1.5-1.5h-13A1.5 1.5 0 0 0 0 6v7zm1.5.5A.5.5 0 0 1 1 13V6a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5h-13z"/>
                        </svg>
                        Portfolio Builder
                    </a>
                    <button class="btn btn-outline-light btn-sm" onclick="toggleBulkActions()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-square" viewBox="0 0 16 16">
                            <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                            <path d="M10.97 4.97a.75.75 0 0 1 1.071 1.05l-3.992 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.235.235 0 0 1 .02-.022z"/>
                        </svg>
                        Bulk Actions
                    </button>
                    <a href="{% url 'critique:artwork_upload' %}" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle me-2" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                        </svg>
                        New Artwork
                    </a>
                </div>
            </div>
            
            <!-- Studio Statistics -->
            <div class="row text-center">
                <div class="col-6 col-md-3">
                    <div class="border-end border-light">
                        <h5 class="mb-0" id="total-artworks">{{ artworks.count|default:0 }}</h5>
                        <small class="text-light">Total Pieces</small>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="border-end border-light">
                        <h5 class="mb-0" id="draft-count">0</h5>
                        <small class="text-light">Drafts</small>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="border-end border-light">
                        <h5 class="mb-0" id="seeking-critique-count">0</h5>
                        <small class="text-light">Seeking Critique</small>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <h5 class="mb-0" id="total-interactions">0</h5>
                    <small class="text-light">Total Interactions</small>
                </div>
            </div>
        </div>
        
        <div class="card-body">
            <!-- Sidebar and Main Content Layout -->
            <div class="row g-0">
                <!-- Portfolio Folders Sidebar -->
                {% if folders %}
                <div class="col-lg-3 col-xl-2 sidebar-wrapper">
                    <div class="folder-sidebar bg-dark text-white p-3 rounded-3 me-3 mb-4" id="folderSidebar">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0 fw-bold">
                                <i class="bi bi-folder2 me-2"></i>
                                Portfolio Folders
                            </h6>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-light" id="sidebarCollapseBtn" onclick="toggleSidebarCollapse()" title="Collapse sidebar">
                                    <i class="bi bi-chevron-left"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-light d-lg-none" onclick="toggleFolderSidebar()">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Folder List -->
                        <div class="sidebar-content" id="sidebarContent">
                        <div class="folder-list">
                            {% for folder in folders %}
                            <div class="folder-item mb-2" data-folder-id="{{ folder.id }}">
                                <div class="folder-card bg-secondary bg-opacity-25 rounded p-2 hover-highlight" 
                                     onclick="filterByFolder({{ folder.id }})">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-folder me-2 text-primary"></i>
                                            <div>
                                                <div class="folder-name fw-semibold small">{{ folder.name }}</div>
                                                <div class="folder-count text-muted" style="font-size: 0.75rem;">
                                                    {{ folder.artworks.count }} artwork{{ folder.artworks.count|pluralize }}
                                                </div>
                                            </div>
                                        </div>
                                        <span class="badge bg-primary">{{ folder.artworks.count }}</span>
                                    </div>
                                    
                                    <!-- Folder Preview Thumbnails -->
                                    {% if folder.artworks.exists %}
                                    <div class="folder-thumbnails mt-2">
                                        <div class="row g-1">
                                            {% for artwork in folder.artworks.all|slice:":2" %}
                                            <div class="col-6">
                                                {% if artwork.get_display_image_url %}
                                                    <img src="{{ artwork.get_display_image_url }}" 
                                                         class="img-fluid rounded" 
                                                         alt="{{ artwork.title }}"
                                                         style="width: 100%; height: 30px; object-fit: cover;">
                                                {% else %}
                                                    <div class="bg-light d-flex align-items-center justify-content-center rounded" 
                                                         style="height: 30px;">
                                                        <i class="bi bi-image text-muted" style="font-size: 0.7rem;"></i>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% if folder.artworks.count > 2 %}
                                        <div class="text-center mt-1">
                                            <small class="text-muted" style="font-size: 0.65rem;">+{{ folder.artworks.count|add:"-2" }} more</small>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                            
                            <!-- All Artworks Option -->
                            <div class="folder-item mb-2">
                                <div class="folder-card bg-primary bg-opacity-25 rounded p-2 hover-highlight" 
                                     onclick="clearFolderFilter()">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-collection me-2 text-info"></i>
                                            <div>
                                                <div class="folder-name fw-semibold small">All Artworks</div>
                                                <div class="folder-count text-muted" style="font-size: 0.75rem;">
                                                    Show all pieces
                                                </div>
                                            </div>
                                        </div>
                                        <span class="badge bg-info">{{ artworks.count }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Portfolio Management Button -->  
                        <div class="mt-3 pt-3 border-top border-secondary">
                            <a href="{% url 'critique:portfolio_builder' %}" class="btn btn-sm btn-outline-light w-100">
                                <i class="bi bi-tools me-1"></i>
                                Organize Portfolio
                            </a>
                        </div>
                        </div> <!-- End sidebar-content -->
                    </div>
                </div>
                {% endif %}
                
                <!-- Main Content Area -->
                <div class="{% if folders %}col-lg-9 col-xl-10{% else %}col-12{% endif %} main-content">
                    <!-- Mobile Folder Toggle -->
                    {% if folders %}
                    <div class="d-lg-none mb-3">
                        <button class="btn btn-outline-primary btn-sm" onclick="toggleFolderSidebar()">
                            <i class="bi bi-folder2 me-1"></i>
                            Browse Folders
                        </button>
                    </div>
                    {% endif %}
                    
            <!-- Advanced Studio Filters -->
            <div class="studio-filters-panel p-4 rounded-3 shadow-sm mb-4">
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search me-1" viewBox="0 0 16 16">
                                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                            </svg>
                            Search & Filter
                        </label>
                        <div class="input-group">
                            <input type="text" id="searchInput" class="form-control border-primary" placeholder="Search by title, tags, or description...">
                            <button class="btn btn-primary" type="button" id="searchButton">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="col-md-2">
                        <label class="form-label fw-semibold text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-text me-1" viewBox="0 0 16 16">
                                <path d="M5.5 7a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5zM5 9.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5z"/>
                                <path d="M9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.5L9.5 0zm0 1v2A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/>
                            </svg>
                            Status
                        </label>
                        <select id="statusFilter" class="form-select border-primary">
                            <option value="all">All Status</option>
                            <option value="draft">Drafts Only</option>
                            <option value="published">Published</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label class="form-label fw-semibold text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye me-1" viewBox="0 0 16 16">
                                <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                                <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                            </svg>
                            Visibility
                        </label>
                        <select id="visibilityFilter" class="form-select border-primary">
                            <option value="all">All Visibility</option>
                            <option value="public">Public</option>
                            <option value="private">Private</option>
                            <option value="unlisted">Unlisted</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label class="form-label fw-semibold text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat-dots me-1" viewBox="0 0 16 16">
                                <path d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                                <path d="m2.165 15.803.02-.004c1.83-.363 2.948-.842 3.468-1.105A9.06 9.06 0 0 0 8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6a10.437 10.437 0 0 1-.524 2.318l-.003.011a10.722 10.722 0 0 1-.244.637c-.079.186.074.394.273.362a21.673 21.673 0 0 0 .693-.125zm.8-3.108a1 1 0 0 0-.287-.801C1.618 10.83 1 9.468 1 8c0-3.192 3.004-6 7-6s7 2.808 7 6c0 3.193-3.004 6-7 6a8.06 8.06 0 0 1-2.088-.272 1 1 0 0 0-.711.074c-.387.196-1.24.57-2.634.893a10.97 10.97 0 0 0 .398-2z"/>
                            </svg>
                            Critique Status
                        </label>
                        <select id="critiqueFilter" class="form-select border-primary">
                            <option value="all">All</option>
                            <option value="seeking">Seeking Critique</option>
                            <option value="not_seeking">Not Seeking</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label class="form-label fw-semibold text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-sort-down me-1" viewBox="0 0 16 16">
                                <path d="M3.5 2.5a.5.5 0 0 0-1 0v8.793l-1.146-1.147a.5.5 0 0 0-.708.708l2 1.999.007.007a.497.497 0 0 0 .7-.006l2-2a.5.5 0 0 0-.707-.708L3.5 11.293V2.5zm3.5 1a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zM7.5 6a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5zm0 3a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1h-3zm0 3a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1z"/>
                            </svg>
                            Sort By
                        </label>
                        <select id="sortDropdown" class="form-select border-primary">
                            <option value="newest">Recent First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="most_likes">Most Popular</option>
                            <option value="most_critiques">Most Critiques</option>
                            <option value="title_asc">Title (A-Z)</option>
                            <option value="title_desc">Title (Z-A)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Quick Action Buttons -->
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-sm btn-outline-primary" onclick="filterByTag('recent')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-clock me-1" viewBox="0 0 16 16">
                            <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
                        </svg>
                        Last 7 Days
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="filterByCritiques('active')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-chat-dots me-1" viewBox="0 0 16 16">
                            <path d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                            <path d="m2.165 15.803.02-.004c1.83-.363 2.948-.842 3.468-1.105A9.06 9.06 0 0 0 8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6a10.437 10.437 0 0 1-.524 2.318l-.003.011a10.722 10.722 0 0 1-.244.637c-.079.186.074.394.273.362a21.673 21.673 0 0 0 .693-.125zm.8-3.108a1 1 0 0 0-.287-.801C1.618 10.83 1 9.468 1 8c0-3.192 3.004-6 7-6s7 2.808 7 6c0 3.193-3.004 6-7 6a8.06 8.06 0 0 1-2.088-.272 1 1 0 0 0-.711.074c-.387.196-1.24.57-2.634.893a10.97 10.97 0 0 0 .398-2z"/>
                        </svg>
                        Active Critiques
                    </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="showDraftsOnly()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-file-earmark-text me-1" viewBox="0 0 16 16">
                            <path d="M5.5 7a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5zM5 9.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5z"/>
                            <path d="M9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.5L9.5 0zm0 1v2A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/>
                        </svg>
                        Drafts Only
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="clearAllFilters()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-arrow-clockwise me-1" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                            <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                        </svg>
                        Clear Filters
                    </button>
                </div>
            </div>
            
            {% if artworks %}
                <!-- Bulk Actions Bar (Hidden by default) -->
                <div id="bulk-actions-bar" class="alert alert-info d-none mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <span><span id="selected-count">0</span> artworks selected</span>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-success" onclick="bulkPublish()">Publish Selected</button>
                            <button class="btn btn-sm btn-warning" onclick="bulkDraft()">Mark as Draft</button>
                            <button class="btn btn-sm btn-info" onclick="bulkToggleCritique()">Toggle Critique Requests</button>
                            <button class="btn btn-sm btn-danger" onclick="bulkDelete()">Delete Selected</button>
                            <button class="btn btn-sm btn-secondary" onclick="cancelBulkActions()">Cancel</button>
                        </div>
                    </div>
                </div>

                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="artworksContainer">
                    {% for artwork in artworks %}
                        <div class="col artwork-item" data-artwork-id="{{ artwork.id }}" 
                             data-status="{% if artwork.is_published %}published{% else %}draft{% endif %}"
                             data-visibility="{{ artwork.visibility|default:'public' }}"
                             data-seeking-critique="{% if artwork.seeking_critique %}true{% else %}false{% endif %}"
                             data-folder-id="{{ artwork.folder.id|default:'' }}">
                            <div class="card h-100 position-relative artwork-card">
                                <!-- Bulk Selection Checkbox -->
                                <div class="artwork-checkbox position-absolute top-0 start-0 p-2 d-none bulk-hidden">
                                    <input type="checkbox" 
                                           class="form-check-input" 
                                           id="checkbox-{{ artwork.id }}"
                                           name="artwork_selection"
                                           value="{{ artwork.id }}"
                                           onchange="toggleArtworkSelection({{ artwork.id }}, this)">
                                </div>
                                
                                <!-- Status Indicators -->
                                <div class="position-absolute top-0 end-0 p-2">
                                    <div class="d-flex flex-column gap-1">
                                        {% if not artwork.is_published %}
                                            <span class="badge bg-warning text-dark">DRAFT</span>
                                        {% endif %}
                                        {% if artwork.visibility == 'private' %}
                                            <span class="badge bg-dark">PRIVATE</span>
                                        {% elif artwork.visibility == 'unlisted' %}
                                            <span class="badge bg-secondary">UNLISTED</span>
                                        {% endif %}
                                        {% if artwork.seeking_critique %}
                                            <span class="badge bg-success">SEEKING CRITIQUE</span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Image Container -->
                                <div class="position-relative" style="z-index: 1;">
                                    <a href="{% url 'critique:artwork_detail' artwork.id %}" style="z-index: 1;">
                                        {% if artwork.get_display_image_url %}
                                            <img src="{{ artwork.get_display_image_url }}" class="card-img-top" alt="{{ artwork.title }}" style="height: 200px; object-fit: cover; z-index: 1;">
                                        {% else %}
                                            <div class="bg-secondary text-white d-flex justify-content-center align-items-center" style="height: 200px; z-index: 1;">
                                                <span>No Image</span>
                                            </div>
                                        {% endif %}
                                    </a>
                                    
                                    <!-- Quick Action Overlay -->
                                    <div class="position-absolute bottom-0 start-0 end-0 bg-dark bg-opacity-75 text-white p-2 quick-actions" style="opacity: 0; transition: opacity 0.3s;">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="d-flex gap-1">
                                                <button class="btn btn-sm btn-outline-light" onclick="togglePublishStatus({{ artwork.id }})" title="Toggle Publish Status">
                                                    {% if artwork.is_published %}
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-eye-slash" viewBox="0 0 16 16">
                                                            <path d="M13.359 11.238C15.06 9.72 16 8 16 8s-3-5.5-8-5.5a7.028 7.028 0 0 0-2.79.588l.77.771A5.944 5.944 0 0 1 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.134 13.134 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755-.165.165-.337.328-.517.486l.708.709z"/>
                                                            <path d="M11.297 9.176a3.5 3.5 0 0 0-4.474-4.474l.823.823a2.5 2.5 0 0 1 2.829 2.829l.822.822zm-2.943 1.299.822.822a3.5 3.5 0 0 1-4.474-4.474l.823.823a2.5 2.5 0 0 0 2.829 2.829z"/>
                                                            <path d="M3.35 5.47c-.18.16-.353.322-.518.487A13.134 13.134 0 0 0 1.172 8l.195.288c.335.48.83 1.12 1.465 1.755C4.121 11.332 5.881 12.5 8 12.5c.716 0 1.39-.133 2.02-.36l.77.772A7.029 7.029 0 0 1 8 13.5C3 13.5 0 8 0 8s.939-1.721 2.641-3.238l.708.709zm10.296 8.884-12-12 .708-.708 12 12-.708.708z"/>
                                                        </svg>
                                                    {% else %}
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16">
                                                            <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                                                            <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                                                        </svg>
                                                    {% endif %}
                                                </button>
                                                <button class="btn btn-sm btn-outline-light" onclick="toggleCritiqueRequest({{ artwork.id }})" title="Toggle Critique Request">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-chat-dots" viewBox="0 0 16 16">
                                                        <path d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                                                        <path d="m2.165 15.803.02-.004c1.83-.363 2.948-.842 3.468-1.105A9.06 9.06 0 0 0 8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6a10.437 10.437 0 0 1-.524 2.318l-.003.011a10.722 10.722 0 0 1-.244.637c-.079.186.074.394.273.362a21.673 21.673 0 0 0 .693-.125zm.8-3.108a1 1 0 0 0-.287-.801C1.618 10.83 1 9.468 1 8c0-3.192 3.004-6 7-6s7 2.808 7 6c0 3.193-3.004 6-7 6a8.06 8.06 0 0 1-2.088-.272 1 1 0 0 0-.711.074c-.387.196-1.24.57-2.634.893a10.97 10.97 0 0 0 .398-2z"/>
                                                    </svg>
                                                </button>
                                                <button class="btn btn-sm btn-outline-light" onclick="openVersionManager({{ artwork.id }})" title="Version History">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-clock-history" viewBox="0 0 16 16">
                                                        <path d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022l-.074.997zm2.004.45a7.003 7.003 0 0 0-.985-.299l.219-.976c.383.086.76.2 1.126.342l-.36.933zm1.37.71a7.01 7.01 0 0 0-.439-.27l.493-.87a8.025 8.025 0 0 1 .979.654l-.615.789a6.996 6.996 0 0 0-.418-.302zm1.834 1.79a6.99 6.99 0 0 0-.653-.796l.724-.69c.27.285.52.59.747.91l-.818.576zm.744 1.352a7.08 7.08 0 0 0-.214-.468l.893-.45a7.976 7.976 0 0 1 .45 1.088l-.942.313a7.023 7.023 0 0 0-.187-.483zm.53 2.507a6.991 6.991 0 0 0-.1-1.025l.985-.17c.067.386.106.778.116 1.17l-1.001.025zm-.131 1.538c.033-.17.06-.339.081-.51l.993.123a7.957 7.957 0 0 1-.23 1.155l-.964-.267c.046-.165.086-.332.12-.501zm-.952 2.379c.184-.29.346-.594.486-.908l.914.405c-.16.36-.345.706-.555 1.038l-.845-.535zm-1.442 1.633c.263-.226.509-.467.740-.722l.724.69a8.026 8.026 0 0 1-.989.912l-.475-.88zm-2.266.97c.342-.14.677-.296.99-.49l.546.837a7.972 7.972 0 0 1-1.198.596l-.338-.943zm-2.137.339c.37-.042.741-.111 1.106-.207l.238.971a7.998 7.998 0 0 1-1.425.267l.081-.031z"/>
                                                        <path d="M8 1a7 7 0 1 0 4.95 11.95l.707.707A8.001 8.001 0 1 1 8 0v1z"/>
                                                        <path d="M7.5 3a.5.5 0 0 1 .5.5v5.21l3.248 1.856a.5.5 0 0 1-.496.868l-3.5-2A.5.5 0 0 1 7 9V3.5a.5.5 0 0 1 .5-.5z"/>
                                                    </svg>
                                                </button>
                                            </div>
                                            <div class="d-flex gap-1">
                                                <button class="btn btn-sm btn-outline-light" onclick="openQuickEdit({{ artwork.id }})" title="Quick Edit">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16">
                                                        <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708L10.5 8.207l-3-3L12.146.146zM11.207 9l-3-3L2.5 11.707V15h3.293L11.207 9zM13 2.5a.5.5 0 0 0-.5-.5h-2.797l-1.5 1.5h3.797V2.5z"/>
                                                    </svg>
                                                </button>
                                                <a href="{% url 'critique:artwork_detail' artwork.id %}" class="btn btn-sm btn-outline-light" title="View Details">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-arrow-right" viewBox="0 0 16 16">
                                                        <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z"/>
                                                    </svg>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Card Body with Inline Editing -->
                                <div class="card-body">
                                    <!-- Editable Title -->
                                    <h5 class="card-title artwork-title" data-artwork-id="{{ artwork.id }}" onclick="enableInlineEdit(this, 'title')">
                                        {{ artwork.title }}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-pencil ms-1 edit-icon" viewBox="0 0 16 16">
                                            <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708L10.5 8.207l-3-3L12.146.146zM11.207 9l-3-3L2.5 11.707V15h3.293L11.207 9zM13 2.5a.5.5 0 0 0-.5-.5h-2.797l-1.5 1.5h3.797V2.5z"/>
                                        </svg>
                                    </h5>
                                    
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <small class="text-muted">{{ artwork.created_at|date:"M d, Y" }}</small>
                                        <div class="d-flex align-items-center gap-2">
                                            <small class="text-muted">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-heart me-1" viewBox="0 0 16 16">
                                                    <path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01L8 2.748zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15z"/>
                                                </svg>
                                                {{ artwork.total_likes|default:0 }}
                                            </small>
                                            <small class="text-muted">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-chat-dots me-1" viewBox="0 0 16 16">
                                                    <path d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                                                    <path d="m2.165 15.803.02-.004c1.83-.363 2.948-.842 3.468-1.105A9.06 9.06 0 0 0 8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6a10.437 10.437 0 0 1-.524 2.318l-.003.011a10.722 10.722 0 0 1-.244.637c-.079.186.074.394.273.362a21.673 21.673 0 0 0 .693-.125zm.8-3.108a1 1 0 0 0-.287-.801C1.618 10.83 1 9.468 1 8c0-3.192 3.004-6 7-6s7 2.808 7 6c0 3.193-3.004 6-7 6a8.06 8.06 0 0 1-2.088-.272 1 1 0 0 0-.711.074c-.387.196-1.24.57-2.634.893a10.97 10.97 0 0 0 .398-2z"/>
                                                </svg>
                                                {{ artwork.critique_count|default:0 }}
                                            </small>
                                        </div>
                                    </div>
                                    
                                    <!-- Editable Description -->
                                    <p class="card-text artwork-description" data-artwork-id="{{ artwork.id }}" onclick="enableInlineEdit(this, 'description')">
                                        {{ artwork.description|truncatechars:120|default:"Click to add description..." }}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-pencil ms-1 edit-icon" viewBox="0 0 16 16">
                                            <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708L10.5 8.207l-3-3L12.146.146zM11.207 9l-3-3L2.5 11.707V15h3.293L11.207 9zM13 2.5a.5.5 0 0 0-.5-.5h-2.797l-1.5 1.5h3.797V2.5z"/>
                                        </svg>
                                    </p>
                                    
                                    <!-- Tags Section -->
                                    <div class="mb-2">
                                        <div class="artwork-tags" data-artwork-id="{{ artwork.id }}" onclick="enableInlineEdit(this, 'tags')">
                                            {% if artwork.tags %}
                                                {% for tag in artwork.tags_list|slice:":4" %}
                                                    <span class="badge bg-primary me-1">{{ tag }}</span>
                                                {% endfor %}
                                                {% if artwork.tags_list|length > 4 %}
                                                    <span class="badge bg-secondary">+{{ artwork.tags_list|length|add:"-4" }} more</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted small">Click to add tags...</span>
                                            {% endif %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-pencil ms-1 edit-icon" viewBox="0 0 16 16">
                                                <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708L10.5 8.207l-3-3L12.146.146zM11.207 9l-3-3L2.5 11.707V15h3.293L11.207 9zM13 2.5a.5.5 0 0 0-.5-.5h-2.797l-1.5 1.5h3.797V2.5z"/>
                                            </svg>
                                        </div>
                                    </div>
                                    
                                    <!-- Medium Badge -->
                                    {% if artwork.medium %}
                                        <span class="badge bg-secondary">{{ artwork.medium }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <!-- Pagination -->
                {% if is_paginated %}
                <nav aria-label="Page navigation" class="mt-5">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1" aria-label="First">
                                    <span aria-hidden="true">&laquo;&laquo;</span>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#" aria-label="First">
                                    <span aria-hidden="true">&laquo;&laquo;</span>
                                </a>
                            </li>
                            <li class="page-item disabled">
                                <a class="page-link" href="#" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                        {% endif %}
                        
                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <li class="page-item active">
                                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}" aria-label="Last">
                                    <span aria-hidden="true">&raquo;&raquo;</span>
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            <li class="page-item disabled">
                                <a class="page-link" href="#" aria-label="Last">
                                    <span aria-hidden="true">&raquo;&raquo;</span>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
                
            {% else %}
                <div class="alert alert-info text-center py-5">
                    <h4 class="mb-3">You haven't uploaded any artworks yet</h4>
                    <p>Share your creative work with the community to receive valuable feedback and appreciation!</p>
                    <a href="{% url 'critique:artwork_upload' %}" class="btn btn-lg btn-primary mt-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload me-2" viewBox="0 0 16 16">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                        </svg>
                        Upload Your First Artwork
                    </a>
                </div>
            {% endif %}
                </div> <!-- End Main Content -->
            </div> <!-- End Row -->
        </div> <!-- End Card Body -->
    </div> <!-- End Card -->
</div> <!-- End Container -->

<script>
// Get CSRF token
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
           '{{ csrf_token }}';
}

let bulkActionsMode = false;
let selectedArtworks = new Set();

document.addEventListener('DOMContentLoaded', function() {
    initializeStudioWorkspace();
    calculateStatistics();
    setupEventListeners();
    setupHoverEffects();
});

function initializeStudioWorkspace() {
    console.log('Initializing Artist Studio Workspace...');
    
    // Load user preferences from localStorage
    const savedFilters = localStorage.getItem('studio_filters');
    if (savedFilters) {
        const filters = JSON.parse(savedFilters);
        applyFilters(filters);
    }
}

function calculateStatistics() {
    const artworkItems = document.querySelectorAll('.artwork-item');
    let totalArtworks = artworkItems.length;
    let draftCount = 0;
    let seekingCritiqueCount = 0;
    let totalInteractions = 0;
    
    artworkItems.forEach(item => {
        if (item.dataset.status === 'draft') draftCount++;
        if (item.dataset.seekingCritique === 'true') seekingCritiqueCount++;
        
        const likes = parseInt(item.querySelector('.bi-heart').parentElement.textContent.match(/\d+/)?.[0] || 0);
        const critiques = parseInt(item.querySelector('.bi-chat-dots').parentElement.textContent.match(/\d+/)?.[0] || 0);
        totalInteractions += likes + critiques;
    });
    
    document.getElementById('total-artworks').textContent = totalArtworks;
    document.getElementById('draft-count').textContent = draftCount;
    document.getElementById('seeking-critique-count').textContent = seekingCritiqueCount;
    document.getElementById('total-interactions').textContent = totalInteractions;
}

function setupEventListeners() {
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const visibilityFilter = document.getElementById('visibilityFilter');
    const critiqueFilter = document.getElementById('critiqueFilter');
    const sortDropdown = document.getElementById('sortDropdown');
    
    // Advanced search and filtering
    [searchInput, statusFilter, visibilityFilter, critiqueFilter, sortDropdown].forEach(element => {
        if (element) {
            element.addEventListener('change', applyFiltersAndSort);
            element.addEventListener('input', applyFiltersAndSort);
        }
    });
    
    // Search on Enter key
    if (searchInput) {
        searchInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                applyFiltersAndSort();
            }
        });
    }
}

function setupHoverEffects() {
    // Show quick actions on hover
    document.querySelectorAll('.artwork-card').forEach(card => {
        const quickActions = card.querySelector('.quick-actions');
        if (quickActions) {
            card.addEventListener('mouseenter', () => {
                quickActions.style.opacity = '1';
            });
            card.addEventListener('mouseleave', () => {
                quickActions.style.opacity = '0';
            });
        }
    });
}

function applyFiltersAndSort() {
    const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
    const statusFilter = document.getElementById('statusFilter')?.value || 'all';
    const visibilityFilter = document.getElementById('visibilityFilter')?.value || 'all';
    const critiqueFilter = document.getElementById('critiqueFilter')?.value || 'all';
    const sortBy = document.getElementById('sortDropdown')?.value || 'newest';
    
    const artworkItems = Array.from(document.querySelectorAll('.artwork-item'));
    
    // Apply filters
    artworkItems.forEach(item => {
        let visible = true;
        
        // Search filter
        if (searchTerm) {
            const title = item.querySelector('.artwork-title').textContent.toLowerCase();
            const description = item.querySelector('.artwork-description').textContent.toLowerCase();
            const tags = item.querySelector('.artwork-tags').textContent.toLowerCase();
            
            visible = visible && (title.includes(searchTerm) || description.includes(searchTerm) || tags.includes(searchTerm));
        }
        
        // Status filter
        if (statusFilter !== 'all') {
            visible = visible && item.dataset.status === statusFilter;
        }
        
        // Visibility filter
        if (visibilityFilter !== 'all') {
            visible = visible && item.dataset.visibility === visibilityFilter;
        }
        
        // Critique filter
        if (critiqueFilter !== 'all') {
            const seekingCritique = item.dataset.seekingCritique === 'true';
            visible = visible && ((critiqueFilter === 'seeking' && seekingCritique) || (critiqueFilter === 'not_seeking' && !seekingCritique));
        }
        
        item.style.display = visible ? '' : 'none';
    });
    
    // Apply sorting
    const visibleItems = artworkItems.filter(item => item.style.display !== 'none');
    sortArtworks(visibleItems, sortBy);
    
    // Save filters to localStorage
    const filters = { searchTerm, statusFilter, visibilityFilter, critiqueFilter, sortBy };
    localStorage.setItem('studio_filters', JSON.stringify(filters));
}

function sortArtworks(items, sortBy) {
    const container = document.getElementById('artworksContainer');
    
    items.sort((a, b) => {
        const titleA = a.querySelector('.artwork-title').textContent.trim();
        const titleB = b.querySelector('.artwork-title').textContent.trim();
        
        const dateA = new Date(a.querySelector('.text-muted').textContent);
        const dateB = new Date(b.querySelector('.text-muted').textContent);
        
        const likesA = parseInt(a.querySelector('.bi-heart').parentElement.textContent.match(/\d+/)?.[0] || 0);
        const likesB = parseInt(b.querySelector('.bi-heart').parentElement.textContent.match(/\d+/)?.[0] || 0);
        
        const critiquesA = parseInt(a.querySelector('.bi-chat-dots').parentElement.textContent.match(/\d+/)?.[0] || 0);
        const critiquesB = parseInt(b.querySelector('.bi-chat-dots').parentElement.textContent.match(/\d+/)?.[0] || 0);
        
        switch(sortBy) {
            case 'newest':
                return dateB - dateA;
            case 'oldest':
                return dateA - dateB;
            case 'most_likes':
                return likesB - likesA;
            case 'most_critiques':
                return critiquesB - critiquesA;
            case 'title_asc':
                return titleA.localeCompare(titleB);
            case 'title_desc':
                return titleB.localeCompare(titleA);
            default:
                return 0;
        }
    });
    
    // Re-append sorted items
    items.forEach(item => {
        container.appendChild(item);
    });
}

// Quick filter functions
function filterByTag(tag) {
    const searchInput = document.getElementById('searchInput');
    if (tag === 'recent') {
        const weekAgo = new Date();
        weekAgo.setDate(weekAgo.getDate() - 7);
        
        document.querySelectorAll('.artwork-item').forEach(item => {
            const dateText = item.querySelector('.text-muted').textContent;
            const itemDate = new Date(dateText);
            item.style.display = itemDate >= weekAgo ? '' : 'none';
        });
    }
}

function filterByCritiques(type) {
    document.getElementById('critiqueFilter').value = type === 'active' ? 'seeking' : 'all';
    applyFiltersAndSort();
}

function showDraftsOnly() {
    document.getElementById('statusFilter').value = 'draft';
    applyFiltersAndSort();
}

function clearAllFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = 'all';
    document.getElementById('visibilityFilter').value = 'all';
    document.getElementById('critiqueFilter').value = 'all';
    document.getElementById('sortDropdown').value = 'newest';
    
    document.querySelectorAll('.artwork-item').forEach(item => {
        item.style.display = '';
    });
    
    // Clear folder filter
    clearFolderFilter();
    
    localStorage.removeItem('studio_filters');
}

// Folder filtering functions
let currentFolderId = null;

function filterByFolder(folderId) {
    currentFolderId = folderId;
    
    // Update active folder styling
    document.querySelectorAll('.folder-card').forEach(card => {
        card.classList.remove('active');
    });
    
    const activeFolder = document.querySelector(`[data-folder-id="${folderId}"] .folder-card`);
    if (activeFolder) {
        activeFolder.classList.add('active');
    }
    
    // Filter artworks by folder
    document.querySelectorAll('.artwork-item').forEach(item => {
        const artworkFolderId = item.dataset.folderId;
        if (artworkFolderId == folderId) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
    
    // Update statistics
    updateFolderStatistics(folderId);
    
    // Close mobile sidebar
    if (window.innerWidth < 992) {
        toggleFolderSidebar();
    }
}

function clearFolderFilter() {
    currentFolderId = null;
    
    // Remove active styling from all folders
    document.querySelectorAll('.folder-card').forEach(card => {
        card.classList.remove('active');
    });
    
    // Show all artworks
    document.querySelectorAll('.artwork-item').forEach(item => {
        item.style.display = '';
    });
    
    // Update statistics
    calculateStatistics();
    
    // Close mobile sidebar
    if (window.innerWidth < 992) {
        toggleFolderSidebar();
    }
}

function updateFolderStatistics(folderId) {
    const folderArtworks = document.querySelectorAll(`[data-folder-id="${folderId}"]`);
    const totalCount = folderArtworks.length;
    
    let draftCount = 0;
    let seekingCritiqueCount = 0;
    let totalInteractions = 0;
    
    folderArtworks.forEach(item => {
        if (item.dataset.status === 'draft') draftCount++;
        if (item.dataset.seekingCritique === 'true') seekingCritiqueCount++;
        
        const likesElement = item.querySelector('.likes-count');
        if (likesElement) {
            totalInteractions += parseInt(likesElement.textContent) || 0;
        }
    });
    
    // Update display
    document.getElementById('total-artworks').textContent = totalCount;
    document.getElementById('draft-count').textContent = draftCount;
    document.getElementById('seeking-critique-count').textContent = seekingCritiqueCount;
    document.getElementById('total-interactions').textContent = totalInteractions;
}

// Mobile sidebar toggle functionality
function toggleFolderSidebar() {
    const sidebar = document.getElementById('folderSidebar');
    const backdrop = document.getElementById('sidebarBackdrop') || createBackdrop();
    
    if (sidebar && window.innerWidth < 992) {
        const isShowing = sidebar.classList.contains('show');
        
        if (isShowing) {
            sidebar.classList.remove('show');
            backdrop.classList.remove('show');
            document.body.style.overflow = '';
        } else {
            sidebar.classList.add('show');
            backdrop.classList.add('show');
            document.body.style.overflow = 'hidden';
        }
    }
}

function createBackdrop() {
    const backdrop = document.createElement('div');
    backdrop.id = 'sidebarBackdrop';
    backdrop.className = 'sidebar-backdrop';
    backdrop.onclick = toggleFolderSidebar;
    document.body.appendChild(backdrop);
    return backdrop;
}

// Sidebar collapse functionality
function toggleSidebarCollapse() {
    const sidebar = document.getElementById('folderSidebar');
    const sidebarWrapper = sidebar.closest('.sidebar-wrapper');
    const mainContent = document.querySelector('.main-content');
    const collapseBtn = document.getElementById('sidebarCollapseBtn');
    const chevronIcon = collapseBtn.querySelector('i');
    
    if (sidebar && sidebarWrapper && mainContent) {
        const isCollapsed = sidebar.classList.contains('collapsed');
        
        if (isCollapsed) {
            // Expand sidebar
            sidebar.classList.remove('collapsed');
            sidebarWrapper.classList.remove('collapsed');
            sidebarWrapper.className = sidebarWrapper.className.replace(/col-\w+-\d+/g, '');
            sidebarWrapper.classList.add('col-lg-3', 'col-xl-2');
            mainContent.className = mainContent.className.replace(/col-\w+-\d+/g, '');
            mainContent.classList.add('col-lg-9', 'col-xl-10');
            collapseBtn.title = 'Collapse sidebar';
            
            // Animate chevron back
            chevronIcon.style.transform = 'rotate(0deg)';
        } else {
            // Collapse sidebar
            sidebar.classList.add('collapsed');
            sidebarWrapper.classList.add('collapsed');
            sidebarWrapper.className = sidebarWrapper.className.replace(/col-\w+-\d+/g, '');
            sidebarWrapper.classList.add('col-auto');
            mainContent.className = mainContent.className.replace(/col-\w+-\d+/g, '');
            mainContent.classList.add('col');
            collapseBtn.title = 'Expand sidebar';
            
            // Animate chevron
            chevronIcon.style.transform = 'rotate(180deg)';
        }
        
        // Save collapse state
        localStorage.setItem('sidebarCollapsed', !isCollapsed);
    }
}

// Restore collapse state on page load
document.addEventListener('DOMContentLoaded', function() {
    const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    if (isCollapsed) {
        setTimeout(() => toggleSidebarCollapse(), 100);
    }
});

// Bulk Actions (remove duplicate declaration)
bulkSelectionMode = false;

// Ensure function is available after DOM loads
document.addEventListener('DOMContentLoaded', function() {
    window.toggleBulkActions = function() {
    console.log('toggleBulkActions called, current mode:', bulkSelectionMode);
    bulkSelectionMode = !bulkSelectionMode;
    const checkboxes = document.querySelectorAll('.artwork-checkbox');
    const bulkBar = document.getElementById('bulk-actions-bar');
    const toggleBtn = document.querySelector('[onclick="toggleBulkActions()"]');
    
    console.log('Found checkboxes:', checkboxes.length);
    console.log('Bulk bar element:', bulkBar);
    console.log('Toggle button:', toggleBtn);
    
    if (bulkSelectionMode) {
        console.log('Enabling bulk selection mode');
        checkboxes.forEach((cb, index) => {
            console.log(`Setting checkbox ' + index + ' to visible`);
            cb.classList.remove('bulk-hidden', 'd-none');
            cb.classList.add('bulk-visible');
            cb.style.setProperty('display', 'block', 'important');
            
            const input = cb.querySelector('input[type="checkbox"]');
            if (input) {
                input.style.setProperty('opacity', '1', 'important');
                input.style.setProperty('width', '20px', 'important');
                input.style.setProperty('height', '20px', 'important');
                input.style.setProperty('z-index', '9999', 'important');
                input.style.setProperty('position', 'relative', 'important');
                input.style.setProperty('appearance', 'auto', 'important');
                console.log('Checkbox input styled:', input);
            }
        });
        if (bulkBar) bulkBar.classList.remove('d-none');
        if (toggleBtn) {
            toggleBtn.classList.add('active');
            toggleBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-square" viewBox="0 0 16 16"><path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg> Cancel';
        }
    } else {
        console.log('Disabling bulk selection mode');
        cancelBulkActions();
    }
    };

    window.toggleArtworkSelection = function(artworkId, checkbox) {
        if (checkbox.checked) {
            selectedArtworks.add(artworkId);
        } else {
            selectedArtworks.delete(artworkId);
        }
        updateSelectedCount();
    };

    window.updateSelectedCount = function() {
        document.getElementById('selected-count').textContent = selectedArtworks.size;
    };

    window.cancelBulkActions = function() {
        bulkSelectionMode = false;
        selectedArtworks.clear();
        
        const checkboxes = document.querySelectorAll('.artwork-checkbox');
        const bulkBar = document.getElementById('bulk-actions-bar');
        const toggleBtn = document.querySelector('[onclick="toggleBulkActions()"]');
        
        checkboxes.forEach(cb => {
            cb.classList.remove('bulk-visible');
            cb.classList.add('bulk-hidden', 'd-none');
            cb.style.setProperty('display', 'none', 'important');
            const input = cb.querySelector('input');
            if (input) input.checked = false;
        });
        
        bulkBar.classList.add('d-none');
        toggleBtn.classList.remove('active');
        toggleBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-square" viewBox="0 0 16 16"><path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/><path d="M10.97 4.97a.75.75 0 0 1 1.071 1.05l-3.992 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.235.235 0 0 1 .02-.022z"/></svg> Bulk Actions';
        
        updateSelectedCount();
    };
});

// Individual Artwork Actions
function togglePublishStatus(artworkId) {
    const artworkItem = document.querySelector('[data-artwork-id="' + artworkId + '"]');
    const currentStatus = artworkItem.dataset.status;
    
    // Make API call to toggle publish status
    fetch('/api/artworks/' + artworkId + '/toggle_publish_status/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            const newStatus = data.status;
            artworkItem.dataset.status = newStatus;
            updateStatusBadges(artworkItem, newStatus);
            calculateStatistics();
            
            // Show success feedback
            showToast('Artwork ' + (newStatus === 'published' ? 'published' : 'saved as draft'), 'success');
        } else {
            showToast('Failed to update status', 'error');
        }
    })
    .catch(error => {
        console.error('Error toggling publish status:', error);
        showToast('Failed to update status', 'error');
    });
}

function toggleCritiqueRequest(artworkId) {
    const artworkItem = document.querySelector('[data-artwork-id="' + artworkId + '"]');
    
    // Make API call to toggle critique request
    fetch('/api/artworks/' + artworkId + '/toggle_critique_request/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.id !== undefined) {
            const newSeeking = data.seeking_critique;
            artworkItem.dataset.seekingCritique = newSeeking.toString();
            updateCritiqueBadge(artworkItem, newSeeking);
            calculateStatistics();
            
            // Show success feedback
            showToast('Critique requests ' + (newSeeking ? 'enabled' : 'disabled'), 'success');
        } else {
            showToast('Failed to update critique request', 'error');
        }
    })
    .catch(error => {
        console.error('Error toggling critique request:', error);
        showToast('Failed to update critique request', 'error');
    });
}

function updateStatusBadges(artworkItem, status) {
    const statusContainer = artworkItem.querySelector('.position-absolute.top-0.end-0');
    const draftBadge = statusContainer.querySelector('.badge.bg-warning');
    
    if (status === 'draft') {
        if (!draftBadge) {
            const badge = document.createElement('span');
            badge.className = 'badge bg-warning text-dark';
            badge.textContent = 'DRAFT';
            statusContainer.querySelector('.d-flex').appendChild(badge);
        }
    } else {
        if (draftBadge) {
            draftBadge.remove();
        }
    }
    
    // Update the publish/draft button icon in quick actions
    const publishButton = artworkItem.querySelector('[onclick^="togglePublishStatus"]');
    if (publishButton) {
        const icon = publishButton.querySelector('svg');
        icon.innerHTML = status === 'published' ? 
            '<path d="M13.359 11.238C15.06 9.72 16 8 16 8s-3-5.5-8-5.5a7.028 7.028 0 0 0-2.79.588l.77.771A5.944 5.944 0 0 1 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.134 13.134 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755-.165.165-.337.328-.517.486l.708.709z"/><path d="M11.297 9.176a3.5 3.5 0 0 0-4.474-4.474l.823.823a2.5 2.5 0 0 1 2.829 2.829l.822.822zm-2.943 1.299.822.822a3.5 3.5 0 0 1-4.474-4.474l.823.823a2.5 2.5 0 0 0 2.829 2.829z"/><path d="M3.35 5.47c-.18.16-.353.322-.518.487A13.134 13.134 0 0 0 1.172 8l.195.288c.335.48.83 1.12 1.465 1.755C4.121 11.332 5.881 12.5 8 12.5c.716 0 1.39-.133 2.02-.36l.77.772A7.029 7.029 0 0 1 8 13.5C3 13.5 0 8 0 8s.939-1.721 2.641-3.238l.708.709zm10.296 8.884-12-12 .708-.708 12 12-.708.708z"/>' :
            '<path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/><path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>';
    }
}

// Quick Edit Modal/Popup functionality
function openQuickEdit(artworkId) {
    const artworkItem = document.querySelector('[data-artwork-id="' + artworkId + '"]');
    const title = artworkItem.querySelector('.artwork-title').textContent.trim();
    const description = artworkItem.querySelector('.artwork-description').textContent.trim();
    const visibility = artworkItem.dataset.visibility;
    
    // Create quick edit modal
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'quickEditModal';
    modal.innerHTML = 
        '<div class="modal-dialog modal-lg">' +
            '<div class="modal-content">' +
                '<div class="modal-header">' +
                    '<h5 class="modal-title">Quick Edit Artwork</h5>' +
                    '<button type="button" class="btn-close" data-bs-dismiss="modal"></button>' +
                '</div>' +
                '<div class="modal-body">' +
                    '<form id="quickEditForm">' +
                        '<div class="mb-3">' +
                            '<label class="form-label">Title</label>' +
                            '<input type="text" class="form-control" id="editTitle" value="' + title + '">' +
                        '</div>' +
                        '<div class="mb-3">' +
                            '<label class="form-label">Description</label>' +
                            '<textarea class="form-control" id="editDescription" rows="4">' + (description.includes('Click to add') ? '' : description) + '</textarea>' +
                        '</div>' +
                        '<div class="mb-3">' +
                            '<label class="form-label">Visibility</label>' +
                            '<select class="form-select" id="editVisibility">' +
                                '<option value="public" ' + (visibility === 'public' ? 'selected' : '') + '>Public</option>' +
                                '<option value="private" ' + (visibility === 'private' ? 'selected' : '') + '>Private</option>' +
                                '<option value="unlisted" ' + (visibility === 'unlisted' ? 'selected' : '') + '>Unlisted</option>' +
                            '</select>' +
                        '</div>' +
                    '</form>' +
                '</div>' +
                '<div class="modal-footer">' +
                    '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>' +
                    '<button type="button" class="btn btn-primary" onclick="saveQuickEdit(' + artworkId + ')">Save Changes</button>' +
                '</div>' +
            '</div>' +
        '</div>';
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Remove modal from DOM when closed
    modal.addEventListener('hidden.bs.modal', () => {
        modal.remove();
    });
}

function saveQuickEdit(artworkId) {
    const title = document.getElementById('editTitle').value.trim();
    const description = document.getElementById('editDescription').value.trim();
    const visibility = document.getElementById('editVisibility').value;
    
    const updateData = {
        title: title,
        description: description,
        visibility: visibility
    };
    
    fetch('/api/artworks/' + artworkId + '/', {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(updateData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            const artworkItem = document.querySelector('[data-artwork-id="' + artworkId + '"]');
            
            // Update title
            artworkItem.querySelector('.artwork-title').firstChild.textContent = title;
            
            // Update description
            const descElement = artworkItem.querySelector('.artwork-description');
            descElement.firstChild.textContent = description || 'Click to add description...';
            
            // Update visibility
            artworkItem.dataset.visibility = visibility;
            updateVisibilityBadge(artworkItem, visibility);
            
            calculateStatistics();
            showToast('Artwork updated successfully', 'success');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('quickEditModal'));
            modal.hide();
        } else {
            showToast('Failed to update artwork', 'error');
        }
    })
    .catch(error => {
        console.error('Error updating artwork:', error);
        showToast('Failed to update artwork', 'error');
    });
}

// Artwork Versioning Functions
function openVersionManager(artworkId) {
    fetch('/api/artworks/' + artworkId + '/versions/', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.versions) {
            showVersionManagerModal(artworkId, data.versions, data.artwork_title);
        } else {
            showToast('Failed to load version history', 'error');
        }
    })
    .catch(error => {
        console.error('Error loading versions:', error);
        showToast('Failed to load version history', 'error');
    });
}

function showVersionManagerModal(artworkId, versions, artworkTitle) {
    // Store versions data globally for access by delete functions
    window.currentVersions = versions;
    
    // Get current artwork image from the artwork card
    const artworkCard = document.querySelector('[data-artwork-id="' + artworkId + '"]');
    const currentArtworkImage = artworkCard ? artworkCard.querySelector('img').src : '/static/images/placeholder.png';
    const versionCardsHtml = versions.map(function(version, index) {
        // Determine if version has critiques (using critique_count if available)
        const hasCritiques = version.critique_count > 0;
        const deleteButtonClass = 'btn-outline-danger';
        const deleteButtonText = 'Delete';
        const deleteButtonTitle = hasCritiques ? 
            'Delete this version (has ' + version.critique_count + ' critique' + (version.critique_count === 1 ? '' : 's') + ' - warning will be shown)' :
            'Permanently delete this version';
        const deleteAction = 'deleteVersion';
        
        return '<div class="col-md-4 mb-3 version-card" ' +
                 'data-is-archived="' + (version.is_archived || false) + '" ' +
                 'style="' + (version.is_archived ? 'display: none;' : '') + '">' +
            '<div class="card bg-secondary text-white h-100" draggable="true" ' +
                 'data-version-id="' + version.id + '" ' +
                 'data-version-number="' + version.version_number + '" ' +
                 'data-version-title="' + version.title + '" ' +
                 'data-version-description="' + version.description + '" ' +
                 'data-artwork-id="' + artworkId + '">' +
                '<div class="card-header d-flex justify-content-between align-items-center">' +
                    '<h6 class="mb-0">Version ' + version.version_number + '</h6>' +
                    '<small class="text-light">' + new Date(version.created_at).toLocaleDateString() + '</small>' +
                '</div>' +
                '<div class="card-body p-2">' +
                    '<div class="mb-2">' +
                        '<img src="' + (version.image_display_url || '/static/images/placeholder.png') + '" ' +
                             'class="img-fluid rounded" style="width: 100%; height: 150px; object-fit: cover; cursor: pointer;" ' +
                             'alt="Version ' + version.version_number + '" ' +
                             'onclick="showFullImage(\'' + (version.image_display_url || '/static/images/placeholder.png') + '\', \'Version ' + version.version_number + '\')">' +
                    '</div>' +
                    '<h6 class="card-title text-sm mb-1">' + version.title + '</h6>' +
                    '<p class="card-text text-xs text-muted mb-2">' + 
                        (version.description ? version.description.substring(0, 60) + (version.description.length > 60 ? '...' : '') : 'No description') + 
                    '</p>' +
                    (version.version_notes ? '<p class="text-warning text-xs mb-2"><strong>Notes:</strong> ' + version.version_notes.substring(0, 40) + (version.version_notes.length > 40 ? '...' : '') + '</p>' : '') +
                    (hasCritiques ? '<p class="text-info text-xs mb-2"><i class="bi bi-chat-dots"></i> ' + version.critique_count + ' critique' + (version.critique_count === 1 ? '' : 's') + '</p>' : '') +
                    '<div class="d-grid gap-1">' +
                        '<button class="btn btn-sm btn-warning" onclick="restoreVersion(' + artworkId + ', ' + version.id + ')" ' +
                                'title="Make this version your current artwork" ' +
                                'data-bs-toggle="tooltip" data-bs-placement="top">' +
                            'Restore' +
                        '</button>' +
                        '<button class="btn btn-sm ' + deleteButtonClass + '" onclick="' + deleteAction + '(' + version.id + ', ' + version.version_number + ', ' + artworkId + ')" ' +
                                'title="' + deleteButtonTitle + '" ' +
                                'data-bs-toggle="tooltip" data-bs-placement="top">' +
                            deleteButtonText +
                        '</button>' +
                    '</div>' +
                '</div>' +
            '</div>' +
        '</div>';
    }).join('');

    const compareButtonDisabled = versions.length < 1 ? 'disabled' : '';
    const compareButtonTitle = versions.length < 1 ? 'Create at least one version to enable comparison' : 'Compare different versions side-by-side to see what changed';
    
    const modalHtml = 
        '<div class="modal fade" id="versionManagerModal" tabindex="-1" aria-labelledby="versionManagerModalLabel" aria-hidden="true">' +
            '<div class="modal-dialog modal-xl">' +
                '<div class="modal-content bg-dark text-light">' +
                    '<div class="modal-header border-secondary">' +
                        '<div class="d-flex align-items-center">' +
                            '<h5 class="modal-title mb-0 me-3" id="versionManagerModalLabel">' +
                                '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-clock-history me-2" viewBox="0 0 16 16">' +
                                    '<path d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022l-.074.997zm2.004.45a7.003 7.003 0 0 0-.985-.299l.219-.976c.383.086.76.2 1.126.342l-.36.933zm1.37.71a7.01 7.01 0 0 0-.439-.27l.493-.87a8.025 8.025 0 0 1 .979.654l-.615.789a6.996 6.996 0 0 0-.418-.302zm1.834 1.79a6.99 6.99 0 0 0-.653-.796l.724-.69c.27.285.52.59.747.91l-.818.576zm.744 1.352a7.08 7.08 0 0 0-.214-.468l.893-.45a7.976 7.976 0 0 1 .45 1.088l-.942.313a7.023 7.023 0 0 0-.187-.483zm.53 2.507a6.991 6.991 0 0 0-.1-1.025l.985-.17c.067.386.106.778.116 1.17l-1.001.025zm-.131 1.538c.033-.17.06-.339.081-.51l.993.123a7.957 7.957 0 0 1-.23 1.155l-.964-.267c.046-.165.086-.332.12-.501zm-.952 2.379c.184-.29.346-.594.486-.908l.914.405c-.16.36-.345.706-.555 1.038l-.845-.535zm-1.442 1.633c.263-.226.509-.467.740-.722l.724.69a8.026 8.026 0 0 1-.989.912l-.475-.88zm-2.266.97c.342-.14.677-.296.99-.49l.546.837a7.972 7.972 0 0 1-1.198.596l-.338-.943zm-2.137.339c.37-.042.741-.111 1.106-.207l.238.971a7.998 7.998 0 0 1-1.425.267l.081-.031z"/>' +
                                    '<path d="M8 1a7 7 0 1 0 4.95 11.95l.707.707A8.001 8.001 0 1 1 8 0v1z"/>' +
                                    '<path d="M7.5 3a.5.5 0 0 1 .5.5v5.21l3.248 1.856a.5.5 0 0 1-.496.868l-3.5-2A.5.5 0 0 1 7 9V3.5a.5.5 0 0 1 .5-.5z"/>' +
                                '</svg>' +
                                'Version History: ' + artworkTitle +
                            '</h5>' +
                            '<div class="form-check form-switch">' +
                                '<input class="form-check-input" type="checkbox" id="showArchivedVersions" onchange="toggleArchivedVersions()">' +
                                '<label class="form-check-label text-muted small" for="showArchivedVersions">' +
                                    'Show Archived' +
                                '</label>' +
                            '</div>' +
                        '</div>' +
                        '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>' +
                    '</div>' +
                    '<div class="modal-body">' +
                        '<div class="alert alert-info border-info bg-dark text-light mb-3">' +
                            '<div class="d-flex">' +
                                '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-info-circle me-2 flex-shrink-0 mt-1" viewBox="0 0 16 16">' +
                                    '<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>' +
                                    '<path d="M8.93 6.588l-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>' +
                                '</svg>' +
                                '<div>' +
                                    '<strong>Version Control System</strong><br>' +
                                    '<small>Create snapshots of your artwork to save different states. You can restore to any previous version or compare changes between versions. Perfect for experimenting with edits while keeping your original safe.</small>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                        '<div class="row mb-3">' +
                            '<div class="col-md-4">' +
                                '<button class="btn btn-primary" onclick="createNewVersion(' + artworkId + ')" ' +
                                        'title="Save the current state of your artwork as a new version" ' +
                                        'data-bs-toggle="tooltip" data-bs-placement="top">' +
                                    '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle me-1" viewBox="0 0 16 16">' +
                                        '<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>' +
                                        '<path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>' +
                                    '</svg>' +
                                    'Create Version' +
                                '</button>' +
                            '</div>' +
                            '<div class="col-md-4">' +
                                '<button class="btn btn-success" onclick="showNewVersionUploadModal(' + artworkId + ')" ' +
                                        'title="Create a new version with immediate file upload" ' +
                                        'data-bs-toggle="tooltip" data-bs-placement="top">' +
                                    '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cloud-upload me-1" viewBox="0 0 16 16">' +
                                        '<path fill-rule="evenodd" d="M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318 1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383z"/>' +
                                        '<path fill-rule="evenodd" d="M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3z"/>' +
                                    '</svg>' +
                                    'Upload New Version' +
                                '</button>' +
                            '</div>' +
                            '<div class="col-md-4">' +
                                '<button class="btn btn-warning" onclick="toggleReorderMode(' + artworkId + ')" ' +
                                        (versions.length < 2 ? 'disabled' : '') + ' ' +
                                        'title="' + (versions.length < 2 ? 'Need at least 2 versions to reorder' : 'Drag and drop to reorder version numbers') + '" ' +
                                        'data-bs-toggle="tooltip" data-bs-placement="top" id="reorderToggleBtn">' +
                                    '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-list-ol me-1" viewBox="0 0 16 16">' +
                                        '<path fill-rule="evenodd" d="M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5z"/>' +
                                        '<path d="M1.713 11.865v-.474H2c.217 0 .363-.137.363-.317 0-.185-.158-.31-.361-.31-.223 0-.367.152-.373.31h-.59c.016-.467.373-.787.986-.787.588-.002.954.291.957.703a.595.595 0 0 1-.492.594v.033a.615.615 0 0 1 .569.631c.003.533-.502.8-1.051.8-.656 0-1-.37-1.008-.794h.582c.008.178.186.306.422.309.254 0 .424-.145.422-.35-.002-.195-.155-.348-.414-.348h-.3zm-.004-4.699h-.604v-.035c0-.408.295-.844.958-.844.583 0 .96.326.96.756 0 .389-.257.617-.476.848l-.537.572v.03h1.054V9H1.143v-.395l.957-.99c.138-.142.293-.304.293-.508 0-.18-.147-.32-.342-.32a.33.33 0 0 0-.342.338v.041zM2.564 5h-.635V2.924h-.031l-.598.42v-.567l.629-.443h.635V5z"/>' +
                                    '</svg>' +
                                    'Reorder' +
                                '</button>' +
                            '</div>' +
                            '<div class="col-md-4 text-end">' +
                                '<button class="btn btn-outline-info" onclick="toggleComparisonMode(' + artworkId + ')" ' +
                                        compareButtonDisabled + ' ' +
                                        'title="' + compareButtonTitle + '" ' +
                                        'data-bs-toggle="tooltip" data-bs-placement="top" id="comparisonToggleBtn">' +
                                    '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-shuffle me-1" viewBox="0 0 16 16">' +
                                        '<path fill-rule="evenodd" d="M0 3.5A.5.5 0 0 1 .5 3H1c2.202 0 3.827 1.24 4.874 2.418.49.552.865 1.102 1.126 1.532.26-.43.636-.98 1.126-1.532C9.173 4.24 10.798 3 13 3v1c-1.798 0-3.173 1.01-4.126 2.082A9.624 9.624 0 0 0 7.556 8a9.624 9.624 0 0 0 1.317 1.918C9.828 10.99 11.204 12 13 12v1c-2.202 0-3.827-1.24-4.874-2.418A10.595 10.595 0 0 1 7 9.05c-.26.43-.636.98-1.126 1.532C4.827 11.76 3.202 13 1 13H.5a.5.5 0 0 1 0-1H1c1.798 0 3.173-1.01 4.126-2.082A9.624 9.624 0 0 0 6.444 8a9.624 9.624 0 0 0-1.317-1.918C4.172 5.01 2.796 4 1 4H.5a.5.5 0 0 1-.5-.5z"/>' +
                                        '<path d="M13 5.466V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192zm0 9v-3.932a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192z"/>' +
                                    '</svg>' +
                                    'Compare Versions' +
                                '</button>' +
                            '</div>' +
                        '</div>' +
                        '<div id="comparisonArea" class="comparison-area mb-3" style="display: none;">' +
                            '<div class="alert alert-warning border-warning bg-dark text-light">' +
                                '<div class="d-flex">' +
                                    '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-arrows-move me-2 flex-shrink-0 mt-1" viewBox="0 0 16 16">' +
                                        '<path fill-rule="evenodd" d="M7.646.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 1.707V5.5a.5.5 0 0 1-1 0V1.707L6.354 2.854a.5.5 0 1 1-.708-.708l2-2zM8 10a.5.5 0 0 1 .5.5v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 .708-.708L7.5 14.293V10.5A.5.5 0 0 1 8 10zM.146 8.354a.5.5 0 0 1 0-.708l2-2a.5.5 0 1 1 .708.708L1.707 7.5H5.5a.5.5 0 0 1 0 1H1.707l1.147 1.146a.5.5 0 0 1-.708.708l-2-2zM10 8a.5.5 0 0 1 .5-.5h3.793l-1.147-1.146a.5.5 0 0 1 .708-.708l2 2a.5.5 0 0 1 0 .708l-2 2a.5.5 0 0 1-.708-.708L14.293 8.5H10.5A.5.5 0 0 1 10 8z"/>' +
                                    '</svg>' +
                                    '<div>' +
                                        '<strong>Drag & Drop Comparison Mode</strong><br>' +
                                        '<small>Drag version cards from below into the comparison slots to see differences side-by-side.</small>' +
                                    '</div>' +
                                '</div>' +
                            '</div>' +
                            '<div class="row">' +
                                '<div class="col-md-6">' +
                                    '<div class="comparison-slot" id="comparisonSlot1" data-slot="1">' +
                                        '<div class="drop-zone border border-dashed border-2 rounded p-4 text-center text-muted h-100 d-flex flex-column justify-content-center">' +
                                            '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-cloud-arrow-down mx-auto mb-2" viewBox="0 0 16 16">' +
                                                '<path fill-rule="evenodd" d="M7.646 10.854a.5.5 0 0 0 .708 0l2-2a.5.5 0 0 0-.708-.708L8.5 9.293V5.5a.5.5 0 0 0-1 0v3.793L6.354 8.146a.5.5 0 1 0-.708.708l2 2z"/>' +
                                                '<path d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773 16 11.569 14.502 13 12.687 13H3.781C1.708 13 0 11.366 0 9.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383zm.653.757c-.757.653-1.153 1.44-1.153 2.056v.448l-.445.049C2.064 6.805 1 7.952 1 9.318 1 10.785 2.23 12 3.781 12h8.906C13.98 12 15 10.988 15 9.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 4.825 10.328 3 8 3a4.53 4.53 0 0 0-2.941 1.1z"/>' +
                                            '</svg>' +
                                            '<h6>Version Slot 1</h6>' +
                                            '<p class="mb-0">Drop a version here</p>' +
                                        '</div>' +
                                    '</div>' +
                                '</div>' +
                                '<div class="col-md-6">' +
                                    '<div class="comparison-slot" id="comparisonSlot2" data-slot="2">' +
                                        '<div class="drop-zone border border-dashed border-2 rounded p-4 text-center text-muted h-100 d-flex flex-column justify-content-center">' +
                                            '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-cloud-arrow-down mx-auto mb-2" viewBox="0 0 16 16">' +
                                                '<path fill-rule="evenodd" d="M7.646 10.854a.5.5 0 0 0 .708 0l2-2a.5.5 0 0 0-.708-.708L8.5 9.293V5.5a.5.5 0 0 0-1 0v3.793L6.354 8.146a.5.5 0 1 0-.708.708l2 2z"/>' +
                                                '<path d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773 16 11.569 14.502 13 12.687 13H3.781C1.708 13 0 11.366 0 9.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383zm.653.757c-.757.653-1.153 1.44-1.153 2.056v.448l-.445.049C2.064 6.805 1 7.952 1 9.318 1 10.785 2.23 12 3.781 12h8.906C13.98 12 15 10.988 15 9.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 4.825 10.328 3 8 3a4.53 4.53 0 0 0-2.941 1.1z"/>' +
                                            '</svg>' +
                                            '<h6>Version Slot 2</h6>' +
                                            '<p class="mb-0">Drop a version here</p>' +
                                        '</div>' +
                                    '</div>' +
                                '</div>' +
                            '</div>' +
                            '<div class="text-center mt-3">' +
                                '<button class="btn btn-success me-2" id="compareSelectedBtn" onclick="compareSelectedVersions(' + artworkId + ')" disabled>' +
                                    '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-fill me-1" viewBox="0 0 16 16">' +
                                        '<path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/>' +
                                        '<path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/>' +
                                    '</svg>' +
                                    'Compare Selected Versions' +
                                '</button>' +
                                '<button class="btn btn-outline-secondary" onclick="clearComparison()">' +
                                    '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise me-1" viewBox="0 0 16 16">' +
                                        '<path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>' +
                                        '<path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>' +
                                    '</svg>' +
                                    'Clear Selection' +
                                '</button>' +
                            '</div>' +
                        '</div>' +
                        '<div id="reorderArea" class="reorder-area mb-3" style="display: none;">' +
                            '<div class="alert alert-info border-info bg-dark text-light">' +
                                '<div class="d-flex">' +
                                    '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-arrows-move me-2 flex-shrink-0 mt-1" viewBox="0 0 16 16">' +
                                        '<path fill-rule="evenodd" d="M7.646.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 1.707V5.5a.5.5 0 0 1-1 0V1.707L6.354 2.854a.5.5 0 1 1-.708-.708l2-2zM8 10a.5.5 0 0 1 .5.5v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 .708-.708L7.5 14.293V10.5A.5.5 0 0 1 8 10zM.146 8.354a.5.5 0 0 1 0-.708l2-2a.5.5 0 1 1 .708.708L1.707 7.5H5.5a.5.5 0 0 1 0 1H1.707l1.147 1.146a.5.5 0 0 1-.708.708l-2-2zM10 8a.5.5 0 0 1 .5-.5h3.793l-1.147-1.146a.5.5 0 0 1 .708-.708l2 2a.5.5 0 0 1 0 .708l-2 2a.5.5 0 0 1-.708-.708L14.293 8.5H10.5A.5.5 0 0 1 10 8z"/>' +
                                    '</svg>' +
                                    '<div>' +
                                        '<strong>Drag & Drop Reorder Mode</strong><br>' +
                                        '<small>Drag version cards up and down to reorder their version numbers. Higher positions get higher version numbers.</small>' +
                                    '</div>' +
                                '</div>' +
                            '</div>' +
                            '<div id="reorderableVersions" class="reorderable-container">' +
                                '<div class="text-center p-4">' +
                                    '<div class="spinner-border text-primary" role="status">' +
                                        '<span class="visually-hidden">Loading versions...</span>' +
                                    '</div>' +
                                    '<p class="mt-2 text-muted">Loading versions for reordering...</p>' +
                                '</div>' +
                            '</div>' +
                            '<div class="text-center mt-3">' +
                                '<button class="btn btn-success me-2" id="saveReorderBtn" onclick="saveVersionOrder(currentReorderArtworkId)" disabled>' +
                                    '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle-fill me-1" viewBox="0 0 16 16">' +
                                        '<path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.061L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>' +
                                    '</svg>' +
                                    'Save New Order' +
                                '</button>' +
                                '<button class="btn btn-outline-secondary" onclick="cancelReorderMode(currentReorderArtworkId)">' +
                                    '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle me-1" viewBox="0 0 16 16">' +
                                        '<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>' +
                                        '<path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>' +
                                    '</svg>' +
                                    'Cancel' +
                                '</button>' +
                            '</div>' +
                        '</div>' +
                        '<div class="row">' +
                            '<div class="col-md-4 mb-3">' +
                                '<div class="card bg-primary text-white h-100 version-card" draggable="true" ' +
                                     'data-version-id="current" ' +
                                     'data-version-number="current" ' +
                                     'data-version-title="Current Version" ' +
                                     'data-version-description="This is the current published state of your artwork" ' +
                                     'data-artwork-id="' + artworkId + '">' +
                                    '<div class="card-header d-flex justify-content-between align-items-center">' +
                                        '<h6 class="mb-0">Current Version</h6>' +
                                        '<span class="badge bg-light text-primary">Active</span>' +
                                    '</div>' +
                                    '<div class="card-body p-2">' +
                                        '<div class="mb-2">' +
                                            '<img src="' + currentArtworkImage + '" ' +
                                                 'class="img-fluid rounded" style="width: 100%; height: 150px; object-fit: cover; cursor: pointer;" ' +
                                                 'alt="Current Version" ' +
                                                 'onclick="showFullImage(\'' + currentArtworkImage + '\', \'Current Version\')">' +
                                        '</div>' +
                                        '<p class="text-xs text-muted mb-2">This is the current published state of your artwork</p>' +
                                    '</div>' +
                                '</div>' +
                            '</div>' +
                            versionCardsHtml +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>' +
        '</div>';
    
    // Remove existing modal if present
    const existingModal = document.getElementById('versionManagerModal');
    if (existingModal) existingModal.remove();
    
    // Add new modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('versionManagerModal'));
    modal.show();
    
    // Initialize drag and drop functionality
    initializeDragAndDrop();
    
    // Initialize tooltips after modal is shown
    modal._element.addEventListener('shown.bs.modal', function () {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('#versionManagerModal [data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
}

function createNewVersion(artworkId) {
    const notes = prompt('Add version notes (optional):\n\nThis will create a snapshot of your artwork\'s current state that you can restore later.');
    
    // Check if user cancelled the prompt
    if (notes === null) {
        return; // User cancelled, don't create version
    }
    
    fetch('/api/artworks/' + artworkId + '/versions/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            version_notes: notes || '',
            force_create: true
        })
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            throw new Error('HTTP ' + response.status);
        }
    })
    .then(data => {
        if (data.version) {
            showToast(`Version ${data.version.version_number} created successfully`, 'success');
            
            // Update the artwork thumbnail immediately in the studio workspace
            const artworkCard = document.querySelector(`[data-artwork-id="${artworkId}"]`);
            if (artworkCard) {
                const thumbnailImg = artworkCard.querySelector('.artwork-thumbnail');
                if (thumbnailImg && data.version.image_display_url) {
                    thumbnailImg.src = data.version.image_display_url + '?t=' + Date.now();
                    thumbnailImg.onload = function() {
                        thumbnailImg.style.opacity = '1';
                    };
                }
            }
            
            // Refresh the version manager
            const modal = bootstrap.Modal.getInstance(document.getElementById('versionManagerModal'));
            modal.hide();
            setTimeout(() => openVersionManager(artworkId), 500);
        } else {
            showToast('Failed to create version', 'error');
        }
    })
    .catch(error => {
        console.error('Error creating version:', error);
        showToast('Failed to create version', 'error');
    });
}

function restoreVersion(artworkId, versionId) {
    if (!confirm('Are you sure you want to set this version as current? This will update the main artwork image and details.')) {
        return;
    }
    
    // Show loading animation
    showArtisticLoader('brush');
    
    fetch('/api/artworks/' + artworkId + '/versions/' + versionId + '/restore/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        hideArtisticLoader();
        
        if (data.success && data.message) {
            showToast(data.message, 'success');
            
            // If we're on the artwork detail page, update the main image immediately
            const mainArtworkImage = document.querySelector('#main-artwork-image');
            if (mainArtworkImage && data.artwork && data.artwork.image_url) {
                mainArtworkImage.src = data.artwork.image_url;
            }
            
            // Refresh the page after a short delay to show all updates
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showToast(data.error || 'Failed to restore version', 'error');
        }
    })
    .catch(error => {
        hideArtisticLoader();
        console.error('Error restoring version:', error);
        showToast('Failed to restore version', 'error');
    });
}

function openVersionComparison(artworkId) {
    fetch('/api/artworks/' + artworkId + '/versions/', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.versions) {
            showVersionComparisonModal(artworkId, data.versions, data.artwork_title);
        } else {
            showToast('Failed to load versions for comparison', 'error');
        }
    })
    .catch(error => {
        console.error('Error loading versions:', error);
        showToast('Failed to load versions for comparison', 'error');
    });
}

function showVersionComparisonModal(artworkId, versions, artworkTitle) {
    const versionOptions = versions.map(function(v) {
        return '<option value="' + v.id + '">Version ' + v.version_number + ' - ' + v.title + '</option>';
    }).join('');
    
    const modalHtml = 
        '<div class="modal fade" id="versionComparisonModal" tabindex="-1" aria-labelledby="versionComparisonModalLabel" aria-hidden="true">' +
            '<div class="modal-dialog modal-xl">' +
                '<div class="modal-content bg-dark text-light">' +
                    '<div class="modal-header border-secondary">' +
                        '<h5 class="modal-title" id="versionComparisonModalLabel">' +
                            '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-shuffle me-2" viewBox="0 0 16 16">' +
                                '<path fill-rule="evenodd" d="M0 3.5A.5.5 0 0 1 .5 3H1c2.202 0 3.827 1.24 4.874 2.418.49.552.865 1.102 1.126 1.532.26-.43.636-.98 1.126-1.532C9.173 4.24 10.798 3 13 3v1c-1.798 0-3.173 1.01-4.126 2.082A9.624 9.624 0 0 0 7.556 8a9.624 9.624 0 0 0 1.317 1.918C9.828 10.99 11.204 12 13 12v1c-2.202 0-3.827-1.24-4.874-2.418A10.595 10.595 0 0 1 7 9.05c-.26.43-.636.98-1.126 1.532C4.827 11.76 3.202 13 1 13H.5a.5.5 0 0 1 0-1H1c1.798 0 3.173-1.01 4.126-2.082A9.624 9.624 0 0 0 6.444 8a9.624 9.624 0 0 0-1.317-1.918C4.172 5.01 2.796 4 1 4H.5a.5.5 0 0 1-.5-.5z"/>' +
                                '<path d="M13 5.466V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192zm0 9v-3.932a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192z"/>' +
                            '</svg>' +
                            'Compare Versions: ' + artworkTitle +
                        '</h5>' +
                        '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>' +
                    '</div>' +
                    '<div class="modal-body">' +
                        '<div class="row mb-3">' +
                            '<div class="col-md-6">' +
                                '<label class="form-label">Select First Version:</label>' +
                                '<select class="form-select bg-dark text-light border-secondary" id="version1Select">' +
                                    '<option value="current">Current Version</option>' +
                                    versionOptions +
                                '</select>' +
                            '</div>' +
                            '<div class="col-md-6">' +
                                '<label class="form-label">Select Second Version:</label>' +
                                '<select class="form-select bg-dark text-light border-secondary" id="version2Select">' +
                                    '<option value="">Select version to compare</option>' +
                                    '<option value="current">Current Version</option>' +
                                    versionOptions +
                                '</select>' +
                            '</div>' +
                        '</div>' +
                        '<div class="row mb-3">' +
                            '<div class="col-12 text-center">' +
                                '<button class="btn btn-primary" onclick="performVersionComparison(' + artworkId + ')">' +
                                    'Compare Selected Versions' +
                                '</button>' +
                            '</div>' +
                        '</div>' +
                        '<div id="comparisonResults" class="mt-4" style="display: none;"></div>' +
                    '</div>' +
                '</div>' +
            '</div>' +
        '</div>';
    
    // Remove existing modal if present
    const existingModal = document.getElementById('versionComparisonModal');
    if (existingModal) existingModal.remove();
    
    // Add new modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('versionComparisonModal'));
    modal.show();
}

function performVersionComparison(artworkId) {
    const version1 = document.getElementById('version1Select').value;
    const version2 = document.getElementById('version2Select').value;
    
    if (!version1 || !version2) {
        showToast('Please select both versions to compare', 'warning');
        return;
    }
    
    if (version1 === version2) {
        showToast('Please select different versions to compare', 'warning');
        return;
    }
    
    // Show artistic loading animation for comparison
    showLoadingOverlay('palette', 'Comparing versions...', 'Analyzing differences between your artwork versions');
    
    fetch('/api/artworks/' + artworkId + '/versions/compare/?version1=' + version1 + '&version2=' + version2, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        // Hide loading overlay
        hideLoadingOverlay();
        
        if (data.version1 && data.version2) {
            displayComparisonResults(data);
        } else {
            showToast('Failed to compare versions', 'error');
        }
    })
    .catch(error => {
        // Hide loading overlay
        hideLoadingOverlay();
        
        console.error('Error comparing versions:', error);
        showToast('Failed to compare versions', 'error');
    });
}

function displayComparisonResults(comparisonData) {
    const resultsContainer = document.getElementById('comparisonResults');
    
    // Build version 1 content
    const version1Image = comparisonData.version1.image_display_url ? 
        '<img src="' + comparisonData.version1.image_display_url + '" class="img-fluid mb-2" alt="Version 1">' : 
        '<div class="bg-dark p-3 mb-2 text-center">No Image</div>';
    
    const version1Medium = comparisonData.version1.medium ? 
        '<p><strong>Medium:</strong> ' + comparisonData.version1.medium + '</p>' : '';
    
    const version1Dimensions = comparisonData.version1.dimensions ? 
        '<p><strong>Dimensions:</strong> ' + comparisonData.version1.dimensions + '</p>' : '';
    
    const version1Tags = comparisonData.version1.tags ? 
        '<p><strong>Tags:</strong> ' + comparisonData.version1.tags + '</p>' : '';
    
    // Build version 2 content
    const version2Image = comparisonData.version2.image_display_url ? 
        '<img src="' + comparisonData.version2.image_display_url + '" class="img-fluid mb-2" alt="Version 2">' : 
        '<div class="bg-dark p-3 mb-2 text-center">No Image</div>';
    
    const version2Medium = comparisonData.version2.medium ? 
        '<p><strong>Medium:</strong> ' + comparisonData.version2.medium + '</p>' : '';
    
    const version2Dimensions = comparisonData.version2.dimensions ? 
        '<p><strong>Dimensions:</strong> ' + comparisonData.version2.dimensions + '</p>' : '';
    
    const version2Tags = comparisonData.version2.tags ? 
        '<p><strong>Tags:</strong> ' + comparisonData.version2.tags + '</p>' : '';
    
    // Build differences section
    let differencesHtml = '';
    if (comparisonData.differences.length > 0) {
        const differencesList = comparisonData.differences.map(function(diff) {
            const fieldName = diff.field.charAt(0).toUpperCase() + diff.field.slice(1);
            
            let version1Content, version2Content;
            if (diff.field === 'image') {
                version1Content = diff.version1_value ? 
                    '<img src="' + diff.version1_value + '" class="img-thumbnail" style="max-width: 100px;">' : 
                    'No image';
                version2Content = diff.version2_value ? 
                    '<img src="' + diff.version2_value + '" class="img-thumbnail" style="max-width: 100px;">' : 
                    'No image';
            } else {
                version1Content = diff.version1_value || 'Empty';
                version2Content = diff.version2_value || 'Empty';
            }
            
            return '<li class="list-group-item bg-dark text-light border-secondary">' +
                '<strong>' + fieldName + ':</strong>' +
                '<div class="row mt-2">' +
                    '<div class="col-md-6">' +
                        '<span class="badge bg-info me-2">Version 1</span>' +
                        version1Content +
                    '</div>' +
                    '<div class="col-md-6">' +
                        '<span class="badge bg-warning me-2">Version 2</span>' +
                        version2Content +
                    '</div>' +
                '</div>' +
            '</li>';
        }).join('');
        
        differencesHtml = '<div class="mt-4">' +
            '<h6 class="text-danger">Differences Found:</h6>' +
            '<ul class="list-group list-group-flush">' +
                differencesList +
            '</ul>' +
        '</div>';
    } else {
        differencesHtml = '<div class="alert alert-success mt-4">No differences found between these versions.</div>';
    }
    
    const resultsHtml = 
        '<div class="card bg-secondary text-light">' +
            '<div class="card-header">' +
                '<h6 class="mb-0">Comparison Results</h6>' +
            '</div>' +
            '<div class="card-body">' +
                '<div class="row">' +
                    '<div class="col-md-6">' +
                        '<h6 class="text-info">Version ' + (comparisonData.version1.version_number || 'Current') + '</h6>' +
                        version1Image +
                        '<p><strong>Title:</strong> ' + comparisonData.version1.title + '</p>' +
                        '<p><strong>Description:</strong> ' + comparisonData.version1.description + '</p>' +
                        version1Medium +
                        version1Dimensions +
                        version1Tags +
                    '</div>' +
                    '<div class="col-md-6">' +
                        '<h6 class="text-warning">Version ' + (comparisonData.version2.version_number || 'Current') + '</h6>' +
                        version2Image +
                        '<p><strong>Title:</strong> ' + comparisonData.version2.title + '</p>' +
                        '<p><strong>Description:</strong> ' + comparisonData.version2.description + '</p>' +
                        version2Medium +
                        version2Dimensions +
                        version2Tags +
                    '</div>' +
                '</div>' +
                differencesHtml +
            '</div>' +
        '</div>';
    
    resultsContainer.innerHTML = resultsHtml;
    resultsContainer.style.display = 'block';
}

function previewVersion(versionId, artworkId) {
    if (versionId === 'current') {
        // Fetch current artwork data and show preview modal
        fetch('/api/artworks/' + artworkId + '/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                showCurrentVersionPreviewModal(data);
            } else {
                showToast('Artwork not found', 'error');
            }
        })
        .catch(error => {
            console.error('Error loading current artwork:', error);
            showToast('Failed to load artwork preview', 'error');
        });
    } else {
        // Fetch version data and show preview modal
        fetch('/api/artworks/' + artworkId + '/versions/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            const version = data.versions.find(v => v.id == versionId);
            if (version) {
                showVersionPreviewModal(version, artworkId);
            } else {
                showToast('Version not found', 'error');
            }
        })
        .catch(error => {
            console.error('Error loading version:', error);
            showToast('Failed to load version preview', 'error');
        });
    }
}

function showCurrentVersionPreviewModal(artwork) {
    const imageHtml = artwork.image_display_url ? 
        '<img src="' + artwork.image_display_url + '" class="img-fluid rounded" alt="' + artwork.title + '">' : 
        '<div class="text-center p-4"><i class="bi bi-image" style="font-size: 3rem;"></i><p class="mt-2">No image available</p></div>';
    
    const modalHtml = 
        '<div class="modal fade" id="currentVersionPreviewModal" tabindex="-1">' +
            '<div class="modal-dialog modal-lg">' +
                '<div class="modal-content bg-dark text-light">' +
                    '<div class="modal-header border-secondary">' +
                        '<h5 class="modal-title">Current Version Preview</h5>' +
                        '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>' +
                    '</div>' +
                    '<div class="modal-body">' +
                        '<div class="row">' +
                            '<div class="col-md-8">' +
                                imageHtml +
                            '</div>' +
                            '<div class="col-md-4">' +
                                '<h6>' + artwork.title + '</h6>' +
                                '<p class="text-muted">' + (artwork.description || 'No description available') + '</p>' +
                                '<hr class="border-secondary">' +
                                '<p><strong>Created:</strong> ' + new Date(artwork.created_at).toLocaleDateString() + '</p>' +
                                '<p><strong>Last Updated:</strong> ' + new Date(artwork.updated_at).toLocaleDateString() + '</p>' +
                                '<p><strong>Status:</strong> <span class="badge bg-success">Current Version</span></p>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="modal-footer border-secondary">' +
                        '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>' +
                        '<a href="/artworks/' + artwork.id + '/" class="btn btn-primary">View Full Page</a>' +
                    '</div>' +
                '</div>' +
            '</div>' +
        '</div>';
    
    // Remove existing modal if present
    const existingModal = document.getElementById('currentVersionPreviewModal');
    if (existingModal) existingModal.remove();
    
    // Add new modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('currentVersionPreviewModal'));
    modal.show();
}

function showVersionPreviewModal(version, artworkId) {
    const imageHtml = version.image_display_url ? 
        '<img src="' + version.image_display_url + '" class="img-fluid rounded" alt="' + version.title + '">' : 
        '<div class="bg-secondary d-flex align-items-center justify-content-center rounded" style="height: 300px;"><span class="text-muted">No Image</span></div>';
    
    const modalHtml = 
        '<div class="modal fade" id="versionPreviewModal" tabindex="-1" aria-labelledby="versionPreviewModalLabel" aria-hidden="true">' +
            '<div class="modal-dialog modal-lg">' +
                '<div class="modal-content bg-dark text-light">' +
                    '<div class="modal-header border-secondary">' +
                        '<h5 class="modal-title" id="versionPreviewModalLabel">' +
                            '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-eye me-2" viewBox="0 0 16 16">' +
                                '<path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>' +
                                '<path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>' +
                            '</svg>' +
                            'Preview Version ' + version.version_number +
                        '</h5>' +
                        '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>' +
                    '</div>' +
                    '<div class="modal-body">' +
                        '<div class="row">' +
                            '<div class="col-md-6">' +
                                imageHtml +
                            '</div>' +
                            '<div class="col-md-6">' +
                                '<h4 class="text-primary">' + version.title + '</h4>' +
                                '<p class="text-muted mb-3">Version ' + version.version_number + ' • ' + new Date(version.created_at).toLocaleDateString() + '</p>' +
                                
                                '<div class="mb-3">' +
                                    '<h6 class="text-info">Description</h6>' +
                                    '<p>' + version.description + '</p>' +
                                '</div>' +
                                
                                (version.version_notes ? 
                                    '<div class="mb-3">' +
                                        '<h6 class="text-warning">Version Notes</h6>' +
                                        '<p class="text-light">' + version.version_notes + '</p>' +
                                    '</div>' : '') +
                                
                                (version.medium ? 
                                    '<div class="mb-2">' +
                                        '<strong>Medium:</strong> ' + version.medium +
                                    '</div>' : '') +
                                
                                (version.dimensions ? 
                                    '<div class="mb-2">' +
                                        '<strong>Dimensions:</strong> ' + version.dimensions +
                                    '</div>' : '') +
                                
                                (version.tags ? 
                                    '<div class="mb-3">' +
                                        '<strong>Tags:</strong>' + 
                                        '<div class="mt-1">' +
                                            version.tags.split(',').map(function(tag) {
                                                return '<span class="badge bg-secondary me-1">' + tag.trim() + '</span>';
                                            }).join('') +
                                        '</div>' +
                                    '</div>' : '') +
                                
                                '<div class="d-flex gap-2 mt-4">' +
                                    '<button class="btn btn-warning" onclick="restoreVersion(' + artworkId + ', ' + version.id + '); bootstrap.Modal.getInstance(document.getElementById(\'versionPreviewModal\')).hide();">' +
                                        '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise me-1" viewBox="0 0 16 16">' +
                                            '<path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>' +
                                            '<path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>' +
                                        '</svg>' +
                                        'Set as Current' +
                                    '</button>' +
                                    '<button class="btn btn-outline-info" onclick="openVersionComparison(' + artworkId + '); bootstrap.Modal.getInstance(document.getElementById(\'versionPreviewModal\')).hide();">' +
                                        'Compare Versions' +
                                    '</button>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>' +
        '</div>';
    
    // Remove existing modal if present
    const existingModal = document.getElementById('versionPreviewModal');
    if (existingModal) existingModal.remove();
    
    // Add new modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('versionPreviewModal'));
    modal.show();
}

function updateCritiqueBadge(artworkItem, seeking) {
    const statusContainer = artworkItem.querySelector('.position-absolute.top-0.end-0');
    const critiqueBadge = statusContainer.querySelector('.badge.bg-success');
    
    if (seeking) {
        if (!critiqueBadge) {
            const badge = document.createElement('span');
            badge.className = 'badge bg-success';
            badge.textContent = 'SEEKING CRITIQUE';
            statusContainer.querySelector('.d-flex').appendChild(badge);
        }
    } else {
        if (critiqueBadge) {
            critiqueBadge.remove();
        }
    }
    
    // Update the button icon in quick actions
    const quickActionsButton = artworkItem.querySelector('[onclick^="toggleCritiqueRequest"]');
    if (quickActionsButton) {
        const icon = quickActionsButton.querySelector('svg');
        if (seeking) {
            icon.classList.add('text-success');
        } else {
            icon.classList.remove('text-success');
        }
    }
}

function changeVisibility(artworkId, newVisibility) {
    const artworkItem = document.querySelector('[data-artwork-id="' + artworkId + '"]');
    
    fetch('/api/artworks/' + artworkId + '/', {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            visibility: newVisibility
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            artworkItem.dataset.visibility = newVisibility;
            updateVisibilityBadge(artworkItem, newVisibility);
            calculateStatistics();
            showToast(`Visibility changed to ' + newVisibility + '`, 'success');
        } else {
            showToast('Failed to update visibility', 'error');
        }
    })
    .catch(error => {
        console.error('Error updating visibility:', error);
        showToast('Failed to update visibility', 'error');
    });
}

function updateVisibilityBadge(artworkItem, visibility) {
    const statusContainer = artworkItem.querySelector('.position-absolute.top-0.end-0');
    let visibilityBadge = statusContainer.querySelector('.badge.bg-info');
    
    // Remove existing visibility badge
    if (visibilityBadge) {
        visibilityBadge.remove();
    }
    
    // Add new visibility badge if not public
    if (visibility !== 'public') {
        const badge = document.createElement('span');
        badge.className = 'badge bg-info';
        badge.textContent = visibility.toUpperCase();
        statusContainer.querySelector('.d-flex').appendChild(badge);
    }
}

// Inline Editing
function enableInlineEdit(element, fieldType) {
    const artworkCard = element.closest('.artwork-item');
    const artworkId = artworkCard.dataset.artworkId;
    const currentValue = element.textContent.trim().replace(/\s*✏️/, ''); // Remove edit icon
    
    // Create input element
    let inputElement;
    if (fieldType === 'description') {
        inputElement = document.createElement('textarea');
        inputElement.className = 'form-control form-control-sm';
        inputElement.rows = 3;
    } else {
        inputElement = document.createElement('input');
        inputElement.type = 'text';
        inputElement.className = 'form-control form-control-sm';
    }
    
    inputElement.value = currentValue.includes('Click to add') ? '' : currentValue;
    
    // Replace element with input
    element.style.display = 'none';
    element.parentNode.insertBefore(inputElement, element.nextSibling);
    inputElement.focus();
    inputElement.select();
    
    // Save on blur or Enter
    const saveEdit = () => {
        const newValue = inputElement.value.trim();
        
        if (newValue !== currentValue) {
            // Make API call to save changes
            const updateData = {};
            updateData[fieldType] = newValue;
            
            fetch('/api/artworks/' + artworkId + '/', {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(updateData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.id) {
                    element.textContent = newValue || `Click to add ' + fieldType + '`;
                    showToast(`' + fieldType.charAt(0).toUpperCase() + fieldType.slice(1) + ' updated`, 'success');
                } else {
                    showToast(`Failed to update ' + fieldType + '`, 'error');
                    element.textContent = currentValue;
                }
            })
            .catch(error => {
                console.error(`Error updating ' + fieldType + ':`, error);
                showToast(`Failed to update ' + fieldType + '`, 'error');
                element.textContent = currentValue;
            });
        }
        
        inputElement.remove();
        element.style.display = '';
    };
    
    const cancelEdit = () => {
        inputElement.remove();
        element.style.display = '';
    };
    
    inputElement.addEventListener('blur', saveEdit);
    inputElement.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            saveEdit();
        }
        if (e.key === 'Escape') {
            e.preventDefault();
            cancelEdit();
        }
    });
}

// CSRF Token helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Bulk action functions with API calls
function bulkPublish() {
    if (selectedArtworks.size === 0) return;
    
    fetch('/api/artworks/bulk_actions/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            artwork_ids: Array.from(selectedArtworks),
            action: 'publish'
        })
    })
    .then(response => response.json())
    .then(data => {
        showToast(`Published ${selectedArtworks.size} artworks`, 'success');
        // Update UI for selected artworks
        selectedArtworks.forEach(id => {
            const item = document.querySelector(`[data-artwork-id="${id}"]`);
            if (item) {
                item.dataset.status = 'published';
                updateStatusBadges(item, 'published');
            }
        });
        calculateStatistics();
        cancelBulkActions();
    })
    .catch(error => {
        console.error('Bulk publish error:', error);
        showToast('Failed to publish artworks', 'error');
    });
}

function bulkDraft() {
    if (selectedArtworks.size === 0) return;
    
    fetch('/api/artworks/bulk_actions/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            artwork_ids: Array.from(selectedArtworks),
            action: 'draft'
        })
    })
    .then(response => response.json())
    .then(data => {
        showToast(`Marked ${selectedArtworks.size} artworks as draft`, 'success');
        // Update UI for selected artworks
        selectedArtworks.forEach(id => {
            const item = document.querySelector(`[data-artwork-id="${id}"]`);
            if (item) {
                item.dataset.status = 'draft';
                updateStatusBadges(item, 'draft');
            }
        });
        calculateStatistics();
        cancelBulkActions();
    })
    .catch(error => {
        console.error('Bulk draft error:', error);
        showToast('Failed to mark artworks as draft', 'error');
    });
}

function bulkToggleCritique() {
    if (selectedArtworks.size === 0) return;
    
    fetch('/api/artworks/bulk_actions/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            artwork_ids: Array.from(selectedArtworks),
            action: 'toggle_critique'
        })
    })
    .then(response => response.json())
    .then(data => {
        showToast(`Toggled critique requests for ${selectedArtworks.size} artworks`, 'success');
        // Update UI for selected artworks
        selectedArtworks.forEach(id => {
            const item = document.querySelector(`[data-artwork-id="${id}"]`);
            if (item) {
                const currentSeeking = item.dataset.seekingCritique === 'true';
                item.dataset.seekingCritique = (!currentSeeking).toString();
                updateCritiqueBadge(item, !currentSeeking);
            }
        });
        calculateStatistics();
        cancelBulkActions();
    })
    .catch(error => {
        console.error('Bulk critique toggle error:', error);
        showToast('Failed to toggle critique requests', 'error');
    });
}

function bulkDelete() {
    if (selectedArtworks.size === 0) return;
    
    if (confirm(`Are you sure you want to delete ${selectedArtworks.size} selected artworks? This action cannot be undone.`)) {
        fetch('/api/artworks/bulk_actions/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                artwork_ids: Array.from(selectedArtworks),
                action: 'delete'
            })
        })
        .then(response => response.json())
        .then(data => {
            showToast(`Deleted ${selectedArtworks.size} artworks`, 'success');
            // Remove deleted artworks from UI
            selectedArtworks.forEach(id => {
                const item = document.querySelector(`[data-artwork-id="${id}"]`);
                if (item) {
                    item.remove();
                }
            });
            calculateStatistics();
            cancelBulkActions();
        })
        .catch(error => {
            console.error('Bulk delete error:', error);
            showToast('Failed to delete artworks', 'error');
        });
    }
}

// Toast notification system
function showToast(message, type = 'info') {
    // Remove existing toasts
    const existingToasts = document.querySelectorAll('.toast-notification');
    existingToasts.forEach(toast => toast.remove());
    
    // Create toast element
    const toast = document.createElement('div');
    const alertClass = type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info';
    toast.className = 'toast-notification alert alert-' + alertClass + ' position-fixed';
    toast.style.cssText = 
        'top: 20px;' +
        'right: 20px;' +
        'z-index: 9999;' +
        'min-width: 300px;' +
        'box-shadow: 0 4px 12px rgba(0,0,0,0.15);' +
        'border: none;' +
        'opacity: 0;' +
        'transform: translateX(100%);' +
        'transition: all 0.3s ease;';
    
    let iconSvg;
    if (type === 'success') {
        iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/></svg>';
    } else if (type === 'error') {
        iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-exclamation-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/></svg>';
    } else {
        iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M8.93 6.588l-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg>';
    }
    
    toast.innerHTML = 
        '<div class="d-flex align-items-center">' +
            '<div class="me-2">' +
                iconSvg +
            '</div>' +
            '<div class="flex-grow-1">' + message + '</div>' +
            '<button type="button" class="btn-close ms-2" onclick="this.parentElement.parentElement.remove()"></button>' +
        '</div>';
    
    document.body.appendChild(toast);
    
    // Animate in
    setTimeout(() => {
        toast.style.opacity = '1';
        toast.style.transform = 'translateX(0)';
    }, 10);
    
    // Auto remove after 4 seconds
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}

// Version Delete/Archive Functions
function deleteVersion(versionId, versionNumber, artworkId) {
    // Find the version data to check for critiques
    // Look for versions in the global data or extract from the DOM
    let hasCritiques = false;
    let critiqueCount = 0;
    
    // Try to find critique count from version data if available
    if (window.currentVersions && window.currentVersions.length > 0) {
        const version = window.currentVersions.find(v => v.id == versionId);
        if (version) {
            critiqueCount = version.critique_count || 0;
            hasCritiques = critiqueCount > 0;
        }
    } else {
        // Fallback: check DOM for critique information
        const versionCard = document.querySelector(`[data-version-id="${versionId}"]`);
        if (versionCard) {
            const critiqueText = versionCard.textContent.match(/(\d+)\s+critique/);
            if (critiqueText) {
                critiqueCount = parseInt(critiqueText[1]);
                hasCritiques = critiqueCount > 0;
            }
        }
    }
    
    showDeleteVersionModal(versionId, versionNumber, artworkId, hasCritiques, critiqueCount);
}

function showDeleteVersionModal(versionId, versionNumber, artworkId, hasCritiques = false, critiqueCount = 0) {
    // Different warning content based on whether critiques exist
    const warningClass = hasCritiques ? 'alert-warning border-warning' : 'alert-danger border-danger';
    const warningIcon = hasCritiques ? 'bi-exclamation-triangle text-warning' : 'bi-exclamation-triangle text-danger';
    const warningTitle = hasCritiques ? 'Warning: Version Has Critiques' : 'Permanent Deletion Warning';
    const warningText = hasCritiques ? 
        'This version has ' + critiqueCount + ' critique' + (critiqueCount === 1 ? '' : 's') + ' that will also be permanently deleted. This action cannot be undone.' :
        'This action cannot be undone. Version ' + versionNumber + ' will be permanently deleted from your artwork history.';
    
    const bodyText = hasCritiques ?
        '<p>Are you sure you want to permanently delete <strong>Version ' + versionNumber + '</strong>?</p>' +
        '<p class="text-warning"><strong>Important:</strong> This version has ' + critiqueCount + ' critique' + (critiqueCount === 1 ? '' : 's') + '. Deleting it will also permanently remove all associated critiques and their replies.</p>' +
        '<p class="text-muted">This action cannot be undone. Consider if the critique feedback might be valuable to keep.</p>' :
        '<p>Are you sure you want to permanently delete <strong>Version ' + versionNumber + '</strong>?</p>' +
        '<p class="text-muted">This version has no critiques and can be safely deleted. Once deleted, you will not be able to recover this version.</p>';

    const modalHtml = 
        '<div class="modal fade" id="deleteVersionModal" tabindex="-1" aria-labelledby="deleteVersionModalLabel" aria-hidden="true">' +
            '<div class="modal-dialog">' +
                '<div class="modal-content bg-dark text-white">' +
                    '<div class="modal-header border-danger">' +
                        '<h5 class="modal-title" id="deleteVersionModalLabel">' +
                            '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash text-danger me-2" viewBox="0 0 16 16">' +
                                '<path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>' +
                                '<path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>' +
                            '</svg>' +
                            'Delete Version ' + versionNumber +
                        '</h5>' +
                        '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>' +
                    '</div>' +
                    '<div class="modal-body">' +
                        '<div class="alert ' + warningClass + ' bg-dark text-light">' +
                            '<div class="d-flex">' +
                                '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi ' + warningIcon + ' me-2 flex-shrink-0 mt-1" viewBox="0 0 16 16">' +
                                    '<path d="M7.938 2.016A.13.13 0 0 1 8.002 2a.13.13 0 0 1 .063.016.146.146 0 0 1 .054.057l6.857 11.667c.036.06.035.124.002.183a.163.163 0 0 1-.054.06.116.116 0 0 1-.066.017H1.146a.115.115 0 0 1-.066-.017.163.163 0 0 1-.054-.06.176.176 0 0 1 .002-.183L7.884 2.073a.147.147 0 0 1 .054-.057zm1.044-.45a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566z"/>' +
                                    '<path d="M7.002 12a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 5.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995z"/>' +
                                '</svg>' +
                                '<div>' +
                                    '<strong>' + warningTitle + '</strong><br>' +
                                    '<small>' + warningText + '</small>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                        bodyText +
                    '</div>' +
                    '<div class="modal-footer border-secondary">' +
                        '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>' +
                        '<button type="button" class="btn btn-danger" onclick="confirmDeleteVersion(' + versionId + ', ' + versionNumber + ', ' + artworkId + ')">' +
                            '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash me-1" viewBox="0 0 16 16">' +
                                '<path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>' +
                                '<path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>' +
                            '</svg>' +
                            'Delete Version' +
                        '</button>' +
                    '</div>' +
                '</div>' +
            '</div>' +
        '</div>';

    // Remove existing modal if present
    const existingModal = document.getElementById('deleteVersionModal');
    if (existingModal) existingModal.remove();
    
    // Add new modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('deleteVersionModal'));
    modal.show();
}

function confirmDeleteVersion(versionId, versionNumber, artworkId) {
    // Get the delete button and show loading state
    const deleteBtn = document.querySelector('#deleteVersionModal .btn-danger');
    const originalText = deleteBtn.innerHTML;
    deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span>Deleting...';
    deleteBtn.disabled = true;

    fetch(`/api/artworks/versions/${versionId}/delete/`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            
            // Hide the delete modal
            const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteVersionModal'));
            deleteModal.hide();
            
            // Close version manager modal and refresh
            const versionModal = bootstrap.Modal.getInstance(document.getElementById('versionManagerModal'));
            if (versionModal) versionModal.hide();
            
            // Reload version manager to show updated list
            setTimeout(() => openVersionManager(artworkId), 500);
        } else {
            showToast(data.error || `Failed to delete Version ${versionNumber}`, 'error');
            // Reset button state
            deleteBtn.innerHTML = originalText;
            deleteBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error deleting version:', error);
        showToast(`Failed to delete Version ${versionNumber}`, 'error');
        // Reset button state
        deleteBtn.innerHTML = originalText;
        deleteBtn.disabled = false;
    });
}

// Archive functionality removed - users can now delete versions with critiques directly

// Drag and Drop Version Comparison Functions
let comparisonState = {
    isActive: false,
    slot1: null,
    slot2: null
};

function toggleComparisonMode(artworkId) {
    const comparisonArea = document.getElementById('comparisonArea');
    const toggleBtn = document.getElementById('comparisonToggleBtn');
    
    if (comparisonState.isActive) {
        // Exit comparison mode
        comparisonArea.style.display = 'none';
        comparisonState.isActive = false;
        toggleBtn.innerHTML = toggleBtn.innerHTML.replace('Exit Comparison', 'Compare Versions');
        toggleBtn.classList.remove('btn-warning');
        toggleBtn.classList.add('btn-outline-info');
        clearComparison();
    } else {
        // Enter comparison mode
        comparisonArea.style.display = 'block';
        comparisonState.isActive = true;
        toggleBtn.innerHTML = toggleBtn.innerHTML.replace('Compare Versions', 'Exit Comparison');
        toggleBtn.classList.remove('btn-outline-info');
        toggleBtn.classList.add('btn-warning');
    }
}

function initializeDragAndDrop() {
    // Add drag event listeners to version cards
    const versionCards = document.querySelectorAll('.version-card');
    versionCards.forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
    });
    
    // Add drop event listeners to comparison slots
    const comparisonSlots = document.querySelectorAll('.comparison-slot');
    comparisonSlots.forEach(slot => {
        slot.addEventListener('dragover', handleDragOver);
        slot.addEventListener('drop', handleDrop);
        slot.addEventListener('dragenter', handleDragEnter);
        slot.addEventListener('dragleave', handleDragLeave);
    });
}

function handleDragStart(e) {
    if (!comparisonState.isActive) {
        e.preventDefault();
        return;
    }
    
    const card = e.target.closest('.version-card');
    card.classList.add('dragging');
    e.dataTransfer.setData('text/plain', JSON.stringify({
        versionId: card.dataset.versionId,
        versionNumber: card.dataset.versionNumber,
        versionTitle: card.dataset.versionTitle,
        versionDescription: card.dataset.versionDescription,
        artworkId: card.dataset.artworkId
    }));
    e.dataTransfer.effectAllowed = 'copy';
}

function handleDragEnd(e) {
    const card = e.target.closest('.version-card');
    card.classList.remove('dragging');
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'copy';
}

function handleDragEnter(e) {
    e.preventDefault();
    const slot = e.target.closest('.comparison-slot');
    if (slot) {
        slot.classList.add('drag-over');
    }
}

function handleDragLeave(e) {
    const slot = e.target.closest('.comparison-slot');
    if (slot && !slot.contains(e.relatedTarget)) {
        slot.classList.remove('drag-over');
    }
}

function handleDrop(e) {
    e.preventDefault();
    const slot = e.target.closest('.comparison-slot');
    slot.classList.remove('drag-over');
    
    try {
        const versionData = JSON.parse(e.dataTransfer.getData('text/plain'));
        const slotNumber = slot.dataset.slot;
        
        // Update comparison state
        comparisonState[`slot${slotNumber}`] = versionData;
        
        // Update slot UI
        updateComparisonSlot(slot, versionData);
        
        // Check if both slots are filled to enable comparison button
        updateComparisonButton();
        
    } catch (error) {
        console.error('Error handling drop:', error);
        showToast('Failed to add version to comparison', 'error');
    }
}

function updateComparisonSlot(slot, versionData) {
    const slotContent = slot.querySelector('.drop-zone');
    slotContent.innerHTML = 
        '<div class="card bg-info text-white h-100">' +
            '<div class="card-header d-flex justify-content-between align-items-center">' +
                '<h6 class="mb-0">Version ' + versionData.versionNumber + '</h6>' +
                '<button class="btn btn-sm btn-outline-light" onclick="removeFromSlot(' + slot.dataset.slot + ')" title="Remove from comparison">' +
                    '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16">' +
                        '<path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>' +
                    '</svg>' +
                '</button>' +
            '</div>' +
            '<div class="card-body">' +
                '<h6 class="card-title">' + versionData.versionTitle + '</h6>' +
                '<p class="card-text text-sm">' + versionData.versionDescription.substring(0, 80) + (versionData.versionDescription.length > 80 ? '...' : '') + '</p>' +
            '</div>' +
        '</div>';
    
    slotContent.classList.remove('border-dashed', 'text-muted');
    slotContent.classList.add('border-solid');
}

function removeFromSlot(slotNumber) {
    const slot = document.getElementById(`comparisonSlot${slotNumber}`);
    const slotContent = slot.querySelector('.drop-zone');
    
    // Reset slot UI
    slotContent.innerHTML = 
        '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-cloud-arrow-down mx-auto mb-2" viewBox="0 0 16 16">' +
            '<path fill-rule="evenodd" d="M7.646 10.854a.5.5 0 0 0 .708 0l2-2a.5.5 0 0 0-.708-.708L8.5 9.293V5.5a.5.5 0 0 0-1 0v3.793L6.354 8.146a.5.5 0 1 0-.708.708l2 2z"/>' +
            '<path d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773 16 11.569 14.502 13 12.687 13H3.781C1.708 13 0 11.366 0 9.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383zm.653.757c-.757.653-1.153 1.44-1.153 2.056v.448l-.445.049C2.064 6.805 1 7.952 1 9.318 1 10.785 2.23 12 3.781 12h8.906C13.98 12 15 10.988 15 9.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 4.825 10.328 3 8 3a4.53 4.53 0 0 0-2.941 1.1z"/>' +
        '</svg>' +
        '<h6>Version Slot ' + slotNumber + '</h6>' +
        '<p class="mb-0">Drop a version here</p>';
    
    slotContent.classList.add('border-dashed', 'text-muted');
    slotContent.classList.remove('border-solid');
    
    // Update comparison state
    comparisonState[`slot${slotNumber}`] = null;
    
    // Update comparison button
    updateComparisonButton();
}

function clearComparison() {
    removeFromSlot(1);
    removeFromSlot(2);
}

function updateComparisonButton() {
    const compareBtn = document.getElementById('compareSelectedBtn');
    const hasBothSlots = comparisonState.slot1 && comparisonState.slot2;
    
    compareBtn.disabled = !hasBothSlots;
    
    if (hasBothSlots) {
        compareBtn.classList.remove('btn-outline-secondary');
        compareBtn.classList.add('btn-success');
    } else {
        compareBtn.classList.remove('btn-success');
        compareBtn.classList.add('btn-outline-secondary');
    }
}

function compareSelectedVersions(artworkId) {
    if (!comparisonState.slot1 || !comparisonState.slot2) {
        showToast('Please select two versions to compare', 'error');
        return;
    }
    
    const version1Id = comparisonState.slot1.versionId;
    const version2Id = comparisonState.slot2.versionId;
    
    // Call the existing comparison API with GET method and query parameters
    fetch(`/api/artworks/${artworkId}/versions/compare/?version1=${version1Id}&version2=${version2Id}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        showVersionComparisonModal(data, comparisonState.slot1, comparisonState.slot2);
    })
    .catch(error => {
        console.error('Error comparing versions:', error);
        showToast('Failed to compare versions', 'error');
    });
}

function showVersionComparisonModal(comparisonData, version1, version2) {
    const differences = comparisonData.differences || [];
    
    let differencesHtml = '';
    if (differences.length > 0) {
        differencesHtml = differences.map(diff => {
            const fieldTitle = diff.field.charAt(0).toUpperCase() + diff.field.slice(1);
            
            // Handle image differences specially
            if (diff.field === 'image') {
                return '<div class="mb-3">' +
                    '<h6 class="text-warning">' + fieldTitle + ' Changed</h6>' +
                    '<div class="row">' +
                        '<div class="col-md-6">' +
                            '<div class="card bg-danger text-white">' +
                                '<div class="card-header">Version ' + version1.versionNumber + '</div>' +
                                '<div class="card-body text-center">' +
                                    (diff.version1_value ? 
                                        '<img src="' + diff.version1_value + '" class="img-fluid rounded" style="max-height: 200px;" alt="Version ' + version1.versionNumber + '">' :
                                        '<em>No image</em>') +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                        '<div class="col-md-6">' +
                            '<div class="card bg-success text-white">' +
                                '<div class="card-header">Version ' + version2.versionNumber + '</div>' +
                                '<div class="card-body text-center">' +
                                    (diff.version2_value ? 
                                        '<img src="' + diff.version2_value + '" class="img-fluid rounded" style="max-height: 200px;" alt="Version ' + version2.versionNumber + '">' :
                                        '<em>No image</em>') +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            } else {
                // Handle text differences
                return '<div class="mb-3">' +
                    '<h6 class="text-warning">' + fieldTitle + ' Changed</h6>' +
                    '<div class="row">' +
                        '<div class="col-md-6">' +
                            '<div class="card bg-danger text-white">' +
                                '<div class="card-header">Version ' + version1.versionNumber + '</div>' +
                                '<div class="card-body">' +
                                    '<p class="mb-0">' + (diff.version1_value || '<em>Not set</em>') + '</p>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                        '<div class="col-md-6">' +
                            '<div class="card bg-success text-white">' +
                                '<div class="card-header">Version ' + version2.versionNumber + '</div>' +
                                '<div class="card-body">' +
                                    '<p class="mb-0">' + (diff.version2_value || '<em>Not set</em>') + '</p>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }
        }).join('');
    } else {
        differencesHtml = '<div class="alert alert-info">No differences found between these versions.</div>';
    }
    
    const modalHtml = 
        '<div class="modal fade" id="versionComparisonModal" tabindex="-1" aria-labelledby="versionComparisonModalLabel" aria-hidden="true">' +
            '<div class="modal-dialog modal-xl">' +
                '<div class="modal-content bg-dark text-light">' +
                    '<div class="modal-header border-secondary">' +
                        '<h5 class="modal-title" id="versionComparisonModalLabel">' +
                            '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-arrows-angle-expand me-2" viewBox="0 0 16 16">' +
                                '<path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0L1.414 13.88 1 13.465V15.5a.5.5 0 0 0 .5.5h2.036l-.415-.414 3.707-3.707a.5.5 0 0 0 0-.707zm4.344-4.344a.5.5 0 0 0 .707 0l3.707-3.707.415.414V.5a.5.5 0 0 0-.5-.5h-2.036l.415.414L8.172 4.121a.5.5 0 0 0 0 .707z"/>' +
                            '</svg>' +
                            'Version Comparison: ' + version1.versionNumber + ' vs ' + version2.versionNumber +
                        '</h5>' +
                        '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>' +
                    '</div>' +
                    '<div class="modal-body">' +
                        '<div class="alert alert-info border-info bg-dark text-light mb-4">' +
                            '<div class="d-flex">' +
                                '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-info-circle me-2 flex-shrink-0 mt-1" viewBox="0 0 16 16">' +
                                    '<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>' +
                                    '<path d="M8.93 6.588l-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>' +
                                '</svg>' +
                                '<div>' +
                                    '<strong>Side-by-Side Comparison</strong><br>' +
                                    '<small>Red highlights show the older version, green shows the newer version. Only changed fields are displayed.</small>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                        differencesHtml +
                    '</div>' +
                    '<div class="modal-footer border-secondary">' +
                        '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>' +
                    '</div>' +
                '</div>' +
            '</div>' +
        '</div>';
    
    // Remove existing comparison modal if present
    const existingComparisonModal = document.getElementById('versionComparisonModal');
    if (existingComparisonModal) existingComparisonModal.remove();
    
    // Add new modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('versionComparisonModal'));
    modal.show();
}

// Show New Version Upload Modal
function showNewVersionUploadModal(artworkId) {
    const modalHtml = 
        '<div class="modal fade" id="newVersionUploadModal" tabindex="-1" aria-labelledby="newVersionUploadModalLabel" aria-hidden="true">' +
            '<div class="modal-dialog modal-lg">' +
                '<div class="modal-content bg-dark text-light">' +
                    '<div class="modal-header border-secondary">' +
                        '<h5 class="modal-title" id="newVersionUploadModalLabel">' +
                            '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-cloud-upload me-2" viewBox="0 0 16 16">' +
                                '<path fill-rule="evenodd" d="M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318 1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383z"/>' +
                                '<path fill-rule="evenodd" d="M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3z"/>' +
                            '</svg>' +
                            'Create New Version with Upload' +
                        '</h5>' +
                        '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>' +
                    '</div>' +
                    '<div class="modal-body">' +
                        '<div class="alert alert-success border-success bg-dark text-light mb-4">' +
                            '<div class="d-flex">' +
                                '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-info-circle me-2 flex-shrink-0 mt-1" viewBox="0 0 16 16">' +
                                    '<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>' +
                                    '<path d="M8.93 6.588l-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>' +
                                '</svg>' +
                                '<div>' +
                                    '<strong>Streamlined Version Creation</strong><br>' +
                                    '<small>This creates a new version and immediately allows you to upload the new artwork file. Perfect for iterating on your work!</small>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                        '<form id="newVersionUploadForm" enctype="multipart/form-data">' +
                            '<div class="mb-3">' +
                                '<label for="versionTitle" class="form-label">Version Title</label>' +
                                '<input type="text" class="form-control bg-secondary text-light border-secondary" id="versionTitle" placeholder="Enter version title" required>' +
                            '</div>' +
                            '<div class="mb-3">' +
                                '<label for="versionDescription" class="form-label">Version Description</label>' +
                                '<textarea class="form-control bg-secondary text-light border-secondary" id="versionDescription" rows="3" placeholder="Describe what changed in this version"></textarea>' +
                            '</div>' +
                            '<div class="mb-3">' +
                                '<label for="versionNotes" class="form-label">Version Notes <small class="text-muted">(Optional)</small></label>' +
                                '<textarea class="form-control bg-secondary text-light border-secondary" id="versionNotes" rows="2" placeholder="Add any notes about this version"></textarea>' +
                            '</div>' +
                            '<div class="mb-4">' +
                                '<label for="newVersionFile" class="form-label">Upload New Artwork</label>' +
                                '<div class="drag-drop-area border border-secondary rounded p-4 mb-2 bg-secondary" id="dragDropArea">' +
                                    '<div class="text-center">' +
                                        '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-cloud-upload mb-3 text-muted" viewBox="0 0 16 16">' +
                                            '<path fill-rule="evenodd" d="M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318 1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383z"/>' +
                                            '<path fill-rule="evenodd" d="M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3z"/>' +
                                        '</svg>' +
                                        '<h6 class="text-muted">Drag & drop your image here</h6>' +
                                        '<p class="text-muted mb-2">or click to browse</p>' +
                                        '<div id="filePreview" class="mt-3" style="display: none;">' +
                                            '<img id="previewImage" class="img-thumbnail" style="max-height: 200px;" alt="Preview">' +
                                            '<p class="mt-2 mb-0" id="fileName"></p>' +
                                        '</div>' +
                                    '</div>' +
                                '</div>' +
                                '<input type="file" class="form-control bg-secondary text-light border-secondary d-none" id="newVersionFile" accept="image/jpeg,image/jpg,image/png,image/gif,image/webp,image/svg+xml,image/bmp,image/tiff" required>' +
                                '<div class="form-text text-muted mt-2">' +
                                    '<small>' +
                                        '<strong>Supported formats:</strong> JPEG, PNG, GIF, WebP, SVG, BMP, TIFF<br>' +
                                        '<strong>Maximum size:</strong> 20MB' +
                                    '</small>' +
                                '</div>' +
                            '</div>' +
                        '</form>' +
                    '</div>' +
                    '<div class="modal-footer border-secondary">' +
                        '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>' +
                        '<button type="button" class="btn btn-success" onclick="createVersionWithUpload(' + artworkId + ')" id="createVersionUploadBtn">' +
                            '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cloud-upload me-1" viewBox="0 0 16 16">' +
                                '<path fill-rule="evenodd" d="M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318 1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383z"/>' +
                                '<path fill-rule="evenodd" d="M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3z"/>' +
                            '</svg>' +
                            'Create Version & Upload' +
                        '</button>' +
                    '</div>' +
                '</div>' +
            '</div>' +
        '</div>';
    
    // Remove existing modal if present
    const existingModal = document.getElementById('newVersionUploadModal');
    if (existingModal) existingModal.remove();
    
    // Add new modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('newVersionUploadModal'));
    modal.show();

    // Set up drag and drop functionality after modal is shown
    setTimeout(() => {
        setupDragAndDrop();
    }, 100);
}

function setupDragAndDrop() {
    const dragDropArea = document.getElementById('dragDropArea');
    const fileInput = document.getElementById('newVersionFile');
    const filePreview = document.getElementById('filePreview');
    const previewImage = document.getElementById('previewImage');
    const fileName = document.getElementById('fileName');

    if (!dragDropArea || !fileInput) return;

    // Click to browse
    dragDropArea.addEventListener('click', () => {
        fileInput.click();
    });

    // Drag and drop events
    dragDropArea.addEventListener('dragenter', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dragDropArea.classList.add('drag-over');
    });

    dragDropArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dragDropArea.classList.add('drag-over');
    });

    dragDropArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (!dragDropArea.contains(e.relatedTarget)) {
            dragDropArea.classList.remove('drag-over');
        }
    });

    dragDropArea.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dragDropArea.classList.remove('drag-over');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelection(files[0]);
        }
    });

    // File input change
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileSelection(e.target.files[0]);
        }
    });

    function handleFileSelection(file) {
        // Validate file type
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 'image/svg+xml', 'image/bmp', 'image/tiff'];
        if (!allowedTypes.includes(file.type)) {
            showToast('Error', 'Please select a valid image file (JPEG, PNG, GIF, WebP, SVG, BMP, TIFF).', 'danger');
            return;
        }

        // Validate file size (20MB = 20 * 1024 * 1024 bytes)
        if (file.size > 20 * 1024 * 1024) {
            showToast('Error', 'File size must be less than 20MB.', 'danger');
            return;
        }

        // Set the file to the input
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;

        // Show preview
        const reader = new FileReader();
        reader.onload = (e) => {
            previewImage.src = e.target.result;
            fileName.textContent = file.name;
            filePreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
}

// Create Version with Upload
function createVersionWithUpload(artworkId) {
    const title = document.getElementById('versionTitle').value.trim();
    const description = document.getElementById('versionDescription').value.trim();
    const notes = document.getElementById('versionNotes').value.trim();
    const fileInput = document.getElementById('newVersionFile');
    const file = fileInput.files[0];
    
    if (!title) {
        showToast('Please enter a version title', 'error');
        return;
    }
    
    if (!file) {
        showToast('Please select a file to upload', 'error');
        return;
    }
    
    // Validate file size (20MB)
    if (file.size > 20 * 1024 * 1024) {
        showToast('File size must be less than 20MB', 'error');
        return;
    }
    
    const btn = document.getElementById('createVersionUploadBtn');
    
    // Show artistic loading overlay
    showLoadingOverlay('version', 'Creating new version...', 'Processing your artwork iteration and preparing version history');
    
    // Set button loading state with artistic loader
    setButtonLoading(btn, 'brush', 'Upload New Version');
    
    // Create FormData for multipart upload
    const formData = new FormData();
    formData.append('title', title);
    formData.append('description', description);
    formData.append('version_notes', notes);
    formData.append('image', file);
    
    fetch(`/api/artworks/${artworkId}/versions/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => {
        if (response.status === 201 || response.ok) {
            return response.json();
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    })
    .then(data => {
        // Hide loading overlay
        hideLoadingOverlay();
        
        // Restore button
        restoreButton(btn);
        
        // Check for successful response - API returns data.version.id for 201 status
        if (data.version && data.version.id) {
            showToast(`Version ${data.version.version_number} created and uploaded successfully!`, 'success');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('newVersionUploadModal'));
            if (modal) {
                modal.hide();
            }
            
            // Refresh the version manager if it's open
            const versionModal = document.getElementById('versionManagerModal');
            if (versionModal) {
                const versionModalInstance = bootstrap.Modal.getInstance(versionModal);
                if (versionModalInstance) {
                    versionModalInstance.hide();
                    // Reopen after a short delay to show updated versions
                    setTimeout(() => openVersionManager(artworkId), 300);
                }
            } else {
                // If version manager is not open, refresh the page to show updates
                setTimeout(() => {
                    location.reload();
                }, 1500);
            }
            
        } else {
            showToast(data.error || 'Failed to create version with upload', 'error');
        }
    })
    .catch(error => {
        // Hide loading overlay
        hideLoadingOverlay();
        
        // Restore button
        restoreButton(btn);
        
        console.error('Error creating version with upload:', error);
        showToast('Failed to create version with upload', 'error');
    });
}

// Global variables for reorder mode
let isReorderMode = false;
let reorderableVersions = [];
let currentReorderArtworkId = null;

function toggleReorderMode(artworkId) {
    // Check if user is authenticated
    const csrfToken = getCookie('csrftoken');
    if (!csrfToken) {
        showToast('Please log in to reorder versions', 'error');
        return;
    }
    
    const reorderArea = document.getElementById('reorderArea');
    const comparisonArea = document.getElementById('comparisonArea');
    const reorderBtn = document.getElementById('reorderToggleBtn');
    
    if (!isReorderMode) {
        // Enter reorder mode
        isReorderMode = true;
        currentReorderArtworkId = artworkId;
        
        // Hide comparison area if open
        comparisonArea.style.display = 'none';
        
        // Show reorder area
        reorderArea.style.display = 'block';
        
        // Update button appearance
        reorderBtn.innerHTML = reorderBtn.innerHTML.replace('Reorder', 'Exit Reorder');
        reorderBtn.classList.remove('btn-warning');
        reorderBtn.classList.add('btn-danger');
        
        // Load versions for reordering
        loadVersionsForReordering(artworkId);
        
    } else {
        // Exit reorder mode
        cancelReorderMode(artworkId);
    }
}

function cancelReorderMode(artworkId) {
    isReorderMode = false;
    currentReorderArtworkId = null;
    
    const reorderArea = document.getElementById('reorderArea');
    const reorderBtn = document.getElementById('reorderToggleBtn');
    
    // Hide reorder area
    reorderArea.style.display = 'none';
    
    // Reset button appearance
    reorderBtn.innerHTML = reorderBtn.innerHTML.replace('Exit Reorder', 'Reorder');
    reorderBtn.classList.remove('btn-danger');
    reorderBtn.classList.add('btn-warning');
    
    // Clear reorderable versions
    reorderableVersions = [];
    document.getElementById('saveReorderBtn').disabled = true;
}

function loadVersionsForReordering(artworkId) {
    console.log('Loading versions for artwork ID:', artworkId);
    if (!artworkId || artworkId === 'undefined') {
        console.error('Invalid artworkId provided:', artworkId);
        return;
    }
    
    const container = document.getElementById('reorderableVersions');
    
    // Show loading state
    container.innerHTML = 
        '<div class="text-center p-4">' +
            '<div class="spinner-border text-primary" role="status">' +
                '<span class="visually-hidden">Loading versions...</span>' +
            '</div>' +
            '<p class="mt-2 text-muted">Loading versions for reordering...</p>' +
        '</div>';
    
    // Fetch artwork versions
    fetch(`/api/artworks/${artworkId}/versions/`)
    .then(response => response.json())
    .then(data => {
        if (data.versions && data.versions.length > 0) {
            reorderableVersions = [...data.versions].sort((a, b) => b.version_number - a.version_number);
            renderReorderableVersions();
        } else {
            container.innerHTML = 
                '<div class="text-center p-4">' +
                    '<p class="text-muted">No versions found for reordering.</p>' +
                '</div>';
        }
    })
    .catch(error => {
        console.error('Error loading versions for reordering:', error);
        container.innerHTML = 
            '<div class="text-center p-4">' +
                '<p class="text-danger">Failed to load versions for reordering.</p>' +
                '<button class="btn btn-outline-primary btn-sm" onclick="loadVersionsForReordering(' + artworkId + ')">Retry</button>' +
            '</div>';
    });
}

function renderReorderableVersions() {
    const container = document.getElementById('reorderableVersions');
    
    let html = '<div class="reorder-list">';
    
    reorderableVersions.forEach((version, index) => {
        html += 
            '<div class="reorder-item mb-3" data-version-id="' + version.id + '" draggable="true">' +
                '<div class="card bg-secondary text-light border-info">' +
                    '<div class="card-header d-flex justify-content-between align-items-center">' +
                        '<div class="d-flex align-items-center">' +
                            '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-grip-vertical me-2 text-muted" viewBox="0 0 16 16">' +
                                '<path d="M7 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>' +
                            '</svg>' +
                            '<h6 class="mb-0">Version ' + version.version_number + '</h6>' +
                        '</div>' +
                        '<span class="badge bg-info">' + (index + 1) + ' of ' + reorderableVersions.length + '</span>' +
                    '</div>' +
                    '<div class="card-body">' +
                        '<div class="row">' +
                            '<div class="col-md-3">' +
                                '<img src="' + (version.image_display_url || '/static/images/placeholder.png') + '" class="img-fluid rounded" alt="Version ' + version.version_number + '">' +
                            '</div>' +
                            '<div class="col-md-9">' +
                                '<p class="mb-1"><strong>Description:</strong> ' + (version.description || 'No description') + '</p>' +
                                '<p class="mb-1 text-muted"><small>Created: ' + new Date(version.created_at).toLocaleDateString() + '</small></p>' +
                                (version.notes ? '<p class="mb-0 text-info"><small><strong>Notes:</strong> ' + version.notes + '</small></p>' : '') +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
    });
    
    html += '</div>';
    container.innerHTML = html;
    
    // Initialize drag and drop
    initializeReorderDragDrop();
}

function initializeReorderDragDrop() {
    const reorderItems = document.querySelectorAll('.reorder-item');
    
    reorderItems.forEach(item => {
        item.addEventListener('dragstart', handleReorderDragStart);
        item.addEventListener('dragover', handleReorderDragOver);
        item.addEventListener('drop', handleReorderDrop);
        item.addEventListener('dragend', handleReorderDragEnd);
    });
}

function handleReorderDragStart(e) {
    e.dataTransfer.setData('text/plain', e.target.dataset.versionId);
    e.target.classList.add('dragging');
}

function handleReorderDragOver(e) {
    e.preventDefault();
    const draggingItem = document.querySelector('.reorder-item.dragging');
    const container = e.target.closest('.reorder-list');
    
    // Check if we have valid elements
    if (!draggingItem || !container) {
        return;
    }
    
    const afterElement = getDragAfterElement(container, e.clientY);
    
    // Only proceed if afterElement is null or a valid Node
    if (afterElement === null) {
        container.appendChild(draggingItem);
    } else if (afterElement && afterElement.nodeType === Node.ELEMENT_NODE) {
        container.insertBefore(draggingItem, afterElement);
    }
}

function handleReorderDrop(e) {
    e.preventDefault();
    updateReorderPreview();
    document.getElementById('saveReorderBtn').disabled = false;
}

function handleReorderDragEnd(e) {
    e.target.classList.remove('dragging');
}

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.reorder-item:not(.dragging)')];
    
    const result = draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY });
    
    return result.element || null;
}

function updateReorderPreview() {
    const reorderItems = document.querySelectorAll('.reorder-item');
    
    reorderItems.forEach((item, index) => {
        const badge = item.querySelector('.badge');
        badge.textContent = (index + 1) + ' of ' + reorderItems.length;
    });
}

function saveVersionOrder(artworkId) {
    console.log('Saving version order for artwork ID:', artworkId);
    if (!artworkId || artworkId === 'undefined') {
        console.error('Invalid artworkId provided to saveVersionOrder:', artworkId);
        showToast('Invalid artwork ID', 'error');
        return;
    }
    
    const btn = document.getElementById('saveReorderBtn');
    const originalContent = btn.innerHTML;
    
    // Show loading state
    btn.disabled = true;
    btn.innerHTML = 
        '<span class="spinner-border spinner-border-sm me-2" role="status"></span>' +
        'Saving Order...';
    
    // Get new order
    const reorderItems = document.querySelectorAll('.reorder-item');
    const versionOrder = Array.from(reorderItems).map(item => item.dataset.versionId);
    
    console.log('Version order to save:', versionOrder);
    
    // Send reorder request
    fetch(`/api/artworks/${artworkId}/versions/reorder/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            version_order: versionOrder
        })
    })
    .then(response => {
        if (!response.ok) {
            if (response.status === 403) {
                throw new Error('Authentication required. Please log in to reorder versions.');
            } else if (response.status === 500) {
                // Get the HTML error page for debugging
                return response.text().then(html => {
                    console.error('Server error HTML:', html);
                    throw new Error('Server error occurred while reordering versions');
                });
            } else {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast(`Successfully reordered ${data.updated_versions.length} versions!`, 'success');
            
            // Exit reorder mode
            cancelReorderMode(artworkId);
            
            // Refresh version manager if open
            const versionModal = document.getElementById('versionManagerModal');
            if (versionModal) {
                const versionModalInstance = bootstrap.Modal.getInstance(versionModal);
                if (versionModalInstance) {
                    versionModalInstance.hide();
                    setTimeout(() => openVersionManager(artworkId), 300);
                }
            }
            
        } else {
            showToast(data.error || 'Failed to reorder versions', 'error');
        }
    })
    .catch(error => {
        console.error('Error saving version order:', error);
        showToast(error.message || 'Failed to save version order', 'error');
    })
    .finally(() => {
        // Restore button
        btn.disabled = false;
        btn.innerHTML = originalContent;
    });
}
</script>

<style>
.drag-drop-area {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px dashed #6c757d !important;
}

.drag-drop-area:hover {
    border-color: #0d6efd !important;
    background-color: rgba(13, 110, 253, 0.05) !important;
}

.drag-drop-area.drag-over {
    border-color: #0d6efd !important;
    background-color: rgba(13, 110, 253, 0.1) !important;
    transform: scale(1.02);
}

.version-thumbnail {
    cursor: grab;
    transition: all 0.2s ease;
}

.version-thumbnail:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.version-thumbnail.dragging {
    opacity: 0.5;
    transform: rotate(5deg) scale(1.05);
    cursor: grabbing;
}

/* Reorder mode styles */
.reorder-area {
    border: 2px dashed #6c757d;
    border-radius: 0.5rem;
    background-color: rgba(0, 0, 0, 0.1);
}

.reorderable-container {
    min-height: 200px;
    padding: 1rem;
}

.reorder-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.reorder-item {
    cursor: grab;
    transition: all 0.3s ease;
    position: relative;
}

.reorder-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.reorder-item.dragging {
    opacity: 0.6;
    transform: rotate(2deg) scale(1.02);
    cursor: grabbing;
    z-index: 1000;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

.reorder-item .card {
    border: 2px solid transparent;
    transition: border-color 0.2s ease;
}

.reorder-item:hover .card {
    border-color: #0d6efd;
}

.reorder-item.dragging .card {
    border-color: #ffc107;
    background-color: rgba(255, 193, 7, 0.1);
}

.grip-handle {
    color: #6c757d;
    transition: color 0.2s ease;
}

.reorder-item:hover .grip-handle {
    color: #0d6efd;
}

.reorder-drop-zone {
    min-height: 4px;
    background-color: transparent;
    border-radius: 2px;
    transition: all 0.2s ease;
    margin: 0.25rem 0;
}

.reorder-drop-zone.drag-over {
    background-color: #0d6efd;
    min-height: 8px;
    box-shadow: 0 0 10px rgba(13, 110, 253, 0.5);
}

/* Fix for toggle switch visibility */
.form-check-input[type="checkbox"] {
    background-color: #6c757d !important;
    border: 1px solid #adb5bd !important;
    width: 2em !important;
    height: 1em !important;
    border-radius: 0.5em !important;
    position: relative !important;
}

.form-check-input[type="checkbox"]:checked {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
}

.form-check-input[type="checkbox"]:before {
    content: '';
    position: absolute;
    top: 1px;
    left: 1px;
    width: calc(1em - 4px);
    height: calc(1em - 4px);
    background-color: white;
    border-radius: 50%;
    transition: transform 0.15s ease-in-out;
    transform: translateX(0);
}

.form-check-input[type="checkbox"]:checked:before {
    transform: translateX(calc(1em - 2px));
}
</style>

<script>
// Toggle archived versions visibility
function toggleArchivedVersions() {
    const checkbox = document.getElementById('showArchivedVersions');
    const archivedVersions = document.querySelectorAll('.version-card[data-is-archived="true"]');
    
    if (checkbox.checked) {
        // Show archived versions
        archivedVersions.forEach(function(card) {
            card.style.display = 'block';
            card.style.opacity = '0.7';
            // Add archived badge if not already present
            if (!card.querySelector('.archived-badge')) {
                const badge = document.createElement('div');
                badge.className = 'archived-badge position-absolute top-0 end-0 m-1';
                badge.innerHTML = '<span class="badge bg-secondary">Archived</span>';
                card.querySelector('.card').style.position = 'relative';
                card.querySelector('.card').appendChild(badge);
            }
        });
    } else {
        // Hide archived versions
        archivedVersions.forEach(function(card) {
            card.style.display = 'none';
        });
    }
}

// Full-size image viewing function
function showFullImage(imageUrl, title) {
    // Remove existing full image modal if present
    const existingModal = document.getElementById('fullImageModal');
    if (existingModal) existingModal.remove();
    
    const modalHtml = 
        '<div class="modal fade" id="fullImageModal" tabindex="-1" aria-labelledby="fullImageModalLabel" aria-hidden="true">' +
            '<div class="modal-dialog modal-xl modal-dialog-centered">' +
                '<div class="modal-content bg-dark text-light">' +
                    '<div class="modal-header border-secondary">' +
                        '<h5 class="modal-title" id="fullImageModalLabel">' + title + '</h5>' +
                        '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>' +
                    '</div>' +
                    '<div class="modal-body text-center p-4">' +
                        '<img src="' + imageUrl + '" class="img-fluid rounded" style="max-height: 80vh; max-width: 100%;" alt="' + title + '">' +
                    '</div>' +
                    '<div class="modal-footer border-secondary">' +
                        '<a href="' + imageUrl + '" target="_blank" class="btn btn-outline-light">' +
                            '<i class="bi bi-download"></i> Open in New Tab' +
                        '</a>' +
                        '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>' +
                    '</div>' +
                '</div>' +
            '</div>' +
        '</div>';
    
    // Add modal to body and show it
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('fullImageModal'));
    modal.show();
    
    // Clean up when modal is hidden
    document.getElementById('fullImageModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// Cover Image Upload Functions
let currentFolderId = null;

function openCoverImageUpload(folderId) {
    currentFolderId = folderId;
    
    // Find the current cover image for this folder
    const folderCard = document.querySelector(`[data-folder-id="${folderId}"]`);
    const currentCoverSection = document.getElementById('currentCoverImageSection');
    const currentCoverImg = document.getElementById('currentCoverImg');
    const fileInput = document.getElementById('coverImageFile');
    
    // Reset form
    fileInput.value = '';
    fileInput.required = true;
    removeUploadCoverPreview();
    
    if (folderCard) {
        const coverImg = folderCard.querySelector('.folder-cover-image');
        if (coverImg && coverImg.src) {
            // Show current cover image section
            currentCoverImg.src = coverImg.src;
            currentCoverSection.style.display = 'block';
            fileInput.required = false; // Not required if there's already a cover image
        } else {
            // Hide current cover image section
            currentCoverSection.style.display = 'none';
            fileInput.required = true; // Required if no cover image exists
        }
    } else {
        currentCoverSection.style.display = 'none';
        fileInput.required = true;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('coverImageUploadModal'));
    modal.show();
}

function previewUploadCoverImage(input) {
    const preview = document.getElementById('uploadCoverImagePreview');
    const previewImg = document.getElementById('uploadPreviewImg');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function removeUploadCoverPreview() {
    const preview = document.getElementById('uploadCoverImagePreview');
    const previewImg = document.getElementById('uploadPreviewImg');
    const fileInput = document.getElementById('coverImageFile');
    
    preview.style.display = 'none';
    previewImg.src = '';
    fileInput.value = '';
}

function removeCoverImage() {
    if (!currentFolderId) {
        alert('No folder selected');
        return;
    }
    
    if (confirm('Are you sure you want to remove the cover image for this folder?')) {
        // Send request to remove cover image
        fetch(`/api/folders/${currentFolderId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                cover_image: null
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.id || data.name) {
                // Close modal and refresh page
                bootstrap.Modal.getInstance(document.getElementById('coverImageUploadModal')).hide();
                location.reload();
            } else {
                alert('Failed to remove cover image. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error removing cover image:', error);
            alert('Failed to remove cover image. Please check your connection.');
        });
    }
}

// Handle cover image upload form submission
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('coverImageUploadForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!currentFolderId) {
                alert('No folder selected');
                return;
            }
            
            const formData = new FormData(form);
            
            fetch(`/api/folders/${currentFolderId}/`, {
                method: 'PATCH',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Upload failed with status: ' + response.status);
                }
            })
            .then(data => {
                // Check if response has cover_image field (indicates successful upload)
                if (data && (data.cover_image || data.name)) {
                    // Close modal and refresh page
                    bootstrap.Modal.getInstance(document.getElementById('coverImageUploadModal')).hide();
                    location.reload();
                } else {
                    alert('Failed to upload cover image. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error uploading cover image:', error);
                alert('Failed to upload cover image. Please check your connection.');
            });
        });
    }
    
    // Clear form when modal is hidden
    const modal = document.getElementById('coverImageUploadModal');
    if (modal) {
        modal.addEventListener('hidden.bs.modal', function() {
            document.getElementById('coverImageUploadForm').reset();
            removeUploadCoverPreview();
            currentFolderId = null;
        });
    }
});
</script>

<!-- Cover Image Upload Modal -->
<div class="modal fade" id="coverImageUploadModal" tabindex="-1" aria-labelledby="coverImageUploadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="coverImageUploadModalLabel">Upload Cover Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="coverImageUploadForm" enctype="multipart/form-data">
                <div class="modal-body">
                    {% csrf_token %}
                    
                    <!-- Current Cover Image Display -->
                    <div id="currentCoverImageSection" class="mb-3" style="display: none;">
                        <label class="form-label">Current Cover Image</label>
                        <div class="d-flex align-items-center gap-3">
                            <img id="currentCoverImg" src="" alt="Current cover" class="img-thumbnail" style="max-width: 150px; max-height: 100px; object-fit: cover;">
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeCoverImage()">
                                <i class="bi bi-trash me-1"></i> Remove Cover Image
                            </button>
                        </div>
                        <hr class="my-3">
                    </div>
                    
                    <div class="mb-3">
                        <label for="coverImageFile" class="form-label">Choose New Cover Image</label>
                        <input type="file" class="form-control" id="coverImageFile" name="cover_image" 
                               accept="image/*" onchange="previewUploadCoverImage(this)">
                        <div class="form-text">Upload a cover image for this folder (JPEG, PNG, GIF, WebP, SVG - max 20MB)</div>
                        <div id="uploadCoverImagePreview" class="mt-2" style="display: none;">
                            <img id="uploadPreviewImg" src="" alt="Cover preview" class="img-thumbnail" style="max-width: 200px; max-height: 150px; object-fit: cover;">
                            <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="removeUploadCoverPreview()">
                                <i class="bi bi-x"></i> Remove
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-upload me-2"></i>
                        Upload Cover Image
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}