{% extends "critique/base.html" %}

{% block title %}Password Management - Brush Up{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card bg-dark text-white border-secondary">
                <div class="card-header border-secondary">
                    <h2 class="mb-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-shield-lock me-2" viewBox="0 0 16 16">
                            <path d="M5.338 1.59a61.44 61.44 0 0 0-2.837.856.481.481 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.725 10.725 0 0 0 2.287 2.233c.346.244.652.42.893.533.12.057.218.095.293.118a.55.55 0 0 0 .101.025.615.615 0 0 0 .1-.025c.076-.023.174-.061.294-.118.24-.113.547-.29.893-.533a10.726 10.726 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.775 11.775 0 0 1-2.517 2.453 7.159 7.159 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7.158 7.158 0 0 1-1.048-.625 11.777 11.777 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 62.456 62.456 0 0 1 5.072.56z"/>
                            <path d="M9.5 6.5a1.5 1.5 0 0 1-1 1.415l.385 1.99a.5.5 0 0 1-.491.595h-.788a.5.5 0 0 1-.49-.595L7.5 7.915A1.5 1.5 0 1 1 9.5 6.5z"/>
                        </svg>
                        Password &amp; Security
                    </h2>
                </div>
                <div class="card-body">
                    
                    <!-- Authentication Status -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card bg-secondary border-0">
                                <div class="card-body text-center">
                                    {% if has_google_account %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-google text-success mb-2" viewBox="0 0 16 16">
                                            <path d="M15.545 6.558a9.42 9.42 0 0 1 .139 1.626c0 2.434-.87 4.492-2.384 5.885h.002C11.978 15.292 10.158 16 8 16A8 8 0 1 1 8 0a7.689 7.689 0 0 1 5.352 2.082l-2.284 2.284A4.347 4.347 0 0 0 8 3.166c-2.087 0-3.86 1.408-4.492 3.304a4.792 4.792 0 0 0 0 3.063h.003c.635 1.893 2.405 3.301 4.492 3.301 1.078 0 2.004-.276 2.722-.764h-.003a3.702 3.702 0 0 0 1.599-2.431H8v-3.08h7.545z"/>
                                        </svg>
                                        <h6 class="text-success mb-1">Google Account</h6>
                                        <small class="text-muted">Connected</small>
                                    {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-person-circle text-info mb-2" viewBox="0 0 16 16">
                                            <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                                            <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
                                        </svg>
                                        <h6 class="text-info mb-1">Local Account</h6>
                                        <small class="text-muted">Email/Password</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-secondary border-0">
                                <div class="card-body text-center">
                                    {% if has_password %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-key-fill text-success mb-2" viewBox="0 0 16 16">
                                            <path d="M3.5 11.5a3.5 3.5 0 1 1 3.163-5H14L15.5 8 14 9.5l-1-1-1 1-1-1-1 1-1-1-1 1H6.663a3.5 3.5 0 0 1-3.163 2z"/>
                                        </svg>
                                        <h6 class="text-success mb-1">Password Set</h6>
                                        <small class="text-muted">Email/password login available</small>
                                    {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-key text-warning mb-2" viewBox="0 0 16 16">
                                            <path d="M0 8a4 4 0 0 1 7.465-2H14a.5.5 0 0 1 .354.146l1.5 1.5a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0L13 9.207l-.646.647a.5.5 0 0 1-.708 0L11 9.207l-.646.647a.5.5 0 0 1-.708 0L9 9.207l-.646.647A.5.5 0 0 1 8 10h-.535A4 4 0 0 1 0 8zm4-3a3 3 0 1 0 2.712 4.285A.5.5 0 0 1 7.163 9h.63l.853-.854a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .708 0l.646.647.793-.793-1-1h-6.63a.5.5 0 0 1-.451-.285A3 3 0 0 0 4 5z"/>
                                        </svg>
                                        <h6 class="text-warning mb-1">No Password</h6>
                                        <small class="text-muted">Only Google login available</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Update Form -->
                    <div class="card bg-secondary border-0 mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Profile Information</h5>
                        </div>
                        <div class="card-body">
                            <form method="post">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="update_profile">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        {{ profile_form.first_name.label_tag }}
                                        {{ profile_form.first_name }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        {{ profile_form.last_name.label_tag }}
                                        {{ profile_form.last_name }}
                                    </div>
                                </div>
                                <div class="mb-3">
                                    {{ profile_form.email.label_tag }}
                                    {{ profile_form.email }}
                                    <div class="form-text text-muted">{{ profile_form.email.help_text }}</div>
                                </div>
                                <button type="submit" class="btn btn-primary">Update Profile</button>
                            </form>
                        </div>
                    </div>

                    <!-- Password Management -->
                    <div class="card bg-secondary border-0">
                        <div class="card-header">
                            <h5 class="mb-0">Password Management</h5>
                        </div>
                        <div class="card-body">
                            {% if has_password %}
                                <!-- Change Password Form -->
                                <h6 class="text-light mb-3">Change Password</h6>
                                <form method="post" class="mb-4">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="change_password">
                                    <div class="mb-3">
                                        {{ password_form.old_password.label_tag }}
                                        {{ password_form.old_password }}
                                        {% for error in password_form.old_password.errors %}
                                            <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                    <div class="mb-3">
                                        {{ password_form.new_password1.label_tag }}
                                        {{ password_form.new_password1 }}
                                        {% for error in password_form.new_password1.errors %}
                                            <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                        <div class="form-text text-muted">{{ password_form.new_password1.help_text }}</div>
                                    </div>
                                    <div class="mb-3">
                                        {{ password_form.new_password2.label_tag }}
                                        {{ password_form.new_password2 }}
                                        {% for error in password_form.new_password2.errors %}
                                            <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                    <button type="submit" class="btn btn-warning">Change Password</button>
                                </form>

                                {% if has_google_account %}
                                    <!-- Remove Password Option for OAuth Users -->
                                    <hr class="border-secondary">
                                    <h6 class="text-light mb-3">Remove Password</h6>
                                    <p class="text-muted mb-3">
                                        If you prefer to use only your Google account for login, you can remove your password. 
                                        You'll still be able to log in with Google.
                                    </p>
                                    <form method="post">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="remove_password">
                                        <div class="mb-3">
                                            <div class="form-check">
                                                {{ remove_password_form.confirm }}
                                                {{ remove_password_form.confirm.label_tag }}
                                            </div>
                                            <div class="form-text text-muted">{{ remove_password_form.confirm.help_text }}</div>
                                            {% for error in remove_password_form.confirm.errors %}
                                                <div class="text-danger small">{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                        <button type="submit" class="btn btn-outline-danger">Remove Password</button>
                                    </form>
                                {% endif %}
                            {% else %}
                                <!-- Set Password Form for OAuth Users -->
                                <h6 class="text-light mb-3">Set Up Password Login</h6>
                                <div class="alert alert-info border-info bg-dark">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle me-2" viewBox="0 0 16 16">
                                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                        <path d="M8.93 6.588l-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                                    </svg>
                                    <strong>Why set up a password?</strong><br>
                                    Adding a password gives you an alternative login method if Google authentication is unavailable, 
                                    and lets you access your account from any device or browser.
                                </div>
                                
                                <form method="post" class="mb-4">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="set_password">
                                    <div class="mb-3">
                                        {{ password_form.new_password1.label_tag }}
                                        {{ password_form.new_password1 }}
                                        {% for error in password_form.new_password1.errors %}
                                            <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                        <div class="form-text text-muted">{{ password_form.new_password1.help_text }}</div>
                                    </div>
                                    <div class="mb-3">
                                        {{ password_form.new_password2.label_tag }}
                                        {{ password_form.new_password2 }}
                                        {% for error in password_form.new_password2.errors %}
                                            <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                        <div class="form-text text-muted">{{ password_form.new_password2.help_text }}</div>
                                    </div>
                                    <button type="submit" class="btn btn-success">Set Password</button>
                                </form>

                                <hr class="border-secondary">
                                <h6 class="text-light mb-3">Alternative: Email Password Reset</h6>
                                <p class="text-muted mb-3">
                                    You can also set up your password by receiving a password reset email.
                                </p>
                                <button type="button" class="btn btn-outline-primary" onclick="sendPasswordReset()">
                                    Send Password Setup Email
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function sendPasswordReset() {
    const button = event.target;
    const originalText = button.innerText;
    button.disabled = true;
    button.innerText = 'Sending...';
    
    fetch('/api/auth/send-password-reset/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            email: '{{ user.email }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Password setup instructions have been sent to your email address.');
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while sending the email.');
    })
    .finally(() => {
        button.disabled = false;
        button.innerText = originalText;
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}